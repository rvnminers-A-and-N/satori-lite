#!/bin/bash

CONTAINER_NAME="satori"

# Dev mode - always mount local code
IMAGE_TAG="dev"
IMAGE="satorinet/satori-lite:${IMAGE_TAG}"

# Check if running in local mode
if [ "$1" = "local" ] || [ "$2" = "local" ]; then
    CENTRAL_URL="http://host.docker.internal:8000"
    API_URL="http://host.docker.internal:8000"
    echo "Using LOCAL central-lite at $CENTRAL_URL"
else
    CENTRAL_URL="http://137.184.38.13:8000"
    API_URL="http://137.184.38.13:8000"
    echo "Using REMOTE central-lite at $CENTRAL_URL"
fi

# Function to create data directories (in source code directories)
create_data_dirs() {
    mkdir -p "$(pwd)/neuron-lite/config"
    mkdir -p "$(pwd)/neuron-lite/wallet"
    mkdir -p "$(pwd)/neuron-lite/models"
    mkdir -p "$(pwd)/engine-lite/db"
}

# Function to create and start container
create_container() {
    # Create data directories
    create_data_dirs

    # Dev mode: mount code + data (data stored within source directories)
    # Note: neuron-lite contains config, wallet, models subdirectories
    # Note: engine-lite contains db subdirectory
    docker run -d --name $CONTAINER_NAME \
        --restart unless-stopped \
        -p 5001:5001 \
        -e SATORI_UI_PORT=5001 \
        -v "$(pwd)/lib-lite:/Satori/Lib" \
        -v "$(pwd)/neuron-lite:/Satori/Neuron" \
        -v "$(pwd)/engine-lite:/Satori/Engine" \
        -v "$(pwd)/web:/Satori/web" \
        -v "$(pwd)/neuron-lite/models:/Satori/models" \
        -e SATORI_ENV=dev \
        -e SATORI_CENTRAL_URL=$CENTRAL_URL \
        -e SATORI_API_URL=$API_URL \
        -e PYTHONPATH="/Satori/Lib:/Satori/Neuron:/Satori/Engine:/Satori" \
        $IMAGE python /Satori/Neuron/start.py || {
        echo "Error: Failed to create container. Is Docker running?"
        exit 1
    }
}

# Help
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Satori Lite CLI - Development Mode"
    echo ""
    echo "Usage: satori-dev [local] [command]"
    echo ""
    echo "Flags:"
    echo "  local       Connect to local central-lite (host.docker.internal:8000)"
    echo "              Without this flag, connects to remote central-lite"
    echo ""
    echo "Commands:"
    echo "  (none)      Enter interactive CLI"
    echo "  start       Start the neuron container"
    echo "  stop        Stop the neuron container"
    echo "  restart     Restart the neuron container"
    echo "  logs        Show container logs"
    echo "  status      Show container status"
    echo "  --help      Show this help"
    echo ""
    echo "Examples:"
    echo "  ./satori-dev local          # Start with local central-lite"
    echo "  ./satori-dev local restart  # Restart with local central-lite"
    echo "  ./satori-dev restart        # Restart with remote central-lite"
    echo ""
    echo "Development mode mounts local code directories:"
    echo "  ./lib-lite, ./neuron-lite, ./engine-lite, ./web"
    echo ""
    echo "Data persists in source directories:"
    echo "  ./neuron-lite/config, ./neuron-lite/wallet,"
    echo "  ./neuron-lite/models, ./engine-lite/db"
    exit 0
fi

# Determine the command (handle "local" flag)
if [ "$1" = "local" ]; then
    COMMAND="$2"
else
    COMMAND="$1"
fi

# Commands
case "$COMMAND" in
    start)
        docker start $CONTAINER_NAME
        echo "Satori neuron started"
        ;;
    stop)
        docker stop $CONTAINER_NAME 2>/dev/null
        docker rm $CONTAINER_NAME 2>/dev/null
        echo "Satori neuron stopped and removed"
        ;;
    restart)
        echo "Restarting Satori neuron..."
        # Stop and remove container
        docker stop $CONTAINER_NAME 2>/dev/null
        docker rm $CONTAINER_NAME 2>/dev/null
        # Create fresh container
        create_container
        echo "Satori neuron restarted"
        ;;
    logs)
        docker logs $CONTAINER_NAME --tail 100 -f
        ;;
    status)
        if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "Satori neuron is running"
            docker ps --filter "name=$CONTAINER_NAME" --format "Container: {{.Names}}\nStatus: {{.Status}}\nCreated: {{.CreatedAt}}"
        else
            echo "Satori neuron is not running"
        fi
        ;;
    "")
        # Default: enter CLI
        if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "Satori neuron is not running. Starting..."
            # Try to start existing container, or create new one
            if ! docker start $CONTAINER_NAME 2>/dev/null; then
                echo "Container not found. Creating..."
                create_container
            fi
            sleep 2
        fi
        docker exec -it $CONTAINER_NAME python /Satori/Neuron/cli.py
        ;;
    *)
        echo "Unknown command: $COMMAND"
        echo "Run 'satori-dev --help' for usage"
        exit 1
        ;;
esac
