{% extends "base.html" %}

{% block title %}Satori - Network{% endblock %}

{% block extra_css %}
<style>
    /* ============================================ */
    /* BASE STYLES */
    /* ============================================ */
    .network-graph {
        background: linear-gradient(135deg, var(--accent-primary) 0%, var(--accent-secondary) 100%);
        border-radius: 12px;
        overflow: hidden;
        position: relative;
    }
    .network-graph svg {
        width: 100%;
        height: 650px;
    }
    .metric-card {
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }
    .metric-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow);
    }
    .stats-number {
        font-size: 2rem;
        font-weight: 700;
        background: var(--accent-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
    }

    /* ============================================ */
    /* NODE ROLE COLORS (for gradients) */
    /* ============================================ */
    /* Functional roles - what the node actively does */
    /* predictor: #00ff88 (green) - makes predictions */
    /* relay: #ff6b6b (red/coral) - relays data */
    /* oracle: #00aaff (blue) - provides oracle data */
    /* signer: #ffd700 (gold) - signs governance/consensus (also curates & archives) */

    .node-you { fill: url(#myNodeGradient) !important; }
    .node-predictor { fill: #00ff88 !important; }
    .node-relay { fill: #ff6b6b !important; }
    .node-oracle { fill: #00aaff !important; }
    .node-signer { fill: #ffd700 !important; }
    .node-unknown { fill: #888888 !important; }

    /* ============================================ */
    /* TITLE COLORS (for outer ring gradients) */
    /* ============================================ */
    /* Earned titles - achievements/status */
    /* historic: #9966ff (purple) - uptime dedication */
    /* friendly: #ff66aa (pink) - community builder */
    /* charity: #ffcc00 (gold) - generous donor */
    /* civic: #00ddff (cyan) - governance active */
    /* whale: #00ff88 (bright green) - max stake */
    /* legend: #ffffff (white/rainbow) - all titles */

    .title-ring {
        fill: none;
        stroke-width: 4;
        pointer-events: none;
        filter: drop-shadow(0 0 3px currentColor);
    }

    /* Title ring glow animation for special nodes */
    @keyframes titleRingGlow {
        0%, 100% { filter: drop-shadow(0 0 3px currentColor); opacity: 1; }
        50% { filter: drop-shadow(0 0 8px currentColor); opacity: 0.85; }
    }
    .node:hover .title-ring {
        animation: titleRingGlow 1.5s ease-in-out infinite;
    }

    /* ============================================ */
    /* STAKING STATUS BADGES (pool-operator, delegate) */
    /* ============================================ */
    /* These are economic relationships, not functional roles */
    /* Shown as small icon badges on the node */
    .staking-badge {
        font-size: 8px;
        font-weight: bold;
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .staking-badge-operator {
        fill: #aa44ff;
    }
    .staking-badge-delegate {
        fill: #00d4aa;
    }

    /* ============================================ */
    /* REPUTATION VISUAL INDICATORS */
    /* ============================================ */
    /* Reputation is shown as an inner glow on the node circle */
    /* Trusted (90+): green glow - highly reliable node */
    /* Good (70-89): blue - good standing */
    /* Neutral (50-69): no glow (grey/white border) - default */
    /* Suspect (30-49): yellow/orange glow - caution */
    /* Untrusted (<30): red glow - avoid */

    .reputation-ring {
        fill: none;
        stroke-width: 2;
        pointer-events: none;
    }

    /* Trusted: bright green glow */
    .reputation-trusted {
        stroke: #00ff88;
        filter: drop-shadow(0 0 6px #00ff88) drop-shadow(0 0 3px #00ff88);
    }
    @keyframes trustedGlow {
        0%, 100% { filter: drop-shadow(0 0 6px #00ff88) drop-shadow(0 0 3px #00ff88); }
        50% { filter: drop-shadow(0 0 10px #00ff88) drop-shadow(0 0 5px #00ff88); }
    }
    .node:hover .reputation-trusted {
        animation: trustedGlow 2s ease-in-out infinite;
    }

    /* Good: blue */
    .reputation-good {
        stroke: #00aaff;
        filter: drop-shadow(0 0 4px #00aaff);
    }

    /* Neutral: subtle grey/white (default, no special effect) */
    .reputation-neutral {
        stroke: rgba(255, 255, 255, 0.3);
        filter: none;
    }

    /* Suspect: yellow/orange warning */
    .reputation-suspect {
        stroke: #ffaa00;
        filter: drop-shadow(0 0 4px #ffaa00);
    }
    @keyframes suspectPulse {
        0%, 100% { filter: drop-shadow(0 0 4px #ffaa00); opacity: 1; }
        50% { filter: drop-shadow(0 0 8px #ff6600); opacity: 0.8; }
    }
    .reputation-suspect {
        animation: suspectPulse 1.5s ease-in-out infinite;
    }

    /* Untrusted: red danger */
    .reputation-untrusted {
        stroke: #ff4444;
        filter: drop-shadow(0 0 6px #ff4444);
    }
    @keyframes untrustedPulse {
        0%, 100% { filter: drop-shadow(0 0 6px #ff4444); opacity: 1; }
        50% { filter: drop-shadow(0 0 10px #ff0000); opacity: 0.7; }
    }
    .reputation-untrusted {
        animation: untrustedPulse 1s ease-in-out infinite;
    }

    /* ============================================ */
    /* SLASHING STATUS INDICATORS */
    /* ============================================ */
    /* Slashing status: warned (yellow) or removed (red) */
    /* Shown as a strike-through or warning icon on the node */

    .slashing-badge {
        font-size: 10px;
        font-weight: bold;
        pointer-events: none;
    }

    /* Warned: yellow warning icon, positioned bottom-right */
    .slashing-warned {
        fill: #ffcc00;
        text-shadow: 0 0 4px #ffcc00, 0 1px 2px rgba(0,0,0,0.8);
    }

    /* Removed: red X icon, node is greyed out */
    .slashing-removed {
        fill: #ff4444;
        text-shadow: 0 0 4px #ff4444, 0 1px 2px rgba(0,0,0,0.8);
    }

    /* Grey out removed nodes */
    .node-slashed-removed .node-circle {
        fill: #444444 !important;
        opacity: 0.5;
    }
    .node-slashed-removed .title-ring {
        opacity: 0.3;
    }
    .node-slashed-removed .node-label {
        opacity: 0.5;
        text-decoration: line-through;
    }

    /* ============================================ */
    /* EDGE TYPE STYLES */
    /* ============================================ */
    .edge-p2p {
        stroke: rgba(0, 255, 136, 0.4);
        stroke-width: 1.5;
    }
    .edge-lending {
        stroke: #aa44ff;
        stroke-width: 2;
        stroke-dasharray: 8, 4;
    }
    .edge-delegation {
        stroke: #00d4aa;
        stroke-width: 2;
        stroke-dasharray: 4, 4;
    }
    .edge-charity {
        stroke: #ffcc00;
        stroke-width: 2;
        stroke-dasharray: 2, 2;
    }

    /* ============================================ */
    /* NODE INTERACTIONS */
    /* ============================================ */
    .node-circle {
        cursor: pointer;
        transition: all 0.3s ease;
    }
    .node-circle:hover {
        filter: brightness(1.3) drop-shadow(0 0 8px currentColor);
    }
    .node-label {
        font-size: 9px;
        fill: white;
        pointer-events: none;
        text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    .node-role-badge {
        font-size: 7px;
        fill: rgba(255,255,255,0.7);
        pointer-events: none;
    }

    /* ============================================ */
    /* PULSE & ANIMATION EFFECTS */
    /* ============================================ */
    @keyframes heartbeatPulse {
        0% { r: 12; opacity: 1; stroke-width: 3; }
        100% { r: 40; opacity: 0; stroke-width: 1; }
    }
    @keyframes predictionPulse {
        0% { r: 12; opacity: 1; stroke-width: 2; }
        100% { r: 35; opacity: 0; stroke-width: 1; }
    }
    @keyframes signerFlash {
        0% { opacity: 1; }
        50% { opacity: 0.3; }
        100% { opacity: 1; }
    }
    @keyframes livePulse {
        0%, 100% { opacity: 1; box-shadow: 0 0 5px currentColor; }
        50% { opacity: 0.5; box-shadow: 0 0 15px currentColor; }
    }
    .heartbeat-ring {
        fill: none;
        stroke: #ff6b6b;
        pointer-events: none;
    }
    .heartbeat-pulse {
        display: inline-block;
        width: 8px;
        height: 8px;
        background: #ff6b6b;
        border-radius: 50%;
        margin-right: 4px;
        animation: heartbeatPulseIndicator 1s ease-in-out infinite;
    }
    .heartbeat-pulse-sm {
        display: inline-block;
        width: 6px;
        height: 6px;
        background: #ff6b6b;
        border-radius: 50%;
        margin-right: 4px;
        animation: heartbeatPulseIndicator 1s ease-in-out infinite;
    }
    @keyframes heartbeatPulseIndicator {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.3); opacity: 0.7; }
    }
    .prediction-ring {
        fill: none;
        stroke: #00ff88;
        pointer-events: none;
    }
    .observation-ring {
        fill: none;
        stroke: #00aaff;
        pointer-events: none;
    }
    .signer-flash {
        animation: signerFlash 0.5s ease-in-out;
    }

    /* Data packets */
    .data-packet {
        filter: drop-shadow(0 0 4px currentColor);
    }
    .packet-prediction { fill: #00ff88; }
    .packet-observation { fill: #00aaff; }
    .packet-heartbeat { fill: #ff6b6b; }
    .packet-consensus { fill: #ffd700; }

    /* ============================================ */
    /* LEGEND STYLES */
    /* ============================================ */
    .network-legend {
        position: absolute;
        top: 10px;
        left: 10px;
        background: rgba(0,0,0,0.7);
        border-radius: 10px;
        padding: 12px;
        font-size: 11px;
        color: white;
        z-index: 100;
        max-width: 240px;
        max-height: calc(100% - 20px);
        overflow-y: auto;
        backdrop-filter: blur(5px);
    }
    .network-legend::-webkit-scrollbar {
        width: 6px;
    }
    .network-legend::-webkit-scrollbar-track {
        background: rgba(255,255,255,0.1);
        border-radius: 3px;
    }
    .network-legend::-webkit-scrollbar-thumb {
        background: rgba(255,255,255,0.3);
        border-radius: 3px;
    }
    .network-legend::-webkit-scrollbar-thumb:hover {
        background: rgba(255,255,255,0.5);
    }
    .legend-title {
        font-weight: bold;
        margin-bottom: 8px;
        border-bottom: 1px solid rgba(255,255,255,0.2);
        padding-bottom: 5px;
    }
    .legend-item {
        display: flex;
        align-items: center;
        margin-bottom: 4px;
        cursor: pointer;
        opacity: 1;
        transition: opacity 0.3s;
        padding: 2px 4px;
        border-radius: 3px;
    }
    .legend-item.hidden {
        opacity: 0.3;
    }
    .legend-item:hover {
        background: rgba(255,255,255,0.1);
    }
    .legend-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
    }
    .legend-line {
        width: 20px;
        height: 3px;
        margin-right: 8px;
        flex-shrink: 0;
    }
    .legend-ring {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
        border: 2px solid;
        background: transparent;
    }
    .legend-glow {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        margin-right: 8px;
        flex-shrink: 0;
    }
    .legend-hint {
        color: rgba(255,255,255,0.4);
        font-size: 9px;
        margin-left: auto;
    }
    .legend-section {
        margin-top: 10px;
        padding-top: 8px;
        border-top: 1px solid rgba(255,255,255,0.1);
    }

    /* ============================================ */
    /* COLLAPSIBLE PANEL STYLES */
    /* ============================================ */
    .management-panel {
        border: 1px solid var(--border-color);
        border-radius: 10px;
        margin-bottom: 15px;
        overflow: hidden;
        background: var(--bg-card);
    }
    .panel-header {
        background: var(--bg-card-header);
        padding: 12px 15px;
        cursor: pointer;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: background 0.3s;
        color: var(--text-primary);
    }
    .panel-header:hover {
        background: var(--bg-input);
    }
    .panel-header h6 {
        margin: 0;
        display: flex;
        align-items: center;
        color: var(--text-primary);
    }
    .panel-header .toggle-icon {
        transition: transform 0.3s;
        color: var(--text-secondary);
    }
    .panel-header.collapsed .toggle-icon {
        transform: rotate(-90deg);
    }
    .panel-body {
        padding: 15px;
        display: none;
        background: var(--bg-card);
        color: var(--text-primary);
    }
    .panel-body.show {
        display: block;
    }

    /* ============================================ */
    /* EVENT FEED STYLES */
    /* ============================================ */
    .event-feed {
        max-height: 250px;
        overflow-y: auto;
        font-size: 11px;
    }
    .event-item {
        padding: 6px 10px;
        border-left: 3px solid transparent;
        margin-bottom: 4px;
        background: var(--bg-input);
        border-radius: 0 5px 5px 0;
        animation: fadeInSlide 0.3s ease-out;
    }
    @keyframes fadeInSlide {
        from { opacity: 0; transform: translateX(-10px); }
        to { opacity: 1; transform: translateX(0); }
    }
    .event-prediction { border-left-color: #00ff88; }
    .event-observation { border-left-color: #00aaff; }
    .event-heartbeat { border-left-color: #ff6b6b; }
    .event-consensus { border-left-color: #ffd700; }
    .event-pool { border-left-color: #aa44ff; }
    .event-delegation { border-left-color: #00d4aa; }
    .event-system { border-left-color: var(--accent-primary); }
    .event-time {
        color: var(--text-muted);
        font-size: 10px;
    }

    /* ============================================ */
    /* STREAM VISUALIZATION */
    /* ============================================ */
    .stream-lane-label {
        font-size: 10px;
        fill: rgba(255,255,255,0.6);
    }

    /* ============================================ */
    /* LIVE INDICATOR */
    /* ============================================ */
    .live-indicator {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        margin-right: 6px;
        animation: livePulse 2s ease-in-out infinite;
    }
    .live-indicator.connected { background: #00ff88; }
    .live-indicator.disconnected { background: #ff6b6b; animation: none; }

    /* ============================================ */
    /* WEBSOCKET STATUS */
    /* ============================================ */
    .ws-status {
        position: absolute;
        top: 10px;
        right: 10px;
        background: rgba(0,0,0,0.7);
        padding: 5px 10px;
        border-radius: 15px;
        font-size: 10px;
        color: white;
        z-index: 100;
    }
    .ws-status.connected { border: 1px solid #00ff88; }
    .ws-status.disconnected { border: 1px solid #ff6b6b; }

    /* ============================================ */
    /* TIMELINE STYLES */
    /* ============================================ */
    .timeline {
        position: relative;
        padding-left: 0;
        list-style: none;
    }
    .timeline-block {
        position: relative;
        padding-left: 50px;
        margin-bottom: 1.25rem;
    }
    .timeline-step {
        position: absolute;
        left: 0;
        width: 32px;
        height: 32px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 14px;
        color: white;
    }
    .timeline-block:not(:last-child)::before {
        content: '';
        position: absolute;
        left: 15px;
        top: 32px;
        width: 2px;
        height: calc(100% + 4px);
        background: var(--border-color);
    }
    .timeline-content {
        padding-top: 2px;
    }

    /* Gradient backgrounds */
    .bg-gradient-primary { background: var(--accent-gradient); }
    .bg-gradient-success { background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); }
    .bg-gradient-info { background: linear-gradient(135deg, #06b6d4 0%, #0891b2 100%); }
    .bg-gradient-warning { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); }
    .bg-gradient-danger { background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); }
    .bg-gradient-secondary { background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); }

    /* Badge adjustments */
    .badge-sm {
        font-size: 0.65rem;
        padding: 0.25em 0.5em;
    }

    /* Icon shape */
    .icon-shape {
        width: 48px;
        height: 48px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Mode modal */
    .mode-modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
    }
    .mode-modal-content {
        margin: 10% auto;
        padding: 1.5rem;
        width: 450px;
        max-width: 90%;
    }
    .mode-option {
        padding: 1rem;
        border: 1px solid var(--border-color);
        border-radius: 8px;
        margin-bottom: 0.75rem;
        cursor: pointer;
        transition: all 0.2s;
    }
    .mode-option:hover {
        border-color: var(--accent-primary);
        background: var(--bg-input);
    }
    .mode-option.recommended {
        border-color: var(--accent-primary);
    }

    /* Form controls */
    .form-switch .form-check-input {
        width: 2.5em;
        height: 1.25em;
    }

    /* ============================================ */
    /* PING/IDENTIFY TOOL STYLES */
    /* ============================================ */
    .ping-result {
        padding: 8px 12px;
        border-radius: 6px;
        margin-top: 8px;
        font-size: 11px;
    }
    .ping-result.success {
        background: rgba(0, 255, 136, 0.1);
        border: 1px solid rgba(0, 255, 136, 0.3);
        color: #00ff88;
    }
    .ping-result.error {
        background: rgba(255, 107, 107, 0.1);
        border: 1px solid rgba(255, 107, 107, 0.3);
        color: #ff6b6b;
    }
    .ping-result.pending {
        background: rgba(255, 170, 0, 0.1);
        border: 1px solid rgba(255, 170, 0, 0.3);
        color: #ffaa00;
    }
    .identity-card {
        background: linear-gradient(135deg, rgba(90, 90, 255, 0.1) 0%, rgba(58, 58, 204, 0.1) 100%);
        border: 1px solid rgba(90, 90, 255, 0.3);
        border-radius: 10px;
        padding: 12px;
    }
    .identity-item {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border-bottom: 1px solid var(--border-color);
    }
    .identity-item:last-child {
        border-bottom: none;
    }
    .identity-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
    }
    .identity-value {
        font-size: 11px;
        font-family: monospace;
        color: var(--text-primary);
        word-break: break-all;
        text-align: right;
        max-width: 180px;
    }
    .identity-value-wrapper {
        display: flex;
        align-items: center;
        gap: 4px;
    }
    .identity-value.truncated {
        cursor: pointer;
    }
    .copy-btn {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    .copy-btn:hover {
        opacity: 1;
        color: var(--primary);
    }
    .copy-btn.copied {
        color: var(--success);
        opacity: 1;
    }
    .peer-table {
        font-size: 11px;
        color: var(--text-primary);
    }
    .peer-table th {
        font-size: 10px;
        text-transform: uppercase;
        color: var(--text-muted);
        font-weight: 600;
        padding: 6px 8px;
        border-bottom: 1px solid var(--border-color);
        background: var(--bg-card-header);
    }
    .peer-table td {
        padding: 8px;
        border-bottom: 1px solid var(--border-color);
        vertical-align: middle;
        color: var(--text-primary);
        background: var(--bg-card);
    }
    .peer-table tr {
        background: var(--bg-card);
    }
    .peer-table tr:hover {
        background: var(--bg-input);
    }
    .peer-table tbody tr {
        background: var(--bg-card);
    }
    .peer-role-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 9px;
        text-transform: uppercase;
        font-weight: 600;
    }
    .peer-role-node { background: rgba(128, 128, 128, 0.2); color: #888; }
    .peer-role-oracle { background: rgba(0, 170, 255, 0.2); color: #00aaff; }
    .peer-role-signer { background: rgba(255, 215, 0, 0.2); color: #ffd700; }
    .peer-role-pool-operator { background: rgba(170, 68, 255, 0.2); color: #aa44ff; }
    .peer-role-predictor { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
    .peer-role-relay { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .peer-role-delegate { background: rgba(0, 212, 170, 0.2); color: #00d4aa; }
    .peer-role-charity { background: rgba(255, 204, 0, 0.2); color: #ffcc00; }
    .peer-role-unknown { background: rgba(128, 128, 128, 0.2); color: #888; }
    .rtt-badge {
        padding: 2px 6px;
        border-radius: 4px;
        font-size: 10px;
    }
    .rtt-good { background: rgba(0, 255, 136, 0.2); color: #00ff88; }
    .rtt-medium { background: rgba(255, 170, 0, 0.2); color: #ffaa00; }
    .rtt-poor { background: rgba(255, 107, 107, 0.2); color: #ff6b6b; }
    .btn-ping {
        padding: 2px 8px;
        font-size: 10px;
    }
    .protocol-tag {
        display: inline-block;
        padding: 2px 6px;
        margin: 1px;
        border-radius: 3px;
        font-size: 9px;
        background: var(--bg-input);
        color: var(--text-muted);
    }
    /* Multiaddr and Evrmore cells - tight fit */
    .multiaddr-cell {
        font-size: 9px;
        font-family: monospace;
        word-break: break-all;
        white-space: normal;
        line-height: 1.3;
        max-width: 280px;
        display: inline-block;
    }
    .evrmore-cell {
        font-size: 9px;
        font-family: monospace;
        word-break: break-all;
        white-space: nowrap;
    }
    /* Pending identify and cached data indicators */
    .pending-identify {
        color: var(--text-muted);
        font-size: 10px;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .pending-identify .spinning {
        animation: spin 1s linear infinite;
    }
    @keyframes spin {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }
    .cached-badge {
        color: var(--warning);
        margin-left: 4px;
        opacity: 0.7;
    }
    .pending-row {
        opacity: 0.85;
    }
    .cached-row {
        border-left: 2px solid var(--warning);
    }
    /* Protocols dropdown */
    .protocols-dropdown {
        position: relative;
        display: inline-block;
    }
    .protocol-trigger {
        cursor: pointer;
        user-select: none;
    }
    .protocol-trigger:hover {
        background: var(--bg-input-focus);
    }
    .protocols-dropdown-content {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        z-index: 1000;
        min-width: 180px;
        max-height: 200px;
        overflow-y: auto;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        padding: 4px 0;
    }
    .protocols-dropdown-content.show {
        display: block;
    }
    .protocol-item {
        padding: 6px 10px;
        font-size: 10px;
        cursor: default;
        position: relative;
    }
    .protocol-item:hover {
        background: var(--bg-input-focus);
    }
    .protocol-item .protocol-name {
        font-weight: 600;
        color: var(--text-primary);
    }
    .protocol-item .protocol-desc {
        font-size: 9px;
        color: var(--text-muted);
        margin-top: 2px;
        display: block;
        font-family: monospace;
        color: var(--text-secondary);
        white-space: nowrap;
    }
    .protocol-item:hover {
        background: var(--bg-input);
        color: var(--text-primary);
    }
    /* Bootstrap dropdown dark mode styling */
    .dropdown-menu {
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        box-shadow: 0 4px 12px rgba(0,0,0,0.4);
    }
    .dropdown-menu .dropdown-item {
        color: var(--text-secondary);
        font-size: 12px;
    }
    .dropdown-menu .dropdown-item:hover,
    .dropdown-menu .dropdown-item:focus {
        background: var(--bg-input);
        color: var(--text-primary);
    }
    .dropdown-menu .dropdown-header {
        color: var(--text-muted);
        font-size: 10px;
        padding: 4px 12px;
    }
    .dropdown-menu .dropdown-item i {
        color: var(--text-muted);
    }
    .dropdown-menu .dropdown-item:hover i {
        color: var(--text-primary);
    }

    /* Peer Stats Card (Network Map popup) */
    .peer-stats-card {
        position: absolute;
        z-index: 1001;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 8px;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
        padding: 12px 16px;
        min-width: 320px;
        max-width: 420px;
        display: none;
    }
    .peer-stats-card.show {
        display: block;
    }
    .peer-stats-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 12px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    .peer-stats-card-title {
        font-size: 12px;
        font-weight: 600;
        color: var(--text-primary);
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .peer-stats-card-close {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 2px;
        font-size: 18px;
        line-height: 1;
    }
    .peer-stats-card-close:hover {
        color: var(--text-primary);
    }
    .peer-stats-row {
        display: flex;
        margin-bottom: 8px;
    }
    .peer-stats-label {
        font-size: 10px;
        color: var(--text-muted);
        text-transform: uppercase;
        min-width: 100px;
        flex-shrink: 0;
    }
    .peer-stats-value {
        font-size: 11px;
        font-family: monospace;
        color: var(--text-primary);
        word-break: break-all;
        flex: 1;
    }
    .peer-stats-value.multiaddr {
        font-size: 10px;
        line-height: 1.4;
    }
    .peer-stats-actions {
        margin-top: 12px;
        padding-top: 8px;
        border-top: 1px solid var(--border-color);
        display: flex;
        gap: 8px;
    }

    /* Node hover tooltip */
    .node-tooltip {
        position: absolute;
        z-index: 1002;
        background: var(--bg-card);
        border: 1px solid var(--border-color);
        border-radius: 6px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        padding: 8px 12px;
        pointer-events: none;
        display: none;
        max-width: 380px;
    }
    .node-tooltip.show {
        display: block;
    }
    .node-tooltip-row {
        display: flex;
        align-items: center;
        gap: 8px;
        margin-bottom: 4px;
    }
    .node-tooltip-row:last-child {
        margin-bottom: 0;
    }
    .node-tooltip-label {
        font-size: 9px;
        color: var(--text-muted);
        text-transform: uppercase;
        min-width: 50px;
    }
    .node-tooltip-value {
        font-size: 10px;
        color: var(--text-primary);
        font-family: monospace;
        word-break: break-all;
    }

    /* ============================================ */
    /* HORIZONTAL IDENTITY CARD STYLES */
    /* ============================================ */
    .identity-item-horizontal {
        display: flex;
        flex-direction: column;
        gap: 2px;
    }
    .identity-label-sm {
        font-size: 9px;
        color: var(--text-muted);
        text-transform: uppercase;
        white-space: nowrap;
    }
    .identity-value-sm {
        font-size: 11px;
        font-family: monospace;
        color: var(--accent-primary);
        background: var(--bg-input);
        padding: 2px 6px;
        border-radius: 4px;
        white-space: nowrap;
    }
    .identity-value-sm.multiaddr-full {
        white-space: normal;
        word-break: break-all;
        max-width: 100%;
    }
    .copy-btn-sm {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 1px;
        opacity: 0.6;
        transition: opacity 0.2s;
    }
    .copy-btn-sm:hover {
        opacity: 1;
        color: var(--primary);
    }
    .copy-btn-sm.copied {
        color: var(--success);
        opacity: 1;
    }
    .copy-btn-xs {
        background: none;
        border: none;
        color: var(--text-muted);
        cursor: pointer;
        padding: 0;
        opacity: 0.5;
        transition: opacity 0.2s;
        vertical-align: middle;
    }
    .copy-btn-xs:hover {
        opacity: 1;
        color: var(--primary);
    }
    .copy-btn-xs.copied {
        color: var(--success);
        opacity: 1;
    }
    .protocol-tag-sm {
        display: inline-block;
        padding: 1px 4px;
        margin: 1px;
        border-radius: 3px;
        font-size: 8px;
        background: var(--bg-input);
        color: var(--text-muted);
    }

    /* Title badges */
    .title-badge {
        display: inline-block;
        padding: 2px 6px;
        margin: 1px;
        border-radius: 4px;
        font-size: 9px;
        font-weight: 600;
        text-transform: uppercase;
    }
    .title-badge.historic {
        background: linear-gradient(135deg, #9966ff 0%, #6633cc 100%);
        color: white;
    }
    .title-badge.friendly {
        background: linear-gradient(135deg, #00aaff 0%, #0066cc 100%);
        color: white;
    }
    .title-badge.charity {
        background: linear-gradient(135deg, #ff6b6b 0%, #cc3333 100%);
        color: white;
    }
    .title-badge.whale {
        background: linear-gradient(135deg, #00ff88 0%, #00aa55 100%);
        color: white;
    }
    .title-badge.legend {
        background: linear-gradient(135deg, #ffd700 0%, #ffaa00 100%);
        color: #333;
        box-shadow: 0 0 8px rgba(255, 215, 0, 0.5);
    }
</style>
{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg px-4">
    <span class="navbar-brand">
        Satori
        <small class="text-muted ms-2" style="font-size: 0.65rem; font-weight: 400; opacity: 0.6;">{{ version }}</small>
    </span>
    <div class="ms-auto d-flex align-items-center">
        <!-- Connected Status -->
        <span class="me-3">
            <span class="status-indicator status-online" id="statusIndicator"></span>
            <span id="statusText">Connected</span>
        </span>
        <!-- Navigation Links -->
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-sm me-2" title="Dashboard">
            <i class="material-icons align-middle" style="font-size: 16px;">dashboard</i>
            Dashboard
        </a>
        <a href="{{ url_for('network') }}" class="btn btn-outline-light btn-sm me-2 active" title="P2P Network">
            <i class="material-icons align-middle" style="font-size: 16px;">hub</i>
            Network
        </a>
        <a href="{{ url_for('oracle_page') }}" class="btn btn-outline-light btn-sm me-2" title="Oracle - Publish Data Streams">
            <i class="material-icons align-middle" style="font-size: 16px;">cloud_upload</i>
            Oracle
        </a>
        <a href="{{ url_for('predictions_page') }}" class="btn btn-outline-light btn-sm me-2" title="Predictions">
            <i class="material-icons align-middle" style="font-size: 16px;">trending_up</i>
            Predictions
        </a>
        <a href="{{ url_for('governance') }}" class="btn btn-outline-light btn-sm me-2" title="Governance">
            <i class="material-icons align-middle" style="font-size: 16px;">how_to_vote</i>
            Governance
        </a>
        {% if is_signer %}
        <a href="{{ url_for('signer_dashboard') }}" class="btn btn-outline-light btn-sm me-2" title="Signer">
            <i class="material-icons align-middle" style="font-size: 16px;">key</i>
            Signer
        </a>
        {% endif %}
        <a href="{{ url_for('stake_management') }}" class="btn btn-outline-light btn-sm me-2" title="Stake Management">
            <i class="material-icons align-middle" style="font-size: 16px;">handshake</i>
            Stake
        </a>
        <a href="{{ url_for('badges_page') }}" class="btn btn-outline-light btn-sm me-2" title="Badges & Achievements">
            <i class="material-icons align-middle" style="font-size: 16px;">military_tech</i>
            Badges
        </a>
        <a href="{{ url_for('donate') }}" class="btn btn-outline-light btn-sm me-2" title="Donate to Treasury">
            <i class="material-icons align-middle" style="font-size: 16px;">volunteer_activism</i>
            Donate
        </a>
        <a href="{{ url_for('guide') }}" class="btn btn-outline-light btn-sm me-2" title="Rewards Guide">
            <i class="material-icons align-middle" style="font-size: 16px;">menu_book</i>
            Guide
        </a>
        <a href="{{ url_for('restart_neuron') }}" class="btn btn-outline-light btn-sm me-2" title="Restart Node" onclick="return confirm('Restart your Satori node?');">
            <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm me-2">Logout</a>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <i class="material-icons" id="themeIcon">light_mode</i>
        </button>
    </div>
</nav>

<!-- Include D3.js, Chart.js, and Socket.IO -->
<script src="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>

<div class="container-fluid py-4">
    <!-- Header -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h4 class="mb-0">
                        <span id="wsIndicator" class="live-indicator connected"></span>
                        P2P Network Dashboard
                    </h4>
                    <p class="text-muted small mb-0">Real-time network visualization with live updates</p>
                </div>
                <div>
                    <button onclick="refreshAllData();" class="btn btn-outline-secondary btn-sm me-2">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i> Refresh
                    </button>
                    <button onclick="toggleFullscreen();" class="btn btn-outline-secondary btn-sm">
                        <i class="material-icons align-middle" style="font-size: 16px;">fullscreen</i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Stats Row -->
    <div class="row g-3 mb-4">
        <div class="col-xl-2 col-sm-4 col-6">
            <div class="card metric-card h-100">
                <div class="card-body p-3 text-center">
                    <p class="text-muted small mb-1 text-uppercase">Connected</p>
                    <h4 id="connectedPeerCount" class="stats-number mb-0" style="color: #00ff88;">0</h4>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-sm-4 col-6">
            <div class="card metric-card h-100">
                <div class="card-body p-3 text-center">
                    <p class="text-muted small mb-1 text-uppercase">Known</p>
                    <h4 id="totalPeers" class="stats-number mb-0">0</h4>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-sm-4 col-6">
            <div class="card metric-card h-100">
                <div class="card-body p-3 text-center">
                    <p class="text-muted small mb-1 text-uppercase">Mesh Peers</p>
                    <h4 id="meshPeerCount" class="mb-0" style="font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #00aaff 0%, #0066cc 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">0</h4>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-sm-4 col-6">
            <div class="card metric-card h-100">
                <div class="card-body p-3 text-center">
                    <p class="text-muted small mb-1 text-uppercase">Uptime</p>
                    <h4 id="topUptimePercent" class="mb-0" style="font-size: 2rem; font-weight: 700; background: linear-gradient(135deg, #ffd700 0%, #ff8c00 100%); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">--%</h4>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-sm-4 col-6">
            <div class="card metric-card h-100">
                <div class="card-body p-3 text-center">
                    <p class="text-muted small mb-1 text-uppercase">Latency</p>
                    <h4 id="avgLatency" class="stats-number mb-0">--</h4>
                </div>
            </div>
        </div>
        <div class="col-xl-2 col-sm-4 col-6">
            <div class="card metric-card h-100">
                <div class="card-body p-3 text-center">
                    <p class="text-muted small mb-1 text-uppercase">Mode</p>
                    <h6 id="networkMode" class="mb-0"><span class="badge bg-gradient-info">Central</span></h6>
                </div>
            </div>
        </div>
    </div>

    <!-- Protocol Status Row -->
    <div class="row g-3 mb-4">
        <!-- Protocol Version -->
        <div class="col-xl-4 col-md-6 col-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <h6 class="mb-0">
                        <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #5a5aff;">verified</i>
                        Protocol Version
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Current</p>
                            <h5 id="protocolVersion" class="mb-0" style="color: #5a5aff;">v1.0.0</h5>
                        </div>
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Compatible Peers</p>
                            <h5 id="compatiblePeers" class="mb-0" style="color: #00ff88;">0%</h5>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">Features:</span>
                        <span id="featureCount" class="text-info" style="cursor: pointer;" onclick="toggleFeatureList()" title="Click to see all features">0 enabled â–¼</span>
                    </div>
                    <div id="featureList" style="display: none; max-height: 120px; overflow-y: auto; margin-top: 8px; font-size: 10px;">
                        <!-- Feature list populated by JavaScript -->
                    </div>
                    <div class="progress mt-2" style="height: 6px;">
                        <div id="upgradeProgress" class="progress-bar bg-gradient-success" role="progressbar" style="width: 100%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Storage Redundancy -->
        <div class="col-xl-4 col-md-6 col-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00d4aa;">storage</i>
                            Storage Redundancy
                        </h6>
                        <button onclick="fetchStorageStatus();" class="btn btn-outline-info btn-sm" title="Refresh storage status">
                            <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Disk Usage</p>
                            <h5 id="diskUsage" class="mb-0" style="color: #00d4aa;">0 MB</h5>
                        </div>
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Status</p>
                            <span id="storageStatus" class="badge bg-gradient-secondary">Inactive</span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <!-- Memory Backend (always on - required for read/write path) -->
                    <div class="d-flex justify-content-between align-items-center small mb-2">
                        <span title="In-memory cache - required for read/write operations">
                            <i class="material-icons" style="font-size: 14px;">memory</i> Memory
                        </span>
                        <div class="d-flex align-items-center gap-2">
                            <span id="memoryBackendItems" class="text-success" style="font-size: 10px;">active</span>
                            <i class="material-icons text-success" style="font-size: 14px;" title="Always on - required">lock</i>
                        </div>
                    </div>
                    <!-- File Backend (always on - core persistence layer) -->
                    <div class="d-flex justify-content-between align-items-center small mb-2">
                        <span title="Persistent local file storage (~/.satori/) - survives restarts">
                            <i class="material-icons" style="font-size: 14px;">folder</i> File
                        </span>
                        <div class="d-flex align-items-center gap-2">
                            <span id="fileBackendItems" class="text-success" style="font-size: 10px;">active</span>
                            <i class="material-icons text-success" style="font-size: 14px;" title="Always on - core persistence">lock</i>
                        </div>
                    </div>
                    <!-- DHT Backend -->
                    <div class="d-flex justify-content-between align-items-center small">
                        <span title="Distributed storage across network peers">
                            <i class="material-icons" style="font-size: 14px;">cloud</i> DHT
                        </span>
                        <div class="d-flex align-items-center gap-2">
                            <span id="dhtBackendItems" class="text-muted" style="font-size: 10px;">0 items</span>
                            <div class="form-check form-switch mb-0">
                                <input class="form-check-input" type="checkbox" id="dhtBackendToggle"
                                       onchange="toggleStorageBackend('dht', this.checked)">
                            </div>
                        </div>
                    </div>
                    <!-- Storage details -->
                    <hr class="my-2">
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Deferred Rewards:</span>
                        <span id="deferredRewardsCount">0</span>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Stored Alerts:</span>
                        <span id="storedAlertsCount">0</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bandwidth & QoS -->
        <div class="col-xl-4 col-md-12 col-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <h6 class="mb-0">
                        <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ff6b6b;">speed</i>
                        Bandwidth & QoS
                    </h6>
                </div>
                <div class="card-body p-3">
                    <div class="row">
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Sent</p>
                            <h6 id="bytesSent" class="mb-0" style="color: #ff6b6b;">0 KB</h6>
                        </div>
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Received</p>
                            <h6 id="bytesReceived" class="mb-0" style="color: #00aaff;">0 KB</h6>
                        </div>
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">QoS</p>
                            <span id="qosStatus" class="badge bg-gradient-info">Off</span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="text-muted">Messages/sec:</span>
                        <span id="messagesPerSec">0</span>
                    </div>
                    <div class="d-flex justify-content-between small mb-1">
                        <span class="text-muted">Rate Limited:</span>
                        <span id="dropsRateLimited" class="text-warning">0</span>
                    </div>
                    <div class="d-flex justify-content-between small">
                        <span class="text-muted">Low Priority Drops:</span>
                        <span id="dropsLowPriority" class="text-danger">0</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Curator & Archiver Row (Observer View) -->
    <div class="row g-4 mb-4">
        <!-- Curator Status -->
        <div class="col-xl-6 col-md-12 col-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #9966ff;">verified_user</i>
                            Curator Network
                        </h6>
                        <span class="badge bg-info">Data Quality</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row mb-3">
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Curated Streams</p>
                            <h5 id="curatedStreams" class="mb-0" style="color: #9966ff;">0</h5>
                        </div>
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Tracked Oracles</p>
                            <h5 id="trackedOracles" class="mb-0" style="color: #00aaff;">0</h5>
                        </div>
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Open Flags</p>
                            <h5 id="unresolvedFlags" class="mb-0 text-warning">0</h5>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Average Quality Score</p>
                            <h6 id="avgQualityScore" class="mb-0 text-success">--</h6>
                        </div>
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Active Curators</p>
                            <h6 id="activeCurators" class="mb-0" style="color: #ffd700;">5</h6>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="material-icons align-middle" style="font-size: 12px;">info</i>
                            Curators (signers) ensure oracle data quality across the network
                        </small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Archiver Status -->
        <div class="col-xl-6 col-md-12 col-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00ff88;">archive</i>
                            Archive Network
                        </h6>
                        <span class="badge bg-success">Historical Data</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row mb-3">
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Archived Rounds</p>
                            <h5 id="localArchives" class="mb-0" style="color: #00ff88;">0</h5>
                        </div>
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Total Size</p>
                            <h5 id="archiveSize" class="mb-0" style="color: #00aaff;">0 MB</h5>
                        </div>
                        <div class="col-4 text-center">
                            <p class="text-muted small mb-1">Archivers Online</p>
                            <h5 id="networkArchivers" class="mb-0" style="color: #ffd700;">0</h5>
                        </div>
                    </div>
                    <div class="row mb-2">
                        <div class="col-6 text-center">
                            <p id="archiveIntegrityLabel" class="text-muted small mb-1">Network Integrity</p>
                            <h6 id="archiveIntegrity" class="mb-0 text-muted">--</h6>
                        </div>
                        <div class="col-6 text-center">
                            <p class="text-muted small mb-1">Redundancy</p>
                            <h6 id="archiveRedundancy" class="mb-0" style="color: #00aaff;">3x</h6>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small class="text-muted">
                            <i class="material-icons align-middle" style="font-size: 12px;">info</i>
                            Archivers (signers) preserve historical prediction and reward data
                        </small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Governance Row -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card metric-card">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ffd700;">how_to_vote</i>
                            Governance
                        </h6>
                        <div class="d-flex flex-column align-items-end">
                            <div>
                                <span id="governanceBadge" class="badge bg-secondary me-2">Loading...</span>
                                <button onclick="showCreateProposal();" id="proposeBtn" class="btn btn-outline-primary btn-sm" style="display: none;">
                                    <i class="material-icons align-middle" style="font-size: 14px;">add</i> Propose
                                </button>
                            </div>
                            <small id="governanceHint" class="text-muted mt-1" style="font-size: 11px; display: none;">
                                <i class="material-icons align-middle" style="font-size: 12px;">info</i>
                                Stake SATORI to become a voter
                            </small>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row mb-3">
                        <div class="col-md-2 col-4 text-center">
                            <p class="text-muted small mb-1">Active</p>
                            <h5 id="activeProposals" class="mb-0" style="color: #ffd700;">0</h5>
                        </div>
                        <div class="col-md-2 col-4 text-center">
                            <p class="text-muted small mb-1">Passed</p>
                            <h5 id="passedProposals" class="mb-0 text-success">0</h5>
                        </div>
                        <div class="col-md-2 col-4 text-center">
                            <p class="text-muted small mb-1">Rejected</p>
                            <h5 id="rejectedProposals" class="mb-0 text-danger">0</h5>
                        </div>
                        <div class="col-md-3 col-6 text-center">
                            <p class="text-muted small mb-1">My Stake</p>
                            <h6 id="myStake" class="mb-0">0 SATORI</h6>
                        </div>
                        <div class="col-md-3 col-6 text-center">
                            <p class="text-muted small mb-1">Voting Power</p>
                            <h6 id="myVotingPower" class="mb-0" style="color: #00aaff;">0</h6>
                        </div>
                    </div>

                    <!-- Active Proposals List -->
                    <div id="activeProposalsList">
                        <h6 class="text-muted small mb-2">Active Proposals</h6>
                        <div id="proposalsContainer" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-center text-muted small py-3">No active proposals</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Protocol Status Row -->
    <div class="row g-4 mb-4">
        <!-- Predictions Protocol -->
        <div class="col-lg-4 col-md-6">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00aaff;">insights</i>
                            Predictions
                        </h6>
                        <a href="{{ url_for('predictions_page') }}" class="btn btn-outline-primary btn-sm">
                            Open <i class="material-icons align-middle" style="font-size: 14px;">open_in_new</i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 id="protocolPredMy" class="mb-0 text-primary">--</h4>
                            <small class="text-muted">My Predictions</small>
                        </div>
                        <div class="col-4">
                            <h4 id="protocolPredCached" class="mb-0 text-success">--</h4>
                            <small class="text-muted">Cached</small>
                        </div>
                        <div class="col-4">
                            <h4 id="protocolPredScore" class="mb-0 text-warning">--</h4>
                            <small class="text-muted">Avg Score</small>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="protocolPredStatus" class="text-muted">Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Oracles Protocol -->
        <div class="col-lg-4 col-md-6">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00ff88;">visibility</i>
                            Oracles
                        </h6>
                        <a href="{{ url_for('oracle_page') }}" class="btn btn-outline-success btn-sm">
                            Open <i class="material-icons align-middle" style="font-size: 14px;">open_in_new</i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 id="protocolOracleReg" class="mb-0 text-success">--</h4>
                            <small class="text-muted">My Oracle Streams</small>
                        </div>
                        <div class="col-4">
                            <h4 id="protocolOracleKnown" class="mb-0 text-info">--</h4>
                            <small class="text-muted">Known Oracles</small>
                        </div>
                        <div class="col-4">
                            <h4 id="protocolOracleObs" class="mb-0 text-warning">--</h4>
                            <small class="text-muted">Observations</small>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="protocolOracleStatus" class="text-muted">Loading...</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Streams Protocol -->
        <div class="col-lg-4 col-md-6">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ffd700;">hub</i>
                            Streams
                        </h6>
                        <a href="{{ url_for('oracle_page') }}" class="btn btn-outline-warning btn-sm">
                            Open <i class="material-icons align-middle" style="font-size: 14px;">open_in_new</i>
                        </a>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="row text-center">
                        <div class="col-4">
                            <h4 id="protocolStreamMy" class="mb-0 text-success">--</h4>
                            <small class="text-muted">My Claims</small>
                        </div>
                        <div class="col-4">
                            <h4 id="protocolStreamKnown" class="mb-0 text-info">--</h4>
                            <small class="text-muted">Known</small>
                        </div>
                        <div class="col-4">
                            <h4 id="protocolStreamTotal" class="mb-0 text-warning">--</h4>
                            <small class="text-muted">Total Claims</small>
                        </div>
                    </div>
                    <div class="text-center mt-2">
                        <small id="protocolStreamStatus" class="text-muted">Loading...</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consensus Round Row -->
    <div class="row g-4 mb-4">
        <!-- Current Consensus Round -->
        <div class="col-lg-5">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00ff88;">sync</i>
                            Consensus Round
                        </h6>
                        <div>
                            <span id="consensusRoundBadge" class="badge bg-secondary me-2">Round #--</span>
                            <button onclick="refreshConsensusStatus();" class="btn btn-outline-success btn-sm" title="Refresh">
                                <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <!-- Round Progress -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small">Round Progress</span>
                            <span id="consensusPhase" class="badge bg-info">--</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="consensusProgressBar" class="progress-bar bg-success progress-bar-striped progress-bar-animated"
                                 role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                        </div>
                        <div class="d-flex justify-content-between mt-1">
                            <small class="text-muted">Started: <span id="consensusStartTime">--</span></small>
                            <small class="text-muted">Ends: <span id="consensusEndTime">--</span></small>
                        </div>
                    </div>

                    <!-- Round Stats -->
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <h5 id="consensusValidators" class="mb-0 text-success">--</h5>
                            <small class="text-muted">Validators</small>
                        </div>
                        <div class="col-3">
                            <h5 id="consensusVotes" class="mb-0 text-primary">--</h5>
                            <small class="text-muted">Votes</small>
                        </div>
                        <div class="col-3">
                            <h5 id="consensusStreams" class="mb-0 text-warning">--</h5>
                            <small class="text-muted">Streams</small>
                        </div>
                        <div class="col-3">
                            <h5 id="consensusQuorum" class="mb-0 text-info">--</h5>
                            <small class="text-muted">Quorum</small>
                        </div>
                    </div>

                    <!-- My Participation -->
                    <div class="border-top pt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">
                                <i class="material-icons align-middle" style="font-size: 14px;">person</i>
                                My Participation
                            </span>
                            <span id="consensusMyStatus" class="badge bg-secondary">Not Participating</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mt-1">
                            <small class="text-muted">My Votes Submitted</small>
                            <small id="consensusMyVotes" class="fw-bold">0</small>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Streams Scored</small>
                            <small id="consensusMyStreams" class="fw-bold">0</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Distribution Status (Read-Only) -->
        <div class="col-lg-3">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ffd700;">payments</i>
                            Distributions
                        </h6>
                        <button onclick="refreshDistributionStatus();" class="btn btn-outline-warning btn-sm" title="Refresh">
                            <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <!-- Last Distribution -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small">Last Distribution</span>
                            <span id="distLastTime" class="small">--</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Amount</span>
                            <span id="distLastAmount" class="fw-bold text-warning">-- SATORI</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Recipients</span>
                            <span id="distLastRecipients" class="small">--</span>
                        </div>
                    </div>

                    <!-- Pending Distribution -->
                    <div class="border-top pt-2">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small">Pending</span>
                            <span id="distPendingStatus" class="badge bg-secondary">None</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Pool Amount</span>
                            <span id="distPendingAmount" class="fw-bold text-info">-- SATORI</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Eligible Predictors</span>
                            <span id="distEligibleCount" class="small">--</span>
                        </div>
                    </div>

                    <!-- My Pending Rewards -->
                    <div class="border-top pt-2 mt-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">
                                <i class="material-icons align-middle" style="font-size: 14px;">person</i>
                                My Pending
                            </span>
                            <span id="distMyPending" class="fw-bold text-success">-- SATORI</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Recent Rounds History -->
        <div class="col-lg-4">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ffd700;">history</i>
                            Recent Rounds
                        </h6>
                        <span id="consensusCompletedCount" class="badge bg-success">0 completed</span>
                    </div>
                </div>
                <div class="card-body p-2">
                    <div id="consensusHistoryList" class="list-group list-group-flush" style="max-height: 240px; overflow-y: auto;">
                        <div class="text-center text-muted small py-3">Loading round history...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Transparency Row -->
    <div class="row g-4 mb-4">
        <!-- Voting Power Breakdown -->
        <div class="col-lg-4 col-md-6">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00aaff;">calculate</i>
                            Voting Power Breakdown
                        </h6>
                        <button onclick="refreshVotingPower();" class="btn btn-outline-info btn-sm" title="Refresh">
                            <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Base Stake</span>
                            <span id="vpBaseStake" class="fw-bold">0 SATORI</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Stake Weight (1.0x)</span>
                            <span id="vpStakeWeight" class="text-info">+0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">
                                <i class="material-icons align-middle" style="font-size: 12px;">schedule</i>
                                Uptime Bonus (90+ days = +10%)
                            </span>
                            <span id="vpUptimeBonus" class="text-warning">+0%</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">
                                <i class="material-icons align-middle" style="font-size: 12px;">verified</i>
                                Signer Bonus (+25%)
                            </span>
                            <span id="vpSignerBonus" class="text-success">+0%</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="fw-bold">Total Voting Power</span>
                            <span id="vpTotal" class="fw-bold" style="color: #00aaff; font-size: 1.2em;">0</span>
                        </div>
                    </div>
                    <div class="small text-muted">
                        <div class="d-flex justify-content-between">
                            <span>Network Total</span>
                            <span id="vpNetworkTotal">0</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Your Share</span>
                            <span id="vpShare">0%</span>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span>Active Voters</span>
                            <span id="vpActiveVoters">0</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Uptime Details -->
        <div class="col-lg-4 col-md-6">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ffd700;">timer</i>
                            Uptime Details
                        </h6>
                        <span id="uptimeQualifiedBadge" class="badge bg-secondary">--</span>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Current Streak</span>
                            <span id="uptimeStreak" class="fw-bold" style="color: #ffd700;">0 days</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Heartbeats Sent</span>
                            <span id="uptimeHeartbeatsSent" class="text-info">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Heartbeats Received</span>
                            <span id="uptimeHeartbeatsReceived" class="text-success">0</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Current Round</span>
                            <span id="uptimeCurrentRound" class="small">--</span>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="text-muted small">Relay Threshold</span>
                            <span class="text-warning">95%</span>
                        </div>
                        <div class="d-flex justify-content-between align-items-center">
                            <span class="text-muted small">Bonus Threshold</span>
                            <span style="color: #ffd700;">90 days</span>
                        </div>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div id="uptimeProgressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                    <small class="text-muted d-block mt-1 text-center">
                        <span id="uptimeProgressLabel">0 / 90 days to bonus</span>
                    </small>
                </div>
            </div>
        </div>

        <!-- Network Infrastructure -->
        <div class="col-lg-4 col-md-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00ff88;">dns</i>
                            Network Infrastructure
                        </h6>
                        <button onclick="refreshInfrastructure();" class="btn btn-outline-info btn-sm" title="Refresh">
                            <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div class="mb-2">
                        <span class="text-muted small d-block mb-1">
                            <i class="material-icons align-middle" style="font-size: 12px;">meeting_room</i>
                            Rendezvous Server
                        </span>
                        <div class="d-flex justify-content-between align-items-center">
                            <code id="infraRendezvous" class="small" style="word-break: break-all; font-size: 10px;">--</code>
                            <span id="infraRendezvousLatency" class="badge bg-success ms-2">-- ms</span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="mb-2">
                        <span class="text-muted small d-block mb-1">
                            <i class="material-icons align-middle" style="font-size: 12px;">hub</i>
                            Bootstrap Peers (<span id="infraBootstrapCount">0</span>)
                        </span>
                        <div id="infraBootstrapList" class="small" style="max-height: 80px; overflow-y: auto;">
                            <span class="text-muted">Loading...</span>
                        </div>
                    </div>
                    <hr class="my-2">
                    <div class="row text-center">
                        <div class="col-4">
                            <span class="text-muted small d-block">DHT Nodes</span>
                            <span id="infraDhtNodes" class="fw-bold text-info">0</span>
                        </div>
                        <div class="col-4">
                            <span class="text-muted small d-block">Mesh Peers</span>
                            <span id="infraMeshPeers" class="fw-bold text-success">0</span>
                        </div>
                        <div class="col-4">
                            <span class="text-muted small d-block">Relay Status</span>
                            <span id="infraRelayStatus" class="badge bg-secondary">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Badges & Achievements Row -->
    <div class="row g-4 mb-4">
        <div class="col-lg-6 col-md-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #ffd700;">military_tech</i>
                            Badges & Achievements
                        </h6>
                        <div>
                            <a href="{{ url_for('badges_page') }}" class="btn btn-outline-warning btn-sm me-1" title="View all badges">
                                <i class="material-icons align-middle" style="font-size: 14px;">open_in_new</i>
                            </a>
                            <button onclick="loadMyBadges();" class="btn btn-outline-info btn-sm" title="Refresh">
                                <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body p-3">
                    <!-- Badge Stats Summary -->
                    <div class="row text-center mb-3">
                        <div class="col-3">
                            <h4 id="badgeTotalCount" class="mb-0" style="color: #ffd700;">0</h4>
                            <small class="text-muted">Earned</small>
                        </div>
                        <div class="col-3">
                            <h5 id="badgeHighestRarity" class="mb-0" style="color: #9e9e9e;">--</h5>
                            <small class="text-muted">Rarest</small>
                        </div>
                        <div class="col-3">
                            <h5 id="badgeStreakDays" class="mb-0" style="color: #ffd700;">0</h5>
                            <small class="text-muted">Streak Days</small>
                        </div>
                        <div class="col-3">
                            <h5 id="badgeRank" class="mb-0" style="color: #00ff88;">--</h5>
                            <small class="text-muted">Rank Badges</small>
                        </div>
                    </div>

                    <!-- Progress to Next Badge -->
                    <div class="mb-3">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-muted small">Progress to Next Badge</span>
                            <span id="badgeProgressPct" class="small text-warning">0%</span>
                        </div>
                        <div class="progress" style="height: 8px;">
                            <div id="badgeProgressBar" class="progress-bar bg-warning" role="progressbar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="badgeProgressText">Loading...</small>
                    </div>

                    <!-- Earned Badges Display -->
                    <div class="mb-2">
                        <span class="text-muted small d-block mb-2">Recent Badges</span>
                        <div id="earnedBadgesList" class="d-flex flex-wrap gap-2">
                            <span class="text-muted small">Loading badges...</span>
                        </div>
                    </div>

                    <!-- Badge Categories Summary -->
                    <div id="badgeCategorySummary" style="display: none;">
                        <hr class="my-2">
                        <div class="row text-center small">
                            <div class="col-3">
                                <span id="badgeCatRank" class="fw-bold text-success">0</span>
                                <span class="text-muted d-block">Rank</span>
                            </div>
                            <div class="col-3">
                                <span id="badgeCatStreak" class="fw-bold text-warning">0</span>
                                <span class="text-muted d-block">Streak</span>
                            </div>
                            <div class="col-3">
                                <span id="badgeCatAchieve" class="fw-bold text-info">0</span>
                                <span class="text-muted d-block">Achievement</span>
                            </div>
                            <div class="col-3">
                                <span id="badgeCatCommunity" class="fw-bold text-primary">0</span>
                                <span class="text-muted d-block">Community</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Badge Leaderboard -->
        <div class="col-lg-6 col-md-12">
            <div class="card metric-card h-100">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #00ff88;">leaderboard</i>
                            Badge Leaderboard
                        </h6>
                        <button onclick="loadBadgeLeaderboard();" class="btn btn-outline-success btn-sm" title="Refresh">
                            <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                        </button>
                    </div>
                </div>
                <div class="card-body p-3">
                    <div id="badgeLeaderboardList" class="list-group list-group-flush" style="max-height: 220px; overflow-y: auto;">
                        <div class="text-center text-muted small py-3">Loading badge leaderboard...</div>
                    </div>
                    <div class="text-center mt-2">
                        <a href="{{ url_for('badges_page') }}" class="btn btn-outline-primary btn-sm">
                            <i class="material-icons align-middle" style="font-size: 14px;">emoji_events</i>
                            View Full Badge Catalog
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- My Identity Card (Full Width Horizontal) -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header py-2">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: var(--accent-primary);">fingerprint</i>
                            My Identity
                        </h6>
                        <div>
                            <button onclick="showModeSelector();" class="btn btn-outline-secondary btn-sm me-1" title="Change Mode">
                                <i class="material-icons align-middle" style="font-size: 14px;">settings</i>
                            </button>
                            <button onclick="refreshIdentity();" class="btn btn-outline-info btn-sm me-1" title="Refresh">
                                <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                            </button>
                            <button onclick="requestIdentityNetwork();" class="btn btn-outline-primary btn-sm me-1" title="Request identities from the network">
                                <i class="material-icons align-middle" style="font-size: 14px;">download</i>
                            </button>
                            <button onclick="announceIdentity();" class="btn btn-outline-success btn-sm" title="Broadcast your identity to the network">
                                <i class="material-icons align-middle" style="font-size: 14px;">upload</i>
                            </button>
                        </div>
                    </div>
                </div>
                <div class="card-body py-2">
                    <!-- Row 1: Copyable text-based identity info -->
                    <div class="d-flex flex-wrap align-items-center gap-4 mb-3">
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Peer ID</span>
                            <span class="identity-value-wrapper">
                                <code id="myPeerId" class="identity-value-sm" title="Click to copy">Loading...</code>
                                <span id="myPeerIdFull" style="display: none;"></span>
                                <button class="copy-btn-sm" onclick="copyToClipboard('myPeerIdFull', this)" title="Copy full Peer ID">
                                    <i class="material-icons" style="font-size: 12px;">content_copy</i>
                                </button>
                            </span>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Evrmore Identity</span>
                            <span class="identity-value-wrapper">
                                <code id="myEvrmoreAddress" class="identity-value-sm" title="Click to copy">Loading...</code>
                                <span id="myEvrmoreAddressFull" style="display: none;"></span>
                                <button class="copy-btn-sm" onclick="copyToClipboard('myEvrmoreAddressFull', this)" title="Copy address">
                                    <i class="material-icons" style="font-size: 12px;">content_copy</i>
                                </button>
                            </span>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Public Key <span class="text-muted">(for signer setup)</span></span>
                            <span class="identity-value-wrapper">
                                <code id="myPublicKey" class="identity-value-sm" style="word-break: break-all; font-size: 9px;" title="Click to copy">Loading...</code>
                                <span id="myPublicKeyFull" style="display: none;"></span>
                                <button class="copy-btn-sm" onclick="copyToClipboard('myPublicKeyFull', this)" title="Copy public key">
                                    <i class="material-icons" style="font-size: 12px;">content_copy</i>
                                </button>
                            </span>
                        </div>
                        <div class="identity-item-horizontal flex-grow-1">
                            <span class="identity-label-sm">Multiaddress <span class="text-muted">(share with friends)</span></span>
                            <span class="identity-value-wrapper">
                                <code id="myMultiaddr" class="identity-value-sm multiaddr-full" title="Click to copy">Loading...</code>
                                <span id="myMultiaddrFull" style="display: none;"></span>
                                <button class="copy-btn-sm" onclick="copyToClipboard('myMultiaddrFull', this)" title="Copy multiaddress to share">
                                    <i class="material-icons" style="font-size: 12px;">content_copy</i>
                                </button>
                            </span>
                        </div>
                    </div>
                    <!-- Row 2: Status badges and info -->
                    <div class="d-flex flex-wrap align-items-center gap-4 pt-2" style="border-top: 1px solid var(--border-color);">
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Role</span>
                            <span id="myRole" class="badge bg-gradient-success badge-sm">Predictor</span>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">NAT</span>
                            <span id="myNatStatus" class="badge bg-gradient-warning badge-sm">--</span>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Heartbeat</span>
                            <div class="d-flex align-items-center gap-2">
                                <span id="heartbeatStatus" class="badge bg-gradient-secondary badge-sm">
                                    <span class="heartbeat-pulse" style="display: none;"></span>
                                    <span id="heartbeatStatusText">Inactive</span>
                                </span>
                                <small id="lastHeartbeatTime" class="text-muted" style="font-size: 10px;">--</small>
                            </div>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Predictions</span>
                            <div class="d-flex align-items-center gap-2">
                                <span id="predictionWorkStatus" class="badge bg-gradient-secondary badge-sm">
                                    <span id="activePredictionsCount">0</span> active
                                </span>
                                <span id="consensusStatus" class="badge bg-gradient-secondary badge-sm" title="Consensus rounds participated">
                                    <span id="consensusParticipation">0</span> consensus
                                </span>
                            </div>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Protocols</span>
                            <div class="protocols-dropdown">
                                <span class="protocol-tag protocol-trigger" onclick="toggleProtocolsDropdown('myProtocolsDropdown')">
                                    <span id="myProtocolCount">0</span> protocols <i class="material-icons" style="font-size: 10px; vertical-align: middle;">expand_more</i>
                                </span>
                                <div id="myProtocolsDropdown" class="protocols-dropdown-content">
                                    <!-- Populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="identity-item-horizontal">
                            <span class="identity-label-sm">Titles</span>
                            <div id="myTitles">
                                <span class="text-muted small">None yet</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Heartbeat Status Card -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="mb-0">
                        <i class="material-icons align-middle me-2" style="color: #ff6b6b;">favorite</i>
                        Heartbeat Status
                    </h6>
                    <div class="d-flex align-items-center gap-2">
                        <span id="heartbeatActiveIndicator" class="badge bg-gradient-secondary">
                            <span class="heartbeat-pulse-sm" style="display: none;"></span>
                            <span id="heartbeatActiveText">Checking...</span>
                        </span>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Heartbeat Stats -->
                        <div class="col-md-8">
                            <div class="row g-3">
                                <div class="col-6 col-md-2">
                                    <div class="text-center p-2" style="background: var(--bg-input); border-radius: 8px;">
                                        <div class="text-muted small">Expected</div>
                                        <div id="heartbeatsExpected" class="h5 mb-0" style="color: #9966ff;">0</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <div class="text-center p-2" style="background: var(--bg-input); border-radius: 8px;">
                                        <div class="text-muted small">Sent</div>
                                        <div id="heartbeatsSent" class="h5 mb-0" style="color: #00ff88;">0</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-2">
                                    <div class="text-center p-2" style="background: var(--bg-input); border-radius: 8px;">
                                        <div class="text-muted small">Received</div>
                                        <div id="heartbeatsReceived" class="h5 mb-0" style="color: #00aaff;">0</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-2" style="background: var(--bg-input); border-radius: 8px;">
                                        <div class="text-muted small">Uptime</div>
                                        <div id="heartbeatUptime" class="h5 mb-0" style="color: #ffd700;">--%</div>
                                    </div>
                                </div>
                                <div class="col-6 col-md-3">
                                    <div class="text-center p-2" style="background: var(--bg-input); border-radius: 8px;">
                                        <div class="text-muted small">Last Beat</div>
                                        <div id="heartbeatLastAgo" class="h5 mb-0" style="color: #ff6b6b;">--</div>
                                    </div>
                                </div>
                            </div>
                            <!-- Heartbeat Round -->
                            <div class="mt-3">
                                <small class="text-muted">Heartbeat Round: </small>
                                <span id="heartbeatCurrentRound" class="text-warning" title="Current heartbeat cycle for uptime tracking">--</span>
                            </div>
                            <!-- Network Epoch & Round -->
                            <div class="mt-2 d-flex gap-3">
                                <div>
                                    <small class="text-muted">Network Epoch: </small>
                                    <span id="networkEpoch" class="text-info" title="Weekly epoch for badges & governance">--</span>
                                </div>
                                <div>
                                    <small class="text-muted">Round: </small>
                                    <span id="networkRound" class="text-primary" title="Daily round for reward distribution">--</span>
                                    <small class="text-muted">/ 7</small>
                                </div>
                            </div>
                        </div>
                        <!-- Last Message -->
                        <div class="col-md-4">
                            <div class="p-3 h-100" style="background: var(--bg-input); border-radius: 8px; border-left: 3px solid #ff6b6b;">
                                <div class="text-muted small mb-2">
                                    <i class="material-icons align-middle" style="font-size: 14px;">chat_bubble</i>
                                    Last Heartbeat Message
                                </div>
                                <div id="heartbeatLastMessage" class="small" style="font-style: italic; color: var(--text-secondary);">
                                    Waiting for heartbeat...
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Network Graph (Full Width) -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card network-graph">
                <!-- Legend -->
                <div class="network-legend" id="networkLegend">
                    <div class="legend-title">
                        <i class="material-icons" style="font-size: 14px; vertical-align: middle;">help_outline</i>
                        Network Key
                    </div>
                    <div class="legend-section" style="margin-top: 0; padding-top: 0; border-top: none;">
                        <small style="color: rgba(255,255,255,0.6);">Roles (node fill)</small>
                    </div>
                    <div class="legend-item" data-type="you" onclick="toggleNodeType('you')">
                        <div class="legend-dot" style="background: linear-gradient(135deg, #5a5aff 0%, #3a3acc 100%);"></div>
                        <span>Your Node</span>
                    </div>
                    <div class="legend-item" data-type="node" onclick="toggleNodeType('node')">
                        <div class="legend-dot" style="background: #888;"></div>
                        <span>Node</span>
                        <small class="legend-hint">base participant</small>
                    </div>
                    <div class="legend-item" data-type="predictor" onclick="toggleNodeType('predictor')">
                        <div class="legend-dot" style="background: #00ff88;"></div>
                        <span>Predictor</span>
                        <small class="legend-hint">makes predictions</small>
                    </div>
                    <div class="legend-item" data-type="oracle" onclick="toggleNodeType('oracle')">
                        <div class="legend-dot" style="background: #00aaff;"></div>
                        <span>Oracle</span>
                        <small class="legend-hint">provides data</small>
                    </div>
                    <div class="legend-item" data-type="signer" onclick="toggleNodeType('signer')">
                        <div class="legend-dot" style="background: #ffd700;"></div>
                        <span>Signer</span>
                        <small class="legend-hint">curates & archives</small>
                    </div>
                    <div class="legend-item" data-type="relay" onclick="toggleNodeType('relay')">
                        <div class="legend-dot" style="background: #ff6b6b;"></div>
                        <span>Relay</span>
                        <small class="legend-hint">routes traffic</small>
                    </div>
                    <div class="legend-section">
                        <small style="color: rgba(255,255,255,0.6);">Staking Status (badge icon)</small>
                    </div>
                    <div class="legend-item" data-type="pool-operator">
                        <span class="legend-badge" style="color: #aa44ff; font-size: 14px; margin-right: 8px;">â¬¢</span>
                        <span>Pool Operator</span>
                        <small class="legend-hint">runs staking pool</small>
                    </div>
                    <div class="legend-item" data-type="delegate">
                        <span class="legend-badge" style="color: #00d4aa; font-size: 14px; margin-right: 8px;">â†—</span>
                        <span>Delegate</span>
                        <small class="legend-hint">stakes with pool</small>
                    </div>
                    <div class="legend-section">
                        <small style="color: rgba(255,255,255,0.6);">Relationship Types</small>
                    </div>
                    <div class="legend-item" data-edge="p2p" onclick="toggleEdgeType('p2p')">
                        <div class="legend-line" style="background: rgba(0, 255, 136, 0.6);"></div>
                        <span>P2P Connection</span>
                    </div>
                    <div class="legend-item" data-edge="lending" onclick="toggleEdgeType('lending')">
                        <div class="legend-line" style="background: repeating-linear-gradient(90deg, #aa44ff 0px, #aa44ff 8px, transparent 8px, transparent 12px);"></div>
                        <span>Lending</span>
                    </div>
                    <div class="legend-item" data-edge="delegation" onclick="toggleEdgeType('delegation')">
                        <div class="legend-line" style="background: repeating-linear-gradient(90deg, #00d4aa 0px, #00d4aa 4px, transparent 4px, transparent 8px);"></div>
                        <span>Delegation</span>
                    </div>
                    <div class="legend-section">
                        <small style="color: rgba(255,255,255,0.6);">Titles (outer ring)</small>
                    </div>
                    <div class="legend-item" data-title="historic">
                        <div class="legend-ring" style="border-color: #9966ff;"></div>
                        <span>Historic</span>
                        <small class="legend-hint">uptime dedication</small>
                    </div>
                    <div class="legend-item" data-title="friendly">
                        <div class="legend-ring" style="border-color: #ff66aa;"></div>
                        <span>Friendly</span>
                        <small class="legend-hint">community builder</small>
                    </div>
                    <div class="legend-item" data-title="charity">
                        <div class="legend-ring" style="border-color: #ffcc00;"></div>
                        <span>Charity</span>
                        <small class="legend-hint">generous donor</small>
                    </div>
                    <div class="legend-item" data-title="civic">
                        <div class="legend-ring" style="border-color: #00ddff;"></div>
                        <span>Civic</span>
                        <small class="legend-hint">governance active</small>
                    </div>
                    <div class="legend-item" data-title="whale">
                        <div class="legend-ring" style="border-color: #00ff88;"></div>
                        <span>Whale</span>
                        <small class="legend-hint">max stake</small>
                    </div>
                    <div class="legend-item" data-title="legend">
                        <div class="legend-ring" style="border: 2px solid transparent; background: linear-gradient(90deg, #ff6b6b, #ffd700, #00ff88, #00aaff, #9966ff) border-box; -webkit-mask: linear-gradient(#fff 0 0) padding-box, linear-gradient(#fff 0 0); mask-composite: exclude;"></div>
                        <span>Legend</span>
                        <small class="legend-hint">all titles earned</small>
                    </div>
                    <div class="legend-section">
                        <small style="color: rgba(255,255,255,0.6);">Reputation (inner glow)</small>
                    </div>
                    <div class="legend-item" data-reputation="trusted">
                        <div class="legend-glow" style="background: #00ff88; box-shadow: 0 0 6px #00ff88, 0 0 3px #00ff88;"></div>
                        <span>Trusted</span>
                        <small class="legend-hint">90+ score</small>
                    </div>
                    <div class="legend-item" data-reputation="good">
                        <div class="legend-glow" style="background: #00aaff; box-shadow: 0 0 4px #00aaff;"></div>
                        <span>Good</span>
                        <small class="legend-hint">70-89 score</small>
                    </div>
                    <div class="legend-item" data-reputation="neutral">
                        <div class="legend-glow" style="background: #888888;"></div>
                        <span>Neutral</span>
                        <small class="legend-hint">50-69 score</small>
                    </div>
                    <div class="legend-item" data-reputation="suspect">
                        <div class="legend-glow" style="background: #ffaa00; box-shadow: 0 0 4px #ffaa00;"></div>
                        <span>Suspect</span>
                        <small class="legend-hint">30-49 score</small>
                    </div>
                    <div class="legend-item" data-reputation="untrusted">
                        <div class="legend-glow" style="background: #ff4444; box-shadow: 0 0 6px #ff4444;"></div>
                        <span>Untrusted</span>
                        <small class="legend-hint">&lt;30 score</small>
                    </div>
                    <div class="legend-section">
                        <small style="color: rgba(255,255,255,0.6);">Slashing Status (badge icon)</small>
                    </div>
                    <div class="legend-item" data-slashing="warned">
                        <span class="legend-badge" style="color: #ffcc00; font-size: 14px; margin-right: 8px; text-shadow: 0 0 4px #ffcc00;">âš </span>
                        <span>Warned</span>
                        <small class="legend-hint">50% penalty</small>
                    </div>
                    <div class="legend-item" data-slashing="removed">
                        <span class="legend-badge" style="color: #ff4444; font-size: 14px; margin-right: 8px; text-shadow: 0 0 4px #ff4444;">âœ•</span>
                        <span>Removed</span>
                        <small class="legend-hint">no rewards</small>
                    </div>
                </div>

                <!-- WebSocket Status -->
                <div class="ws-status disconnected" id="wsStatus">
                    <span id="wsStatusDot" class="live-indicator disconnected"></span>
                    <span id="wsStatusText">Connecting...</span>
                </div>

                <div class="card-body p-0" style="position: relative;">
                    <div id="networkGraph"></div>
                    <!-- Peer Stats Card (popup on node click) -->
                    <div id="peerStatsCard" class="peer-stats-card">
                        <div class="peer-stats-card-header">
                            <div class="peer-stats-card-title">
                                <span id="peerStatsRole" class="peer-role-badge peer-role-predictor">predictor</span>
                                <span id="peerStatsStatus" class="badge bg-success badge-xs">Connected</span>
                            </div>
                            <button class="peer-stats-card-close" onclick="hidePeerStatsCard()">&times;</button>
                        </div>
                        <div class="peer-stats-row">
                            <span class="peer-stats-label">Peer ID</span>
                            <span id="peerStatsPeerId" class="peer-stats-value">--</span>
                        </div>
                        <div class="peer-stats-row">
                            <span class="peer-stats-label">Multiaddress</span>
                            <span id="peerStatsMultiaddr" class="peer-stats-value multiaddr">--</span>
                        </div>
                        <div class="peer-stats-row">
                            <span class="peer-stats-label">Evrmore ID</span>
                            <span id="peerStatsEvrmore" class="peer-stats-value">--</span>
                        </div>
                        <div class="peer-stats-row">
                            <span class="peer-stats-label">Latency</span>
                            <span id="peerStatsLatency" class="peer-stats-value">--</span>
                        </div>
                        <div class="peer-stats-row">
                            <span class="peer-stats-label">Protocols</span>
                            <span id="peerStatsProtocols" class="peer-stats-value">--</span>
                        </div>
                        <div class="peer-stats-actions">
                            <button id="peerStatsPingBtn" class="btn btn-sm btn-outline-success" onclick="pingFromStatsCard()">
                                <i class="material-icons" style="font-size: 14px;">network_ping</i> Ping
                            </button>
                            <button id="peerStatsCopyBtn" class="btn btn-sm btn-outline-secondary" onclick="copyFromStatsCard()">
                                <i class="material-icons" style="font-size: 14px;">content_copy</i> Copy Multiaddr
                            </button>
                        </div>
                    </div>
                    <!-- Node Hover Tooltip -->
                    <div id="nodeTooltip" class="node-tooltip">
                        <div class="node-tooltip-row">
                            <span class="node-tooltip-label">Peer ID</span>
                            <span id="tooltipPeerId" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row">
                            <span class="node-tooltip-label">Roles</span>
                            <span id="tooltipRoles" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row" id="tooltipTitlesRow" style="display: none;">
                            <span class="node-tooltip-label">Titles</span>
                            <span id="tooltipTitles" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row" id="tooltipStakingRow" style="display: none;">
                            <span class="node-tooltip-label">Staking</span>
                            <span id="tooltipStaking" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row" id="tooltipReputationRow" style="display: none;">
                            <span class="node-tooltip-label">Reputation</span>
                            <span id="tooltipReputation" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row" id="tooltipSlashingRow" style="display: none;">
                            <span class="node-tooltip-label">Slashing</span>
                            <span id="tooltipSlashing" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row">
                            <span class="node-tooltip-label">Status</span>
                            <span id="tooltipStatus" class="node-tooltip-value">--</span>
                        </div>
                        <div class="node-tooltip-row">
                            <span class="node-tooltip-label">Latency</span>
                            <span id="tooltipLatency" class="node-tooltip-value">--</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tools Row: Peer Tools + Live Events -->
    <div class="row g-4 mb-4">
        <!-- Peer Tools (Combined Connect + Ping + Connected Peers) -->
        <div class="col-xl-8 col-md-12 col-12">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #aa44ff;">hub</i>
                        Peer Tools
                    </h6>
                </div>
                <div class="card-body pt-2">
                    <div class="row">
                        <!-- Left Column: Connect & Ping -->
                        <div class="col-md-6 border-end">
                            <!-- Helper text -->
                            <p class="text-muted small mb-2" style="font-size: 9px; opacity: 0.8;">
                                <i class="material-icons align-middle" style="font-size: 10px;">info</i>
                                Use full multiaddress for new peers. Peer ID alone works only for known/connected peers.
                            </p>

                            <!-- Connect Section -->
                            <p class="text-muted small mb-1"><i class="material-icons align-middle" style="font-size: 14px;">add_link</i> Connect to Peer</p>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="connectMultiaddrInput" class="form-control" placeholder="/ip4/x.x.x.x/tcp/24600/p2p/16Uiu2...">
                                <button class="btn btn-outline-primary" onclick="connectPeer();" id="connectBtn" title="Connect">
                                    <i class="material-icons align-middle" style="font-size: 16px;">link</i>
                                </button>
                            </div>
                            <div id="connectResult" style="display: none;" class="mb-2"></div>

                            <!-- Ping Section -->
                            <p class="text-muted small mb-1 mt-3"><i class="material-icons align-middle" style="font-size: 14px;">network_ping</i> Ping Peer</p>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="pingPeerIdInput" class="form-control" placeholder="Peer ID or /ip4/.../p2p/...">
                                <button class="btn btn-outline-success" onclick="pingPeer();" id="pingBtn" title="Ping">
                                    <i class="material-icons align-middle" style="font-size: 16px;">play_arrow</i>
                                </button>
                            </div>
                            <div id="pingResult" style="display: none;"></div>
                            <div class="d-flex justify-content-between small">
                                <div>
                                    <span class="text-muted">Sent:</span>
                                    <span id="pingsSent" class="text-info">0</span>
                                </div>
                                <div>
                                    <span class="text-muted">Avg RTT:</span>
                                    <span id="avgRtt" class="text-success">--</span>
                                </div>
                            </div>

                            <!-- Identity Operations Section -->
                            <p class="text-muted small mb-1 mt-3"><i class="material-icons align-middle" style="font-size: 14px;">badge</i> Identity Operations</p>
                            <div class="input-group input-group-sm mb-2">
                                <input type="text" id="identityPeerIdInput" class="form-control" placeholder="Peer ID or /ip4/.../p2p/...">
                                <button class="btn btn-outline-primary" onclick="requestIdentityFromInput();" title="Request their identity">
                                    <i class="material-icons align-middle" style="font-size: 16px;">download</i>
                                </button>
                                <button class="btn btn-outline-warning" onclick="broadcastIdentityToInput();" title="Send my identity">
                                    <i class="material-icons align-middle" style="font-size: 16px;">upload</i>
                                </button>
                            </div>
                            <div id="identityResult" style="display: none;"></div>
                        </div>

                        <!-- Right Column: Connected Peers -->
                        <div class="col-md-6">
                            <div class="d-flex justify-content-between align-items-center mb-1">
                                <p class="text-muted small mb-0"><i class="material-icons align-middle" style="font-size: 14px;">people</i> Connected Peers</p>
                                <span id="connectedPeersToolsCount" class="badge bg-gradient-info">0</span>
                            </div>
                            <div id="connectedPeersList" style="max-height: 180px; overflow-y: auto; font-size: 10px;">
                                <span class="text-muted">No peers connected</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Real-time Event Feed -->
        <div class="col-xl-4 col-md-12 col-12">
            <div class="card h-100">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center">
                        <h6 class="mb-0">
                            <i class="material-icons me-1" style="font-size: 18px; vertical-align: middle; color: #06b6d4;">rss_feed</i>
                            Live Events
                        </h6>
                        <button class="btn btn-link btn-sm p-0" onclick="clearEventFeed();" title="Clear">
                            <i class="material-icons" style="font-size: 18px;">clear_all</i>
                        </button>
                    </div>
                </div>
                <div class="card-body pt-2">
                    <div class="event-feed" id="eventFeed" style="max-height: 200px;">
                        <div class="text-muted text-center py-3">
                            <i class="material-icons" style="font-size: 24px;">hourglass_empty</i>
                            <p class="mb-0 mt-1">Waiting for events...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Data Streams Visualization -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div>
                            <h6 class="mb-0">Live Data Streams</h6>
                            <p class="text-muted small mb-0">Real-time data flowing through the network</p>
                        </div>
                        <div id="streamStats">
                            <span class="badge bg-gradient-success me-1"><span id="predictionsCount">0</span> predictions</span>
                            <span class="badge bg-gradient-info me-1"><span id="observationsCount">0</span> observations</span>
                            <span class="badge bg-gradient-danger me-1"><span id="heartbeatsCount">0</span> heartbeats</span>
                            <span class="badge bg-gradient-warning me-1"><span id="consensusCount">0</span> consensus</span>
                            <span class="badge bg-gradient-primary"><span id="governanceCount">0</span> governance</span>
                        </div>
                    </div>
                </div>
                <div class="card-body p-0" style="height: 125px; overflow: hidden;">
                    <svg id="streamVisualization" width="100%" height="125"></svg>
                </div>
            </div>
        </div>
    </div>

    <!-- Management Panels Row -->
    <div class="row g-4 mb-4">
        <!-- Pool Management Panel -->
        <div class="col-xl-6 col-12">
            <div class="card">
                <div class="management-panel">
                    <div class="panel-header" onclick="togglePanel('poolPanel')">
                        <h6>
                            <i class="material-icons me-2" style="font-size: 20px; vertical-align: middle; color: #06b6d4;">pool</i>
                            Pool Management
                        </h6>
                        <i class="material-icons toggle-icon">expand_more</i>
                    </div>
                    <div class="panel-body" id="poolPanel">
                        <!-- My Pool Status -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <p class="text-muted small mb-1">My Pool Status</p>
                                <div id="myPoolStatus">
                                    <span class="badge bg-gradient-secondary">Not Operating</span>
                                </div>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Pool Size Limit</p>
                                <p id="myPoolSize" class="mb-0">--</p>
                            </div>
                        </div>

                        <!-- Pool Toggle -->
                        <div class="mb-3 p-2 border rounded">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="poolOpenToggle" onchange="togglePoolOpen();">
                                <label class="form-check-label" for="poolOpenToggle">
                                    Accept Pool Contributions
                                </label>
                            </div>
                        </div>

                        <hr>

                        <!-- Join a Pool -->
                        <p class="text-muted small mb-2">Join a Pool</p>
                        <div class="input-group input-group-sm mb-3">
                            <input type="text" id="joinPoolAddress" class="form-control" placeholder="Pool address (34 chars)" maxlength="34">
                            <button class="btn btn-outline-primary" onclick="joinPool();">Join</button>
                        </div>

                        <!-- Current Lending -->
                        <div class="row">
                            <div class="col-6">
                                <p class="text-muted small mb-1">Currently Lending To</p>
                                <p id="lendingTo" class="mb-0" style="font-family: monospace; font-size: 10px;">--</p>
                            </div>
                            <div class="col-6 text-end">
                                <button class="btn btn-outline-danger btn-sm" onclick="leavePool();" id="leavePoolBtn" disabled>
                                    <i class="material-icons align-middle" style="font-size: 14px;">exit_to_app</i> Leave Pool
                                </button>
                            </div>
                        </div>

                        <hr>

                        <!-- Pool Contributors (if operating) -->
                        <p class="text-muted small mb-2">Pool Contributors (<span id="poolContributorCount">0</span>)</p>
                        <div id="poolContributorsList" style="max-height: 150px; overflow-y: auto; font-size: 11px;">
                            <span class="text-muted">No contributors</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Delegation Management Panel -->
        <div class="col-xl-6 col-12">
            <div class="card">
                <div class="management-panel">
                    <div class="panel-header" onclick="togglePanel('delegationPanel')">
                        <h6>
                            <i class="material-icons me-2" style="font-size: 20px; vertical-align: middle; color: #f59e0b;">people</i>
                            Delegation Management
                        </h6>
                        <i class="material-icons toggle-icon">expand_more</i>
                    </div>
                    <div class="panel-body" id="delegationPanel">
                        <!-- Add Worker -->
                        <p class="text-muted small mb-2">Stake for Address (become delegate)</p>
                        <div class="input-group input-group-sm mb-3">
                            <input type="text" id="stakeForAddress" class="form-control" placeholder="Worker address (34 chars)" maxlength="34">
                            <button class="btn btn-outline-success" onclick="addWorker();">Add Worker</button>
                        </div>

                        <!-- Worker Reward -->
                        <div class="row mb-3">
                            <div class="col-6">
                                <p class="text-muted small mb-1">Worker Reward %</p>
                                <div class="input-group input-group-sm">
                                    <input type="number" id="workerRewardPct" class="form-control" placeholder="0-100" min="0" max="100">
                                    <button class="btn btn-outline-primary" onclick="setWorkerReward();">Set</button>
                                </div>
                            </div>
                            <div class="col-6">
                                <p class="text-muted small mb-1">Current Offer</p>
                                <p id="currentWorkerReward" class="mb-0">--</p>
                            </div>
                        </div>

                        <hr>

                        <!-- My Delegate -->
                        <div class="mb-3">
                            <p class="text-muted small mb-1">I'm Delegating To</p>
                            <div id="delegatingTo">
                                <span>Not delegating</span>
                            </div>
                        </div>

                        <hr>

                        <!-- Proxy Children (Workers) -->
                        <p class="text-muted small mb-2">My Workers / Proxy Children (<span id="proxyChildCount">0</span>)</p>
                        <div id="proxyChildrenList" style="max-height: 200px; overflow-y: auto; font-size: 11px;">
                            <span class="text-muted">No workers</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Known Peers / Peer Discovery -->
    <div class="row g-4 mb-4">
        <div class="col-12">
            <div class="card">
                <div class="management-panel">
                    <div class="panel-header" onclick="togglePanel('knownPeersPanel')">
                        <h6>
                            <i class="material-icons me-2" style="font-size: 20px; vertical-align: middle; color: #00aaff;">hub</i>
                            Known Peers
                            <span id="knownPeersCount" class="badge bg-gradient-info ms-2">0</span>
                        </h6>
                        <div class="d-flex align-items-center">
                            <button onclick="event.stopPropagation(); refreshKnownPeers();" class="btn btn-outline-info btn-sm me-1" title="Refresh peer list from cache">
                                <i class="material-icons align-middle" style="font-size: 14px;">refresh</i>
                            </button>
                            <!-- Identity Request Dropdown -->
                            <div class="dropdown me-1" onclick="event.stopPropagation();">
                                <button class="btn btn-outline-primary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Request identities from peers">
                                    <i class="material-icons align-middle" style="font-size: 14px;">download</i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><h6 class="dropdown-header">Request Their Identity</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="requestIdentityNetwork();">
                                        <i class="material-icons align-middle me-1" style="font-size: 14px;">public</i> From Network
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="requestIdentityKnown();">
                                        <i class="material-icons align-middle me-1" style="font-size: 14px;">group</i> From Known Peers
                                    </a></li>
                                </ul>
                            </div>
                            <!-- Identity Broadcast Dropdown -->
                            <div class="dropdown me-2" onclick="event.stopPropagation();">
                                <button class="btn btn-outline-success btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown" title="Broadcast your identity to peers">
                                    <i class="material-icons align-middle" style="font-size: 14px;">upload</i>
                                </button>
                                <ul class="dropdown-menu dropdown-menu-end">
                                    <li><h6 class="dropdown-header">Broadcast My Identity</h6></li>
                                    <li><a class="dropdown-item" href="#" onclick="broadcastIdentityNetwork();">
                                        <i class="material-icons align-middle me-1" style="font-size: 14px;">public</i> To Network
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="broadcastIdentityKnown();">
                                        <i class="material-icons align-middle me-1" style="font-size: 14px;">group</i> To Known Peers
                                    </a></li>
                                </ul>
                            </div>
                            <i class="material-icons toggle-icon">expand_more</i>
                        </div>
                    </div>
                    <div class="panel-body show" id="knownPeersPanel">
                        <!-- Filter by Role -->
                        <div class="row mb-3">
                            <div class="col-md-4">
                                <label class="text-muted small">Filter by Role</label>
                                <select id="peerRoleFilter" class="form-select form-select-sm" onchange="filterPeersByRole();">
                                    <option value="all">All Roles</option>
                                    <option value="node">Nodes (base only)</option>
                                    <option value="predictor">Predictors</option>
                                    <option value="oracle">Oracles</option>
                                    <option value="signer">Signers</option>
                                    <option value="relay">Relays</option>
                                    <option value="pool-operator">Pool Operators</option>
                                    <option value="delegate">Delegates</option>
                                    <option value="charity">Charity</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Sort by</label>
                                <select id="peerSortBy" class="form-select form-select-sm" onchange="sortPeers();">
                                    <option value="latency">Latency (Lowâ†’High)</option>
                                    <option value="role">Role</option>
                                    <option value="recent">Recently Seen</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="text-muted small">Search</label>
                                <input type="text" id="peerSearchInput" class="form-control form-control-sm" placeholder="Peer ID or address..." oninput="searchPeers();">
                            </div>
                        </div>

                        <!-- Peers Table -->
                        <div style="max-height: 400px; overflow-y: auto; background: var(--bg-card); border-radius: 8px;">
                            <table class="table peer-table mb-0" style="background: var(--bg-card);">
                                <thead>
                                    <tr>
                                        <th>Multiaddress</th>
                                        <th>Evrmore Identity</th>
                                        <th>Role</th>
                                        <th>Status</th>
                                        <th>RTT</th>
                                        <th>Protocols</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="knownPeersTableBody">
                                    <tr>
                                        <td colspan="7" class="text-center py-4" style="background: var(--bg-card); color: var(--text-muted);">
                                            <i class="material-icons" style="font-size: 32px; color: var(--text-muted);">hourglass_empty</i>
                                            <p class="mb-1 mt-2">Waiting for peers to announce themselves...</p>
                                            <small style="color: var(--text-muted);">Peers broadcast their identity every 5 minutes. This will update automatically once connected.</small>
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <!-- Peer Stats Summary -->
                        <div class="row mt-3 pt-3" style="border-top: 1px solid var(--border-color);">
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Total</small>
                                <span id="statsTotalPeers" class="text-primary fw-bold">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Nodes</small>
                                <span id="statsNodeCount" style="color: #888;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Predictors</small>
                                <span id="statsPredictorCount" style="color: #00ff88;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Oracles</small>
                                <span id="statsOracleCount" style="color: #00aaff;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Signers</small>
                                <span id="statsSignerCount" style="color: #ffd700;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Relays</small>
                                <span id="statsRelayCount" style="color: #ff6b6b;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Pool Ops</small>
                                <span id="statsPoolOperatorCount" style="color: #aa44ff;">0</span>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Delegates</small>
                                <span id="statsDelegateCount" style="color: #00d4aa;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Connected</small>
                                <span id="statsConnectedCount" style="color: #00ff88;">0</span>
                            </div>
                            <div class="col-6 col-md-3 col-lg-2 text-center mb-2">
                                <small class="text-muted d-block">Avg RTT</small>
                                <span id="statsAvgRtt" class="text-success">--</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Consensus Timeline & Activity Chart -->
    <div class="row g-4 mb-4">
        <div class="col-xl-6 col-12">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">Consensus Pipeline</h6>
                </div>
                <div class="card-body">
                    <div class="timeline">
                        <div class="timeline-block">
                            <span id="phase1Dot" class="timeline-step bg-gradient-secondary">
                                <i class="material-icons" style="font-size: 16px;">visibility</i>
                            </span>
                            <div class="timeline-content">
                                <h6 class="small mb-0">Observation</h6>
                                <p class="text-muted small mb-0" id="phase1Status">Waiting</p>
                            </div>
                        </div>
                        <div class="timeline-block">
                            <span id="phase2Dot" class="timeline-step bg-gradient-secondary">
                                <i class="material-icons" style="font-size: 16px;">calculate</i>
                            </span>
                            <div class="timeline-content">
                                <h6 class="small mb-0">Score Calculation</h6>
                                <p class="text-muted small mb-0" id="phase2Status">Pending</p>
                            </div>
                        </div>
                        <div class="timeline-block">
                            <span id="phase3Dot" class="timeline-step bg-gradient-secondary">
                                <i class="material-icons" style="font-size: 16px;">how_to_vote</i>
                            </span>
                            <div class="timeline-content">
                                <h6 class="small mb-0">Voting</h6>
                                <p class="text-muted small mb-0" id="phase3Status">Pending</p>
                                <div class="progress mt-1" style="height: 4px; width: 150px; background: var(--bg-input);">
                                    <div id="votingProgress" class="progress-bar bg-gradient-info" style="width: 0%"></div>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-block">
                            <span id="phase4Dot" class="timeline-step bg-gradient-secondary">
                                <i class="material-icons" style="font-size: 16px;">draw</i>
                            </span>
                            <div class="timeline-content">
                                <h6 class="small mb-0">Signing (3/5)</h6>
                                <p class="text-muted small mb-0" id="phase4Status">Pending</p>
                                <div id="signatureIndicators" class="mt-1">
                                    <span class="badge bg-gradient-secondary me-1">1</span>
                                    <span class="badge bg-gradient-secondary me-1">2</span>
                                    <span class="badge bg-gradient-secondary me-1">3</span>
                                    <span class="badge bg-gradient-secondary me-1">4</span>
                                    <span class="badge bg-gradient-secondary">5</span>
                                </div>
                            </div>
                        </div>
                        <div class="timeline-block">
                            <span id="phase5Dot" class="timeline-step bg-gradient-secondary">
                                <i class="material-icons" style="font-size: 16px;">send</i>
                            </span>
                            <div class="timeline-content">
                                <h6 class="small mb-0">Distribution</h6>
                                <p class="text-muted small mb-0" id="phase5Status">Pending</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-6 col-12">
            <div class="card h-100">
                <div class="card-header">
                    <h6 class="mb-0">Network Activity (24h)</h6>
                </div>
                <div class="card-body">
                    <canvas id="activityChart" height="220"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Mode Selector Modal -->
<div id="modeModal" class="mode-modal">
    <div class="mode-modal-content card">
        <h5 class="mb-3">
            <i class="material-icons align-middle me-2">settings_ethernet</i>
            Network Mode
        </h5>
        <hr style="border-color: var(--border-color);">
        <div class="mode-option">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="modeSelect" id="modeCentralSelect" value="central">
                <label class="form-check-label" for="modeCentralSelect">
                    <strong>Central</strong>
                    <br><small class="text-muted">Use central servers only. Most stable.</small>
                </label>
            </div>
        </div>
        <div class="mode-option recommended">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="modeSelect" id="modeHybridSelect" value="hybrid">
                <label class="form-check-label" for="modeHybridSelect">
                    <strong>Hybrid</strong> <span class="badge bg-gradient-primary ms-2">Recommended</span>
                    <br><small class="text-muted">P2P with central fallback.</small>
                </label>
            </div>
        </div>
        <div class="mode-option">
            <div class="form-check">
                <input class="form-check-input" type="radio" name="modeSelect" id="modeP2PSelect" value="p2p">
                <label class="form-check-label" for="modeP2PSelect">
                    <strong>Pure P2P</strong>
                    <br><small class="text-muted">Fully decentralized.</small>
                </label>
            </div>
        </div>
        <p class="text-warning small mt-3 mb-3">
            <i class="material-icons align-middle" style="font-size: 16px;">warning</i>
            Requires restart to take effect
        </p>
        <div class="text-end">
            <button onclick="hideModeSelector();" class="btn btn-outline-secondary btn-sm">Cancel</button>
            <button onclick="saveNetworkMode();" class="btn btn-primary btn-sm ms-2">Save & Restart</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // ============================================
    // UTILITY FUNCTIONS
    // ============================================

    // Helper function to get primary role from peer (handles both 'role' string and 'roles' array)
    // Returns the highest-priority role based on hierarchy: signer > oracle > relay > predictor
    const ROLE_HIERARCHY = ['signer', 'oracle', 'relay', 'predictor'];
    const SPECIALIZED_ROLES = ['signer', 'oracle', 'relay', 'predictor', 'pool-operator', 'delegate'];

    function getPeerRole(peer) {
        let roles = [];
        if (peer.roles && Array.isArray(peer.roles) && peer.roles.length > 0) {
            roles = peer.roles.map(r => r.toLowerCase());
        } else if (peer.role) {
            return peer.role.toLowerCase();
        }

        if (roles.length === 0) return 'unknown';

        // Return highest-priority role based on hierarchy
        for (const role of ROLE_HIERARCHY) {
            if (roles.includes(role)) {
                return role;
            }
        }

        // Fallback to first role if none match hierarchy
        return roles[0];
    }

    // Check if peer has ONLY the base "node" role (no specialized roles)
    function isNodeOnly(peer) {
        let roles = [];
        if (peer.roles && Array.isArray(peer.roles) && peer.roles.length > 0) {
            roles = peer.roles.map(r => r.toLowerCase());
        } else if (peer.role) {
            roles = peer.role.toLowerCase().split(',').map(r => r.trim());
        }

        // Node-only if no specialized roles are present
        return !roles.some(r => SPECIALIZED_ROLES.includes(r));
    }

    // Check if peer has a specific role (handles multi-role peers)
    function hasRole(peer, targetRole) {
        let roles = [];
        if (peer.roles && Array.isArray(peer.roles) && peer.roles.length > 0) {
            roles = peer.roles.map(r => r.toLowerCase());
        } else if (peer.role) {
            roles = peer.role.toLowerCase().split(',').map(r => r.trim());
        }
        return roles.includes(targetRole.toLowerCase());
    }

    // ============================================
    // GLOBAL STATE
    // ============================================
    let socket = null;
    let networkGraph = null;
    let activityChart = null;
    let graphData = { nodes: [], links: [] };
    let graphSimulation = null;  // Persistent simulation to avoid jostling on updates
    let visibleNodeTypes = new Set(['you', 'node', 'oracle', 'signer', 'relay', 'predictor', 'unknown']);
    let visibleEdgeTypes = new Set(['p2p', 'lending', 'delegation']);

    // Counters
    let counters = {
        predictions: 0,
        observations: 0,
        heartbeats: 0,
        consensus: 0,
        governance: 0
    };

    // Event tracking
    let lastSeenHeartbeats = {};
    let eventFeedItems = [];
    const MAX_EVENTS = 50;

    // Mesh tracking for live events
    let lastMeshPeerCount = null;
    let lastConnectedCount = null;

    // ============================================
    // INITIALIZATION
    // ============================================
    document.addEventListener('DOMContentLoaded', function() {
        // Apply stored theme
        const storedTheme = localStorage.getItem('satori-theme') || 'dark';
        document.documentElement.setAttribute('data-theme', storedTheme);
        const icon = document.getElementById('themeIcon');
        if (icon) {
            icon.textContent = storedTheme === 'dark' ? 'light_mode' : 'dark_mode';
        }

        initWebSocket();
        initNetworkGraph();
        initStreamVisualization();
        initActivityChart();
        refreshAllData();

        // Fallback polling (in case WebSocket fails)
        setInterval(pollHeartbeats, 5000);
        setInterval(pollHeartbeatStats, 10000);  // Poll heartbeat stats every 10s
        setInterval(fetchUnifiedStatus, 5000);   // Poll unified status every 5s for fresh peer counts
        setInterval(refreshAllData, 30000);
        setInterval(fetchActivityData, 60000);   // Poll activity chart data every 60s

        // Initial heartbeat stats load
        pollHeartbeatStats();

        // Close Bootstrap dropdowns when clicking outside or when another opens
        document.addEventListener('click', function(e) {
            // Close all open dropdowns when clicking outside
            if (!e.target.closest('.dropdown')) {
                document.querySelectorAll('.dropdown-menu.show').forEach(menu => {
                    menu.classList.remove('show');
                    menu.closest('.dropdown')?.querySelector('.dropdown-toggle')?.classList.remove('show');
                    menu.closest('.dropdown')?.classList.remove('show');
                });
            }
        });

        // When a dropdown toggle is clicked, close other dropdowns first
        document.querySelectorAll('.dropdown-toggle').forEach(toggle => {
            toggle.addEventListener('click', function(e) {
                const currentDropdown = this.closest('.dropdown');
                document.querySelectorAll('.dropdown').forEach(dropdown => {
                    if (dropdown !== currentDropdown) {
                        dropdown.querySelector('.dropdown-menu')?.classList.remove('show');
                        dropdown.querySelector('.dropdown-toggle')?.classList.remove('show');
                        dropdown.classList.remove('show');
                    }
                });
            });
        });
    });

    // ============================================
    // WEBSOCKET CONNECTION
    // ============================================
    function initWebSocket() {
        try {
            socket = io();

            socket.on('connect', function() {
                console.log('WebSocket connected');
                updateWsStatus(true);
                addEvent('system', 'Connected to server');
            });

            socket.on('disconnect', function() {
                console.log('WebSocket disconnected');
                updateWsStatus(false);
                addEvent('system', 'Disconnected from server');
            });

            // Network events
            socket.on('network.heartbeat', function(data) {
                handleHeartbeat(data);
            });

            socket.on('network.prediction', function(data) {
                handlePrediction(data);
            });

            socket.on('network.observation', function(data) {
                handleObservation(data);
            });

            socket.on('network.consensus.phase', function(data) {
                handleConsensusPhase(data);
            });

            socket.on('network.consensus.vote', function(data) {
                handleConsensusVote(data);
            });

            socket.on('network.consensus.signature', function(data) {
                handleSignature(data);
            });

            // Governance events
            socket.on('network.governance', function(data) {
                handleGovernance(data);
            });

            socket.on('network.governance.vote', function(data) {
                handleGovernance(data);
            });

            socket.on('network.governance.proposal', function(data) {
                handleGovernance(data);
            });

            // Pool/Delegation events
            socket.on('pool.join', function(data) {
                handlePoolJoin(data);
            });

            socket.on('pool.leave', function(data) {
                handlePoolLeave(data);
            });

            socket.on('delegation.add', function(data) {
                handleDelegationAdd(data);
            });

            socket.on('delegation.remove', function(data) {
                handleDelegationRemove(data);
            });

            // Peer events
            socket.on('peer.connect', function(data) {
                handlePeerConnect(data);
            });

            socket.on('peer.disconnect', function(data) {
                handlePeerDisconnect(data);
            });

        } catch (e) {
            console.warn('WebSocket init failed:', e);
            updateWsStatus(false);
        }
    }

    function updateWsStatus(connected) {
        const status = document.getElementById('wsStatus');
        const dot = document.getElementById('wsStatusDot');
        const text = document.getElementById('wsStatusText');
        const indicator = document.getElementById('wsIndicator');

        if (connected) {
            status.className = 'ws-status connected';
            dot.className = 'live-indicator connected';
            indicator.className = 'live-indicator connected';
            text.textContent = 'Live';
        } else {
            status.className = 'ws-status disconnected';
            dot.className = 'live-indicator disconnected';
            indicator.className = 'live-indicator disconnected';
            text.textContent = 'Polling';
        }
    }

    // ============================================
    // EVENT HANDLERS
    // ============================================
    function handleHeartbeat(data) {
        const peerId = data.peer_id || data.node_id;
        const isOwnHeartbeat = data.is_own === true;

        // Dedup key to handle GossipSub self-delivery (received arrives before sent)
        const key = peerId + '_' + data.timestamp;
        const seenBefore = lastSeenHeartbeats[key];

        if (seenBefore) {
            // Already seen this heartbeat - but if this is the "sent" version (is_own=true)
            // and we previously saw the "received" version, update the display
            if (isOwnHeartbeat && seenBefore === 'received') {
                // Replace the "from" event with "broadcast" - but don't double count
                lastSeenHeartbeats[key] = 'sent';
                pulseOwnNode('heartbeat');
                // Update the last event to show broadcast instead of from
                updateLastHeartbeatEvent(peerId);
                updateHeartbeatStatus(true, new Date());
            }
            return;
        }

        // Mark as seen with type
        lastSeenHeartbeats[key] = isOwnHeartbeat ? 'sent' : 'received';

        counters.heartbeats++;
        document.getElementById('heartbeatsCount').textContent = counters.heartbeats;

        createStreamParticle('heartbeat');

        if (isOwnHeartbeat) {
            // Our own heartbeat broadcast - pulse our node (expanding ring)
            pulseOwnNode('heartbeat');
            addEvent('heartbeat', `Heartbeat broadcast to network`);
            updateHeartbeatStatus(true, new Date());
        } else {
            // Received heartbeat from another peer - packet flows TO us
            sendNetworkPacketToUs(peerId, 'heartbeat');
            addEvent('heartbeat', `Heartbeat from ${peerId}`);
        }

        // Cleanup old entries
        const keys = Object.keys(lastSeenHeartbeats);
        if (keys.length > 200) {
            keys.slice(0, 100).forEach(k => delete lastSeenHeartbeats[k]);
        }
    }

    function updateLastHeartbeatEvent(peerId) {
        // Find and update the most recent heartbeat event to say "broadcast" instead of "from"
        const feed = document.getElementById('eventFeed');
        if (!feed) return;
        const myPeerId = peerId || document.getElementById('myPeerIdFull')?.textContent;
        if (!myPeerId) return;

        const items = feed.querySelectorAll('.event-item');
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const text = item.querySelector('.event-text');
            // Match "Heartbeat from [our peer ID]"
            if (text && text.textContent === 'Heartbeat from ' + myPeerId) {
                text.textContent = 'Heartbeat broadcast to network';
                break;
            }
        }
    }

    function updateHeartbeatStatus(isActive, lastTime) {
        const statusEl = document.getElementById('heartbeatStatus');
        const statusTextEl = document.getElementById('heartbeatStatusText');
        const pulseEl = statusEl.querySelector('.heartbeat-pulse');
        const timeEl = document.getElementById('lastHeartbeatTime');

        if (isActive) {
            statusEl.className = 'badge bg-gradient-danger badge-sm';
            statusTextEl.textContent = 'Active';
            if (pulseEl) pulseEl.style.display = 'inline-block';
        } else {
            statusEl.className = 'badge bg-gradient-secondary badge-sm';
            statusTextEl.textContent = 'Inactive';
            if (pulseEl) pulseEl.style.display = 'none';
        }

        if (lastTime) {
            timeEl.textContent = 'Last: ' + lastTime.toLocaleTimeString();
        }
    }

    function handlePrediction(data) {
        const peerId = data.peer_id || data.node_id;
        counters.predictions++;
        document.getElementById('predictionsCount').textContent = counters.predictions;

        const myPeerId = document.getElementById('myPeerIdFull')?.textContent;
        const isOwnPrediction = myPeerId && peerId === myPeerId;

        createStreamParticle('prediction');

        if (isOwnPrediction) {
            pulseOwnNode('prediction');
            updatePredictionWorkStatus();
        } else {
            // Received prediction from another peer - packet flows TO us (no pulse on other nodes)
            sendNetworkPacketToUs(peerId, 'prediction');
        }

        addEvent('prediction', `Prediction from ${peerId}${data.stream ? ' on ' + data.stream : ''}`);
    }

    function updatePredictionWorkStatus() {
        const countEl = document.getElementById('activePredictionsCount');
        const statusEl = document.getElementById('predictionWorkStatus');
        const count = parseInt(countEl.textContent) + 1;
        countEl.textContent = count;
        if (count > 0) {
            statusEl.className = 'badge bg-gradient-success badge-sm';
        }
    }

    function updateConsensusStatus() {
        const countEl = document.getElementById('consensusParticipation');
        const statusEl = document.getElementById('consensusStatus');
        const count = parseInt(countEl.textContent) + 1;
        countEl.textContent = count;
        if (count > 0) {
            statusEl.className = 'badge bg-gradient-warning badge-sm';
        }
    }

    function handleObservation(data) {
        const peerId = data.peer_id || data.node_id || '';
        counters.observations++;
        document.getElementById('observationsCount').textContent = counters.observations;

        const myPeerId = document.getElementById('myPeerIdFull')?.textContent;
        const isOwnObservation = data.is_own || (myPeerId && peerId === myPeerId);

        createStreamParticle('observation');

        if (isOwnObservation) {
            pulseOwnNode('observation');
            // Show that WE published an observation
            addEvent('observation', `Published observation: ${data.stream_id || 'stream'}`);
        } else {
            // Received observation from another peer - packet flows TO us
            sendNetworkPacketToUs(peerId, 'observation');
            addEvent('observation', `Observation from ${peerId || 'peer'}`);
        }
    }

    function handleConsensusPhase(data) {
        updateConsensusTimeline(data.phase);
        addEvent('consensus', `Consensus phase: ${data.phase}`);
    }

    function handleConsensusVote(data) {
        const peerId = data.peer_id || data.node_id;
        counters.consensus++;
        document.getElementById('consensusCount').textContent = counters.consensus;

        const myPeerId = document.getElementById('myPeerIdFull')?.textContent;
        const isOwnVote = myPeerId && peerId === myPeerId;

        createStreamParticle('consensus');

        if (isOwnVote) {
            pulseOwnNode('consensus');
            updateConsensusStatus();
        } else {
            sendNetworkPacketToUs(peerId, 'consensus');
        }

        addEvent('consensus', `Vote from ${peerId}`);
    }

    function handleSignature(data) {
        addEvent('consensus', `Signature ${data.index}/5 received`);
        updateSignatureIndicator(data.index, true);
    }

    function handleGovernance(data) {
        const peerId = data.peer_id || data.node_id || data.voter || 'unknown';
        counters.governance++;
        document.getElementById('governanceCount').textContent = counters.governance;

        const myPeerId = document.getElementById('myPeerIdFull')?.textContent;
        const isOwnGovernance = myPeerId && peerId === myPeerId;

        createStreamParticle('governance');

        if (isOwnGovernance) {
            pulseOwnNode('governance');
        } else {
            // Received governance event from another peer - packet flows TO us
            sendNetworkPacketToUs(peerId, 'governance');
        }

        // Determine event type for display
        const eventType = data.type || 'activity';
        let message = `Governance ${eventType}`;
        if (data.proposal_id) {
            message += ` on proposal ${data.proposal_id.substring(0, 8)}...`;
        }
        if (data.vote) {
            message += ` (${data.vote})`;
        }
        addEvent('governance', message + ` from ${peerId}`);
    }

    function handlePoolJoin(data) {
        addEvent('pool', `${truncateId(data.address)} joined pool ${truncateId(data.pool)}`);
        addRelationshipEdge(data.address, data.pool, 'lending');
        loadPoolStatus();
    }

    function handlePoolLeave(data) {
        addEvent('pool', `${truncateId(data.address)} left pool`);
        removeRelationshipEdge(data.address, data.pool, 'lending');
        loadPoolStatus();
    }

    function handleDelegationAdd(data) {
        addEvent('delegation', `${truncateId(data.parent)} now delegates for ${truncateId(data.child)}`);
        addRelationshipEdge(data.parent, data.child, 'delegation');
        loadDelegationStatus();
    }

    function handleDelegationRemove(data) {
        addEvent('delegation', `Delegation removed: ${truncateId(data.child)}`);
        removeRelationshipEdge(data.parent, data.child, 'delegation');
        loadDelegationStatus();
    }

    function handlePeerConnect(data) {
        addEvent('system', `Peer connected: ${truncateId(data.peer_id)}`);
        addNodeToGraph(data);
        // Update connected peer count (the main stat)
        const connectedEl = document.getElementById('connectedPeerCount');
        if (connectedEl) {
            connectedEl.textContent = parseInt(connectedEl.textContent) + 1;
        }
        // Also update the Peer Tools count
        const toolsCountEl = document.getElementById('connectedPeersToolsCount');
        if (toolsCountEl) {
            toolsCountEl.textContent = parseInt(toolsCountEl.textContent) + 1;
        }
        // Refresh the unified status after a short delay for full data sync
        setTimeout(fetchUnifiedStatus, 500);
    }

    function handlePeerDisconnect(data) {
        addEvent('system', `Peer disconnected: ${truncateId(data.peer_id)}`);
        removeNodeFromGraph(data.peer_id);
        // Update connected peer count (the main stat)
        const connectedEl = document.getElementById('connectedPeerCount');
        if (connectedEl) {
            connectedEl.textContent = Math.max(0, parseInt(connectedEl.textContent) - 1);
        }
        // Also update the Peer Tools count
        const toolsCountEl = document.getElementById('connectedPeersToolsCount');
        if (toolsCountEl) {
            toolsCountEl.textContent = Math.max(0, parseInt(toolsCountEl.textContent) - 1);
        }
        // Refresh the unified status after a short delay for full data sync
        setTimeout(fetchUnifiedStatus, 500);
    }

    // ============================================
    // EVENT FEED
    // ============================================
    function addEvent(type, message) {
        const feed = document.getElementById('eventFeed');
        const time = new Date().toLocaleTimeString();

        const eventHtml = `
            <div class="event-item event-${type}">
                <div class="d-flex justify-content-between">
                    <span class="event-text">${message}</span>
                    <span class="event-time">${time}</span>
                </div>
            </div>
        `;

        // Remove placeholder if exists
        const placeholder = feed.querySelector('.text-center');
        if (placeholder) placeholder.remove();

        // Add new event at top
        feed.insertAdjacentHTML('afterbegin', eventHtml);

        // Limit events
        eventFeedItems.push({ type, message, time });
        if (eventFeedItems.length > MAX_EVENTS) {
            eventFeedItems.shift();
            const items = feed.querySelectorAll('.event-item');
            if (items.length > MAX_EVENTS) {
                items[items.length - 1].remove();
            }
        }
    }

    function clearEventFeed() {
        const feed = document.getElementById('eventFeed');
        feed.innerHTML = `
            <div class="text-muted text-center py-3">
                <i class="material-icons" style="font-size: 24px;">hourglass_empty</i>
                <p class="mb-0 mt-1">Waiting for events...</p>
            </div>
        `;
        eventFeedItems = [];
    }

    // ============================================
    // NETWORK GRAPH (D3.js)
    // ============================================
    function initNetworkGraph() {
        const container = document.getElementById('networkGraph');
        const width = container.clientWidth;
        const height = 650;

        const svg = d3.select('#networkGraph')
            .append('svg')
            .attr('width', width)
            .attr('height', height);

        // Gradient definitions
        const defs = svg.append('defs');

        const myGradient = defs.append('radialGradient')
            .attr('id', 'myNodeGradient');
        myGradient.append('stop').attr('offset', '0%').attr('stop-color', '#5a5aff');
        myGradient.append('stop').attr('offset', '100%').attr('stop-color', '#3a3acc');

        // Role color definitions (functional roles only)
        // Note: Signers also perform curation & archiving as part of their duties
        const roleColors = {
            predictor: '#00ff88',   // Green - makes predictions
            relay: '#ff6b6b',       // Red/coral - relays data
            oracle: '#00aaff',      // Blue - provides oracle data
            signer: '#ffd700'       // Gold - signs governance/consensus (also curates & archives)
        };

        // Staking status colors (economic relationships, not roles)
        const stakingColors = {
            'pool-operator': '#aa44ff',  // Purple - runs a staking pool
            'delegate': '#00d4aa'        // Teal - delegates stake to pool
        };

        // Title color definitions
        const titleColors = {
            historic: '#9966ff',   // Purple - uptime dedication
            friendly: '#ff66aa',   // Pink - community builder
            charity: '#ffcc00',    // Gold - generous donor
            civic: '#00ddff',      // Cyan - governance active
            whale: '#00ff88',      // Bright green - max stake
            legend: '#ffffff'      // White/rainbow - all titles
        };

        // Store colors globally for dynamic gradient creation
        window.roleColors = roleColors;
        window.titleColors = titleColors;
        window.stakingColors = stakingColors;
        window.svgDefs = defs;

        // Create a gradient for a unique combination of roles
        // Roles are ordered by hierarchy: signer > oracle > relay > predictor
        // so the most important role appears first (top-left) in the gradient
        const roleHierarchy = ['signer', 'oracle', 'relay', 'predictor'];

        window.getOrCreateRoleGradient = function(roles) {
            if (!roles || roles.length === 0) return '#888888';
            if (roles.length === 1) return roleColors[roles[0]] || '#888888';

            // Sort roles by hierarchy (most important first)
            const orderedRoles = [...roles].sort((a, b) => {
                const aIdx = roleHierarchy.indexOf(a.toLowerCase());
                const bIdx = roleHierarchy.indexOf(b.toLowerCase());
                // If not in hierarchy, put at end
                const aPos = aIdx === -1 ? 999 : aIdx;
                const bPos = bIdx === -1 ? 999 : bIdx;
                return aPos - bPos;
            });

            // Create unique gradient ID based on ordered roles
            const gradientId = 'roleGrad_' + orderedRoles.join('_');

            // Check if gradient already exists
            if (!defs.select('#' + gradientId).empty()) {
                return 'url(#' + gradientId + ')';
            }

            // Create linear gradient with role colors (most important at top-left)
            const gradient = defs.append('linearGradient')
                .attr('id', gradientId)
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '100%').attr('y2', '100%');

            orderedRoles.forEach((role, i) => {
                const offset = (i / (orderedRoles.length - 1)) * 100;
                gradient.append('stop')
                    .attr('offset', offset + '%')
                    .attr('stop-color', roleColors[role] || '#888888');
            });

            return 'url(#' + gradientId + ')';
        };

        // Create a gradient for a unique combination of titles
        window.getOrCreateTitleGradient = function(titles) {
            if (!titles || titles.length === 0) return null;

            // Special case for legend - rainbow gradient
            if (titles.includes('legend')) {
                const legendId = 'titleGrad_legend';
                if (defs.select('#' + legendId).empty()) {
                    const legendGrad = defs.append('linearGradient')
                        .attr('id', legendId)
                        .attr('x1', '0%').attr('y1', '0%')
                        .attr('x2', '100%').attr('y2', '0%');
                    legendGrad.append('stop').attr('offset', '0%').attr('stop-color', '#ff6b6b');
                    legendGrad.append('stop').attr('offset', '20%').attr('stop-color', '#ffd700');
                    legendGrad.append('stop').attr('offset', '40%').attr('stop-color', '#00ff88');
                    legendGrad.append('stop').attr('offset', '60%').attr('stop-color', '#00aaff');
                    legendGrad.append('stop').attr('offset', '80%').attr('stop-color', '#9966ff');
                    legendGrad.append('stop').attr('offset', '100%').attr('stop-color', '#ff66aa');
                }
                return 'url(#' + legendId + ')';
            }

            if (titles.length === 1) return titleColors[titles[0]] || '#888888';

            // Create unique gradient ID based on sorted titles
            const sortedTitles = [...titles].sort();
            const gradientId = 'titleGrad_' + sortedTitles.join('_');

            // Check if gradient already exists
            if (!defs.select('#' + gradientId).empty()) {
                return 'url(#' + gradientId + ')';
            }

            // Create linear gradient with title colors
            const gradient = defs.append('linearGradient')
                .attr('id', gradientId)
                .attr('x1', '0%').attr('y1', '0%')
                .attr('x2', '100%').attr('y2', '0%');

            sortedTitles.forEach((title, i) => {
                const offset = (i / (sortedTitles.length - 1)) * 100;
                gradient.append('stop')
                    .attr('offset', offset + '%')
                    .attr('stop-color', titleColors[title] || '#888888');
            });

            return 'url(#' + gradientId + ')';
        };

        // Arrow markers for directed edges
        defs.append('marker')
            .attr('id', 'arrowLending')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#aa44ff');

        defs.append('marker')
            .attr('id', 'arrowDelegation')
            .attr('viewBox', '0 -5 10 10')
            .attr('refX', 20)
            .attr('refY', 0)
            .attr('markerWidth', 6)
            .attr('markerHeight', 6)
            .attr('orient', 'auto')
            .append('path')
            .attr('d', 'M0,-5L10,0L0,5')
            .attr('fill', '#00d4aa');

        // Create groups
        svg.append('g').attr('class', 'edges');
        svg.append('g').attr('class', 'nodes');
        svg.append('g').attr('class', 'packets');

        // Initialize with placeholder
        updateNetworkGraph(generatePlaceholderNetwork());
    }

    function generatePlaceholderNetwork() {
        const nodes = [
            { id: 'you', label: 'You', type: 'you', isMe: true, roles: ['predictor'], titles: [], stakingStatus: null },
        ];

        // Generate some sample nodes with various role/title/staking combinations
        // roles: functional roles (predictor, relay, oracle, signer)
        //        Note: signers also curate & archive as part of their duties
        // titles: earned achievements (historic, friendly, charity, civic, whale, legend)
        // stakingStatus: economic relationship (null, 'pool-operator', 'delegate')
        const sampleNodes = [
            { roles: ['predictor'], titles: [], stakingStatus: null },
            { roles: ['predictor', 'oracle'], titles: ['historic'], stakingStatus: null },
            { roles: ['oracle'], titles: [], stakingStatus: 'pool-operator' },
            { roles: ['signer'], titles: ['whale', 'civic'], stakingStatus: null },
            { roles: ['predictor', 'relay'], titles: ['friendly'], stakingStatus: 'delegate' },
            { roles: ['predictor'], titles: ['charity'], stakingStatus: null },
            { roles: ['signer'], titles: ['legend'], stakingStatus: 'pool-operator' },
            { roles: ['predictor', 'oracle', 'relay'], titles: ['historic', 'charity'], stakingStatus: 'delegate' },
        ];

        for (let i = 1; i <= 8; i++) {
            const sample = sampleNodes[i - 1];
            nodes.push({
                id: `peer_${i}`,
                label: `Peer ${i}`,
                type: sample.roles[0], // Primary role for filtering
                roles: sample.roles,
                titles: sample.titles,
                stakingStatus: sample.stakingStatus,
                isMe: false,
                latency: Math.floor(Math.random() * 150) + 30
            });
        }

        const links = [];
        // Connect you to several peers
        for (let i = 1; i <= 4; i++) {
            links.push({ source: 'you', target: `peer_${i}`, type: 'p2p' });
        }

        // Add some peer-to-peer connections
        links.push({ source: 'peer_1', target: 'peer_5', type: 'p2p' });
        links.push({ source: 'peer_2', target: 'peer_6', type: 'p2p' });
        links.push({ source: 'peer_3', target: 'peer_7', type: 'p2p' });

        // Add relationship edges
        links.push({ source: 'peer_5', target: 'peer_1', type: 'lending' });
        links.push({ source: 'you', target: 'peer_3', type: 'delegation' });

        return { nodes, links };
    }

    function updateNetworkGraph(data) {
        const svg = d3.select('#networkGraph svg');
        const width = svg.node().clientWidth;
        const height = 650;

        // Filter based on visibility
        const visibleNodes = data.nodes.filter(n => visibleNodeTypes.has(n.type));
        const visibleNodeIds = new Set(visibleNodes.map(n => n.id));
        const visibleLinks = data.links.filter(l => {
            const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
            const targetId = typeof l.target === 'object' ? l.target.id : l.target;
            return visibleNodeIds.has(sourceId) && visibleNodeIds.has(targetId) && visibleEdgeTypes.has(l.type);
        });

        // Check if topology actually changed (different node count or node IDs)
        const oldNodeIds = new Set(graphData.nodes.map(n => n.id));
        const newNodeIds = new Set(data.nodes.map(n => n.id));
        const topologyChanged = oldNodeIds.size !== newNodeIds.size ||
            [...newNodeIds].some(id => !oldNodeIds.has(id)) ||
            [...oldNodeIds].some(id => !newNodeIds.has(id));

        // Preserve existing node positions when topology hasn't changed
        if (!topologyChanged && graphData.nodes.length > 0) {
            const oldPositions = new Map(graphData.nodes.map(n => [n.id, { x: n.x, y: n.y, vx: n.vx, vy: n.vy }]));
            visibleNodes.forEach(n => {
                const old = oldPositions.get(n.id);
                if (old && old.x !== undefined) {
                    n.x = old.x;
                    n.y = old.y;
                    n.vx = old.vx || 0;
                    n.vy = old.vy || 0;
                }
            });
        }

        graphData = data;

        // Update counters (top stat cards now show Connected/Known/Mesh/Uptime instead of role counts)
        // Role counts are displayed in the Known Peers stats section

        // Create or update simulation
        if (!graphSimulation || topologyChanged) {
            // Stop old simulation if exists
            if (graphSimulation) {
                graphSimulation.stop();
            }
            // Create new simulation only when topology changes
            graphSimulation = d3.forceSimulation(visibleNodes)
                .force('link', d3.forceLink(visibleLinks).id(d => d.id).distance(150))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(35));
        } else {
            // Just update nodes/links without restarting simulation from scratch
            graphSimulation.nodes(visibleNodes);
            graphSimulation.force('link').links(visibleLinks);
            // Don't restart - positions are already stable
        }
        const simulation = graphSimulation;

        // Edges
        const edges = svg.select('.edges')
            .selectAll('line')
            .data(visibleLinks, d => `${d.source.id || d.source}-${d.target.id || d.target}-${d.type}`)
            .join('line')
            .attr('class', d => `edge-${d.type}`)
            .attr('marker-end', d => d.type === 'lending' ? 'url(#arrowLending)' : d.type === 'delegation' ? 'url(#arrowDelegation)' : null);

        // Nodes
        const nodes = svg.select('.nodes')
            .selectAll('g.node')
            .data(visibleNodes, d => d.id)
            .join(
                enter => {
                    const g = enter.append('g').attr('class', 'node');

                    // Title ring (outer ring) - drawn first so it's behind the node
                    g.filter(d => d.titles && d.titles.length > 0)
                        .append('circle')
                        .attr('class', 'title-ring')
                        .attr('r', d => d.isMe ? 26 : 18)
                        .attr('fill', 'none')
                        .attr('stroke', d => {
                            const titleGrad = window.getOrCreateTitleGradient(d.titles);
                            return titleGrad || 'transparent';
                        })
                        .attr('stroke-width', 4);

                    // Main node circle with role gradient
                    g.append('circle')
                        .attr('class', d => `node-circle node-${d.type}`)
                        .attr('r', d => d.isMe ? 22 : 14)
                        .attr('fill', d => {
                            if (d.isMe) return 'url(#myNodeGradient)';
                            if (d.roles && d.roles.length > 0) {
                                return window.getOrCreateRoleGradient(d.roles);
                            }
                            return window.roleColors ? (window.roleColors[d.type] || '#888888') : '#888888';
                        })
                        .attr('stroke', d => d.isMe ? '#fff' : 'rgba(255,255,255,0.3)')
                        .attr('stroke-width', d => d.isMe ? 3 : 1);

                    // Staking status badge (small icon for pool-operator or delegate)
                    // Pool operator: â¬¢ (hexagon) in purple, positioned top-right
                    g.filter(d => d.stakingStatus === 'pool-operator')
                        .append('text')
                        .attr('class', 'staking-badge staking-badge-operator')
                        .attr('dx', d => d.isMe ? 16 : 10)
                        .attr('dy', d => d.isMe ? -16 : -10)
                        .attr('text-anchor', 'middle')
                        .text('â¬¢');

                    // Delegate: â†— (arrow) in teal, positioned top-right
                    g.filter(d => d.stakingStatus === 'delegate')
                        .append('text')
                        .attr('class', 'staking-badge staking-badge-delegate')
                        .attr('dx', d => d.isMe ? 16 : 10)
                        .attr('dy', d => d.isMe ? -16 : -10)
                        .attr('text-anchor', 'middle')
                        .text('â†—');

                    // Reputation ring (inner glow based on reputation score)
                    // Only show for nodes with non-neutral reputation
                    g.filter(d => !d.isMe && d.reputationScore !== undefined && d.reputationScore !== null)
                        .append('circle')
                        .attr('class', d => {
                            const score = d.reputationScore;
                            if (score >= 90) return 'reputation-ring reputation-trusted';
                            if (score >= 70) return 'reputation-ring reputation-good';
                            if (score >= 50) return 'reputation-ring reputation-neutral';
                            if (score >= 30) return 'reputation-ring reputation-suspect';
                            return 'reputation-ring reputation-untrusted';
                        })
                        .attr('r', d => d.isMe ? 20 : 12)  // Slightly inside the main circle
                        .attr('fill', 'none');

                    // Slashing status badge (warning or removed indicator)
                    // Warned: âš  in yellow, positioned bottom-left
                    g.filter(d => d.slashingStatus === 'warned')
                        .append('text')
                        .attr('class', 'slashing-badge slashing-warned')
                        .attr('dx', d => d.isMe ? -16 : -10)
                        .attr('dy', d => d.isMe ? 16 : 10)
                        .attr('text-anchor', 'middle')
                        .text('âš ');

                    // Removed: âœ• in red, positioned bottom-left
                    g.filter(d => d.slashingStatus === 'removed')
                        .each(function(d) {
                            // Add class to parent group for greying out
                            d3.select(this.parentNode).classed('node-slashed-removed', true);
                        })
                        .append('text')
                        .attr('class', 'slashing-badge slashing-removed')
                        .attr('dx', d => d.isMe ? -16 : -10)
                        .attr('dy', d => d.isMe ? 16 : 10)
                        .attr('text-anchor', 'middle')
                        .text('âœ•');

                    g.append('text')
                        .attr('class', 'node-label')
                        .attr('dy', d => {
                            // Push label down if node has title ring
                            const hasTitle = d.titles && d.titles.length > 0;
                            if (d.isMe) return hasTitle ? 42 : 38;
                            return hasTitle ? 32 : 28;
                        })
                        .attr('text-anchor', 'middle')
                        .text(d => d.isMe ? 'You' : (d.label || d.id));

                    // Role badge (show all roles if multiple)
                    g.filter(d => !d.isMe && d.roles && d.roles.length > 0)
                        .append('text')
                        .attr('class', 'node-role-badge')
                        .attr('dy', d => d.titles && d.titles.length > 0 ? -24 : -20)
                        .attr('text-anchor', 'middle')
                        .text(d => {
                            if (d.roles.length === 1) return d.roles[0].toUpperCase();
                            // Show abbreviated multi-role
                            return d.roles.map(r => r.charAt(0).toUpperCase()).join('+');
                        });

                    return g;
                },
                update => update,
                exit => exit.remove()
            )
            .on('mouseenter', function(event, d) {
                if (!d.isMe) {
                    showNodeTooltip(d, event);
                }
            })
            .on('mouseleave', function(event, d) {
                hideNodeTooltip();
            })
            .call(d3.drag()
                .on('start', function(event, d) {
                    d._dragStartX = event.x;
                    d._dragStartY = event.y;
                    d._wasDragged = false;
                    d._cardWasOpen = (currentStatsPeerId === d.id);
                    dragstarted(event, d);
                })
                .on('drag', function(event, d) {
                    // Check if moved more than 5px - counts as drag
                    const dx = event.x - d._dragStartX;
                    const dy = event.y - d._dragStartY;
                    if (Math.abs(dx) > 5 || Math.abs(dy) > 5) {
                        d._wasDragged = true;
                        hidePeerStatsCard();
                    }
                    dragged(event, d);
                })
                .on('end', function(event, d) {
                    dragended(event, d);
                    if (!d.isMe) {
                        // If card was open before drag, reopen it in new position
                        // Or if it was a click (not drag), open it
                        if (d._cardWasOpen || !d._wasDragged) {
                            showPeerStatsCard(d, event);
                        }
                    }
                }));

        simulation.on('tick', () => {
            edges
                .attr('x1', d => d.source.x)
                .attr('y1', d => d.source.y)
                .attr('x2', d => d.target.x)
                .attr('y2', d => d.target.y);

            nodes.attr('transform', d => `translate(${d.x},${d.y})`);
        });

        function dragstarted(event, d) {
            if (!event.active) simulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) simulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        // Animate data packets
        animateDataPackets(svg, visibleLinks);
    }

    function triggerNodePulse(nodeId, type) {
        const svg = d3.select('#networkGraph svg');
        const nodesGroup = svg.select('.nodes');

        nodesGroup.selectAll('g.node').each(function(d) {
            if (d && (d.id === nodeId || (d.id && nodeId && d.id.includes(nodeId.substring(0, 8))))) {
                const nodeGroup = d3.select(this);
                const colors = {
                    heartbeat: '#ff6b6b',
                    prediction: '#00ff88',
                    observation: '#00aaff'
                };

                const pulseRing = nodeGroup.append('circle')
                    .attr('class', `${type}-ring`)
                    .attr('r', 14)
                    .attr('fill', 'none')
                    .attr('stroke', colors[type] || '#fff')
                    .attr('stroke-width', 3)
                    .attr('opacity', 1);

                pulseRing.transition()
                    .duration(1000)
                    .attr('r', 40)
                    .attr('opacity', 0)
                    .remove();
            }
        });
    }

    function addNodeToGraph(data) {
        const node = {
            id: data.peer_id,
            label: data.peer_id,
            type: getPeerRole(data) || 'predictor',
            isMe: false,
            latency: data.latency || 0
        };

        graphData.nodes.push(node);
        graphData.links.push({ source: 'you', target: data.peer_id, type: 'p2p' });

        updateNetworkGraph(graphData);
    }

    function removeNodeFromGraph(peerId) {
        graphData.nodes = graphData.nodes.filter(n => n.id !== peerId);
        graphData.links = graphData.links.filter(l => {
            const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
            const targetId = typeof l.target === 'object' ? l.target.id : l.target;
            return sourceId !== peerId && targetId !== peerId;
        });

        updateNetworkGraph(graphData);
    }

    function addRelationshipEdge(source, target, type) {
        const exists = graphData.links.some(l => {
            const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
            const targetId = typeof l.target === 'object' ? l.target.id : l.target;
            return sourceId === source && targetId === target && l.type === type;
        });

        if (!exists) {
            graphData.links.push({ source, target, type });
            updateNetworkGraph(graphData);
        }
    }

    function removeRelationshipEdge(source, target, type) {
        graphData.links = graphData.links.filter(l => {
            const sourceId = typeof l.source === 'object' ? l.source.id : l.source;
            const targetId = typeof l.target === 'object' ? l.target.id : l.target;
            return !(sourceId === source && targetId === target && l.type === type);
        });

        updateNetworkGraph(graphData);
    }

    // Store links globally so sendNetworkPacket can access them
    let networkLinks = [];

    function animateDataPackets(svg, links) {
        // Store links for real-time event-driven packets
        networkLinks = links;
        // NOTE: Packets are now sent by real WebSocket events via sendNetworkPacket()
        // No random interval animation - packets only appear when real network activity occurs
    }

    // Send a packet on the network graph triggered by real events
    function sendNetworkPacket(fromNodeId, toNodeId, type) {
        const svg = d3.select('#networkGraph svg');
        if (!svg.node()) return;

        const packets = svg.select('.packets');
        if (!packets.node()) return;

        // Find a relevant link, or use a random link if no match
        let link = networkLinks.find(l =>
            (l.source?.id?.includes(fromNodeId?.substring(0, 8)) ||
             l.target?.id?.includes(toNodeId?.substring(0, 8)))
        );

        // Fallback to random link if no specific match
        if (!link && networkLinks.length > 0) {
            link = networkLinks[Math.floor(Math.random() * networkLinks.length)];
        }

        if (!link || !link.source || !link.target || link.source.x === undefined) return;

        const colors = {
            heartbeat: '#ff6b6b',
            prediction: '#00ff88',
            observation: '#00aaff',
            consensus: '#ffd700',
            p2p: '#00ff88',
            lending: '#aa44ff',
            delegation: '#00d4aa'
        };

        const packet = packets.append('circle')
            .attr('class', 'data-packet')
            .attr('r', 4)
            .attr('cx', link.source.x)
            .attr('cy', link.source.y)
            .attr('fill', colors[type] || '#00ff88')
            .style('filter', `drop-shadow(0 0 4px ${colors[type] || '#00ff88'})`);

        packet.transition()
            .duration(1000)
            .attr('cx', link.target.x)
            .attr('cy', link.target.y)
            .remove();
    }

    // Send a packet TO our node (for received events)
    function sendNetworkPacketToUs(fromPeerId, type) {
        const svg = d3.select('#networkGraph svg');
        if (!svg.node()) {
            console.log('sendNetworkPacketToUs: no svg');
            return;
        }

        const packets = svg.select('.packets');
        if (!packets.node()) {
            console.log('sendNetworkPacketToUs: no packets group');
            return;
        }

        // Guard against calls before graph is initialized
        if (!graphData || !graphData.nodes || graphData.nodes.length === 0) {
            console.log('sendNetworkPacketToUs: graph not initialized yet');
            return;
        }

        // Find our node (type='you' or isMe=true)
        const nodesGroup = svg.select('.nodes');
        let ourNode = null;
        let sourceNode = null;
        nodesGroup.selectAll('g.node').each(function(d) {
            if (d && (d.type === 'you' || d.isMe === true)) {
                ourNode = d;
            }
            // Try to find the source peer node - match by full ID or unique portion
            if (d && fromPeerId && d.id && !d.isMe && d.type !== 'you') {
                // Full match
                if (d.id === fromPeerId) {
                    sourceNode = d;
                }
                // Partial match - use last 12 chars which are unique per peer
                else if (fromPeerId.length > 12 && d.id.endsWith(fromPeerId.slice(-12))) {
                    sourceNode = d;
                }
            }
        });

        if (!ourNode || ourNode.x === undefined) {
            console.log('sendNetworkPacketToUs: our node not found or no position');
            return;
        }

        const colors = {
            heartbeat: '#ff6b6b',
            prediction: '#00ff88',
            observation: '#00aaff',
            consensus: '#ffd700',
            governance: '#aa44ff'
        };

        // Determine start position - use source node if found, otherwise pick a random connected peer
        let startX, startY;
        if (sourceNode && sourceNode.x !== undefined) {
            startX = sourceNode.x;
            startY = sourceNode.y;
        } else {

            // Get all connected peers (not us)
            const connectedPeers = graphData.nodes.filter(n => n && !n.isMe && n.type !== 'you' && n.x !== undefined);
            if (connectedPeers.length > 0) {
                // Pick a random peer from the list
                const randomPeer = connectedPeers[Math.floor(Math.random() * connectedPeers.length)];
                startX = randomPeer.x;
                startY = randomPeer.y;
            } else if (networkLinks.length > 0) {
                // Pick a random link and use the non-us end as start
                const link = networkLinks[Math.floor(Math.random() * networkLinks.length)];
                const isSourceUs = link.source?.type === 'you' || link.source?.isMe;
                const otherEnd = isSourceUs ? link.target : link.source;
                if (otherEnd && otherEnd.x !== undefined) {
                    startX = otherEnd.x;
                    startY = otherEnd.y;
                } else {
                    // Fallback: start from edge of graph
                    startX = ourNode.x + (Math.random() - 0.5) * 200;
                    startY = ourNode.y + (Math.random() - 0.5) * 200;
                }
            } else {
                // No links, start from random offset
                startX = ourNode.x + (Math.random() - 0.5) * 200;
                startY = ourNode.y + (Math.random() - 0.5) * 200;
            }
        }

        // Animate packet FROM source TO our node
        const packet = packets.append('circle')
            .attr('class', 'data-packet')
            .attr('r', 5)
            .attr('cx', startX)
            .attr('cy', startY)
            .attr('fill', colors[type] || '#00ff88')
            .style('filter', `drop-shadow(0 0 6px ${colors[type] || '#00ff88'})`);

        packet.transition()
            .duration(800)
            .attr('cx', ourNode.x)
            .attr('cy', ourNode.y)
            .on('end', function() {
                d3.select(this).remove();
            });
    }

    // Pulse our own node for outgoing broadcasts (heartbeats we send)
    function pulseOwnNode(type) {
        const svg = d3.select('#networkGraph svg');
        if (!svg.node()) {
            console.log('pulseOwnNode: no svg');
            return;
        }

        // Get or create packets group
        let packets = svg.select('.packets');
        if (!packets.node()) {
            packets = svg.append('g').attr('class', 'packets');
        }

        const nodesGroup = svg.select('.nodes');

        const colors = {
            heartbeat: '#ff6b6b',
            prediction: '#00ff88',
            observation: '#00aaff',
            consensus: '#ffd700',
            governance: '#aa44ff'
        };

        // Find our node (type='you' or isMe=true) and create expanding pulse
        let foundOwnNode = false;
        nodesGroup.selectAll('g.node').each(function(d) {
            if (d && (d.type === 'you' || d.isMe === true)) {
                foundOwnNode = true;
                const x = d.x;
                const y = d.y;
                console.log('pulseOwnNode: creating pulse at', x, y, 'color:', colors[type]);

                // Create expanding pulse ring
                const pulse = packets.append('circle')
                    .attr('cx', x)
                    .attr('cy', y)
                    .attr('r', 15)
                    .attr('fill', 'none')
                    .attr('stroke', colors[type] || '#00ff88')
                    .attr('stroke-width', 4)
                    .attr('opacity', 1)
                    .style('filter', `drop-shadow(0 0 8px ${colors[type] || '#00ff88'})`);

                pulse.transition()
                    .duration(1000)
                    .attr('r', 60)
                    .attr('opacity', 0)
                    .on('end', function() {
                        d3.select(this).remove();
                    });
            }
        });
        if (!foundOwnNode) {
            console.log('pulseOwnNode: could not find own node in graph');
        }
    }

    // ============================================
    // LEGEND TOGGLE
    // ============================================
    function toggleNodeType(type) {
        const item = document.querySelector(`.legend-item[data-type="${type}"]`);
        if (visibleNodeTypes.has(type)) {
            visibleNodeTypes.delete(type);
            item.classList.add('hidden');
        } else {
            visibleNodeTypes.add(type);
            item.classList.remove('hidden');
        }
        updateNetworkGraph(graphData);
    }

    function toggleEdgeType(type) {
        const item = document.querySelector(`.legend-item[data-edge="${type}"]`);
        if (visibleEdgeTypes.has(type)) {
            visibleEdgeTypes.delete(type);
            item.classList.add('hidden');
        } else {
            visibleEdgeTypes.add(type);
            item.classList.remove('hidden');
        }
        updateNetworkGraph(graphData);
    }

    // ============================================
    // STREAM VISUALIZATION
    // ============================================
    function initStreamVisualization() {
        const svg = d3.select('#streamVisualization');
        const width = svg.node().clientWidth || 800;
        const height = 125;

        const lanes = ['Predictions', 'Observations', 'Heartbeats', 'Consensus', 'Governance'];
        const laneHeight = height / lanes.length;

        lanes.forEach((lane, i) => {
            svg.append('line')
                .attr('x1', 80)
                .attr('y1', (i + 1) * laneHeight)
                .attr('x2', width)
                .attr('y2', (i + 1) * laneHeight)
                .attr('stroke', 'rgba(255,255,255,0.1)')
                .attr('stroke-dasharray', '5,5');

            svg.append('text')
                .attr('class', 'stream-lane-label')
                .attr('x', 5)
                .attr('y', i * laneHeight + laneHeight / 2 + 4)
                .text(lane);
        });

        // NOTE: Particles are created by real WebSocket events via handleHeartbeat(),
        // handlePrediction(), handleObservation(), handleConsensusVote() - no fake animation needed
    }

    function createStreamParticle(type) {
        const svg = d3.select('#streamVisualization');
        const width = svg.node().clientWidth || 800;
        const height = 125;
        const laneHeight = height / 5;

        const laneMap = { prediction: 0, observation: 1, heartbeat: 2, consensus: 3, governance: 4 };
        const colorMap = { prediction: '#00ff88', observation: '#00aaff', heartbeat: '#ff6b6b', consensus: '#ffd700', governance: '#aa44ff' };

        const lane = laneMap[type] || 0;

        // Add random offset to prevent stacking when multiple arrive at once
        const startOffset = Math.random() * 40;  // 0-40px random offset
        const delay = Math.random() * 200;  // 0-200ms random delay

        const particle = svg.append('circle')
            .attr('r', 4)
            .attr('cx', 80 + startOffset)
            .attr('cy', lane * laneHeight + laneHeight / 2)
            .attr('fill', colorMap[type])
            .style('filter', `drop-shadow(0 0 4px ${colorMap[type]})`)
            .style('opacity', 0);

        // Fade in with delay, then animate across
        particle.transition()
            .delay(delay)
            .duration(100)
            .style('opacity', 1)
            .transition()
            .duration(2500 - delay)
            .ease(d3.easeLinear)
            .attr('cx', width)
            .remove();
    }

    // ============================================
    // ACTIVITY CHART
    // ============================================
    function initActivityChart() {
        const ctx = document.getElementById('activityChart').getContext('2d');
        const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
        const textColor = isDark ? '#fff' : '#344767';

        // Generate default labels (will be replaced by real data)
        const labels = [];
        const now = new Date();
        for (let i = 23; i >= 0; i--) {
            labels.push((now.getHours() - i + 24) % 24 + ':00');
        }

        activityChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    {
                        label: 'Heartbeats',
                        data: Array(24).fill(0),
                        borderColor: '#ff6b6b',
                        backgroundColor: 'rgba(255, 107, 107, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Predictions',
                        data: Array(24).fill(0),
                        borderColor: '#00ff88',
                        backgroundColor: 'rgba(0, 255, 136, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Observations',
                        data: Array(24).fill(0),
                        borderColor: '#00aaff',
                        backgroundColor: 'rgba(0, 170, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Consensus',
                        data: Array(24).fill(0),
                        borderColor: '#ffd700',
                        backgroundColor: 'rgba(255, 215, 0, 0.1)',
                        fill: true,
                        tension: 0.4
                    },
                    {
                        label: 'Governance',
                        data: Array(24).fill(0),
                        borderColor: '#aa44ff',
                        backgroundColor: 'rgba(170, 68, 255, 0.1)',
                        fill: true,
                        tension: 0.4
                    }
                ]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: true,
                        position: 'top',
                        labels: { color: textColor, usePointStyle: true }
                    }
                },
                scales: {
                    x: { grid: { display: false }, ticks: { color: textColor } },
                    y: { grid: { color: 'rgba(255,255,255,0.1)' }, ticks: { color: textColor }, beginAtZero: true }
                }
            }
        });

        // Fetch real activity data
        fetchActivityData();
    }

    function fetchActivityData() {
        fetch('/api/network/activity', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.success && activityChart) {
                    const activity = data.activity;
                    // Update chart with real data - order matches datasets array
                    activityChart.data.labels = activity.labels;
                    activityChart.data.datasets[0].data = activity.heartbeats || Array(24).fill(0);
                    activityChart.data.datasets[1].data = activity.predictions || Array(24).fill(0);
                    activityChart.data.datasets[2].data = activity.observations || Array(24).fill(0);
                    activityChart.data.datasets[3].data = activity.consensus || Array(24).fill(0);
                    activityChart.data.datasets[4].data = activity.governance || Array(24).fill(0);
                    activityChart.update('none');
                }

                // Initialize counters from persisted bridge data (prevents reset on page reload)
                if (data.counts) {
                    const counts = data.counts;
                    // Only update if server count is higher (avoid resetting during live updates)
                    if (counts.heartbeats > counters.heartbeats) {
                        counters.heartbeats = counts.heartbeats;
                        document.getElementById('heartbeatsCount').textContent = counters.heartbeats;
                    }
                    if (counts.predictions > counters.predictions) {
                        counters.predictions = counts.predictions;
                        document.getElementById('predictionsCount').textContent = counters.predictions;
                    }
                    if (counts.observations > counters.observations) {
                        counters.observations = counts.observations;
                        document.getElementById('observationsCount').textContent = counters.observations;
                    }
                    if (counts.consensus_votes > counters.consensus) {
                        counters.consensus = counts.consensus_votes;
                        document.getElementById('consensusCount').textContent = counters.consensus;
                    }
                    if (counts.governance > counters.governance) {
                        counters.governance = counts.governance;
                        document.getElementById('governanceCount').textContent = counters.governance;
                    }
                }
            })
            .catch(error => console.debug('Activity data fetch error:', error));
    }

    // ============================================
    // CONSENSUS TIMELINE
    // ============================================
    function updateConsensusTimeline(phase) {
        const phases = ['observation', 'calculation', 'voting', 'signing', 'distribution'];
        const dots = ['phase1Dot', 'phase2Dot', 'phase3Dot', 'phase4Dot', 'phase5Dot'];
        const currentIndex = phases.indexOf(phase.toLowerCase());

        dots.forEach((dotId, index) => {
            const dot = document.getElementById(dotId);
            if (index < currentIndex) {
                dot.className = 'timeline-step bg-gradient-success';
            } else if (index === currentIndex) {
                dot.className = 'timeline-step bg-gradient-info';
            } else {
                dot.className = 'timeline-step bg-gradient-secondary';
            }
        });
    }

    function updateSignatureIndicator(index, signed) {
        const indicators = document.querySelectorAll('#signatureIndicators .badge');
        if (indicators[index - 1]) {
            indicators[index - 1].className = signed ? 'badge bg-gradient-success me-1' : 'badge bg-gradient-secondary me-1';
        }
    }

    // ============================================
    // DATA FETCHING
    // ============================================

    // Unified status - single source of truth for peer counts
    function fetchUnifiedStatus() {
        fetch('/api/p2p/unified-status', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (!data.success) {
                    console.debug('Unified status not ready:', data.error);
                    return;
                }

                // Update all peer count displays from single atomic source
                const connectedCount = data.connected_count || 0;
                const knownCount = data.known_count || 0;

                // Main stats card
                document.getElementById('connectedPeerCount').textContent = connectedCount;
                document.getElementById('totalPeers').textContent = knownCount;

                // Mesh peer count (unique peers across all GossipSub topics)
                if (data.mesh_peer_count !== undefined) {
                    const newMeshCount = data.mesh_peer_count;
                    document.getElementById('meshPeerCount').textContent = newMeshCount;

                    // Track mesh changes for live events
                    if (lastMeshPeerCount !== null && newMeshCount !== lastMeshPeerCount) {
                        const diff = newMeshCount - lastMeshPeerCount;
                        if (diff > 0) {
                            addEvent('system', `Mesh expanded: +${diff} peer(s) added to mesh (now ${newMeshCount})`);
                        } else {
                            addEvent('system', `Mesh contracted: ${Math.abs(diff)} peer(s) left mesh (now ${newMeshCount})`);
                        }
                    }
                    lastMeshPeerCount = newMeshCount;
                }

                // Peer Tools section
                const toolsCountEl = document.getElementById('connectedPeersToolsCount');
                if (toolsCountEl) {
                    toolsCountEl.textContent = connectedCount;
                }

                // Update my identity info if available
                if (data.my_peer_id) {
                    document.getElementById('myPeerIdFull').textContent = data.my_peer_id;
                    document.getElementById('myPeerId').textContent = data.my_peer_id;
                }
                if (data.my_evrmore_address) {
                    document.getElementById('myEvrmoreAddressFull').textContent = data.my_evrmore_address;
                    document.getElementById('myEvrmoreAddress').textContent = data.my_evrmore_address;
                }
                if (data.my_public_key) {
                    document.getElementById('myPublicKeyFull').textContent = data.my_public_key;
                    document.getElementById('myPublicKey').textContent = data.my_public_key;
                    document.getElementById('myPublicKey').title = data.my_public_key;
                }
                if (data.multiaddr) {
                    document.getElementById('myMultiaddrFull').textContent = data.multiaddr;
                    document.getElementById('myMultiaddr').textContent = data.multiaddr;
                }

                // Update connected peers list in Peer Tools (with latency and roles from known_peers)
                if (data.connected_peers && data.connected_peers.length > 0) {
                    // Build peer objects with latency and roles from known_peers data
                    const connectedWithLatency = data.connected_peers.map(id => {
                        const knownPeer = (data.known_peers || []).find(p => p.peer_id === id);
                        return {
                            id: id,
                            latency: knownPeer ? knownPeer.latency : null,
                            roles: knownPeer ? knownPeer.roles : ['predictor']
                        };
                    });
                    updateConnectedPeersList(connectedWithLatency);
                }

                // Update known peers table if we have full data
                if (data.known_peers) {
                    knownPeersData = data.known_peers;
                    renderKnownPeers(knownPeersData);
                    updatePeerStats(knownPeersData);
                }

                // Update network average latency at the top
                if (data.avg_latency !== undefined && data.avg_latency !== null) {
                    document.getElementById('avgLatency').textContent = data.avg_latency + 'ms';
                }

                // Update uptime percentage (both top stats and heartbeat card)
                if (data.uptime_pct !== undefined && data.uptime_pct !== null) {
                    const uptimePct = (data.uptime_pct * 100).toFixed(1);
                    const heartbeatUptimeEl = document.getElementById('heartbeatUptime');
                    const topUptimeEl = document.getElementById('topUptimePercent');
                    if (heartbeatUptimeEl) heartbeatUptimeEl.textContent = uptimePct + '%';
                    if (topUptimeEl) topUptimeEl.textContent = uptimePct + '%';
                }
            })
            .catch(error => console.debug('Unified status fetch error:', error));
    }

    function refreshAllData() {
        fetchUnifiedStatus();  // Use unified endpoint for peer data
        fetchP2PStatus();      // Still needed for graph, NAT, mode, etc.
        loadPoolStatus();
        loadDelegationStatus();
        fetchProtocolVersion();
        fetchStorageStatus();
        fetchBandwidthStats();
        fetchCuratorStatus();
        fetchArchiverStatus();
        fetchGovernanceStatus();
    }

    // Fetch protocol version info
    // Store features globally for toggle display
    let protocolFeatures = [];

    function fetchProtocolVersion() {
        fetch('/api/p2p/version', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('protocolVersion').textContent = 'v' + (data.current_version || '1.0.0');

                const totalPeers = data.peer_stats?.total_peers || 0;
                const compatiblePeers = data.peer_stats?.compatible_peers || 0;
                const compatPct = totalPeers > 0 ? Math.round((compatiblePeers / totalPeers) * 100) : 100;
                document.getElementById('compatiblePeers').textContent = compatPct + '%';

                const features = data.features || [];
                protocolFeatures = features;
                document.getElementById('featureCount').textContent = features.length + ' enabled â–¼';

                // Build feature list HTML
                const featureListEl = document.getElementById('featureList');
                if (features.length > 0) {
                    let html = '';
                    features.forEach(f => {
                        const name = typeof f === 'string' ? f : (f.name || 'unknown');
                        const enabled = typeof f === 'object' ? f.enabled : true;
                        const displayName = name.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
                        html += `<div class="d-flex justify-content-between py-1 border-bottom" style="border-color: rgba(255,255,255,0.1) !important;">
                            <span>${displayName}</span>
                            <span class="badge ${enabled ? 'bg-success' : 'bg-secondary'}" style="font-size: 9px;">${enabled ? 'ON' : 'OFF'}</span>
                        </div>`;
                    });
                    featureListEl.innerHTML = html;
                } else {
                    featureListEl.innerHTML = '<span class="text-muted">No features detected</span>';
                }

                const progress = data.upgrade_progress || 100;
                document.getElementById('upgradeProgress').style.width = progress + '%';
            })
            .catch(error => console.debug('Protocol version fetch error:', error));
    }

    function toggleFeatureList() {
        const featureList = document.getElementById('featureList');
        const featureCount = document.getElementById('featureCount');
        if (featureList.style.display === 'none') {
            featureList.style.display = 'block';
            featureCount.textContent = protocolFeatures.length + ' enabled â–²';
        } else {
            featureList.style.display = 'none';
            featureCount.textContent = protocolFeatures.length + ' enabled â–¼';
        }
    }

    // Fetch storage redundancy status
    function fetchStorageStatus() {
        fetch('/api/p2p/storage', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // Disk usage - use appropriate unit (bytes, KB, MB, GB)
                const usedBytes = data.disk_usage?.used_bytes || 0;
                let diskUsageText;
                if (usedBytes === 0) {
                    diskUsageText = '0 B';
                } else if (usedBytes < 1024) {
                    diskUsageText = usedBytes + ' B';
                } else if (usedBytes < 1024 * 1024) {
                    diskUsageText = (usedBytes / 1024).toFixed(1) + ' KB';
                } else if (usedBytes < 1024 * 1024 * 1024) {
                    diskUsageText = (usedBytes / 1024 / 1024).toFixed(1) + ' MB';
                } else {
                    diskUsageText = (usedBytes / 1024 / 1024 / 1024).toFixed(2) + ' GB';
                }
                document.getElementById('diskUsage').textContent = diskUsageText;

                // Status badge - based on how many backends are enabled
                const statusEl = document.getElementById('storageStatus');
                const backends = data.backends || {};
                const enabledCount = [backends.memory, backends.file, backends.dht]
                    .filter(b => b && b.enabled).length;

                if (enabledCount >= 2) {
                    statusEl.className = 'badge bg-gradient-success';
                    statusEl.textContent = 'Redundant';
                } else if (enabledCount === 1) {
                    statusEl.className = 'badge bg-gradient-warning';
                    statusEl.textContent = 'Single';
                } else {
                    statusEl.className = 'badge bg-gradient-secondary';
                    statusEl.textContent = 'Inactive';
                }

                // Backend toggles and item counts
                updateBackendStatus('memory', backends.memory);
                updateBackendStatus('file', backends.file);
                updateBackendStatus('dht', backends.dht);

                // Deferred rewards and alerts counts
                if (data.deferred_rewards) {
                    document.getElementById('deferredRewardsCount').textContent =
                        data.deferred_rewards.stored_count || 0;
                }
                if (data.alerts) {
                    document.getElementById('storedAlertsCount').textContent =
                        data.alerts.stored_count || 0;
                }
            })
            .catch(error => console.debug('Storage status fetch error:', error));
    }

    function updateBackendStatus(backendName, backend) {
        const toggleEl = document.getElementById(backendName + 'BackendToggle');
        const itemsEl = document.getElementById(backendName + 'BackendItems');

        // Memory and File backends are always on (no toggle)
        if (backendName === 'memory' || backendName === 'file') {
            if (itemsEl) {
                const items = backend ? (backend.items || 0) : 0;
                itemsEl.textContent = items > 0 ? items + ' items' : 'active';
                itemsEl.className = 'text-success';
                itemsEl.style.fontSize = '10px';
            }
            return;
        }

        // DHT is the only toggleable backend
        if (toggleEl) {
            toggleEl.checked = backend && backend.enabled;
        }
        if (itemsEl) {
            if (backend && backend.enabled) {
                itemsEl.textContent = (backend.items || 0) + ' items';
                itemsEl.className = 'text-success';
                itemsEl.style.fontSize = '10px';
            } else {
                itemsEl.textContent = 'disabled';
                itemsEl.className = 'text-muted';
                itemsEl.style.fontSize = '10px';
            }
        }
    }

    // Toggle storage backend on/off
    function toggleStorageBackend(backend, enabled) {
        fetch('/api/p2p/storage/toggle', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ backend: backend, enabled: enabled })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addEvent('system', `Storage backend "${backend}" ${enabled ? 'enabled' : 'disabled'}`);
                // Refresh status after toggle
                setTimeout(fetchStorageStatus, 500);
            } else {
                // Revert toggle if failed
                const toggleEl = document.getElementById(backend + 'BackendToggle');
                if (toggleEl) toggleEl.checked = !enabled;
                addEvent('system', `Failed to toggle "${backend}": ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Storage toggle error:', error);
            // Revert toggle on error
            const toggleEl = document.getElementById(backend + 'BackendToggle');
            if (toggleEl) toggleEl.checked = !enabled;
            addEvent('system', `Failed to toggle "${backend}": ${error.message}`);
        });
    }

    // Fetch Curator status (Observer view - stats only)
    // Note: Curators = Signers (curation is a job signers perform)
    function fetchCuratorStatus() {
        fetch('/api/p2p/curator/status', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('curatedStreams').textContent = data.curated_streams || 0;
                document.getElementById('trackedOracles').textContent = data.tracked_oracles || 0;
                document.getElementById('unresolvedFlags').textContent = data.unresolved_flags || 0;
                document.getElementById('avgQualityScore').textContent = data.avg_quality_score ?
                    (data.avg_quality_score * 100).toFixed(0) + '%' : '--';
                // active_curators = signer count (curators are signers)
                document.getElementById('activeCurators').textContent = data.active_curators || 0;
            })
            .catch(error => console.debug('Curator status fetch error:', error));
    }

    // Fetch Archiver status (Observer view - stats only)
    // Note: Archivers = Signers (archival is a job signers perform)
    function fetchArchiverStatus() {
        fetch('/api/p2p/archiver/status', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                document.getElementById('localArchives').textContent = data.rounds_archived || data.local_archives || 0;
                document.getElementById('archiveSize').textContent = (data.total_size_mb || data.storage_used / 1024 / 1024 || 0).toFixed(1) + ' MB';
                // network_archivers = signer count (archivers are signers)
                document.getElementById('networkArchivers').textContent = data.network_archivers || 0;

                // Update integrity with dynamic label based on node type
                const integrityLabel = document.getElementById('archiveIntegrityLabel');
                const integrityValue = document.getElementById('archiveIntegrity');

                if (data.integrity !== null && data.integrity !== undefined) {
                    integrityValue.textContent = data.integrity + '%';
                    // Color based on value
                    if (data.integrity >= 95) {
                        integrityValue.className = 'mb-0 text-success';
                    } else if (data.integrity >= 80) {
                        integrityValue.className = 'mb-0 text-warning';
                    } else {
                        integrityValue.className = 'mb-0 text-danger';
                    }
                } else {
                    integrityValue.textContent = '--';
                    integrityValue.className = 'mb-0 text-muted';
                }

                // Update label based on node type (signers see Local, others see Network)
                if (integrityLabel) {
                    integrityLabel.textContent = data.integrity_label || 'Network Integrity';
                }

                // redundancy = signer count (each signer stores a copy)
                document.getElementById('archiveRedundancy').textContent = (data.redundancy || 0) + 'x';
            })
            .catch(error => console.debug('Archiver status fetch error:', error));
    }

    // NOTE: Curator and Archiver action functions removed - all actions now in /signer page

    // Fetch Governance status
    function fetchGovernanceStatus() {
        fetch('/api/p2p/governance/status', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                const badge = document.getElementById('governanceBadge');
                const proposeBtn = document.getElementById('proposeBtn');
                const hint = document.getElementById('governanceHint');

                if (data.can_vote) {
                    badge.className = 'badge bg-gradient-success me-2';
                    badge.textContent = 'Voter';
                    if (hint) hint.style.display = 'none';
                } else {
                    badge.className = 'badge bg-gradient-secondary me-2';
                    badge.textContent = 'Observer';
                    if (hint) hint.style.display = 'block';
                }

                // Show propose button if user has enough stake
                if (data.can_propose) {
                    proposeBtn.style.display = 'inline-block';
                } else {
                    proposeBtn.style.display = 'none';
                }

                document.getElementById('activeProposals').textContent = data.active_proposals || 0;
                document.getElementById('passedProposals').textContent = data.passed_proposals || 0;
                document.getElementById('rejectedProposals').textContent = data.rejected_proposals || 0;
                document.getElementById('myStake').textContent = (data.my_stake || 0) + ' SATORI';
                document.getElementById('myVotingPower').textContent = (data.my_voting_power || 0).toFixed(1);
            })
            .catch(error => console.debug('Governance status fetch error:', error));

        // Also fetch active proposals
        fetchActiveProposals();
    }

    // Fetch active proposals
    function fetchActiveProposals() {
        fetch('/api/p2p/governance/proposals', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                const container = document.getElementById('proposalsContainer');

                if (data.active && data.active.length > 0) {
                    let html = '';
                    data.active.forEach(proposal => {
                        const endsDate = new Date(proposal.voting_ends * 1000);
                        const timeLeft = getTimeLeft(proposal.voting_ends);
                        const typeBadge = getProposalTypeBadge(proposal.proposal_type);

                        html += `
                            <div class="d-flex justify-content-between align-items-center p-2 border-bottom">
                                <div>
                                    <strong>${proposal.title}</strong>
                                    ${typeBadge}
                                    <br>
                                    <small class="text-muted">${proposal.description.substring(0, 80)}...</small>
                                </div>
                                <div class="text-end">
                                    <small class="text-muted d-block">${timeLeft}</small>
                                    <div class="btn-group btn-group-sm">
                                        <button onclick="voteOnProposal('${proposal.proposal_id}', 'yes');" class="btn btn-outline-success py-0">Yes</button>
                                        <button onclick="voteOnProposal('${proposal.proposal_id}', 'no');" class="btn btn-outline-danger py-0">No</button>
                                        <button onclick="showProposalDetails('${proposal.proposal_id}');" class="btn btn-outline-info py-0">Info</button>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div class="text-center text-muted small py-3">No active proposals</div>';
                }
            })
            .catch(error => console.debug('Proposals fetch error:', error));
    }

    // Vote on a proposal
    function voteOnProposal(proposalId, choice) {
        fetch('/api/p2p/governance/vote', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ proposal_id: proposalId, choice: choice })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', `Voted ${choice.toUpperCase()} on proposal`);
                    fetchActiveProposals();
                } else {
                    addEvent('error', 'Vote failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                addEvent('error', 'Vote error: ' + error);
            });
    }

    // Show proposal details modal
    function showProposalDetails(proposalId) {
        fetch(`/api/p2p/governance/proposal/${proposalId}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (!data.proposal) {
                    addEvent('error', 'Proposal not found');
                    return;
                }

                const p = data.proposal;
                const t = data.tally || {};
                const myVote = data.my_vote ? data.my_vote.choice : 'Not voted';

                const total = (t.yes_votes || 0) + (t.no_votes || 0) + (t.abstain_votes || 0);
                const yesPct = total > 0 ? ((t.yes_votes / total) * 100).toFixed(1) : 0;
                const noPct = total > 0 ? ((t.no_votes / total) * 100).toFixed(1) : 0;

                const content = `
                    <h5>${p.title}</h5>
                    <p>${p.description}</p>
                    <hr>
                    <div class="row">
                        <div class="col-6">
                            <strong>Type:</strong> ${p.proposal_type}<br>
                            <strong>Status:</strong> ${p.status}<br>
                            <strong>Proposer:</strong> <code>${p.proposer_address.substring(0, 12)}...</code>
                        </div>
                        <div class="col-6">
                            <strong>Voting Ends:</strong> ${new Date(p.voting_ends * 1000).toLocaleString()}<br>
                            <strong>Total Voters:</strong> ${t.total_voters || 0}<br>
                            <strong>My Vote:</strong> <span class="badge bg-info">${myVote}</span>
                        </div>
                    </div>
                    <hr>
                    <h6>Vote Tally</h6>
                    <div class="progress mb-2" style="height: 25px;">
                        <div class="progress-bar bg-success" style="width: ${yesPct}%">${yesPct}% Yes</div>
                        <div class="progress-bar bg-danger" style="width: ${noPct}%">${noPct}% No</div>
                    </div>
                    <div class="d-flex justify-content-between small text-muted">
                        <span>Quorum: ${t.quorum_reached ? 'Reached' : 'Not reached'}</span>
                        <span>Approval: ${t.approval_reached ? 'Reached' : 'Not reached'}</span>
                    </div>
                `;
                showModal('Proposal Details', content);
            })
            .catch(error => {
                addEvent('error', 'Failed to fetch proposal: ' + error);
            });
    }

    // Show create proposal modal
    function showCreateProposal() {
        const content = `
            <form id="proposalForm">
                <div class="mb-3">
                    <label class="form-label">Title</label>
                    <input type="text" class="form-control" id="proposalTitle" required maxlength="100">
                </div>
                <div class="mb-3">
                    <label class="form-label">Description</label>
                    <textarea class="form-control" id="proposalDescription" rows="4" required></textarea>
                </div>
                <div class="mb-3">
                    <label class="form-label">Type</label>
                    <select class="form-select" id="proposalType">
                        <option value="community">Community</option>
                        <option value="parameter_change">Parameter Change</option>
                        <option value="feature_toggle">Feature Toggle</option>
                        <option value="treasury_spend">Treasury Spend</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Voting Period (days)</label>
                    <input type="number" class="form-control" id="proposalDays" value="7" min="3" max="30">
                </div>
                <button type="submit" class="btn btn-primary w-100">Submit Proposal</button>
            </form>
        `;
        showModal('Create Proposal', content);

        // Handle form submission
        document.getElementById('proposalForm').addEventListener('submit', function(e) {
            e.preventDefault();
            submitProposal();
        });
    }

    // Submit proposal
    function submitProposal() {
        const title = document.getElementById('proposalTitle').value;
        const description = document.getElementById('proposalDescription').value;
        const proposal_type = document.getElementById('proposalType').value;
        const voting_period_days = parseInt(document.getElementById('proposalDays').value);

        fetch('/api/p2p/governance/propose', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ title, description, proposal_type, voting_period_days })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', 'Proposal created: ' + data.proposal_id);
                    closeModal();
                    fetchGovernanceStatus();
                } else {
                    addEvent('error', 'Failed to create proposal: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => {
                addEvent('error', 'Proposal error: ' + error);
            });
    }

    // Helper: get time left
    function getTimeLeft(timestamp) {
        const now = Math.floor(Date.now() / 1000);
        const diff = timestamp - now;
        if (diff <= 0) return 'Ended';
        const days = Math.floor(diff / 86400);
        const hours = Math.floor((diff % 86400) / 3600);
        if (days > 0) return days + 'd ' + hours + 'h left';
        return hours + 'h left';
    }

    // Helper: proposal type badge
    function getProposalTypeBadge(type) {
        const badges = {
            'community': '<span class="badge bg-info ms-1">Community</span>',
            'parameter_change': '<span class="badge bg-warning ms-1">Parameter</span>',
            'feature_toggle': '<span class="badge bg-primary ms-1">Feature</span>',
            'treasury_spend': '<span class="badge bg-success ms-1">Treasury</span>',
            'signer_change': '<span class="badge bg-danger ms-1">Signer</span>',
            'protocol_upgrade': '<span class="badge bg-dark ms-1">Upgrade</span>',
        };
        return badges[type] || '<span class="badge bg-secondary ms-1">' + type + '</span>';
    }

    function fetchBandwidthStats() {
        fetch('/api/p2p/bandwidth', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // Format bytes
                const formatBytes = (bytes) => {
                    if (bytes < 1024) return bytes + ' B';
                    if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
                    return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
                };

                const global = data.global || {};
                document.getElementById('bytesSent').textContent = formatBytes(global.bytes_sent || 0);
                document.getElementById('bytesReceived').textContent = formatBytes(global.bytes_received || 0);
                document.getElementById('messagesPerSec').textContent = (global.messages_per_second || 0).toFixed(1);

                // QoS status
                const qos = data.qos || {};
                const qosEl = document.getElementById('qosStatus');
                if (qos.enabled) {
                    qosEl.className = 'badge bg-gradient-success';
                    qosEl.textContent = 'On';
                } else {
                    qosEl.className = 'badge bg-gradient-secondary';
                    qosEl.textContent = 'Off';
                }

                document.getElementById('dropsRateLimited').textContent = qos.drops_rate_limited || 0;
                document.getElementById('dropsLowPriority').textContent = qos.drops_low_priority || 0;
            })
            .catch(error => console.debug('Bandwidth stats fetch error:', error));
    }

    function fetchP2PStatus() {
        fetch('/api/p2p-status', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // NOTE: Peer counts are now managed by fetchUnifiedStatus() for single source of truth
                // This function only handles: identity info, NAT, mode, graph, relationships

                if (data.peer_id) {
                    // Store full ID in hidden element, display full in horizontal layout
                    document.getElementById('myPeerIdFull').textContent = data.peer_id;
                    document.getElementById('myPeerId').textContent = data.peer_id;
                    document.getElementById('myPeerId').title = 'Click copy button';
                }
                if (data.evrmore_address) {
                    // Store full address in hidden element, display full in horizontal layout
                    document.getElementById('myEvrmoreAddressFull').textContent = data.evrmore_address;
                    document.getElementById('myEvrmoreAddress').textContent = data.evrmore_address;
                    document.getElementById('myEvrmoreAddress').title = 'Click copy button';
                }
                if (data.public_key) {
                    document.getElementById('myPublicKeyFull').textContent = data.public_key;
                    // Show full key, let CSS handle overflow
                    document.getElementById('myPublicKey').textContent = data.public_key;
                    document.getElementById('myPublicKey').title = data.public_key;
                } else {
                    document.getElementById('myPublicKey').textContent = 'Not Available';
                    document.getElementById('myPublicKey').title = 'Public key not yet available - wallet may still be initializing';
                }
                if (data.multiaddr) {
                    // Store full multiaddress in hidden element, display full in horizontal layout
                    document.getElementById('myMultiaddrFull').textContent = data.multiaddr;
                    document.getElementById('myMultiaddr').textContent = data.multiaddr;
                    document.getElementById('myMultiaddr').title = 'Click copy button to share';
                } else {
                    document.getElementById('myMultiaddr').textContent = 'Not available';
                }

                const natStatus = data.nat_type || 'Unknown';
                document.getElementById('myNatStatus').textContent = natStatus;
                document.getElementById('myNatStatus').className = 'badge badge-sm ' +
                    (natStatus === 'Public' ? 'bg-gradient-success' : 'bg-gradient-warning');

                const mode = data.networking_mode || 'central';
                const modeEl = document.getElementById('networkMode');
                const modeColors = { central: 'secondary', hybrid: 'info', p2p: 'success' };
                modeEl.innerHTML = `<span class="badge bg-gradient-${modeColors[mode] || 'info'}">${mode.charAt(0).toUpperCase() + mode.slice(1)}</span>`;

                const modeRadio = document.querySelector(`input[name="modeSelect"][value="${mode}"]`);
                if (modeRadio) modeRadio.checked = true;

                if (data.avg_latency !== undefined) {
                    document.getElementById('avgLatency').textContent = data.avg_latency + 'ms';
                }

                // Update graph with real peer data
                if (data.peers && data.peers.length > 0) {
                    const newGraphData = {
                        nodes: [{ id: 'you', label: 'You', type: 'you', isMe: true }],
                        links: []
                    };

                    data.peers.forEach(peer => {
                        newGraphData.nodes.push({
                            id: peer.id,
                            label: peer.id,
                            type: getPeerRole(peer) || 'predictor',
                            isMe: false,
                            latency: peer.latency
                        });
                        newGraphData.links.push({ source: 'you', target: peer.id, type: 'p2p' });
                    });

                    // Add relationship edges if available
                    if (data.lending_relationships) {
                        data.lending_relationships.forEach(rel => {
                            newGraphData.links.push({ source: rel.lender, target: rel.pool, type: 'lending' });
                        });
                    }

                    if (data.delegation_relationships) {
                        data.delegation_relationships.forEach(rel => {
                            newGraphData.links.push({ source: rel.parent, target: rel.child, type: 'delegation' });
                        });
                    }

                    updateNetworkGraph(newGraphData);
                }

                // NOTE: Connected peers list is now updated by fetchUnifiedStatus()
                // to ensure single source of truth for peer counts
            })
            .catch(error => console.error('Error fetching P2P status:', error));
    }

    // Track last seen event timestamp for polling
    let lastEventTimestamp = 0;

    function pollHeartbeats() {
        // Poll recent events from the bridge (IPC-based, works with gunicorn)
        const since = lastEventTimestamp || (Date.now() / 1000 - 60);  // Last 60s on first poll
        fetch(`/api/network/recent-events?limit=50&since=${since}`, { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (!data.success || !data.events || data.events.length === 0) return;

                data.events.forEach(evt => {
                    const eventType = evt.event;
                    const eventData = evt.data;
                    const key = eventType + '_' + evt.timestamp;

                    // Update last seen timestamp
                    if (evt.timestamp > lastEventTimestamp) {
                        lastEventTimestamp = evt.timestamp;
                    }

                    // Skip if already seen
                    if (lastSeenHeartbeats[key]) return;
                    lastSeenHeartbeats[key] = true;

                    // Handle different event types
                    if (eventType === 'network.heartbeat') {
                        handleHeartbeat(eventData);
                    } else if (eventType === 'network.prediction') {
                        handlePrediction(eventData);
                    } else if (eventType === 'network.observation') {
                        handleObservation(eventData);
                    } else if (eventType === 'network.consensus.vote') {
                        handleConsensusVote(eventData);
                    } else if (eventType === 'network.governance' ||
                               eventType === 'network.governance.vote' ||
                               eventType === 'network.governance.proposal') {
                        handleGovernance(eventData);
                    }
                });

                // Cleanup old entries
                const keys = Object.keys(lastSeenHeartbeats);
                if (keys.length > 500) {
                    keys.slice(0, 250).forEach(k => delete lastSeenHeartbeats[k]);
                }
            })
            .catch(() => {});
    }

    function pollHeartbeatStats() {
        fetch('/api/p2p/heartbeat/stats', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // Update heartbeat card
                const activeIndicator = document.getElementById('heartbeatActiveIndicator');
                const activeText = document.getElementById('heartbeatActiveText');
                const pulseEl = activeIndicator?.querySelector('.heartbeat-pulse-sm');

                if (data.active || data.is_heartbeating) {
                    activeIndicator.className = 'badge bg-gradient-danger';
                    activeText.textContent = 'Active';
                    if (pulseEl) pulseEl.style.display = 'inline-block';
                    // Also update the small status in identity card
                    updateHeartbeatStatus(true, data.last_heartbeat ? new Date(data.last_heartbeat * 1000) : null);
                } else {
                    activeIndicator.className = 'badge bg-gradient-secondary';
                    activeText.textContent = 'Inactive';
                    if (pulseEl) pulseEl.style.display = 'none';
                    updateHeartbeatStatus(false, null);
                }

                // Stats
                document.getElementById('heartbeatsExpected').textContent = data.heartbeats_expected || 0;
                document.getElementById('heartbeatsSent').textContent = data.heartbeats_sent || 0;
                document.getElementById('heartbeatsReceived').textContent = data.heartbeats_received || 0;

                // Uptime percentage
                const uptime = data.uptime_percentage || 0;
                document.getElementById('heartbeatUptime').textContent = (uptime * 100).toFixed(1) + '%';

                // Last heartbeat ago
                if (data.last_heartbeat_ago !== null && data.last_heartbeat_ago !== undefined) {
                    const ago = data.last_heartbeat_ago;
                    if (ago < 60) {
                        document.getElementById('heartbeatLastAgo').textContent = ago + 's ago';
                    } else if (ago < 3600) {
                        document.getElementById('heartbeatLastAgo').textContent = Math.floor(ago / 60) + 'm ago';
                    } else {
                        document.getElementById('heartbeatLastAgo').textContent = Math.floor(ago / 3600) + 'h ago';
                    }
                } else {
                    document.getElementById('heartbeatLastAgo').textContent = '--';
                }

                // Heartbeat round (for uptime tracking)
                if (data.heartbeat_round !== undefined) {
                    document.getElementById('heartbeatCurrentRound').textContent = data.heartbeat_round;
                } else if (data.current_round !== undefined) {
                    // Fallback to current_round if heartbeat_round not provided
                    document.getElementById('heartbeatCurrentRound').textContent = data.current_round;
                }

                // Network Epoch and Round (for rewards/badges)
                if (data.network_epoch !== undefined) {
                    document.getElementById('networkEpoch').textContent = data.network_epoch;
                }
                if (data.network_round !== undefined) {
                    document.getElementById('networkRound').textContent = data.network_round;
                } else if (data.round_in_epoch !== undefined) {
                    document.getElementById('networkRound').textContent = data.round_in_epoch;
                }

                // Last message
                if (data.last_status_message) {
                    document.getElementById('heartbeatLastMessage').textContent = '"' + data.last_status_message + '"';
                }
            })
            .catch(error => {
                console.debug('Heartbeat stats error:', error);
            });
    }

    // ============================================
    // POOL MANAGEMENT
    // ============================================
    function loadPoolStatus() {
        fetch('/api/p2p/pools', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // My pool status
                const statusEl = document.getElementById('myPoolStatus');
                const toggle = document.getElementById('poolOpenToggle');

                if (data.my_pool && data.my_pool.accepting) {
                    statusEl.innerHTML = '<span class="badge bg-gradient-success">Accepting</span>';
                    toggle.checked = true;
                    if (data.my_pool.pool_size_limit) {
                        document.getElementById('myPoolSize').textContent = data.my_pool.pool_size_limit.toFixed(2) + ' SATORI';
                    }
                } else {
                    statusEl.innerHTML = '<span class="badge bg-gradient-secondary">Not Operating</span>';
                    toggle.checked = false;
                }

                // Lending to
                const lendingEl = document.getElementById('lendingTo');
                const leaveBtn = document.getElementById('leavePoolBtn');

                if (data.lending_to) {
                    lendingEl.textContent = truncateId(data.lending_to);
                    leaveBtn.disabled = false;
                } else {
                    lendingEl.textContent = 'Not lending';
                    leaveBtn.disabled = true;
                }

                // Pool contributors
                if (data.pool_contributors) {
                    renderPoolContributors(data.pool_contributors);
                }
            })
            .catch(error => console.error('Pool status error:', error));
    }

    function renderPoolContributors(contributors) {
        const container = document.getElementById('poolContributorsList');
        const countEl = document.getElementById('poolContributorCount');

        if (!contributors || contributors.length === 0) {
            container.innerHTML = '<span class="text-muted">No contributors</span>';
            countEl.textContent = '0';
            return;
        }

        countEl.textContent = contributors.length;
        let html = '<div class="table-responsive"><table class="table table-sm mb-0"><tbody>';

        contributors.forEach(c => {
            html += `
                <tr>
                    <td style="font-family: monospace; font-size: 10px;">${truncateId(c.address)}</td>
                    <td class="text-end">${c.amount ? c.amount.toFixed(2) : '--'}</td>
                    <td class="text-end">
                        <button class="btn btn-link btn-sm p-0 text-danger" onclick="removeContributor('${c.address}');" title="Remove">
                            <i class="material-icons" style="font-size: 16px;">remove_circle</i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function togglePoolOpen() {
        const isOpen = document.getElementById('poolOpenToggle').checked;
        const endpoint = isOpen ? '/pool/lend/enable' : '/pool/lend/disable';

        fetch(endpoint, { method: 'GET' })
            .then(response => {
                if (response.ok) {
                    addEvent('pool', isOpen ? 'Pool opened' : 'Pool closed');
                    loadPoolStatus();
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function joinPool() {
        const address = document.getElementById('joinPoolAddress').value.trim();
        if (address.length !== 34) {
            alert('Please enter a valid 34-character address');
            return;
        }

        fetch('/lend/to/address/' + address, { method: 'GET' })
            .then(response => response.text())
            .then(text => {
                if (text === 'OK') {
                    addEvent('pool', `Joined pool ${truncateId(address)}`);
                    document.getElementById('joinPoolAddress').value = '';
                    loadPoolStatus();
                } else {
                    alert('Unable to join pool: ' + text);
                }
            })
            .catch(error => alert('Error: ' + error));
    }

    function leavePool() {
        if (!confirm('Leave current pool?')) return;

        fetch('/lend/remove', { method: 'GET' })
            .then(response => response.text())
            .then(text => {
                addEvent('pool', 'Left pool');
                loadPoolStatus();
            })
            .catch(error => console.error('Error:', error));
    }

    function removeContributor(address) {
        if (!confirm('Remove contributor ' + truncateId(address) + '?')) return;

        fetch('/pool/addresses/remove', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ address: address })
        })
        .then(response => {
            if (response.ok) {
                addEvent('pool', `Removed ${truncateId(address)} from pool`);
                loadPoolStatus();
            }
        })
        .catch(error => console.error('Error:', error));
    }

    // ============================================
    // DELEGATION MANAGEMENT
    // ============================================
    function loadDelegationStatus() {
        fetch('/api/p2p/delegations', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // My delegate
                const delegateEl = document.getElementById('delegatingTo');
                if (data.my_delegate) {
                    const addr = data.my_delegate.parent_address || data.my_delegate;
                    delegateEl.innerHTML = `
                        <code style="font-size: 10px;">${truncateId(addr)}</code>
                        <span class="badge badge-sm ${data.my_delegate.charity ? 'bg-gradient-warning' : 'bg-gradient-info'} ms-1">
                            ${data.my_delegate.charity ? 'Charity' : 'Standard'}
                        </span>
                    `;
                } else {
                    delegateEl.innerHTML = '<span>Not delegating</span>';
                }

                // Worker reward
                if (data.worker_reward_pct !== undefined) {
                    document.getElementById('currentWorkerReward').textContent = data.worker_reward_pct + '%';
                }

                // Proxy children
                renderProxyChildren(data.my_children);
            })
            .catch(error => console.error('Delegation error:', error));
    }

    function renderProxyChildren(children) {
        const container = document.getElementById('proxyChildrenList');
        const countEl = document.getElementById('proxyChildCount');

        if (!children || children.length === 0) {
            container.innerHTML = '<span class="text-muted">No workers</span>';
            countEl.textContent = '0';
            return;
        }

        countEl.textContent = children.length;
        let html = '<div class="table-responsive"><table class="table table-sm mb-0"><tbody>';

        children.forEach(child => {
            const addr = child.child_address || child.address;
            html += `
                <tr>
                    <td style="font-family: monospace; font-size: 10px;">${truncateId(addr)}</td>
                    <td>${child.pointed ? 'Pointed' : 'No'}</td>
                    <td>
                        <span class="badge badge-sm ${child.charity ? 'bg-gradient-warning' : 'bg-gradient-secondary'}">
                            ${child.charity ? 'Charity' : (child.amount ? child.amount.toFixed(2) : '--')}
                        </span>
                    </td>
                    <td class="text-end">
                        <button class="btn btn-link btn-sm p-0 ${child.charity ? 'text-warning' : 'text-muted'}"
                                onclick="toggleCharity('${addr}', ${child.child}, ${child.charity});" title="${child.charity ? 'Remove charity' : 'Mark as charity'}">
                            <i class="material-icons" style="font-size: 14px;">volunteer_activism</i>
                        </button>
                        <button class="btn btn-link btn-sm p-0 text-danger" onclick="removeWorker('${addr}', ${child.child});" title="Remove">
                            <i class="material-icons" style="font-size: 14px;">remove_circle</i>
                        </button>
                    </td>
                </tr>
            `;
        });

        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    function addWorker() {
        const address = document.getElementById('stakeForAddress').value.trim();
        if (address.length !== 34) {
            alert('Please enter a valid 34-character address');
            return;
        }

        fetch('/stake/for/address/' + address, { method: 'GET' })
            .then(response => response.text())
            .then(text => {
                if (text === 'OK') {
                    addEvent('delegation', `Added worker ${truncateId(address)}`);
                    document.getElementById('stakeForAddress').value = '';
                    loadDelegationStatus();
                } else {
                    alert('Unable to add worker: ' + text);
                }
            })
            .catch(error => alert('Error: ' + error));
    }

    function setWorkerReward() {
        const pct = document.getElementById('workerRewardPct').value;
        if (pct === '' || pct < 0 || pct > 100) {
            alert('Please enter a value between 0 and 100');
            return;
        }

        fetch('/pool/worker/reward/set/' + pct, { method: 'GET' })
            .then(response => response.text())
            .then(text => {
                if (text === 'OK') {
                    addEvent('delegation', `Worker reward set to ${pct}%`);
                    document.getElementById('currentWorkerReward').textContent = pct + '%';
                } else {
                    alert('Unable to set: ' + text);
                }
            })
            .catch(error => alert('Error: ' + error));
    }

    function toggleCharity(address, childId, isCharity) {
        const endpoint = isCharity ? `/api/proxy/child/no_charity/${address}/${childId}` : `/api/proxy/child/charity/${address}/${childId}`;

        fetch(endpoint, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('delegation', `${isCharity ? 'Removed charity status' : 'Marked as charity'}: ${truncateId(address)}`);
                    loadDelegationStatus();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    function removeWorker(address, childId) {
        if (!confirm('Remove worker ' + truncateId(address) + '?')) return;

        fetch(`/api/proxy/child/remove/${address}/${childId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('delegation', `Removed worker ${truncateId(address)}`);
                    loadDelegationStatus();
                } else {
                    alert('Failed: ' + (data.error || 'Unknown error'));
                }
            })
            .catch(error => console.error('Error:', error));
    }

    // ============================================
    // PANEL TOGGLE
    // ============================================
    function togglePanel(panelId) {
        const panel = document.getElementById(panelId);
        const header = panel.previousElementSibling;

        if (panel.classList.contains('show')) {
            panel.classList.remove('show');
            header.classList.add('collapsed');
        } else {
            panel.classList.add('show');
            header.classList.remove('collapsed');
        }
    }

    // ============================================
    // MODE SELECTOR
    // ============================================
    function showModeSelector() {
        document.getElementById('modeModal').style.display = 'block';
    }

    function hideModeSelector() {
        document.getElementById('modeModal').style.display = 'none';
    }

    function saveNetworkMode() {
        const selected = document.querySelector('input[name="modeSelect"]:checked');
        if (!selected) {
            alert('Please select a mode');
            return;
        }

        fetch('/api/networking-mode', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ mode: selected.value })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                hideModeSelector();
                if (confirm('Mode updated. Restart now?')) {
                    window.location.href = '/restart';
                }
            } else {
                alert('Failed: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => alert('Error: ' + error));
    }

    // ============================================
    // UTILITIES
    // ============================================
    function truncateId(id) {
        if (!id) return '--';
        if (id.length <= 12) return id;
        return id.substring(0, 8) + '...' + id.substring(id.length - 4);
    }

    // Truncate peer ID showing only the end (no middle cut) - for network map
    function truncatePeerIdEnd(id, maxLen = 12) {
        if (!id) return '--';
        if (id.length <= maxLen) return id;
        return '...' + id.substring(id.length - maxLen);
    }

    function truncateAddress(addr) {
        if (!addr) return '--';
        if (addr.length <= 16) return addr;
        return addr.substring(0, 8) + '...' + addr.substring(addr.length - 6);
    }

    function truncateMultiaddr(addr) {
        if (!addr) return '--';
        // Extract just the IP and show peer ID suffix
        // /ip4/172.17.0.3/tcp/24600/p2p/16Uiu2HAk... -> /ip4/.../p2p/16Uiu...yz
        const match = addr.match(/\/ip4\/([^\/]+).*\/p2p\/([^\/]+)/);
        if (match) {
            const ip = match[1].length > 10 ? match[1].substring(0, 8) + '...' : match[1];
            const peerId = match[2];
            const shortPeer = peerId.substring(0, 8) + '...' + peerId.substring(peerId.length - 4);
            return `/ip4/${ip}/.../p2p/${shortPeer}`;
        }
        if (addr.length <= 30) return addr;
        return addr.substring(0, 20) + '...' + addr.substring(addr.length - 8);
    }

    function copyToClipboard(elementId, btn) {
        const el = document.getElementById(elementId);
        if (!el) {
            console.error('Element not found:', elementId);
            return;
        }
        const text = el.textContent || el.innerText;
        if (!text || text === 'Loading...' || text === '--') {
            console.log('No valid text to copy');
            return;
        }

        // Try modern clipboard API first, fall back to execCommand
        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(btn);
            }).catch(err => {
                console.error('Clipboard API failed:', err);
                fallbackCopy(text, btn);
            });
        } else {
            fallbackCopy(text, btn);
        }
    }

    // Copy text directly to clipboard (for inline copy buttons)
    function copyText(text, btn) {
        if (!text || text === '--') {
            return;
        }

        if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).then(() => {
                showCopySuccess(btn);
            }).catch(err => {
                console.error('Clipboard API failed:', err);
                fallbackCopy(text, btn);
            });
        } else {
            fallbackCopy(text, btn);
        }
    }

    function fallbackCopy(text, btn) {
        // Fallback for older browsers or non-HTTPS
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.select();
        try {
            document.execCommand('copy');
            showCopySuccess(btn);
        } catch (err) {
            console.error('Fallback copy failed:', err);
            alert('Copy failed. Please copy manually: ' + text);
        }
        document.body.removeChild(textarea);
    }

    function showCopySuccess(btn) {
        const icon = btn.querySelector('i');
        if (icon) {
            icon.textContent = 'check';
            btn.classList.add('copied');
            setTimeout(() => {
                icon.textContent = 'content_copy';
                btn.classList.remove('copied');
            }, 1500);
        }
    }

    // Protocol descriptions for tooltips - loaded from API or fallback to defaults
    let PROTOCOL_DESCRIPTIONS = {};

    // Default fallback descriptions (used before API response)
    const DEFAULT_PROTOCOL_DESCRIPTIONS = {
        // Core libp2p protocols
        '/ipfs/id/1.0.0': 'Identify - Exchange peer information and capabilities',
        '/ipfs/id/push/1.0.0': 'Identify Push - Proactively share identity updates',
        '/ipfs/ping/1.0.0': 'Ping - Measure latency and check peer liveness',
        '/libp2p/circuit/relay/0.2.0/hop': 'Circuit Relay Hop - Relay traffic for NAT traversal',
        '/libp2p/circuit/relay/0.2.0/stop': 'Circuit Relay Stop - Receive relayed connections',
        '/libp2p/dcutr': 'DCUtR - Direct Connection Upgrade through Relay (NAT hole-punching)',
        '/ipfs/kad/1.0.0': 'Kademlia DHT - Distributed hash table for peer/content discovery',
        '/libp2p/autonat/1.0.0': 'AutoNAT - Automatic NAT detection and status',
        '/meshsub/1.0.0': 'GossipSub v1.0 - Pub/sub message propagation',
        '/meshsub/1.1.0': 'GossipSub v1.1 - Enhanced pub/sub with peer scoring',
        '/floodsub/1.0.0': 'FloodSub - Basic flooding pub/sub protocol',
        '/satori/ping/1.0.0': 'Satori Ping - Custom ping with node metadata',
        '/satori/identify/1.0.0': 'Satori Identify - Extended identity with roles/titles',
        '/satori/prediction/1.0.0': 'Prediction Protocol - Submit and receive predictions',
        '/satori/oracle/1.0.0': 'Oracle Protocol - External observation submission',
        '/satori/heartbeat/1.0.0': 'Heartbeat Protocol - Uptime tracking and liveness',
        '/satori/governance/1.0.0': 'Governance Protocol - Proposals and voting',
        '/satori/rewards/1.0.0': 'Rewards Protocol - Reward distribution coordination',
        '/satori/curator/1.0.0': 'Curator Protocol - Data quality curation (signers)',
        '/satori/archiver/1.0.0': 'Archiver Protocol - Historical data storage (signers)',
        // Short name fallbacks
        'gossipsub': 'GossipSub - Pub/sub message propagation protocol',
        'dht': 'Kademlia DHT - Distributed peer and content discovery',
        'relay': 'Circuit Relay - NAT traversal via relay nodes',
        'dcutr': 'DCUtR - Direct connection upgrade (hole-punching)',
        'ping': 'Ping Protocol - Latency measurement',
        'identify': 'Identify Protocol - Peer information exchange',
    };

    // Initialize with defaults, then try to load from API
    PROTOCOL_DESCRIPTIONS = {...DEFAULT_PROTOCOL_DESCRIPTIONS};

    // Fetch protocol descriptions from API
    function fetchProtocolDescriptions() {
        fetch('/api/p2p/protocols/descriptions', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.descriptions) {
                    // Merge API descriptions with defaults (API takes precedence)
                    PROTOCOL_DESCRIPTIONS = {...DEFAULT_PROTOCOL_DESCRIPTIONS, ...data.descriptions};
                    console.log('Protocol descriptions loaded from API');
                }
            })
            .catch(error => {
                console.debug('Using default protocol descriptions:', error.message);
            });
    }

    // Load protocol descriptions on page load
    fetchProtocolDescriptions();

    // Get protocol description (handles both full paths and short names)
    function getProtocolDescription(protocol) {
        if (PROTOCOL_DESCRIPTIONS[protocol]) {
            return PROTOCOL_DESCRIPTIONS[protocol];
        }
        // Try to match by short name
        const shortName = protocol.split('/').pop()?.replace(/\/[\d.]+$/, '') || protocol;
        for (const [key, desc] of Object.entries(PROTOCOL_DESCRIPTIONS)) {
            if (key.includes(shortName) || shortName.includes(key)) {
                return desc;
            }
        }
        return 'Network protocol';
    }

    // Get short display name for protocol
    function getProtocolShortName(protocol) {
        if (!protocol.startsWith('/')) return protocol;
        const parts = protocol.split('/').filter(p => p);
        // Return meaningful part (skip version numbers at end)
        if (parts.length >= 2) {
            const name = parts.slice(0, -1).join('/');
            return name.length > 20 ? parts[parts.length - 2] : name;
        }
        return protocol;
    }

    // Render protocol dropdown content with descriptions
    function renderProtocolDropdownContent(protocols) {
        return protocols.map(p => {
            const shortName = getProtocolShortName(p);
            const desc = getProtocolDescription(p);
            return `<div class="protocol-item" title="${p}">
                <span class="protocol-name">${shortName}</span>
                <span class="protocol-desc">${desc}</span>
            </div>`;
        }).join('');
    }

    // Update My Identity protocols dropdown
    function updateMyProtocols(protocols) {
        const countEl = document.getElementById('myProtocolCount');
        const dropdownEl = document.getElementById('myProtocolsDropdown');
        if (countEl) countEl.textContent = protocols.length;
        if (dropdownEl) {
            dropdownEl.innerHTML = renderProtocolDropdownContent(protocols);
        }
    }

    // Protocols dropdown toggle
    function toggleProtocolsDropdown(id) {
        const dropdown = document.getElementById(id);
        if (!dropdown) return;

        // Close all other dropdowns first
        document.querySelectorAll('.protocols-dropdown-content.show').forEach(el => {
            if (el.id !== id) el.classList.remove('show');
        });

        dropdown.classList.toggle('show');
    }

    // Close dropdowns when clicking outside
    document.addEventListener('click', function(e) {
        if (!e.target.closest('.protocols-dropdown')) {
            document.querySelectorAll('.protocols-dropdown-content.show').forEach(el => {
                el.classList.remove('show');
            });
        }
        // Close peer stats card when clicking outside
        if (!e.target.closest('.peer-stats-card') && !e.target.closest('.node')) {
            hidePeerStatsCard();
        }
    });

    // Current peer being displayed in stats card
    let currentStatsPeerId = null;

    // Show peer stats card on network map node click
    function showPeerStatsCard(nodeData, event) {
        const card = document.getElementById('peerStatsCard');
        const graphContainer = document.getElementById('networkGraph');
        if (!card || !graphContainer) return;

        // Find peer data from knownPeersData
        const peerId = nodeData.id;
        const peer = knownPeersData.find(p => (p.peer_id || p.id) === peerId) || {};

        currentStatsPeerId = peerId;

        // Update card content
        const role = nodeData.type || 'unknown';
        const roleEl = document.getElementById('peerStatsRole');
        roleEl.className = `peer-role-badge peer-role-${role.toLowerCase().replace(/[^a-z]/g, '-')}`;
        roleEl.textContent = role;

        const isConnected = peer.connected === true;
        const statusEl = document.getElementById('peerStatsStatus');
        if (isConnected) {
            statusEl.className = 'badge bg-success badge-xs';
            statusEl.innerHTML = '<i class="material-icons align-middle" style="font-size: 10px;">wifi</i> Connected';
        } else {
            statusEl.className = 'badge bg-secondary badge-xs';
            statusEl.innerHTML = '<i class="material-icons align-middle" style="font-size: 10px;">wifi_off</i> Offline';
        }

        document.getElementById('peerStatsPeerId').textContent = peerId || '--';

        // Use listen_addresses array from API, prefer non-localhost address
        const listenAddrs = peer.listen_addresses || [];
        const multiaddr = listenAddrs.find(a => !a.includes('127.0.0.1')) || listenAddrs[0] || peer.multiaddr || peer.multiaddress || (peerId ? `/p2p/${peerId}` : '--');
        document.getElementById('peerStatsMultiaddr').textContent = multiaddr;

        document.getElementById('peerStatsEvrmore').textContent = peer.evrmore_address || '--';

        const latency = peer.latency || peer.rtt || nodeData.latency;
        document.getElementById('peerStatsLatency').textContent = latency ? `${latency.toFixed(0)} ms` : '--';

        const protocols = peer.protocols || [];
        document.getElementById('peerStatsProtocols').textContent = protocols.length > 0 ? protocols.join(', ') : '--';

        // Position card near the clicked node (but within bounds)
        const containerRect = graphContainer.getBoundingClientRect();
        let x = nodeData.x + 30;
        let y = nodeData.y - 50;

        // Keep card within container bounds
        const cardWidth = 360;
        const cardHeight = 280;
        if (x + cardWidth > containerRect.width) {
            x = nodeData.x - cardWidth - 30;
        }
        if (y < 10) y = 10;
        if (y + cardHeight > containerRect.height) {
            y = containerRect.height - cardHeight - 10;
        }

        card.style.left = `${x}px`;
        card.style.top = `${y}px`;
        card.classList.add('show');
    }

    function hidePeerStatsCard() {
        const card = document.getElementById('peerStatsCard');
        if (card) {
            card.classList.remove('show');
            currentStatsPeerId = null;
        }
    }

    function pingFromStatsCard() {
        if (currentStatsPeerId) {
            quickPing(currentStatsPeerId);
        }
    }

    function copyFromStatsCard() {
        const multiaddr = document.getElementById('peerStatsMultiaddr').textContent;
        if (multiaddr && multiaddr !== '--') {
            const btn = document.getElementById('peerStatsCopyBtn');
            copyText(multiaddr, btn);
        }
    }

    // Node hover tooltip
    function showNodeTooltip(nodeData, event) {
        // Don't show tooltip if stats card is open for this node
        if (currentStatsPeerId === nodeData.id) return;

        const tooltip = document.getElementById('nodeTooltip');
        const graphContainer = document.getElementById('networkGraph');
        if (!tooltip || !graphContainer) return;

        // Find peer data from knownPeersData
        const peerId = nodeData.id;
        const peer = knownPeersData.find(p => (p.peer_id || p.id) === peerId) || {};

        document.getElementById('tooltipPeerId').textContent = peerId || '--';

        // Display all roles with color indicators
        const roles = nodeData.roles || [nodeData.type || 'unknown'];
        const rolesHtml = roles.map(role => {
            const color = window.roleColors ? (window.roleColors[role] || '#888') : '#888';
            return `<span style="color: ${color}; font-weight: 600;">${role}</span>`;
        }).join(', ');
        document.getElementById('tooltipRoles').innerHTML = rolesHtml;

        // Display titles if any
        const titlesRow = document.getElementById('tooltipTitlesRow');
        const titles = nodeData.titles || [];
        if (titles.length > 0) {
            titlesRow.style.display = 'flex';
            const titlesHtml = titles.map(title => {
                const color = window.titleColors ? (window.titleColors[title] || '#888') : '#888';
                // Special styling for legend title
                if (title === 'legend') {
                    return `<span style="background: linear-gradient(90deg, #ff6b6b, #ffd700, #00ff88, #00aaff, #9966ff); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 700;">â˜… ${title}</span>`;
                }
                return `<span style="color: ${color}; font-weight: 600;">â˜… ${title}</span>`;
            }).join(', ');
            document.getElementById('tooltipTitles').innerHTML = titlesHtml;
        } else {
            titlesRow.style.display = 'none';
        }

        // Display staking status if any
        const stakingRow = document.getElementById('tooltipStakingRow');
        const stakingStatus = nodeData.stakingStatus;
        if (stakingStatus) {
            stakingRow.style.display = 'flex';
            const color = window.stakingColors ? (window.stakingColors[stakingStatus] || '#888') : '#888';
            const icon = stakingStatus === 'pool-operator' ? 'â¬¢' : 'â†—';
            const label = stakingStatus === 'pool-operator' ? 'Pool Operator' : 'Delegate';
            document.getElementById('tooltipStaking').innerHTML =
                `<span style="color: ${color}; font-weight: 600;">${icon} ${label}</span>`;
        } else {
            stakingRow.style.display = 'none';
        }

        // Display reputation score if available
        const reputationRow = document.getElementById('tooltipReputationRow');
        const reputationScore = nodeData.reputationScore;
        if (reputationScore !== undefined && reputationScore !== null) {
            reputationRow.style.display = 'flex';
            let repColor, repLabel;
            if (reputationScore >= 90) {
                repColor = '#00ff88';  // Trusted - green
                repLabel = 'Trusted';
            } else if (reputationScore >= 70) {
                repColor = '#00aaff';  // Good - blue
                repLabel = 'Good';
            } else if (reputationScore >= 50) {
                repColor = '#888888';  // Neutral - grey
                repLabel = 'Neutral';
            } else if (reputationScore >= 30) {
                repColor = '#ffaa00';  // Suspect - yellow/orange
                repLabel = 'Suspect';
            } else {
                repColor = '#ff4444';  // Untrusted - red
                repLabel = 'Untrusted';
            }
            document.getElementById('tooltipReputation').innerHTML =
                `<span style="color: ${repColor}; font-weight: 600;">${reputationScore.toFixed(0)} (${repLabel})</span>`;
        } else {
            reputationRow.style.display = 'none';
        }

        // Display slashing status if any
        const slashingRow = document.getElementById('tooltipSlashingRow');
        const slashingStatus = nodeData.slashingStatus;
        if (slashingStatus) {
            slashingRow.style.display = 'flex';
            let slashColor, slashLabel, slashIcon;
            if (slashingStatus === 'removed') {
                slashColor = '#ff4444';
                slashLabel = 'Removed from rewards';
                slashIcon = 'âœ•';
            } else if (slashingStatus === 'warned') {
                slashColor = '#ffcc00';
                slashLabel = 'Warning (50% penalty)';
                slashIcon = 'âš ';
            } else {
                slashColor = '#888';
                slashLabel = slashingStatus;
                slashIcon = '';
            }
            document.getElementById('tooltipSlashing').innerHTML =
                `<span style="color: ${slashColor}; font-weight: 600;">${slashIcon} ${slashLabel}</span>`;
        } else {
            slashingRow.style.display = 'none';
        }

        const isConnected = peer.connected === true;
        document.getElementById('tooltipStatus').textContent = isConnected ? 'Connected' : 'Offline';
        document.getElementById('tooltipStatus').style.color = isConnected ? '#00ff88' : '#888';

        const latency = peer.latency || peer.rtt || nodeData.latency;
        document.getElementById('tooltipLatency').textContent = latency ? `${latency.toFixed(0)} ms` : '--';

        // Position tooltip near the node
        let x = nodeData.x + 20;
        let y = nodeData.y - 60;

        // Keep within bounds
        const containerRect = graphContainer.getBoundingClientRect();
        if (x + 200 > containerRect.width) x = nodeData.x - 180;
        if (y < 10) y = nodeData.y + 30;

        tooltip.style.left = `${x}px`;
        tooltip.style.top = `${y}px`;
        tooltip.classList.add('show');
    }

    function hideNodeTooltip() {
        const tooltip = document.getElementById('nodeTooltip');
        if (tooltip) {
            tooltip.classList.remove('show');
        }
    }

    function toggleFullscreen() {
        const elem = document.documentElement;
        if (!document.fullscreenElement) {
            elem.requestFullscreen().catch(err => console.log(err));
        } else {
            document.exitFullscreen();
        }
    }

    // Close modal on outside click
    window.onclick = function(event) {
        const modal = document.getElementById('modeModal');
        if (event.target === modal) {
            hideModeSelector();
        }
    }

    // ============================================
    // PING / IDENTIFY PROTOCOL FUNCTIONS
    // ============================================
    let knownPeersData = [];
    let pingStats = { sent: 0, totalRtt: 0 };

    // Announce my identity to the network
    function announceIdentity() {
        const btn = document.querySelector('[onclick="announceIdentity();"]');
        btn.disabled = true;
        btn.innerHTML = '<i class="material-icons align-middle spin" style="font-size: 14px;">sync</i>';

        fetch('/api/p2p/identify/announce', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', 'Identity announced to network');
                } else {
                    addEvent('system', 'Identity announce failed: ' + (data.error || 'Unknown'));
                }
            })
            .catch(error => {
                console.error('Announce error:', error);
                addEvent('system', 'Identity announce error');
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="material-icons align-middle" style="font-size: 14px;">cell_tower</i>';
            });
    }

    // Refresh my identity info
    function refreshIdentity() {
        fetch('/api/p2p/identify/stats', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                // API returns peer_id and evrmore_address directly (not in my_identity)
                if (data.peer_id) {
                    document.getElementById('myPeerIdFull').textContent = data.peer_id;
                    document.getElementById('myPeerId').textContent = data.peer_id;
                    document.getElementById('myPeerId').title = 'Click copy button';
                }
                if (data.evrmore_address) {
                    document.getElementById('myEvrmoreAddressFull').textContent = data.evrmore_address;
                    document.getElementById('myEvrmoreAddress').textContent = data.evrmore_address;
                    document.getElementById('myEvrmoreAddress').title = 'Click copy button';
                }
                if (data.public_key) {
                    document.getElementById('myPublicKeyFull').textContent = data.public_key;
                    // Show full key, let CSS handle overflow
                    document.getElementById('myPublicKey').textContent = data.public_key;
                    document.getElementById('myPublicKey').title = data.public_key;
                } else {
                    document.getElementById('myPublicKey').textContent = 'Not Available';
                    document.getElementById('myPublicKey').title = 'Public key not yet available - wallet may still be initializing';
                }
                // Handle protocols at top level
                if (data.protocols && data.protocols.length > 0) {
                    updateMyProtocols(data.protocols);
                }
                // Handle prediction stats
                if (data.active_predictions !== undefined) {
                    document.getElementById('activePredictionsCount').textContent = data.active_predictions;
                    const statusEl = document.getElementById('predictionWorkStatus');
                    if (data.active_predictions > 0) {
                        statusEl.classList.remove('bg-gradient-secondary');
                        statusEl.classList.add('bg-gradient-success');
                    }
                }
                if (data.consensus_participation !== undefined) {
                    document.getElementById('consensusParticipation').textContent = data.consensus_participation;
                    const statusEl = document.getElementById('consensusStatus');
                    if (data.consensus_participation > 0) {
                        statusEl.classList.remove('bg-gradient-secondary');
                        statusEl.classList.add('bg-gradient-info');
                    }
                }
                // Handle legacy my_identity format for compatibility
                if (data.my_identity) {
                    const id = data.my_identity;
                    if (id.peer_id) {
                        document.getElementById('myPeerIdFull').textContent = id.peer_id;
                        document.getElementById('myPeerId').textContent = id.peer_id;
                        document.getElementById('myPeerId').title = 'Click copy button';
                    }
                    if (id.evrmore_address) {
                        document.getElementById('myEvrmoreAddressFull').textContent = id.evrmore_address;
                        document.getElementById('myEvrmoreAddress').textContent = id.evrmore_address;
                        document.getElementById('myEvrmoreAddress').title = 'Click copy button';
                    }
                    // Handle both 'role' (string) and 'roles' (array) formats for own identity
                    const myRole = getPeerRole(id);
                    if (myRole && myRole !== 'unknown') {
                        const roleEl = document.getElementById('myRole');
                        roleEl.textContent = myRole;
                        roleEl.className = 'badge badge-sm ' + getRoleBadgeClass(myRole);
                    }
                    if (id.protocols && id.protocols.length > 0) {
                        updateMyProtocols(id.protocols);
                    }
                }
                addEvent('system', 'Identity refreshed');
            })
            .catch(error => console.error('Refresh identity error:', error));

        // Also fetch titles
        fetchMyTitles();
    }

    // Fetch and display earned titles
    function fetchMyTitles() {
        fetch('/api/p2p/titles', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                const titlesEl = document.getElementById('myTitles');
                if (data.titles && data.titles.length > 0) {
                    titlesEl.innerHTML = data.titles.map(title => {
                        const desc = data.title_descriptions ? data.title_descriptions[title] : '';
                        return `<span class="title-badge ${title}" title="${desc}">${title}</span>`;
                    }).join('');
                } else {
                    titlesEl.innerHTML = '<span class="text-muted small">None yet</span>';
                }
            })
            .catch(error => console.error('Fetch titles error:', error));
    }

    // Connect to a peer by multiaddress
    function connectPeer() {
        const input = document.getElementById('connectMultiaddrInput');
        const multiaddr = input.value.trim();
        if (!multiaddr) {
            alert('Please enter a multiaddress');
            return;
        }

        const btn = document.getElementById('connectBtn');
        const resultDiv = document.getElementById('connectResult');

        btn.disabled = true;
        btn.innerHTML = '<i class="material-icons align-middle spin" style="font-size: 16px;">sync</i>';
        resultDiv.style.display = 'block';
        resultDiv.className = 'ping-result pending';
        resultDiv.innerHTML = '<i class="material-icons align-middle" style="font-size: 14px;">hourglass_empty</i> Connecting...';

        fetch('/api/p2p/connect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ multiaddr: multiaddr })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    resultDiv.className = 'ping-result success';
                    resultDiv.innerHTML = `
                        <i class="material-icons align-middle" style="font-size: 14px;">check_circle</i>
                        Connected successfully!
                    `;
                    addEvent('system', `Connected to peer via ${multiaddr.substring(0, 30)}...`);
                    // Refresh peer list
                    setTimeout(fetchP2PStatus, 1000);
                } else {
                    resultDiv.className = 'ping-result error';
                    resultDiv.innerHTML = `
                        <i class="material-icons align-middle" style="font-size: 14px;">error</i>
                        ${data.error || 'Connection failed'}
                    `;
                    addEvent('system', `Failed to connect: ${data.error || 'unknown'}`);
                }
            })
            .catch(error => {
                resultDiv.className = 'ping-result error';
                resultDiv.innerHTML = `<i class="material-icons align-middle" style="font-size: 14px;">error</i> Error: ${error.message}`;
            })
            .finally(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="material-icons align-middle" style="font-size: 16px;">link</i>';
            });
    }

    // Ping a specific peer
    // Helper to check if input is a multiaddress
    function isMultiaddress(input) {
        return input.startsWith('/ip4/') || input.startsWith('/ip6/') || input.startsWith('/dns');
    }

    // Helper to connect first if multiaddress, then perform action
    async function connectIfNeeded(input, resultDiv, actionName) {
        if (isMultiaddress(input)) {
            resultDiv.innerHTML = `<i class="material-icons align-middle spin" style="font-size: 14px;">sync</i> Connecting first...`;
            try {
                const response = await fetch('/api/p2p/connect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ multiaddr: input })
                });
                const data = await response.json();
                if (!data.success) {
                    resultDiv.className = 'ping-result error';
                    resultDiv.innerHTML = `<i class="material-icons align-middle" style="font-size: 14px;">error</i> Connect failed: ${data.error || 'Unknown'}`;
                    return null;
                }
                addEvent('system', `Connected to ${input.substring(0, 30)}...`);
                // Extract peer ID from multiaddress
                return extractPeerIdFromInput(input);
            } catch (error) {
                resultDiv.className = 'ping-result error';
                resultDiv.innerHTML = `<i class="material-icons align-middle" style="font-size: 14px;">error</i> Connect error: ${error.message}`;
                return null;
            }
        }
        // Already a peer ID
        return input;
    }

    function pingPeer() {
        const input = document.getElementById('pingPeerIdInput');
        const inputValue = input.value.trim();
        if (!inputValue) {
            alert('Please enter a Peer ID or Multiaddress to ping');
            return;
        }

        const btn = document.getElementById('pingBtn');
        const resultDiv = document.getElementById('pingResult');

        btn.disabled = true;
        btn.innerHTML = '<i class="material-icons align-middle spin" style="font-size: 16px;">sync</i>';
        resultDiv.style.display = 'block';
        resultDiv.className = 'ping-result pending';
        resultDiv.innerHTML = '<i class="material-icons align-middle" style="font-size: 14px;">hourglass_empty</i> Pinging...';

        // Connect first if multiaddress, then ping
        connectIfNeeded(inputValue, resultDiv, 'ping').then(peerId => {
            if (!peerId) {
                btn.disabled = false;
                btn.innerHTML = '<i class="material-icons align-middle" style="font-size: 16px;">play_arrow</i>';
                return;
            }

            resultDiv.innerHTML = '<i class="material-icons align-middle" style="font-size: 14px;">hourglass_empty</i> Pinging...';

            fetch('/api/p2p/ping/' + encodeURIComponent(peerId), {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ count: 3 })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const rtt = data.avg_ms;
                        resultDiv.className = 'ping-result success';
                        resultDiv.innerHTML = `
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="material-icons align-middle" style="font-size: 14px;">check_circle</i> Pong received!</span>
                                <span class="rtt-badge ${getRttClass(rtt)}">${rtt.toFixed(1)} ms</span>
                            </div>
                        `;
                        pingStats.sent++;
                        pingStats.totalRtt += rtt;
                        updatePingStats();
                        // Update the peer's RTT in the known peers list
                        updatePeerRtt(peerId, rtt);
                        addEvent('system', `Ping ${truncateId(peerId)}: ${rtt.toFixed(1)}ms`);
                    } else {
                        resultDiv.className = 'ping-result error';
                        resultDiv.innerHTML = `
                            <i class="material-icons align-middle" style="font-size: 14px;">error</i>
                            ${data.error || 'No response (timeout)'}
                        `;
                        addEvent('system', `Ping ${truncateId(peerId)}: timeout`);
                    }
                })
                .catch(error => {
                    resultDiv.className = 'ping-result error';
                    resultDiv.innerHTML = `<i class="material-icons align-middle" style="font-size: 14px;">error</i> Error: ${error.message}`;
                })
                .finally(() => {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="material-icons align-middle" style="font-size: 16px;">play_arrow</i>';
                });
        });
    }

    // Update a peer's RTT in knownPeersData and re-render
    function updatePeerRtt(peerId, rtt) {
        const peer = knownPeersData.find(p => (p.peer_id || p.id) === peerId);
        if (peer) {
            peer.rtt = rtt;
            peer.last_ping = Date.now();
            renderKnownPeers(knownPeersData);
        }
    }

    function updatePingStats() {
        document.getElementById('pingsSent').textContent = pingStats.sent;
        if (pingStats.sent > 0) {
            const avg = pingStats.totalRtt / pingStats.sent;
            document.getElementById('avgRtt').textContent = avg.toFixed(1) + 'ms';
        }
    }

    // Quick ping from connected peers list
    function quickPing(peerId) {
        document.getElementById('pingPeerIdInput').value = peerId;
        pingPeer();
    }

    // Update connected peers list with ping and disconnect buttons
    function updateConnectedPeersList(peers) {
        const container = document.getElementById('connectedPeersList');
        const countBadge = document.getElementById('connectedPeersToolsCount');

        if (!peers || peers.length === 0) {
            container.innerHTML = '<span class="text-muted">No peers connected</span>';
            if (countBadge) countBadge.textContent = '0';
            return;
        }

        if (countBadge) countBadge.textContent = peers.length;

        let html = '';
        peers.slice(0, 10).forEach(peer => {
            const peerId = peer.id || peer.peer_id || peer;
            const role = getPeerRole(peer) || 'predictor';
            const latency = peer.latency ? `${peer.latency}ms` : '--';
            html += `
                <div class="py-1 border-bottom peer-item" data-peer-id="${peerId}">
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <span class="badge bg-gradient-success badge-xs">${role}</span>
                        <div>
                            <span class="text-muted small me-2">${latency}</span>
                            <button class="btn btn-link btn-sm p-0 me-1" onclick="quickPing('${peerId}')" title="Ping">
                                <i class="material-icons" style="font-size: 14px; color: #00ff88;">network_ping</i>
                            </button>
                            <button class="btn btn-link btn-sm p-0" onclick="disconnectPeer('${peerId}')" title="Disconnect">
                                <i class="material-icons" style="font-size: 14px; color: #ff4444;">link_off</i>
                            </button>
                        </div>
                    </div>
                    <code class="small text-break" style="font-size: 9px; word-break: break-all;">${peerId}</code>
                </div>
            `;
        });
        if (peers.length > 10) {
            html += `<div class="text-muted small text-center mt-1">+${peers.length - 10} more peers</div>`;
        }
        container.innerHTML = html;
    }

    // Quick ping from connected peers list
    function quickPing(peerId) {
        document.getElementById('pingPeerIdInput').value = peerId;
        pingPeer();
    }

    // Reconnect to a known peer
    function reconnectPeer(peerId) {
        const btn = event.target.closest('button');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons" style="font-size: 12px;">sync</i>';
        }

        fetch('/api/p2p/identify/reconnect/' + encodeURIComponent(peerId), {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addEvent('system', `Reconnected to ${peerId.substring(0, 20)}...`);
                // Update the peer's connected status and re-render
                const peer = knownPeersData.find(p => (p.peer_id || p.id) === peerId);
                if (peer) {
                    peer.connected = true;
                    renderKnownPeers(knownPeersData);
                }
            } else {
                addEvent('system', `Failed to reconnect: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Error reconnecting to peer:', error);
            addEvent('system', `Reconnect error: ${error.message}`);
        })
        .finally(() => {
            if (btn) {
                btn.disabled = false;
                btn.innerHTML = '<i class="material-icons" style="font-size: 12px;">refresh</i>';
            }
        });
    }

    // Forget a peer (remove from known peers list)
    function forgetPeer(peerId) {
        if (!confirm(`Are you sure you want to forget peer ${peerId.substring(0, 20)}...?`)) {
            return;
        }

        fetch('/api/p2p/identify/forget/' + encodeURIComponent(peerId), {
            method: 'DELETE',
            headers: { 'Content-Type': 'application/json' }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addEvent('system', `Forgot peer ${peerId.substring(0, 20)}...`);
                // Remove from local data and re-render
                knownPeersData = knownPeersData.filter(p => (p.peer_id || p.id) !== peerId);
                renderKnownPeers(knownPeersData);
                updatePeerStats(knownPeersData);
            } else {
                alert('Failed to forget peer: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error forgetting peer:', error);
            alert('Error forgetting peer: ' + error.message);
        });
    }

    // Disconnect a peer
    function disconnectPeer(peerId) {
        fetch('/api/p2p/disconnect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ peer_id: peerId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                addEvent('system', `Disconnected from ${peerId.substring(0, 20)}...`);
                // Remove from UI immediately
                const peerItem = document.querySelector(`.peer-item[data-peer-id="${peerId}"]`);
                if (peerItem) peerItem.remove();
                // Update count in Peer Tools section
                const countBadge = document.getElementById('connectedPeersToolsCount');
                if (countBadge) {
                    const currentCount = parseInt(countBadge.textContent) || 0;
                    countBadge.textContent = Math.max(0, currentCount - 1);
                }
                // Refresh status
                fetchP2PStatus();
            } else {
                addEvent('error', `Failed to disconnect: ${data.error || 'Unknown error'}`);
            }
        })
        .catch(error => {
            console.error('Disconnect error:', error);
            addEvent('error', 'Disconnect failed');
        });
    }

    // ============================================
    // KNOWN PEERS MANAGEMENT
    // ============================================
    function refreshKnownPeers() {
        const btn = document.querySelector('[onclick*="refreshKnownPeers"]');
        if (btn) {
            btn.disabled = true;
            btn.innerHTML = '<i class="material-icons align-middle spin" style="font-size: 14px;">sync</i>';
        }

        fetch('/api/p2p/identify/peers', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                knownPeersData = data.peers || [];
                renderKnownPeers(knownPeersData);
                updatePeerStats(knownPeersData);
                const connectedCount = document.getElementById('connectedPeerCount')?.textContent || '0';
                addEvent('system', `${connectedCount} connected, ${knownPeersData.length} known peers`);
            })
            .catch(error => {
                console.error('Refresh peers error:', error);
                addEvent('system', 'Failed to refresh peers');
            })
            .finally(() => {
                if (btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<i class="material-icons align-middle" style="font-size: 14px;">refresh</i>';
                }
            });
    }

    // ============================================
    // IDENTITY REQUEST FUNCTIONS (Request THEIR identity)
    // ============================================

    function requestIdentityNetwork() {
        addEvent('system', 'Requesting identities from network...');
        fetch('/api/p2p/identify/request/network', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', 'Identity request broadcast to network');
                } else {
                    addEvent('system', 'Request failed: ' + (data.error || 'Unknown'));
                }
                setTimeout(refreshKnownPeers, 2000);
            })
            .catch(error => {
                console.error('Request identity network error:', error);
                addEvent('system', 'Failed to request from network');
            });
    }

    function requestIdentityKnown() {
        addEvent('system', 'Requesting identities from known peers...');
        fetch('/api/p2p/identify/request/known', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', `Identity requested from ${data.count} known peers`);
                } else {
                    addEvent('system', 'Request failed: ' + (data.error || 'Unknown'));
                }
                setTimeout(refreshKnownPeers, 2000);
            })
            .catch(error => {
                console.error('Request identity known error:', error);
                addEvent('system', 'Failed to request from known peers');
            });
    }

    function requestIdentityPeer(peerId) {
        addEvent('system', `Requesting identity from ${peerId.substring(0, 12)}...`);
        fetch(`/api/p2p/identify/request/${peerId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', `Identity request sent to peer`);
                } else {
                    addEvent('system', 'Request failed: ' + (data.error || 'Unknown'));
                }
                setTimeout(refreshKnownPeers, 2000);
            })
            .catch(error => {
                console.error('Request identity peer error:', error);
                addEvent('system', 'Failed to request from peer');
            });
    }

    // ============================================
    // IDENTITY BROADCAST FUNCTIONS (Send OUR identity)
    // ============================================

    function broadcastIdentityNetwork() {
        addEvent('system', 'Broadcasting identity to network...');
        fetch('/api/p2p/identify/announce', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', 'Identity broadcast to network');
                } else {
                    addEvent('system', 'Broadcast failed: ' + (data.error || 'Unknown'));
                }
            })
            .catch(error => {
                console.error('Broadcast identity network error:', error);
                addEvent('system', 'Failed to broadcast to network');
            });
    }

    function broadcastIdentityKnown() {
        addEvent('system', 'Broadcasting identity to known peers...');
        fetch('/api/p2p/identify/broadcast/known', { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', `Identity broadcast to ${data.count} known peers`);
                } else {
                    addEvent('system', 'Broadcast failed: ' + (data.error || 'Unknown'));
                }
            })
            .catch(error => {
                console.error('Broadcast identity known error:', error);
                addEvent('system', 'Failed to broadcast to known peers');
            });
    }

    function broadcastIdentityPeer(peerId) {
        addEvent('system', `Broadcasting identity to ${peerId.substring(0, 12)}...`);
        fetch(`/api/p2p/identify/broadcast/${peerId}`, { method: 'POST' })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    addEvent('system', `Identity sent to peer`);
                } else {
                    addEvent('system', 'Broadcast failed: ' + (data.error || 'Unknown'));
                }
            })
            .catch(error => {
                console.error('Broadcast identity peer error:', error);
                addEvent('system', 'Failed to broadcast to peer');
            });
    }

    // ============================================
    // PEER TOOLS INPUT-BASED IDENTITY FUNCTIONS
    // ============================================

    function extractPeerIdFromInput(input) {
        // Extract peer ID from multiaddress or use as-is
        // Multiaddress format: /ip4/.../tcp/.../p2p/16Uiu2...
        const p2pMatch = input.match(/\/p2p\/([^\/]+)$/);
        if (p2pMatch) {
            return p2pMatch[1];
        }
        // Assume it's already a peer ID
        return input;
    }

    function requestIdentityFromInput() {
        const input = document.getElementById('identityPeerIdInput');
        const value = input.value.trim();
        const resultDiv = document.getElementById('identityResult');

        if (!value) {
            resultDiv.innerHTML = '<span class="text-danger small">Please enter a Peer ID or Multiaddress</span>';
            resultDiv.style.display = 'block';
            return;
        }

        resultDiv.innerHTML = '<span class="text-info small"><i class="material-icons align-middle spin" style="font-size: 12px;">sync</i> Requesting...</span>';
        resultDiv.style.display = 'block';

        // Connect first if multiaddress
        connectIfNeeded(value, resultDiv, 'request identity').then(peerId => {
            if (!peerId) return;

            resultDiv.innerHTML = '<span class="text-info small"><i class="material-icons align-middle spin" style="font-size: 12px;">sync</i> Requesting identity...</span>';

            fetch(`/api/p2p/identify/request/${peerId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resultDiv.innerHTML = '<span class="text-success small"><i class="material-icons align-middle" style="font-size: 12px;">check</i> Request sent</span>';
                        addEvent('system', `Identity request sent to ${peerId.substring(0, 12)}...`);
                        setTimeout(refreshKnownPeers, 2000);
                    } else {
                        resultDiv.innerHTML = `<span class="text-danger small"><i class="material-icons align-middle" style="font-size: 12px;">error</i> ${data.error || 'Failed'}</span>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = '<span class="text-danger small"><i class="material-icons align-middle" style="font-size: 12px;">error</i> Request failed</span>';
                    console.error('Request identity error:', error);
                });
        });
    }

    function broadcastIdentityToInput() {
        const input = document.getElementById('identityPeerIdInput');
        const value = input.value.trim();
        const resultDiv = document.getElementById('identityResult');

        if (!value) {
            resultDiv.innerHTML = '<span class="text-danger small">Please enter a Peer ID or Multiaddress</span>';
            resultDiv.style.display = 'block';
            return;
        }

        resultDiv.innerHTML = '<span class="text-info small"><i class="material-icons align-middle spin" style="font-size: 12px;">sync</i> Sending...</span>';
        resultDiv.style.display = 'block';

        // Connect first if multiaddress
        connectIfNeeded(value, resultDiv, 'broadcast identity').then(peerId => {
            if (!peerId) return;

            resultDiv.innerHTML = '<span class="text-info small"><i class="material-icons align-middle spin" style="font-size: 12px;">sync</i> Sending identity...</span>';

            fetch(`/api/p2p/identify/broadcast/${peerId}`, { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        resultDiv.innerHTML = '<span class="text-success small"><i class="material-icons align-middle" style="font-size: 12px;">check</i> Identity sent</span>';
                        addEvent('system', `Identity sent to ${peerId.substring(0, 12)}...`);
                    } else {
                        resultDiv.innerHTML = `<span class="text-danger small"><i class="material-icons align-middle" style="font-size: 12px;">error</i> ${data.error || 'Failed'}</span>`;
                    }
                })
                .catch(error => {
                    resultDiv.innerHTML = '<span class="text-danger small"><i class="material-icons align-middle" style="font-size: 12px;">error</i> Send failed</span>';
                    console.error('Broadcast identity error:', error);
                });
        });
    }

    // Legacy function - redirects to network request
    function requestIdentities() {
        requestIdentityNetwork();
    }

    function filterPeersByRole() {
        const role = document.getElementById('peerRoleFilter').value;
        let filtered = knownPeersData;
        if (role !== 'all') {
            if (role === 'node') {
                // Filter to peers whose primary role is node (base only)
                filtered = knownPeersData.filter(p => getPeerRole(p) === 'node' || isNodeOnly(p));
            } else {
                // Filter by primary role
                filtered = knownPeersData.filter(p => getPeerRole(p) === role);
            }
        }
        renderKnownPeers(filtered);
    }

    function sortPeers() {
        const sortBy = document.getElementById('peerSortBy').value;
        let sorted = [...knownPeersData];

        switch (sortBy) {
            case 'latency':
                sorted.sort((a, b) => (a.rtt || 9999) - (b.rtt || 9999));
                break;
            case 'role':
                sorted.sort((a, b) => getPeerRole(a).localeCompare(getPeerRole(b)));
                break;
            case 'recent':
                sorted.sort((a, b) => (b.last_seen || 0) - (a.last_seen || 0));
                break;
        }

        renderKnownPeers(sorted);
    }

    function searchPeers() {
        const query = document.getElementById('peerSearchInput').value.toLowerCase().trim();
        if (!query) {
            renderKnownPeers(knownPeersData);
            return;
        }

        const filtered = knownPeersData.filter(p => {
            const peerId = (p.peer_id || p.id || '').toLowerCase();
            const evrmoreAddr = (p.evrmore_address || '').toLowerCase();
            return peerId.includes(query) || evrmoreAddr.includes(query);
        });

        renderKnownPeers(filtered);
    }

    function renderKnownPeers(peers) {
        const tbody = document.getElementById('knownPeersTableBody');
        const countEl = document.getElementById('knownPeersCount');

        countEl.textContent = peers.length;

        if (!peers || peers.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center text-muted py-4">
                        <i class="material-icons" style="font-size: 32px;">search</i>
                        <p class="mb-0 mt-2">No peers discovered yet. Click refresh to scan the network.</p>
                    </td>
                </tr>
            `;
            return;
        }

        let html = '';
        peers.forEach(peer => {
            const peerId = peer.peer_id || peer.id || '--';
            const evrmoreAddr = peer.evrmore_address || '--';
            // Use listen_addresses array from API, prefer non-localhost address
            const listenAddrs = peer.listen_addresses || [];
            const multiaddr = listenAddrs.find(a => !a.includes('127.0.0.1')) || listenAddrs[0] || peer.multiaddr || peer.multiaddress || (peerId !== '--' ? `/p2p/${peerId}` : '--');
            // Handle both 'role' (string) and 'roles' (array) formats
            const roles = peer.roles || (peer.role ? [peer.role] : []);
            const role = roles.length > 0 ? roles[0] : 'unknown';
            // Check both 'latency' (from unified endpoint) and 'rtt' (from ping)
            const rtt = peer.latency || peer.rtt;
            const protocols = peer.protocols || [];
            const isConnected = peer.connected === true;
            const protocolsId = `protocols_${peerId.replace(/[^a-zA-Z0-9]/g, '_')}`;
            const isPending = peer.pending_identify === true;
            const isFromCache = peer.from_cache === true;

            // Helper to render loading spinner for pending data
            const pendingSpinner = '<span class="pending-identify"><i class="material-icons spinning" style="font-size: 12px;">sync</i> Fetching...</span>';
            const cachedBadge = '<span class="cached-badge" title="Data from cache, verifying..."><i class="material-icons" style="font-size: 10px;">cached</i></span>';

            html += `
                <tr class="${isPending ? 'pending-row' : ''} ${isFromCache ? 'cached-row' : ''}">
                    <td>
                        <div class="d-flex align-items-center">
                            <code class="multiaddr-cell" title="${multiaddr}">${multiaddr}</code>
                            <button class="copy-btn-xs ms-1 flex-shrink-0" onclick="copyText('${multiaddr}', this)" title="Copy Multiaddress">
                                <i class="material-icons" style="font-size: 10px;">content_copy</i>
                            </button>
                            ${isFromCache ? cachedBadge : ''}
                        </div>
                    </td>
                    <td>
                        <div class="d-flex align-items-center">
                            ${isPending ? pendingSpinner : `
                                <code class="evrmore-cell" title="${evrmoreAddr}">${evrmoreAddr}</code>
                                ${evrmoreAddr !== '--' ? `<button class="copy-btn-xs ms-1 flex-shrink-0" onclick="copyText('${evrmoreAddr}', this)" title="Copy Evrmore Address">
                                    <i class="material-icons" style="font-size: 10px;">content_copy</i>
                                </button>` : ''}
                            `}
                        </div>
                    </td>
                    <td>
                        <span class="peer-role-badge peer-role-${role.toLowerCase().replace(/[^a-z]/g, '-')}">${role}</span>
                    </td>
                    <td>
                        ${isConnected
                            ? '<span class="badge bg-success badge-xs"><i class="material-icons align-middle" style="font-size: 10px;">wifi</i> Connected</span>'
                            : '<span class="badge bg-secondary badge-xs"><i class="material-icons align-middle" style="font-size: 10px;">wifi_off</i> Offline</span>'}
                    </td>
                    <td>
                        ${rtt !== undefined ? `<span class="rtt-badge ${getRttClass(rtt)}">${rtt.toFixed(0)} ms</span>` : '<span class="text-muted">--</span>'}
                    </td>
                    <td>
                        ${isPending ? pendingSpinner : (protocols.length > 0 ? `
                            <div class="protocols-dropdown">
                                <span class="protocol-tag protocol-trigger" onclick="toggleProtocolsDropdown('${protocolsId}')">
                                    ${protocols.length} protocol${protocols.length > 1 ? 's' : ''} <i class="material-icons" style="font-size: 10px; vertical-align: middle;">expand_more</i>
                                </span>
                                <div id="${protocolsId}" class="protocols-dropdown-content">
                                    ${renderProtocolDropdownContent(protocols)}
                                </div>
                            </div>
                        ` : '<span class="text-muted">--</span>')}
                    </td>
                    <td>
                        <div class="d-flex flex-wrap gap-1">
                            <button class="btn btn-outline-success btn-ping" onclick="quickPing('${peerId}');" title="Ping this peer">
                                <i class="material-icons" style="font-size: 12px;">network_ping</i>
                            </button>
                            <button class="btn btn-outline-primary btn-ping" onclick="requestIdentityPeer('${peerId}');" title="Request their identity">
                                <i class="material-icons" style="font-size: 12px;">download</i>
                            </button>
                            <button class="btn btn-outline-warning btn-ping" onclick="broadcastIdentityPeer('${peerId}');" title="Send my identity">
                                <i class="material-icons" style="font-size: 12px;">upload</i>
                            </button>
                            ${!isConnected ? `<button class="btn btn-outline-info btn-ping" onclick="reconnectPeer('${peerId}');" title="Reconnect to peer">
                                <i class="material-icons" style="font-size: 12px;">refresh</i>
                            </button>` : ''}
                            <button class="btn btn-outline-danger btn-ping" onclick="forgetPeer('${peerId}');" title="Forget this peer">
                                <i class="material-icons" style="font-size: 12px;">person_remove</i>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        });

        tbody.innerHTML = html;
    }

    function updatePeerStats(peers) {
        if (!peers) return;

        document.getElementById('statsTotalPeers').textContent = peers.length;

        // Count by primary role (mutually exclusive - each peer counted once)
        // Uses role hierarchy: signer > oracle > relay > predictor > node
        const nodes = peers.filter(p => getPeerRole(p) === 'node' || isNodeOnly(p)).length;
        const predictors = peers.filter(p => getPeerRole(p) === 'predictor').length;
        const oracles = peers.filter(p => getPeerRole(p) === 'oracle').length;
        const signers = peers.filter(p => getPeerRole(p) === 'signer').length;
        const relays = peers.filter(p => getPeerRole(p) === 'relay').length;
        const poolOperators = peers.filter(p => getPeerRole(p) === 'pool-operator').length;
        const delegates = peers.filter(p => getPeerRole(p) === 'delegate').length;
        const connected = peers.filter(p => p.connected).length;

        document.getElementById('statsNodeCount').textContent = nodes;
        document.getElementById('statsPredictorCount').textContent = predictors;
        document.getElementById('statsOracleCount').textContent = oracles;
        document.getElementById('statsSignerCount').textContent = signers;
        document.getElementById('statsRelayCount').textContent = relays;
        document.getElementById('statsPoolOperatorCount').textContent = poolOperators;
        document.getElementById('statsDelegateCount').textContent = delegates;
        document.getElementById('statsConnectedCount').textContent = connected;

        // Average RTT - update both the stats section and the top latency card
        // Check both 'rtt' and 'latency' fields (latency is the new field from unified endpoint)
        const peersWithRtt = peers.filter(p => (p.rtt !== undefined && p.rtt > 0) || (p.latency !== undefined && p.latency > 0));
        if (peersWithRtt.length > 0) {
            const avgRtt = peersWithRtt.reduce((sum, p) => sum + (p.latency || p.rtt || 0), 0) / peersWithRtt.length;
            document.getElementById('statsAvgRtt').textContent = avgRtt.toFixed(0) + ' ms';
            document.getElementById('avgLatency').textContent = avgRtt.toFixed(0) + 'ms';
        } else {
            document.getElementById('statsAvgRtt').textContent = '--';
        }

        // Update top stats cards
        document.getElementById('connectedPeerCount').textContent = connected;
        document.getElementById('totalPeers').textContent = peers.length;
    }

    // Helper functions
    function getRttClass(rtt) {
        if (rtt < 100) return 'rtt-good';
        if (rtt < 300) return 'rtt-medium';
        return 'rtt-poor';
    }

    function getRoleBadgeClass(role) {
        const roleMap = {
            'node': 'bg-secondary',
            'oracle': 'bg-gradient-info',
            'signer': 'bg-gradient-warning',
            'pool-operator': 'bg-secondary',
            'predictor': 'bg-gradient-success',
            'relay': 'bg-danger',
            'delegate': 'bg-gradient-primary'
        };
        return roleMap[role.toLowerCase()] || 'bg-secondary';
    }

    // CSS for spin animation
    const spinStyle = document.createElement('style');
    spinStyle.textContent = `
        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }
        .spin { animation: spin 1s linear infinite; }
    `;
    document.head.appendChild(spinStyle);

    // Enhanced refreshAllData to include Ping/Identify and System Transparency
    const originalRefreshAllData = refreshAllData;
    refreshAllData = function() {
        originalRefreshAllData();
        refreshIdentity();
        refreshKnownPeers();
        refreshVotingPower();
        refreshUptimeDetails();
        refreshInfrastructure();
    };

    // ============================================
    // SYSTEM TRANSPARENCY FUNCTIONS
    // ============================================

    // Refresh Voting Power Breakdown
    function refreshVotingPower() {
        fetch('/api/p2p/governance/voting-power', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    // Update voting power breakdown
                    const baseStake = data.base_stake || 0;
                    const stakeWeight = baseStake * (data.stake_weight || 1.0);
                    const uptimeBonus = data.uptime_bonus_pct || 0;
                    const signerBonus = data.signer_bonus_pct || 0;
                    const totalPower = data.total_voting_power || 0;
                    const networkTotal = data.network_total_power || 0;
                    const activeVoters = data.active_voters || 0;

                    document.getElementById('vpBaseStake').textContent = baseStake.toFixed(2) + ' SATORI';
                    document.getElementById('vpStakeWeight').textContent = '+' + stakeWeight.toFixed(2);
                    document.getElementById('vpUptimeBonus').textContent = uptimeBonus > 0 ? '+' + uptimeBonus + '%' : '+0%';
                    document.getElementById('vpUptimeBonus').className = uptimeBonus > 0 ? 'text-success' : 'text-warning';
                    document.getElementById('vpSignerBonus').textContent = signerBonus > 0 ? '+' + signerBonus + '%' : '+0%';
                    document.getElementById('vpSignerBonus').className = signerBonus > 0 ? 'text-success' : 'text-muted';
                    document.getElementById('vpTotal').textContent = totalPower.toFixed(2);
                    document.getElementById('vpNetworkTotal').textContent = networkTotal.toFixed(2);
                    document.getElementById('vpActiveVoters').textContent = activeVoters;

                    // Calculate share
                    const share = networkTotal > 0 ? ((totalPower / networkTotal) * 100).toFixed(2) : '0.00';
                    document.getElementById('vpShare').textContent = share + '%';
                }
            })
            .catch(err => console.warn('Failed to fetch voting power:', err));
    }

    // Refresh Uptime Details
    function refreshUptimeDetails() {
        fetch('/api/p2p/uptime/details', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    const streakDays = data.streak_days || 0;
                    const heartbeatsSent = data.heartbeats_sent || 0;
                    const heartbeatsReceived = data.heartbeats_received || 0;
                    const currentRound = data.current_round || '--';
                    const isQualified = data.is_relay_qualified || false;

                    document.getElementById('uptimeStreak').textContent = streakDays + ' days';
                    document.getElementById('uptimeHeartbeatsSent').textContent = heartbeatsSent.toLocaleString();
                    document.getElementById('uptimeHeartbeatsReceived').textContent = heartbeatsReceived.toLocaleString();
                    document.getElementById('uptimeCurrentRound').textContent = currentRound;

                    // Update qualified badge
                    const badge = document.getElementById('uptimeQualifiedBadge');
                    if (isQualified) {
                        badge.textContent = 'Relay Qualified';
                        badge.className = 'badge bg-success';
                    } else {
                        badge.textContent = 'Not Qualified';
                        badge.className = 'badge bg-warning';
                    }

                    // Update progress bar (0-90 days for bonus)
                    const progress = Math.min(100, (streakDays / 90) * 100);
                    document.getElementById('uptimeProgressBar').style.width = progress + '%';
                    if (streakDays >= 90) {
                        document.getElementById('uptimeProgressLabel').textContent = 'âœ“ Bonus Active!';
                        document.getElementById('uptimeProgressBar').className = 'progress-bar bg-success';
                    } else {
                        document.getElementById('uptimeProgressLabel').textContent = streakDays + ' / 90 days to bonus';
                        document.getElementById('uptimeProgressBar').className = 'progress-bar bg-warning';
                    }
                }
            })
            .catch(err => console.warn('Failed to fetch uptime details:', err));
    }

    // Refresh Network Infrastructure
    function refreshInfrastructure() {
        fetch('/api/p2p/infrastructure', { method: 'GET' })
            .then(response => response.json())
            .then(data => {
                if (data.success !== false) {
                    // Rendezvous server
                    const rendezvousPeer = data.rendezvous_peer || '--';
                    const rendezvousLatency = data.rendezvous_latency_ms;
                    // Show full peer ID (element has word-break: break-all for wrapping)
                    document.getElementById('infraRendezvous').textContent = rendezvousPeer;
                    document.getElementById('infraRendezvous').title = rendezvousPeer;

                    const latencyBadge = document.getElementById('infraRendezvousLatency');
                    if (rendezvousLatency !== null && rendezvousLatency !== undefined) {
                        latencyBadge.textContent = rendezvousLatency.toFixed(0) + ' ms';
                        latencyBadge.className = rendezvousLatency < 100 ? 'badge bg-success ms-2' :
                                                 rendezvousLatency < 500 ? 'badge bg-warning ms-2' : 'badge bg-danger ms-2';
                    } else {
                        latencyBadge.textContent = '-- ms';
                        latencyBadge.className = 'badge bg-secondary ms-2';
                    }

                    // Bootstrap peers list
                    const bootstrapPeers = data.bootstrap_peers || [];
                    document.getElementById('infraBootstrapCount').textContent = bootstrapPeers.length;
                    const listEl = document.getElementById('infraBootstrapList');
                    if (bootstrapPeers.length > 0) {
                        let html = '';
                        bootstrapPeers.forEach((peer, idx) => {
                            const peerId = peer.peer_id || peer;
                            const latency = peer.latency_ms;
                            const isRendezvous = peer.is_rendezvous || false;
                            const shortId = typeof peerId === 'string' ? peerId.substring(0, 16) + '...' : peerId;
                            const latencyStr = latency ? `<span class="badge bg-${latency < 100 ? 'success' : latency < 500 ? 'warning' : 'danger'}" style="font-size: 9px;">${latency.toFixed(0)}ms</span>` : '';
                            const starIcon = isRendezvous ? '<i class="material-icons text-warning" style="font-size: 12px;" title="Active Rendezvous">star</i>' : '';
                            html += `<div class="d-flex justify-content-between align-items-center py-1" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                                <code style="font-size: 9px;" title="${peerId}">${shortId}</code>
                                <span>${starIcon} ${latencyStr}</span>
                            </div>`;
                        });
                        listEl.innerHTML = html;
                    } else {
                        listEl.innerHTML = '<span class="text-muted">No bootstrap peers</span>';
                    }

                    // Network stats
                    document.getElementById('infraDhtNodes').textContent = data.dht_nodes || 0;
                    document.getElementById('infraMeshPeers').textContent = data.mesh_peers || 0;

                    // Relay status
                    const relayStatus = data.relay_enabled;
                    const relayBadge = document.getElementById('infraRelayStatus');
                    if (relayStatus === true) {
                        relayBadge.textContent = 'Active';
                        relayBadge.className = 'badge bg-success';
                    } else if (relayStatus === false) {
                        relayBadge.textContent = 'Disabled';
                        relayBadge.className = 'badge bg-secondary';
                    } else {
                        relayBadge.textContent = '--';
                        relayBadge.className = 'badge bg-secondary';
                    }
                }
            })
            .catch(err => console.warn('Failed to fetch infrastructure:', err));
    }

    // =========================================================================
    // CONSENSUS ROUND STATUS
    // =========================================================================

    function refreshConsensusStatus() {
        // Get current consensus round status
        fetch('/api/p2p/consensus/status', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                // Round badge
                document.getElementById('consensusRoundBadge').textContent =
                    'Round #' + (data.current_round || '--');

                // Phase badge
                const phase = data.phase || 'unknown';
                const phaseBadge = document.getElementById('consensusPhase');
                phaseBadge.textContent = phase.charAt(0).toUpperCase() + phase.slice(1);
                phaseBadge.className = 'badge ' + (
                    phase === 'collecting' ? 'bg-info' :
                    phase === 'voting' ? 'bg-warning' :
                    phase === 'finalizing' ? 'bg-success' :
                    phase === 'complete' ? 'bg-secondary' : 'bg-secondary'
                );

                // Progress bar
                const progress = data.progress_percent || 0;
                const progressBar = document.getElementById('consensusProgressBar');
                progressBar.style.width = progress + '%';
                progressBar.setAttribute('aria-valuenow', progress);

                // Times
                if (data.start_time) {
                    const start = new Date(data.start_time * 1000);
                    document.getElementById('consensusStartTime').textContent =
                        start.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } else {
                    document.getElementById('consensusStartTime').textContent = '--';
                }
                if (data.end_time) {
                    const end = new Date(data.end_time * 1000);
                    document.getElementById('consensusEndTime').textContent =
                        end.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                } else {
                    document.getElementById('consensusEndTime').textContent = '--';
                }

                // Stats
                document.getElementById('consensusValidators').textContent = data.validators || 0;
                document.getElementById('consensusVotes').textContent = data.total_votes || 0;
                document.getElementById('consensusStreams').textContent = data.streams_in_round || 0;
                const quorumPct = data.quorum_percent || 0;
                document.getElementById('consensusQuorum').textContent = quorumPct + '%';

                // My participation
                const myStatus = document.getElementById('consensusMyStatus');
                if (data.my_participation) {
                    myStatus.textContent = data.my_participation.is_validator ? 'Validator' : 'Observer';
                    myStatus.className = 'badge ' + (data.my_participation.is_validator ? 'bg-success' : 'bg-info');
                    document.getElementById('consensusMyVotes').textContent = data.my_participation.votes_submitted || 0;
                    document.getElementById('consensusMyStreams').textContent = data.my_participation.streams_scored || 0;
                } else {
                    myStatus.textContent = 'Not Participating';
                    myStatus.className = 'badge bg-secondary';
                    document.getElementById('consensusMyVotes').textContent = '0';
                    document.getElementById('consensusMyStreams').textContent = '0';
                }
            })
            .catch(err => {
                console.error('Failed to load consensus status:', err);
                document.getElementById('consensusPhase').textContent = 'Offline';
                document.getElementById('consensusPhase').className = 'badge bg-danger';
            });

        // Get round history
        fetch('/api/p2p/consensus/history?limit=10', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                const container = document.getElementById('consensusHistoryList');
                const rounds = data.rounds || [];

                document.getElementById('consensusCompletedCount').textContent =
                    (data.total_completed || rounds.length) + ' completed';

                if (rounds.length === 0) {
                    container.innerHTML = '<div class="text-center text-muted small py-3">No completed rounds yet</div>';
                    return;
                }

                container.innerHTML = rounds.map(round => {
                    const endDate = new Date(round.end_time * 1000);
                    const dateStr = endDate.toLocaleDateString() + ' ' + endDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    const statusClass = round.status === 'success' ? 'bg-success' :
                                        round.status === 'failed' ? 'bg-danger' : 'bg-warning';
                    return `
                        <div class="list-group-item py-2 px-3">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="fw-bold text-primary">Round #${round.round_id}</span>
                                    <span class="badge ${statusClass} ms-2">${round.status || 'Unknown'}</span>
                                </div>
                                <small class="text-muted">${dateStr}</small>
                            </div>
                            <div class="d-flex justify-content-between mt-1">
                                <small class="text-muted">
                                    <i class="material-icons align-middle" style="font-size: 12px;">people</i>
                                    ${round.validators || 0} validators
                                </small>
                                <small class="text-muted">
                                    <i class="material-icons align-middle" style="font-size: 12px;">how_to_vote</i>
                                    ${round.total_votes || 0} votes
                                </small>
                                <small class="text-muted">
                                    <i class="material-icons align-middle" style="font-size: 12px;">stream</i>
                                    ${round.streams_scored || 0} streams
                                </small>
                            </div>
                            ${round.my_reward ? `
                                <div class="text-end mt-1">
                                    <span class="badge bg-warning text-dark">
                                        <i class="material-icons align-middle" style="font-size: 12px;">payments</i>
                                        +${round.my_reward} SATORI
                                    </span>
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            })
            .catch(err => {
                console.error('Failed to load consensus history:', err);
                document.getElementById('consensusHistoryList').innerHTML =
                    '<div class="text-center text-danger small py-3">Failed to load history</div>';
            });
    }

    // =========================================================================
    // DISTRIBUTION STATUS (Read-Only)
    // =========================================================================

    function refreshDistributionStatus() {
        fetch('/api/p2p/distribution/status', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                // Last distribution
                if (data.last_distribution) {
                    const lastTime = new Date(data.last_distribution.timestamp * 1000);
                    document.getElementById('distLastTime').textContent =
                        lastTime.toLocaleDateString() + ' ' + lastTime.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                    document.getElementById('distLastAmount').textContent =
                        (data.last_distribution.total_amount || 0).toFixed(2) + ' SATORI';
                    document.getElementById('distLastRecipients').textContent =
                        data.last_distribution.recipient_count || 0;
                } else {
                    document.getElementById('distLastTime').textContent = 'Never';
                    document.getElementById('distLastAmount').textContent = '-- SATORI';
                    document.getElementById('distLastRecipients').textContent = '--';
                }

                // Pending distribution
                const pendingStatus = document.getElementById('distPendingStatus');
                if (data.pending_distribution) {
                    const status = data.pending_distribution.status || 'pending';
                    pendingStatus.textContent = status.charAt(0).toUpperCase() + status.slice(1);
                    pendingStatus.className = 'badge ' + (
                        status === 'ready' ? 'bg-success' :
                        status === 'pending' ? 'bg-warning' :
                        status === 'processing' ? 'bg-info' : 'bg-secondary'
                    );
                    document.getElementById('distPendingAmount').textContent =
                        (data.pending_distribution.pool_amount || 0).toFixed(2) + ' SATORI';
                    document.getElementById('distEligibleCount').textContent =
                        data.pending_distribution.eligible_count || 0;
                } else {
                    pendingStatus.textContent = 'None';
                    pendingStatus.className = 'badge bg-secondary';
                    document.getElementById('distPendingAmount').textContent = '-- SATORI';
                    document.getElementById('distEligibleCount').textContent = '--';
                }

                // My pending rewards
                document.getElementById('distMyPending').textContent =
                    (data.my_pending_reward || 0).toFixed(4) + ' SATORI';
            })
            .catch(err => {
                console.error('Failed to load distribution status:', err);
                document.getElementById('distPendingStatus').textContent = 'Error';
                document.getElementById('distPendingStatus').className = 'badge bg-danger';
            });
    }

    // =========================================================================
    // PROTOCOL STATUS CARDS
    // =========================================================================

    function refreshProtocolStats() {
        // Predictions stats
        fetch('/api/p2p/predictions/stats', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('protocolPredMy').textContent = data.my_predictions || 0;
                document.getElementById('protocolPredCached').textContent = data.cached_predictions || 0;
                const avgScore = data.my_average_score;
                document.getElementById('protocolPredScore').textContent =
                    avgScore !== undefined && avgScore > 0 ? (avgScore * 100).toFixed(1) + '%' : '--';
                document.getElementById('protocolPredStatus').textContent =
                    data.started ? 'Protocol Active | ' + (data.subscribed_streams || 0) + ' streams' : 'Protocol Offline';
                document.getElementById('protocolPredStatus').className =
                    data.started ? 'text-success small' : 'text-danger small';
            })
            .catch(() => {
                document.getElementById('protocolPredStatus').textContent = 'Failed to load';
                document.getElementById('protocolPredStatus').className = 'text-danger small';
            });

        // Oracle stats
        fetch('/api/p2p/oracle/stats', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('protocolOracleReg').textContent = data.my_oracle_registrations || 0;
                document.getElementById('protocolOracleKnown').textContent = data.known_oracles || 0;
                document.getElementById('protocolOracleObs').textContent = data.cached_observations || 0;
                document.getElementById('protocolOracleStatus').textContent =
                    data.started ? 'Protocol Active | ' + (data.subscribed_streams || 0) + ' streams' : 'Protocol Offline';
                document.getElementById('protocolOracleStatus').className =
                    data.started ? 'text-success small' : 'text-danger small';
            })
            .catch(() => {
                document.getElementById('protocolOracleStatus').textContent = 'Failed to load';
                document.getElementById('protocolOracleStatus').className = 'text-danger small';
            });

        // Stream registry stats
        fetch('/api/p2p/streams/stats', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                document.getElementById('protocolStreamMy').textContent = data.my_claims || 0;
                document.getElementById('protocolStreamKnown').textContent = data.known_streams || 0;
                document.getElementById('protocolStreamTotal').textContent = data.total_claims || 0;
                document.getElementById('protocolStreamStatus').textContent =
                    data.started ? 'Registry Active' : 'Registry Offline';
                document.getElementById('protocolStreamStatus').className =
                    data.started ? 'text-success small' : 'text-danger small';
            })
            .catch(() => {
                document.getElementById('protocolStreamStatus').textContent = 'Failed to load';
                document.getElementById('protocolStreamStatus').className = 'text-danger small';
            });
    }

    // =========================================================================
    // BADGE SYSTEM FUNCTIONS
    // =========================================================================

    // Rarity colors for badge display
    const rarityColors = {
        'common': '#9e9e9e',
        'uncommon': '#4CAF50',
        'rare': '#2196F3',
        'epic': '#9C27B0',
        'legendary': '#FF9800',
        'mythic': '#E91E63'
    };

    // Rarity display order (for finding highest)
    const rarityOrder = ['common', 'uncommon', 'rare', 'epic', 'legendary', 'mythic'];

    function loadMyBadges() {
        // Load badges
        fetch('/api/badges/my', { method: 'GET' })
            .then(r => r.json())
            .then(badgesData => {
                // Update badge count
                document.getElementById('badgeTotalCount').textContent = badgesData.total || 0;

                // Find highest rarity
                let highestRarity = 'common';
                let highestRarityIdx = 0;
                if (badgesData.badges && badgesData.badges.length > 0) {
                    for (const badge of badgesData.badges) {
                        const rarity = badge.rarity || 'common';
                        const idx = rarityOrder.indexOf(rarity.toLowerCase());
                        if (idx > highestRarityIdx) {
                            highestRarityIdx = idx;
                            highestRarity = rarity;
                        }
                    }
                }

                const rarityEl = document.getElementById('badgeHighestRarity');
                rarityEl.textContent = highestRarity.charAt(0).toUpperCase() + highestRarity.slice(1);
                rarityEl.style.color = rarityColors[highestRarity.toLowerCase()] || '#9e9e9e';

                // Display earned badges
                const badgesList = document.getElementById('earnedBadgesList');
                if (badgesData.badges && badgesData.badges.length > 0) {
                    // Sort by earned_at descending, show most recent 10
                    const recentBadges = badgesData.badges
                        .sort((a, b) => (b.earned_at || 0) - (a.earned_at || 0))
                        .slice(0, 10);

                    badgesList.innerHTML = recentBadges.map(badge => {
                        const rarity = (badge.rarity || 'common').toLowerCase();
                        const color = rarityColors[rarity] || '#9e9e9e';
                        const name = badge.name || badge.badge_id || 'Badge';
                        const title = `${name}\n${badge.description || ''}\nRarity: ${rarity}`;
                        return `<span class="badge" style="background-color: ${color}; font-size: 0.75rem;" title="${title}">${name}</span>`;
                    }).join('');
                } else {
                    badgesList.innerHTML = '<span class="text-muted small">No badges earned yet. Keep participating!</span>';
                }

                // Update category summary
                const catSummary = document.getElementById('badgeCategorySummary');
                if (badgesData.by_category && Object.keys(badgesData.by_category).length > 0) {
                    catSummary.style.display = 'block';
                    document.getElementById('badgeCatRank').textContent =
                        (badgesData.by_category['rank'] || []).length;
                    document.getElementById('badgeCatStreak').textContent =
                        (badgesData.by_category['streak'] || []).length;
                    document.getElementById('badgeCatAchieve').textContent =
                        (badgesData.by_category['achievement'] || []).length;
                    document.getElementById('badgeCatCommunity').textContent =
                        (badgesData.by_category['community'] || []).length;

                    // Update rank badge count
                    document.getElementById('badgeRank').textContent =
                        (badgesData.by_category['rank'] || []).length;
                }
            })
            .catch(e => {
                console.error('Failed to load badges:', e);
                document.getElementById('earnedBadgesList').innerHTML =
                    '<span class="text-muted small">Failed to load badges</span>';
            });

        // Load progress
        fetch('/api/badges/progress', { method: 'GET' })
            .then(r => r.json())
            .then(progressData => {
                const progressBar = document.getElementById('badgeProgressBar');
                const progressPct = document.getElementById('badgeProgressPct');
                const progressText = document.getElementById('badgeProgressText');
                const streakDays = document.getElementById('badgeStreakDays');

                // Update streak days
                if (progressData.streak) {
                    streakDays.textContent = progressData.streak.current_days || 0;

                    // Use streak progress for the bar
                    const pct = progressData.streak.progress_percent || 0;
                    progressBar.style.width = pct + '%';
                    progressPct.textContent = pct + '%';
                    progressText.textContent = `${progressData.streak.current_days || 0}/${progressData.streak.days_needed || 7} days to ${progressData.streak.next_badge || 'STREAK_EPOCH'}`;
                }
            })
            .catch(e => {
                console.error('Failed to load badge progress:', e);
            });
    }

    function loadBadgeLeaderboard() {
        fetch('/api/badges/leaderboard?limit=10', { method: 'GET' })
            .then(r => r.json())
            .then(data => {
                const list = document.getElementById('badgeLeaderboardList');
                if (data.leaderboard && data.leaderboard.length > 0) {
                    list.innerHTML = data.leaderboard.map((entry, idx) => {
                        const rankIcon = idx === 0 ? 'ðŸ¥‡' : idx === 1 ? 'ðŸ¥ˆ' : idx === 2 ? 'ðŸ¥‰' : `#${entry.rank}`;
                        const addrShort = entry.address ? entry.address.substring(0, 12) + '...' : 'Unknown';
                        return `
                            <div class="list-group-item d-flex justify-content-between align-items-center py-2 px-3">
                                <div>
                                    <span class="me-2">${rankIcon}</span>
                                    <code class="small">${addrShort}</code>
                                </div>
                                <span class="badge bg-warning text-dark">${entry.badge_count} badges</span>
                            </div>
                        `;
                    }).join('');
                } else {
                    list.innerHTML = '<div class="text-center text-muted small py-3">No badge holders yet. Be the first!</div>';
                }
            })
            .catch(e => {
                console.error('Failed to load badge leaderboard:', e);
                document.getElementById('badgeLeaderboardList').innerHTML =
                    '<div class="text-center text-danger small py-3">Failed to load leaderboard</div>';
            });
    }

    // Call on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Existing code runs, also add protocol stats, consensus, and distribution
        setTimeout(refreshProtocolStats, 500);
        setTimeout(refreshConsensusStatus, 600);
        setTimeout(refreshDistributionStatus, 700);
        setTimeout(loadMyBadges, 800);
        setTimeout(loadBadgeLeaderboard, 900);
        setInterval(refreshProtocolStats, 60000);
        setInterval(refreshConsensusStatus, 30000);  // Consensus updates more frequently
        setInterval(refreshDistributionStatus, 60000);
        setInterval(loadMyBadges, 300000);  // Refresh badges every 5 minutes
        setInterval(loadBadgeLeaderboard, 300000);
    });
</script>
{% endblock %}
