{% extends "base.html" %}

{% block title %}Satori - Dashboard{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg px-4">
    <span class="navbar-brand">
        Satori
        <small class="text-muted ms-2" style="font-size: 0.65rem; font-weight: 400; opacity: 0.6;">{{ version }}</small>
    </span>
    <div class="ms-auto d-flex align-items-center">
        <span class="me-3">
            <span class="status-indicator status-online" id="statusIndicator"></span>
            <span id="statusText">Connected</span>
        </span>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm me-2">Logout</a>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <i class="material-icons" id="themeIcon">light_mode</i>
        </button>
    </div>
</nav>

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- Wallet Section -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">account_balance_wallet</i>
                        Wallet
                    </h5>
                    <a href="#" class="small text-muted" onclick="toggleIdentityWallet(); return false;">
                        <i class="material-icons align-middle" style="font-size: 16px;">badge</i>
                        Identity
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Left side: QR Code and Address -->
                        <div class="col-lg-6 mb-4 mb-lg-0">
                            <div class="text-center mb-3">
                                <div id="walletQrCode" class="mb-3" style="display: inline-block; background: white; padding: 10px; border-radius: 10px;">
                                    <p class="text-muted mb-0">Loading QR code...</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Wallet Address</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="walletAddress" readonly placeholder="Loading...">
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('walletAddress')" title="Copy to clipboard">
                                        <i class="material-icons align-middle">content_copy</i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-center">
                                <p id="showPrivateKeyBtn" class="text-danger mb-2" style="cursor: pointer;" onclick="togglePrivateKey()">
                                    <i class="material-icons align-middle" style="font-size: 18px;">visibility</i>
                                    Show Private Key
                                </p>
                                <div id="privateKeySection" style="display: none;">
                                    <p class="text-muted mb-2" style="cursor: pointer;" onclick="togglePrivateKey()">
                                        <i class="material-icons align-middle" style="font-size: 18px;">visibility_off</i>
                                        Hide Private Key
                                    </p>
                                    <div class="alert alert-warning" style="word-break: break-all;">
                                        <small><strong>Private Key:</strong></small><br>
                                        <code id="walletPrivateKey">Loading...</code>
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyPrivateKey()">
                                        <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                                        Copy Private Key
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right side: Send Tokens -->
                        <div class="col-lg-6">
                            <h6 class="mb-3">
                                <i class="material-icons align-middle me-1">send</i>
                                Send SATORI
                            </h6>
                            <div class="mb-3">
                                <label class="form-label">Send From</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sendSource" id="sendFromVault" value="vault" checked>
                                        <label class="form-check-label" for="sendFromVault">
                                            Vault <small class="text-muted" id="vaultBalanceLabel">(--)</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sendSource" id="sendFromWallet" value="wallet">
                                        <label class="form-check-label" for="sendFromWallet">
                                            Identity Wallet <small class="text-muted" id="walletBalanceLabel">(--)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Destination Address</label>
                                <input type="text" class="form-control" id="sendDestAddress" placeholder="Enter destination address (E...)">
                            </div>
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">Amount</label>
                                    <input type="number" class="form-control" id="sendAmount" placeholder="0.00" step="0.00000001" min="0">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Sweep All</label>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="sendSweep" onchange="toggleSweepAmount()">
                                        <label class="form-check-label" for="sendSweep">Send All</label>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" onclick="sendTransaction()" id="sendBtn">
                                <i class="material-icons align-middle me-1">send</i>
                                Send Transaction
                            </button>
                            <div id="sendResult" class="mt-3" style="display: none;"></div>
                            <p class="text-muted small mt-3 mb-0">
                                Transaction fees will be paid during the send process. They typically amount to no more than 0.25 EVR.
                            </p>
                        </div>
                    </div>

                    <!-- Identity Wallet (Collapsed) -->
                    <div id="identityWalletSection" style="display: none;" class="mt-4 pt-4 border-top">
                        <h6 class="text-muted mb-3">
                            <i class="material-icons align-middle me-1">badge</i>
                            Identity Wallet (for digital identity only - do not send tokens here)
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label class="form-label small">Identity Address</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="identityAddress" readonly placeholder="Loading...">
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('identityAddress')" title="Copy">
                                        <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Identity Private Key</label>
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control" id="identityPrivateKey" readonly placeholder="Click to reveal...">
                                    <button class="btn btn-outline-secondary" onclick="toggleIdentityPrivateKey()" title="Show/Hide">
                                        <i class="material-icons align-middle" style="font-size: 16px;" id="identityKeyIcon">visibility</i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="copyIdentityPrivateKey()" title="Copy">
                                        <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">account_balance_wallet</i>
                        Balance
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshBalance()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row text-center py-3">
                        <div class="col-md-4 col-6 mb-3 mb-md-0">
                            <h3 id="tokenBalance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </h3>
                            <p class="text-muted mb-0">SATORI Token</p>
                        </div>
                        <div class="col-md-4 col-6 mb-3 mb-md-0">
                            <h3 id="stakeBalance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </h3>
                            <p class="text-muted mb-0">SATORI Stake</p>
                        </div>
                        <div class="col-md-4 col-12">
                            <h3 id="evrBalance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </h3>
                            <p class="text-muted mb-0">Evrmore (EVR)</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reward Address Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">card_giftcard</i>
                        Reward Address
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Current Address</label>
                        <input type="text" class="form-control" id="currentRewardAddress" readonly placeholder="Not set">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Address</label>
                        <input type="text" class="form-control" id="newRewardAddress" placeholder="Enter new reward address">
                    </div>
                    <button class="btn btn-primary" onclick="setRewardAddress()">Save Address</button>
                </div>
            </div>
        </div>

        <!-- Pool Staking Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#poolStakingCollapse"
                     aria-expanded="false"
                     aria-controls="poolStakingCollapse">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">handshake</i>
                        Pool Staking
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadAvailablePools()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="collapse" id="poolStakingCollapse">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div id="stakingStatus" class="alert alert-secondary">Not staking with a pool</div>
                    </div>

                    <!-- Available Pools List -->
                    <div class="mb-3">
                        <label class="form-label">Available Open Pools</label>
                        <div id="availablePoolsList" class="list-group mb-2" style="max-height: 200px; overflow-y: auto;">
                            <div class="text-muted small p-2">Loading pools...</div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Pool Address</label>
                        <span class="d-inline-block w-100" id="poolAddressWrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                            <input type="text" class="form-control" id="poolAddress" placeholder="Enter pool address or select from list above">
                        </span>
                    </div>
                    <div class="d-flex gap-2">
                        <span class="d-inline-block" id="addStakeBtnWrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                            <button class="btn btn-primary" id="addStakeBtn" onclick="addStakeToPool()">Add Stake to Pool</button>
                        </span>
                        <span class="d-inline-block" id="removeStakeBtnWrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                            <button class="btn btn-danger" id="removeStakeBtn" onclick="removeStakeFromPool()">Remove Stake from Pool</button>
                        </span>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Pool Management Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#poolManagementCollapse"
                     aria-expanded="false"
                     aria-controls="poolManagementCollapse">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">groups</i>
                        Pool Management
                    </h5>
                </div>
                <div class="collapse" id="poolManagementCollapse">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Lender Commission (%)</label>
                        <span class="d-inline-block w-100" id="poolCommissionWrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                            <div class="input-group">
                                <input type="number" class="form-control" id="poolCommission"
                                       placeholder="0 = closed, 1-100 = open"
                                       min="0" max="100" step="1"
                                       onchange="setPoolCommission()"
                                       onkeypress="if(event.key === 'Enter') { setPoolCommission(); event.preventDefault(); }">
                                <span class="input-group-text">%</span>
                            </div>
                        </span>
                        <small class="form-text text-muted">
                            Commission you pay to pool stakers. Empty or 0 = pool closed. 1-100 = pool open with that commission %.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Workers</label>
                        <div id="workerList" class="mb-3">
                            <p class="text-muted">No workers</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Add Worker</label>
                        <span class="d-inline-block w-100" id="addWorkerWrapper" data-bs-toggle="tooltip" data-bs-placement="top" title="">
                            <div class="input-group">
                                <input type="text" class="form-control" id="newWorkerAddress" placeholder="Worker address">
                                <button class="btn btn-primary" id="addWorkerBtn" onclick="addWorker()">Add</button>
                            </div>
                        </span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pool Stakers</label>
                        <div id="lenderList" class="mb-3">
                            <p class="text-muted">No pool stakers</p>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pool Audits</label>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadWorkersAudit()">
                                <i class="material-icons align-middle" style="font-size: 16px;">download</i>
                                Download Workers Audit
                            </button>
                            <button class="btn btn-outline-primary btn-sm" onclick="downloadLendersAudit()">
                                <i class="material-icons align-middle" style="font-size: 16px;">download</i>
                                Download Pool Stakers Audit
                            </button>
                        </div>
                        <small class="form-text text-muted">
                            Download the latest audit files showing worker distributions and pool staker commissions.
                        </small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Pool Staker Payments</label>
                        <button class="btn btn-success btn-sm" onclick="payLenders()">
                            <i class="material-icons align-middle" style="font-size: 16px;">payments</i>
                            Pay Pool Stakers From Audit
                        </button>
                        <small class="form-text text-muted">
                            Automatically pay your pool stakers based on the latest audit file (up to 1000 pool stakers in one transaction).
                        </small>
                    </div>
                </div>
                </div>
            </div>
        </div>

    </div>
</div>

<!-- Status Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="statusToast" class="toast" role="alert">
        <div class="toast-header bg-dark text-white">
            <strong class="me-auto">Satori</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_URL = '/api';

    // State tracking for mutual exclusion
    let isStakingToPool = false;
    let isOpenPool = false;  // True if pool has commission > 0 (accepting pool stakers)
    let hasWorkers = false;  // True if user has workers (active pool)

    function showToast(message, isError = false) {
        const toast = document.getElementById('statusToast');
        const toastBody = document.getElementById('toastMessage');
        toastBody.textContent = message;
        toastBody.className = 'toast-body ' + (isError ? 'text-danger' : 'text-success');
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    async function apiCall(endpoint, method = 'GET', data = null) {
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            const response = await fetch(API_URL + endpoint, options);

            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}`);
            }

            const result = await response.json();

            // Check for HTTP errors
            if (!response.ok) {
                throw new Error(result.detail || result.error || `HTTP ${response.status}`);
            }

            return result;
        } catch (error) {
            console.error('API Error:', error);
            showToast('API Error: ' + error.message, true);
            return null;
        }
    }

    // Update UI based on mutual exclusion rules
    function updateMutualExclusionUI() {
        const poolStakingReasonCommission = 'You cannot stake to a pool while you have commission set (open pool)';
        const poolStakingReasonWorkers = 'You cannot stake to a pool while you have workers (active pool)';
        const poolManagementReason = 'You cannot manage workers or commission while staking to another pool';

        // Pool Staking elements
        const poolAddressInput = document.getElementById('poolAddress');
        const poolAddressWrapper = document.getElementById('poolAddressWrapper');
        const addStakeBtn = document.getElementById('addStakeBtn');
        const addStakeBtnWrapper = document.getElementById('addStakeBtnWrapper');
        const removeStakeBtn = document.getElementById('removeStakeBtn');
        const removeStakeBtnWrapper = document.getElementById('removeStakeBtnWrapper');

        // Pool Management elements
        const poolCommission = document.getElementById('poolCommission');
        const poolCommissionWrapper = document.getElementById('poolCommissionWrapper');
        const newWorkerInput = document.getElementById('newWorkerAddress');
        const addWorkerBtn = document.getElementById('addWorkerBtn');
        const addWorkerWrapper = document.getElementById('addWorkerWrapper');

        // If you're an open pool (have commission set) OR have workers, disable Pool Staking
        if (isOpenPool || hasWorkers) {
            const reason = isOpenPool ? poolStakingReasonCommission : poolStakingReasonWorkers;
            poolAddressInput.disabled = true;
            poolAddressWrapper.setAttribute('title', reason);
            addStakeBtn.disabled = true;
            addStakeBtnWrapper.setAttribute('title', reason);
            removeStakeBtn.disabled = true;
            removeStakeBtnWrapper.setAttribute('title', reason);
        } else {
            poolAddressInput.disabled = false;
            poolAddressWrapper.setAttribute('title', '');
            addStakeBtn.disabled = false;
            addStakeBtnWrapper.setAttribute('title', '');
            // Remove button only enabled if actually staking to a pool
            if (isStakingToPool) {
                removeStakeBtn.disabled = false;
                removeStakeBtnWrapper.setAttribute('title', '');
            } else {
                removeStakeBtn.disabled = true;
                removeStakeBtnWrapper.setAttribute('title', 'You are not currently staking to a pool');
            }
        }

        // If staking to pool, disable Pool Management (both commission AND workers)
        if (isStakingToPool) {
            poolCommission.disabled = true;
            poolCommissionWrapper.setAttribute('title', poolManagementReason);
            newWorkerInput.disabled = true;
            addWorkerBtn.disabled = true;
            addWorkerWrapper.setAttribute('title', poolManagementReason);
        } else {
            poolCommission.disabled = false;
            poolCommissionWrapper.setAttribute('title', '');
            newWorkerInput.disabled = false;
            addWorkerBtn.disabled = false;
            addWorkerWrapper.setAttribute('title', '');
        }

        // Update card collapse states based on usage
        updateCardCollapseStates();
    }

    function updateCardCollapseStates() {
        const poolStakingCollapse = document.getElementById('poolStakingCollapse');
        const poolManagementCollapse = document.getElementById('poolManagementCollapse');

        if (poolStakingCollapse) {
            // Show Pool Staking card if user is staking to a pool
            if (isStakingToPool) {
                poolStakingCollapse.classList.add('show');
            } else {
                poolStakingCollapse.classList.remove('show');
            }
        }

        if (poolManagementCollapse) {
            // Show Pool Management card if user is an open pool or has workers
            if (isOpenPool || hasWorkers) {
                poolManagementCollapse.classList.add('show');
            } else {
                poolManagementCollapse.classList.remove('show');
            }
        }
    }

    function setBalanceLoading(elementId, isLoading) {
        const element = document.getElementById(elementId);
        if (isLoading) {
            element.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
        }
    }

    async function loadBalance() {
        // Load stake from Satori API server (only source for stake info)
        try {
            const result = await apiCall('/balance/get');
            if (result && result.stake !== undefined) {
                document.getElementById('stakeBalance').textContent = result.stake;
            } else {
                document.getElementById('stakeBalance').textContent = '--';
            }
        } catch (error) {
            console.error('Failed to load stake balance:', error);
            document.getElementById('stakeBalance').textContent = '--';
        }
    }

    async function refreshBalance() {
        // Get real-time balance from electrumx blockchain (wallet + vault)
        // Fetches SATORI token and EVR balance
        setBalanceLoading('tokenBalance', true);
        setBalanceLoading('evrBalance', true);

        try {
            const result = await apiCall('/wallet/balance/direct');
            if (result && !result.error) {
                document.getElementById('tokenBalance').textContent = result.total !== undefined ? result.total.toFixed(8) : '--';
                document.getElementById('evrBalance').textContent = result.total_evr !== undefined ? result.total_evr.toFixed(8) : '--';

                // Update balance labels in send section
                if (result.vault_balance !== undefined) {
                    document.getElementById('vaultBalanceLabel').textContent = '(' + result.vault_balance.toFixed(8) + ')';
                }
                if (result.wallet_balance !== undefined) {
                    document.getElementById('walletBalanceLabel').textContent = '(' + result.wallet_balance.toFixed(8) + ')';
                }
            } else {
                // If there's an error, show dashes
                document.getElementById('tokenBalance').textContent = '--';
                document.getElementById('evrBalance').textContent = '--';
                document.getElementById('vaultBalanceLabel').textContent = '(--)';
                document.getElementById('walletBalanceLabel').textContent = '(--)';
                if (result && result.error) {
                    console.error('ElectrumX balance fetch error:', result.error);
                }
            }
        } catch (error) {
            console.error('Failed to fetch balance from ElectrumX:', error);
            document.getElementById('tokenBalance').textContent = '--';
            document.getElementById('evrBalance').textContent = '--';
            document.getElementById('vaultBalanceLabel').textContent = '(--)';
            document.getElementById('walletBalanceLabel').textContent = '(--)';
        }
    }

    async function loadAllBalances() {
        // Load both stake (from API) and live balances (from ElectrumX)
        await Promise.all([
            loadBalance(),      // Stake from Satori API
            refreshBalance()    // SATORI and EVR from ElectrumX
        ]);
    }

    async function loadRewardAddress() {
        const result = await apiCall('/peer/reward-address');
        if (result && result.reward_address) {
            document.getElementById('currentRewardAddress').value = result.reward_address;
        }
    }

    async function setRewardAddress() {
        const address = document.getElementById('newRewardAddress').value.trim();
        if (!address) {
            showToast('Please enter an address', true);
            return;
        }
        if (!isValidAddress(address)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        const result = await apiCall('/peer/reward-address', 'POST', { reward_address: address });
        if (result) {
            showToast('Reward address updated');
            loadRewardAddress();
            document.getElementById('newRewardAddress').value = '';
        }
    }

    async function loadStakingStatus() {
        const result = await apiCall('/lender/status');
        const statusEl = document.getElementById('stakingStatus');
        if (result && result.pool_address) {
            isStakingToPool = true;
            statusEl.className = 'alert alert-success';
            statusEl.textContent = 'Staking with pool: ' + result.pool_address;
            // Update the pool address input field
            document.getElementById('poolAddress').value = result.pool_address;
        } else {
            isStakingToPool = false;
            statusEl.className = 'alert alert-secondary';
            statusEl.textContent = 'Not staking with a pool';
            // Clear the pool address input field
            document.getElementById('poolAddress').value = '';
        }
        updateMutualExclusionUI();
    }

    async function addStakeToPool() {
        const pool = document.getElementById('poolAddress').value.trim();
        if (!pool) {
            showToast('Please enter a pool address', true);
            return;
        }
        if (!isValidAddress(pool)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        const result = await apiCall('/lender/lend', 'POST', { pool_address: pool });
        if (result) {
            showToast('Stake added to pool');
            loadStakingStatus();
        }
    }

    async function removeStakeFromPool() {
        const result = await apiCall('/lender/lend', 'DELETE');
        if (result) {
            showToast('Stake removed from pool');
            loadStakingStatus();
        }
    }

    async function loadAvailablePools() {
        const listEl = document.getElementById('availablePoolsList');
        listEl.innerHTML = '<div class="text-muted small p-2">Loading pools...</div>';

        const result = await apiCall('/pool/open', 'GET');
        if (result && result.pools && result.pools.length > 0) {
            listEl.innerHTML = '';
            result.pools.forEach(pool => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById('poolAddress').value = pool.address;
                };
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Address:</small><br>
                            <code class="small">${pool.address}</code>
                        </div>
                        <div class="text-end">
                            ${pool.alias ? `<span class="badge bg-primary">${pool.alias}</span><br>` : ''}
                            <small class="text-success fw-bold">${pool.commission}% commission</small>
                        </div>
                    </div>
                `;
                listEl.appendChild(item);
            });
        } else {
            listEl.innerHTML = '<div class="text-muted small p-2">No open pools available</div>';
        }
    }

    async function setPoolCommission() {
        const commissionInput = document.getElementById('poolCommission');
        let commission = commissionInput.value ? parseInt(commissionInput.value) : null;

        // Validate
        if (commission !== null && (commission < 0 || commission > 100)) {
            showToast('Commission must be between 0 and 100', true);
            return;
        }

        // Convert 0 to null (closed)
        if (commission === 0) {
            commission = null;
        }

        const result = await apiCall('/pool/toggle-open', 'POST', { commission: commission });
        if (result) {
            const msg = commission === null ? 'Pool closed' : `Pool open with ${commission}% commission`;
            showToast(msg);
            await loadPoolCommission();
            await loadAvailablePools();  // Refresh pool list to show updated commission
            updateMutualExclusionUI();
        }
    }

    async function loadPoolCommission() {
        const result = await apiCall('/pool/commission', 'GET');
        if (result) {
            const commissionInput = document.getElementById('poolCommission');
            commissionInput.value = result.commission || '';
            isOpenPool = result.commission !== null && result.commission > 0;
            updateMutualExclusionUI();  // Update UI after setting isOpenPool
        }
    }

    async function loadWorkers() {
        const workerListEl = document.getElementById('workerList');
        const result = await apiCall('/pool/workers');

        if (result && result.workers && result.workers.length > 0) {
            hasWorkers = true;
            workerListEl.innerHTML = '';
            result.workers.forEach(worker => {
                const workerItem = document.createElement('div');
                workerItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                workerItem.innerHTML = `
                    <div>
                        <small class="text-muted">Address:</small><br>
                        <code class="small">${worker.address}</code>
                        ${worker.alias ? `<br><span class="badge bg-secondary">${worker.alias}</span>` : ''}
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeWorker('${worker.address}')">
                        <i class="material-icons align-middle" style="font-size: 16px;">delete</i>
                    </button>
                `;
                workerListEl.appendChild(workerItem);
            });
        } else {
            hasWorkers = false;
            workerListEl.innerHTML = '<p class="text-muted">No workers</p>';
        }

        updateMutualExclusionUI();
    }

    async function loadLenders() {
        const lenderListEl = document.getElementById('lenderList');
        const result = await apiCall('/pool/lenders');

        if (result && result.lenders && result.lenders.length > 0) {
            lenderListEl.innerHTML = '';
            result.lenders.forEach(lender => {
                const lenderItem = document.createElement('div');
                lenderItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                lenderItem.innerHTML = `
                    <div>
                        <small class="text-muted">Address:</small><br>
                        <code class="small">${lender.address}</code>
                        ${lender.alias ? `<br><span class="badge bg-secondary">${lender.alias}</span>` : ''}
                    </div>
                `;
                lenderListEl.appendChild(lenderItem);
            });
        } else {
            lenderListEl.innerHTML = '<p class="text-muted">No pool stakers</p>';
        }
    }

    // Get central-lite API URL
    function getCentralApiUrl() {
        // For development: assume central-lite runs on port 8000
        // For production: this should be configured properly
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;

        // If we're on localhost, use localhost:8000
        // Otherwise, use the same hostname (assumes central-lite on same domain)
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            return `${protocol}//${hostname}:8000`;
        }
        return `${protocol}//${hostname}`;
    }

    // Helper function to download JSON data as a file
    function downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: 'application/json'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Download workers audit
    async function downloadWorkersAudit() {
        try {
            const centralApiUrl = getCentralApiUrl();
            const response = await fetch(`${centralApiUrl}/api/v1/audit/workers/latest`);

            if (!response.ok) {
                if (response.status === 404) {
                    showToast('No workers audit available yet', 'warning');
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `workers_audit_${timestamp}.json`;

            downloadJSON(data, filename);
            showToast('Workers audit downloaded');
        } catch (error) {
            console.error('Error downloading workers audit:', error);
            showToast('Failed to download workers audit', 'error');
        }
    }

    // Download pool stakers audit
    async function downloadLendersAudit() {
        try {
            const centralApiUrl = getCentralApiUrl();
            const response = await fetch(`${centralApiUrl}/api/v1/audit/stakers/latest`);

            if (!response.ok) {
                if (response.status === 404) {
                    showToast('No pool stakers audit available yet', 'warning');
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `stakers_audit_${timestamp}.json`;

            downloadJSON(data, filename);
            showToast('Pool stakers audit downloaded');
        } catch (error) {
            console.error('Error downloading pool stakers audit:', error);
            showToast('Failed to download pool stakers audit', 'error');
        }
    }

    // Pay lenders from audit
    async function payLenders() {
        try {
            // 1. Fetch audit
            showToast('Fetching audit...', 'info');
            const centralApiUrl = getCentralApiUrl();
            const response = await fetch(`${centralApiUrl}/api/v1/audit/stakers/latest`);

            if (!response.ok) {
                if (response.status === 404) {
                    showToast('No audit available yet', 'warning');
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const audit = await response.json();

            // 2. Find my pool and lenders
            const myAddress = await apiCall('/wallet/address');
            if (!myAddress || !myAddress.wallet_address) {
                showToast('Unable to determine your wallet address', 'error');
                return;
            }

            const myPool = audit.pools.find(p => p.pool_address === myAddress.wallet_address);

            if (!myPool || !myPool.lenders || myPool.lenders.length === 0) {
                showToast('No pool stakers to pay', 'info');
                return;
            }

            // 3. Build payment dictionary
            const payments = {};
            myPool.lenders.forEach(lender => {
                if (lender.commission_owed > 0) {
                    payments[lender.lender_address] = lender.commission_owed;
                }
            });

            const count = Object.keys(payments).length;
            if (count === 0) {
                showToast('No pool stakers with amounts owed', 'info');
                return;
            }

            const total = Object.values(payments).reduce((sum, amt) => sum + amt, 0);

            // 4. Check balance
            const balance = await apiCall('/wallet/balance/direct');
            if (!balance) {
                showToast('Unable to check balance', 'error');
                return;
            }

            if (balance.vault_balance < total) {
                showToast(`Insufficient balance: need ${total.toFixed(8)}, have ${balance.vault_balance.toFixed(8)}`, 'error');
                return;
            }

            // 5. Confirm with user
            const confirmMsg =
                `Pay ${count} pool stakers a total of ${total.toFixed(8)} SATORI?\n\n` +
                `Your balance: ${balance.vault_balance.toFixed(8)} SATORI\n` +
                `EVR for fees: ${balance.vault_evr.toFixed(8)} EVR\n\n` +
                `⚠️ This action cannot be undone!`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // 6. Send payment
            showToast('Sending payment to pool stakers...', 'info');

            const paymentResponse = await fetch('/api/lender/pay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({payments})
            });

            const data = await paymentResponse.json();

            if (data.success) {
                // 7. Show success
                const explorerUrl = `https://evr.cryptoscope.io/tx/?hash=${data.txhash}`;
                showToast(`✓ Paid ${data.lenders_paid} pool stakers!`, 'success');

                const resultMsg =
                    `Successfully paid ${data.lenders_paid} pool stakers!\n\n` +
                    `Total: ${data.total_sent.toFixed(8)} SATORI\n\n` +
                    `Transaction: ${data.txhash}\n\n` +
                    `View on blockchain explorer:\n${explorerUrl}`;

                alert(resultMsg);

                // Refresh balance
                loadAllBalances();
            } else {
                showToast(`Payment failed: ${data.error}`, 'error');
            }

        } catch (error) {
            console.error('Error paying pool stakers:', error);
            showToast(`Failed to pay pool stakers: ${error.message}`, 'error');
        }
    }

    function isValidAddress(address) {
        return address && address.length === 34 && address.startsWith('E');
    }

    async function addWorker() {
        const address = document.getElementById('newWorkerAddress').value.trim();
        if (!address) {
            showToast('Please enter a worker address', true);
            return;
        }
        if (!isValidAddress(address)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        const result = await apiCall('/pool/worker', 'POST', { worker_address: address });
        if (result) {
            showToast('Worker added');
            document.getElementById('newWorkerAddress').value = '';
            loadWorkers();
        }
    }

    async function removeWorker(address) {
        const result = await apiCall(`/pool/worker/${address}`, 'DELETE');
        if (result) {
            showToast('Worker removed');
            loadWorkers();
        }
    }

    async function checkHealth() {
        try {
            const response = await fetch('/health');
            const data = await response.json();
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            if (data.api === 'connected') {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Disconnected';
            }
        } catch (error) {
            document.getElementById('statusIndicator').className = 'status-indicator status-offline';
            document.getElementById('statusText').textContent = 'Disconnected';
        }
    }

    async function loadWalletAddresses() {
        const result = await apiCall('/wallet/address');
        if (result) {
            // Main wallet uses vault address
            if (result.vault_address) {
                document.getElementById('walletAddress').value = result.vault_address;
                loadQrCode(result.vault_address);
            } else {
                document.getElementById('walletAddress').value = 'Not available';
                document.getElementById('walletQrCode').innerHTML = '<p class="text-muted mb-0">No address</p>';
            }
            // Identity wallet (for backup)
            if (result.wallet_address) {
                document.getElementById('identityAddress').value = result.wallet_address;
            } else {
                document.getElementById('identityAddress').value = 'Not available';
            }
        }
    }

    // Identity Wallet functions
    let identityWalletVisible = false;
    let identityPrivateKeyLoaded = false;
    let identityPrivateKeyVisible = false;

    function toggleIdentityWallet() {
        const section = document.getElementById('identityWalletSection');
        identityWalletVisible = !identityWalletVisible;
        section.style.display = identityWalletVisible ? 'block' : 'none';
    }

    async function toggleIdentityPrivateKey() {
        const input = document.getElementById('identityPrivateKey');
        const icon = document.getElementById('identityKeyIcon');

        if (!identityPrivateKeyLoaded) {
            // Load the identity private key from API
            const result = await apiCall('/wallet/identity-private-key');
            if (result && result.private_key) {
                input.value = result.private_key;
                identityPrivateKeyLoaded = true;
            } else {
                input.value = 'Unable to load';
            }
        }

        identityPrivateKeyVisible = !identityPrivateKeyVisible;
        input.type = identityPrivateKeyVisible ? 'text' : 'password';
        icon.textContent = identityPrivateKeyVisible ? 'visibility_off' : 'visibility';
    }

    function copyIdentityPrivateKey() {
        const input = document.getElementById('identityPrivateKey');
        if (input.value && input.value !== 'Click to reveal...' && input.value !== 'Unable to load') {
            navigator.clipboard.writeText(input.value).then(() => {
                showToast('Identity private key copied to clipboard');
            }).catch(() => {
                showToast('Failed to copy', true);
            });
        } else {
            showToast('Please reveal the private key first', true);
        }
    }

    function copyToClipboard(elementId) {
        const input = document.getElementById(elementId);
        const value = input.value;
        if (value && value !== 'Loading...' && value !== 'Not available') {
            navigator.clipboard.writeText(value).then(() => {
                showToast('Address copied to clipboard');
            }).catch(() => {
                // Fallback for older browsers
                input.select();
                document.execCommand('copy');
                showToast('Address copied to clipboard');
            });
        }
    }

    // Wallet Card Functions
    let privateKeyLoaded = false;

    async function loadQrCode(address) {
        const qrContainer = document.getElementById('walletQrCode');
        const result = await apiCall('/wallet/qr/' + encodeURIComponent(address));
        if (result && result.qr_code) {
            qrContainer.innerHTML = '<img src="' + result.qr_code + '" alt="QR Code" style="max-width: 150px;">';
        } else {
            qrContainer.innerHTML = '<p class="text-muted mb-0">QR code unavailable</p>';
        }
    }

    async function togglePrivateKey() {
        const showBtn = document.getElementById('showPrivateKeyBtn');
        const section = document.getElementById('privateKeySection');

        if (section.style.display === 'none') {
            // Show private key (vault private key)
            if (!privateKeyLoaded) {
                const result = await apiCall('/wallet/private-key');
                if (result && result.private_key) {
                    document.getElementById('walletPrivateKey').textContent = result.private_key;
                    privateKeyLoaded = true;
                } else {
                    document.getElementById('walletPrivateKey').textContent = 'Unable to load private key';
                }
            }
            showBtn.style.display = 'none';
            section.style.display = 'block';
        } else {
            // Hide private key
            showBtn.style.display = 'block';
            section.style.display = 'none';
        }
    }

    function copyPrivateKey() {
        const privateKey = document.getElementById('walletPrivateKey').textContent;
        if (privateKey && privateKey !== 'Loading...' && privateKey !== 'Unable to load private key') {
            navigator.clipboard.writeText(privateKey).then(() => {
                showToast('Private key copied to clipboard');
            }).catch(() => {
                showToast('Failed to copy private key', true);
            });
        }
    }

    function toggleSweepAmount() {
        const sweepCheckbox = document.getElementById('sendSweep');
        const amountInput = document.getElementById('sendAmount');
        if (sweepCheckbox.checked) {
            amountInput.disabled = true;
            amountInput.value = '';
            amountInput.placeholder = 'All tokens';
        } else {
            amountInput.disabled = false;
            amountInput.placeholder = '0.00';
        }
    }

    async function sendTransaction() {
        const address = document.getElementById('sendDestAddress').value.trim();
        const amount = document.getElementById('sendAmount').value;
        const sweep = document.getElementById('sendSweep').checked;
        const sendBtn = document.getElementById('sendBtn');
        const resultDiv = document.getElementById('sendResult');

        // Get selected source (wallet or vault)
        const sendSource = document.querySelector('input[name="sendSource"]:checked').value;
        const sourceName = sendSource === 'wallet' ? 'Identity Wallet' : 'Vault';

        // Validate
        if (!address) {
            showToast('Please enter a destination address', true);
            return;
        }
        if (!isValidAddress(address)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        if (!sweep && (!amount || parseFloat(amount) <= 0)) {
            showToast('Please enter an amount or select "Send All"', true);
            return;
        }

        // Confirm with source information
        const confirmMsg = sweep
            ? 'Send ALL tokens from ' + sourceName + ' to ' + address + '?'
            : 'Send ' + amount + ' SATORI from ' + sourceName + ' to ' + address + '?';
        if (!confirm(confirmMsg)) {
            return;
        }

        // Send
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';
        resultDiv.style.display = 'none';

        try {
            const data = { address: address, sweep: sweep };
            if (!sweep) {
                data.amount = parseFloat(amount);
            }

            // Use the appropriate endpoint based on source selection
            const endpoint = sendSource === 'wallet' ? '/wallet/send-from-wallet' : '/wallet/send';
            const result = await apiCall(endpoint, 'POST', data);

            if (result && result.success) {
                resultDiv.className = 'mt-3 alert alert-success';
                resultDiv.innerHTML = '<strong>Success!</strong><br>Sent from ' + sourceName + '<br>Transaction ID: <code style="word-break: break-all;">' + result.txid + '</code>';
                resultDiv.style.display = 'block';
                showToast('Transaction sent successfully from ' + sourceName + '!');
                // Clear form
                document.getElementById('sendDestAddress').value = '';
                document.getElementById('sendAmount').value = '';
                document.getElementById('sendSweep').checked = false;
                toggleSweepAmount();
                // Refresh balances to show updated amounts
                refreshBalance();
            } else {
                const errorMsg = result ? (result.error || 'Transaction failed') : 'Transaction failed';
                resultDiv.className = 'mt-3 alert alert-danger';
                resultDiv.innerHTML = '<strong>Error:</strong> ' + errorMsg;
                resultDiv.style.display = 'block';
                showToast('Transaction failed: ' + errorMsg, true);
            }
        } catch (error) {
            resultDiv.className = 'mt-3 alert alert-danger';
            resultDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
            resultDiv.style.display = 'block';
            showToast('Transaction error: ' + error.message, true);
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="material-icons align-middle me-1">send</i> Send Transaction';
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Update theme icon based on stored theme
        const storedTheme = localStorage.getItem('satori-theme') || 'dark';
        const themeIcon = document.getElementById('themeIcon');
        if (themeIcon) {
            themeIcon.textContent = storedTheme === 'dark' ? 'light_mode' : 'dark_mode';
        }

        // Initialize Bootstrap tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Ensure both pool cards start collapsed (will be expanded by API calls if needed)
        const poolStakingCollapse = document.getElementById('poolStakingCollapse');
        const poolManagementCollapse = document.getElementById('poolManagementCollapse');
        if (poolStakingCollapse) {
            poolStakingCollapse.classList.remove('show');
        }
        if (poolManagementCollapse) {
            poolManagementCollapse.classList.remove('show');
        }

        checkHealth();
        loadWalletAddresses();
        loadAllBalances();  // Load both stake and live balances from ElectrumX
        loadRewardAddress();
        loadStakingStatus();
        loadWorkers();
        loadLenders();
        loadAvailablePools();
        loadPoolCommission();

        // Periodic health check - Disabled to reduce unnecessary load
        // setInterval(checkHealth, 30000);
    });
</script>
{% endblock %}
