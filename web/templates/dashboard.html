{% extends "base.html" %}

{% block title %}Satori - Dashboard{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg px-4">
    <span class="navbar-brand">
        Satori
        <small class="text-muted ms-2" style="font-size: 0.65rem; font-weight: 400; opacity: 0.6;">{{ version }}</small>
    </span>
    <div class="ms-auto d-flex align-items-center">
        <span class="me-3">
            <span class="status-indicator status-online" id="statusIndicator"></span>
            <span id="statusText">Connected</span>
        </span>
        <a href="{{ url_for('network') }}" class="btn btn-outline-secondary btn-sm me-2" title="P2P Network Dashboard">
            <i class="material-icons align-middle" style="font-size: 16px;">hub</i>
            Network
        </a>
        <a href="{{ url_for('stake_management') }}" class="btn btn-outline-light btn-sm me-2">
            <i class="material-icons align-middle" style="font-size: 16px;">handshake</i>
            Stake Management
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm me-2">Logout</a>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <i class="material-icons" id="themeIcon">light_mode</i>
        </button>
    </div>
</nav>

<div class="container-fluid py-4">
    <div class="row g-4">
        <!-- Wallet Section -->
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">account_balance_wallet</i>
                        Wallet
                    </h5>
                    <a href="#" class="small text-muted" onclick="toggleIdentityWallet(); return false;">
                        <i class="material-icons align-middle" style="font-size: 16px;">badge</i>
                        Identity
                    </a>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Left side: QR Code and Address -->
                        <div class="col-lg-6 mb-4 mb-lg-0">
                            <div class="text-center mb-3">
                                <div id="walletQrCode" class="mb-3" style="display: inline-block; background: white; padding: 10px; border-radius: 10px;">
                                    <p class="text-muted mb-0">Loading QR code...</p>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Wallet Address</label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="walletAddress" readonly placeholder="Loading...">
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('walletAddress')" title="Copy to clipboard">
                                        <i class="material-icons align-middle">content_copy</i>
                                    </button>
                                </div>
                            </div>
                            <div class="text-center">
                                <p id="showPrivateKeyBtn" class="text-danger mb-2" style="cursor: pointer;" onclick="togglePrivateKey()">
                                    <i class="material-icons align-middle" style="font-size: 18px;">visibility</i>
                                    Show Private Key
                                </p>
                                <div id="privateKeySection" style="display: none;">
                                    <p class="text-muted mb-2" style="cursor: pointer;" onclick="togglePrivateKey()">
                                        <i class="material-icons align-middle" style="font-size: 18px;">visibility_off</i>
                                        Hide Private Key
                                    </p>
                                    <div class="alert alert-warning" style="word-break: break-all;">
                                        <small><strong>Private Key:</strong></small><br>
                                        <code id="walletPrivateKey">Loading...</code>
                                    </div>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="copyPrivateKey()">
                                        <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                                        Copy Private Key
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Right side: Send Tokens -->
                        <div class="col-lg-6">
                            <h6 class="mb-3">
                                <i class="material-icons align-middle me-1">send</i>
                                Send SATORI
                            </h6>
                            <div class="mb-3">
                                <label class="form-label">Send From</label>
                                <div class="d-flex gap-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sendSource" id="sendFromVault" value="vault" checked>
                                        <label class="form-check-label" for="sendFromVault">
                                            Vault <small class="text-muted" id="vaultBalanceLabel">(--)</small>
                                        </label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="sendSource" id="sendFromWallet" value="wallet">
                                        <label class="form-check-label" for="sendFromWallet">
                                            Identity Wallet <small class="text-muted" id="walletBalanceLabel">(--)</small>
                                        </label>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Destination Address</label>
                                <input type="text" class="form-control" id="sendDestAddress" placeholder="Enter destination address (E...)">
                            </div>
                            <div class="row mb-3">
                                <div class="col-8">
                                    <label class="form-label">Amount</label>
                                    <input type="number" class="form-control" id="sendAmount" placeholder="0.00" step="0.00000001" min="0">
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Sweep All</label>
                                    <div class="form-check mt-2">
                                        <input class="form-check-input" type="checkbox" id="sendSweep" onchange="toggleSweepAmount()">
                                        <label class="form-check-label" for="sendSweep">Send All</label>
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-primary w-100" onclick="sendTransaction()" id="sendBtn">
                                <i class="material-icons align-middle me-1">send</i>
                                Send Transaction
                            </button>
                            <div id="sendResult" class="mt-3" style="display: none;"></div>
                            <p class="text-muted small mt-3 mb-0">
                                Transaction fees will be paid during the send process. They typically amount to no more than 0.25 EVR.
                            </p>
                        </div>
                    </div>

                    <!-- Identity Wallet (Collapsed) -->
                    <div id="identityWalletSection" style="display: none;" class="mt-4 pt-4 border-top">
                        <h6 class="text-muted mb-3">
                            <i class="material-icons align-middle me-1">badge</i>
                            Identity Wallet (for digital identity only - do not send tokens here)
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3 mb-md-0">
                                <label class="form-label small">Identity Address</label>
                                <div class="input-group input-group-sm">
                                    <input type="text" class="form-control" id="identityAddress" readonly placeholder="Loading...">
                                    <button class="btn btn-outline-secondary" onclick="copyToClipboard('identityAddress')" title="Copy">
                                        <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label small">Identity Private Key</label>
                                <div class="input-group input-group-sm">
                                    <input type="password" class="form-control" id="identityPrivateKey" readonly placeholder="Click to reveal...">
                                    <button class="btn btn-outline-secondary" onclick="toggleIdentityPrivateKey()" title="Show/Hide">
                                        <i class="material-icons align-middle" style="font-size: 16px;" id="identityKeyIcon">visibility</i>
                                    </button>
                                    <button class="btn btn-outline-secondary" onclick="copyIdentityPrivateKey()" title="Copy">
                                        <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Balance Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">account_balance_wallet</i>
                        Balance
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="refreshBalance()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row text-center py-3">
                        <div class="col-md-4 col-6 mb-3 mb-md-0">
                            <h3 id="tokenBalance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </h3>
                            <p class="text-muted mb-0">SATORI Token</p>
                            <p id="tokenUsdValue" class="text-muted mb-0" style="font-size: 0.75rem;"></p>
                        </div>
                        <div class="col-md-4 col-6 mb-3 mb-md-0">
                            <h3 id="stakeBalance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </h3>
                            <p class="text-muted mb-0">SATORI Stake</p>
                            <p id="stakeUsdValue" class="text-muted mb-0" style="font-size: 0.75rem;"></p>
                        </div>
                        <div class="col-md-4 col-12">
                            <h3 id="evrBalance">
                                <span class="spinner-border spinner-border-sm" role="status"></span>
                            </h3>
                            <p class="text-muted mb-0">Evrmore (EVR)</p>
                            <p id="evrUsdValue" class="text-muted mb-0" style="font-size: 0.75rem;"></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reward Address Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">card_giftcard</i>
                        Reward Address
                    </h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Current Address</label>
                        <input type="text" class="form-control" id="currentRewardAddress" readonly placeholder="Not set">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">New Address</label>
                        <input type="text" class="form-control" id="newRewardAddress" placeholder="Enter new reward address">
                    </div>
                    <button class="btn btn-primary" onclick="setRewardAddress()">Save Address</button>
                </div>
            </div>
        </div>

        <!-- P2P Network Health Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">hub</i>
                        P2P Network
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadP2PHealth()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="card-body">
                    <div class="row mb-3">
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-0" id="p2pPeerCount">--</div>
                                <small class="text-muted">Peers</small>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center">
                                <div class="h4 mb-0" id="p2pUptimePct">--%</div>
                                <small class="text-muted">Uptime</small>
                            </div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Mode</label>
                        <div id="p2pMode" class="alert alert-secondary py-2 mb-0">
                            <span id="p2pModeText">Loading...</span>
                            <span id="p2pRelayBadge" class="badge bg-success ms-2" style="display: none;">Relay Eligible</span>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Recent Heartbeats</label>
                        <div id="heartbeatFeed" class="list-group" style="max-height: 150px; overflow-y: auto; font-size: 0.85em;">
                            <div class="text-muted small p-2">Loading heartbeats...</div>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">My Delegation</label>
                        <div id="delegationInfo" class="small">
                            <p class="text-muted mb-1">Not delegating to anyone</p>
                        </div>
                    </div>
                    <div>
                        <label class="form-label">Proxy Children</label>
                        <div id="proxyChildren" class="small">
                            <p class="text-muted mb-0">No children delegating to me</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Treasury Alerts Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100" id="treasuryAlertsCard" style="display: none;">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2" id="treasuryAlertIcon">notifications</i>
                        <span id="treasuryAlertTitle">Treasury Status</span>
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="loadTreasuryAlerts()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="card-body">
                    <!-- Alert Banner -->
                    <div id="activeAlertBanner" class="alert alert-warning mb-3" style="display: none;">
                        <div class="d-flex align-items-start">
                            <i class="material-icons me-2" id="alertBannerIcon">warning</i>
                            <div class="flex-grow-1">
                                <strong id="alertBannerTitle">Treasury Alert</strong>
                                <p class="mb-2 small" id="alertBannerMessage">Alert message here</p>
                                <div id="alertActionButtons" class="d-flex gap-2 flex-wrap"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Treasury Status -->
                    <div class="row text-center mb-3">
                        <div class="col-6">
                            <div class="h5 mb-0" id="treasurySatoriLevel">--</div>
                            <small class="text-muted">SATORI Level</small>
                        </div>
                        <div class="col-6">
                            <div class="h5 mb-0" id="treasuryEvrLevel">--</div>
                            <small class="text-muted">EVR Level</small>
                        </div>
                    </div>

                    <!-- Deferred Rewards Section -->
                    <div id="deferredRewardsSection" style="display: none;">
                        <hr>
                        <label class="form-label">
                            <i class="material-icons align-middle me-1" style="font-size: 16px;">schedule</i>
                            Your Deferred Rewards
                        </label>
                        <div class="alert alert-info py-2 mb-2">
                            <div class="d-flex justify-content-between">
                                <span>Total Pending:</span>
                                <strong id="deferredTotal">0 SATORI</strong>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Deferred Rounds:</span>
                                <strong id="deferredCount">0</strong>
                            </div>
                        </div>
                        <small class="text-muted">
                            These rewards will be paid automatically when the treasury is funded.
                        </small>
                    </div>

                    <!-- Alert History -->
                    <div class="mt-3">
                        <a href="#" class="small text-muted" onclick="toggleAlertHistory(); return false;">
                            <i class="material-icons align-middle" style="font-size: 14px;">history</i>
                            View Alert History
                        </a>
                        <div id="alertHistoryList" class="mt-2" style="display: none; max-height: 150px; overflow-y: auto;">
                            <div class="text-muted small">Loading...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Pool Staking Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#poolStakingCollapse"
                     aria-expanded="false"
                     aria-controls="poolStakingCollapse">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">handshake</i>
                        Pool Staking
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadAvailablePools()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="collapse" id="poolStakingCollapse">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Status</label>
                        <div id="stakingStatus" class="alert alert-secondary">Not staking with a pool</div>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Donate & Referral Row -->
    <div class="row g-4 mt-2">
        <!-- Donate Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#donateCollapse"
                     aria-expanded="false"
                     aria-controls="donateCollapse">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">volunteer_activism</i>
                        Donate to Treasury
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadDonationStats()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="collapse" id="donateCollapse">
                <div class="card-body">
                    <!-- Treasury Address -->
                    <div class="mb-3">
                        <label class="form-label">Treasury Address</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="treasuryAddress" readonly placeholder="Loading...">
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('treasuryAddress')" title="Copy">
                                <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                            </button>
                        </div>
                        <small class="text-muted">Send EVR to this address to receive SATORI rewards</small>
                    </div>

                    <!-- Donation Form -->
                    <div class="mb-3">
                        <label class="form-label">Donation Amount (EVR)</label>
                        <div class="input-group">
                            <input type="number" class="form-control" id="donationAmount" placeholder="100" min="1" step="1" onchange="updateDonationEstimate()">
                            <span class="input-group-text">EVR</span>
                        </div>
                        <small class="text-muted" id="donationEstimate">≈ 0 SATORI reward</small>
                    </div>
                    <button class="btn btn-primary w-100" onclick="sendDonation()" id="donateBtn">
                        <i class="material-icons align-middle me-1">send</i>
                        Send Donation
                    </button>
                    <div id="donationResult" class="mt-2" style="display: none;"></div>

                    <hr class="my-3">

                    <!-- My Stats -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <h5 id="donorTotalDonated" class="mb-0">--</h5>
                            <small class="text-muted">Total Donated</small>
                        </div>
                        <div class="col-4">
                            <h5 id="donorTier" class="mb-0">--</h5>
                            <small class="text-muted">Tier</small>
                        </div>
                        <div class="col-4">
                            <h5 id="donorRewardsReceived" class="mb-0">--</h5>
                            <small class="text-muted">Rewards</small>
                        </div>
                    </div>

                    <!-- Tier Progress -->
                    <div class="mb-3">
                        <label class="form-label small">Progress to Next Tier</label>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-success" role="progressbar" id="tierProgressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="tierProgressText">-- EVR to next tier</small>
                    </div>

                    <!-- Top Donors Button -->
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="toggleTopDonors()">
                        <i class="material-icons align-middle" style="font-size: 16px;">leaderboard</i>
                        View Top Donors
                    </button>
                    <div id="topDonorsList" class="mt-2" style="display: none;">
                        <div class="text-muted small">Loading...</div>
                    </div>
                </div>
                </div>
            </div>
        </div>

        <!-- Referral Section -->
        <div class="col-12 col-lg-6">
            <div class="card h-100">
                <div class="card-header d-flex justify-content-between align-items-center"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#referralCollapse"
                     aria-expanded="false"
                     aria-controls="referralCollapse">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">share</i>
                        Referral Program
                    </h5>
                    <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadReferralStats()">
                        <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                    </button>
                </div>
                <div class="collapse" id="referralCollapse">
                <div class="card-body">
                    <!-- My Stats -->
                    <div class="row text-center mb-3">
                        <div class="col-4">
                            <h4 id="referralCount" class="mb-0">0</h4>
                            <small class="text-muted">Referrals</small>
                        </div>
                        <div class="col-4">
                            <h5 id="referralTier" class="mb-0" style="color: #9e9e9e;">None</h5>
                            <small class="text-muted">Tier</small>
                        </div>
                        <div class="col-4">
                            <h5 id="referralBonus" class="mb-0" style="color: #4CAF50;">+0%</h5>
                            <small class="text-muted">Bonus</small>
                        </div>
                    </div>

                    <!-- Tier Progress -->
                    <div class="mb-3">
                        <label class="form-label small">Progress to Next Tier</label>
                        <div class="progress" style="height: 10px;">
                            <div class="progress-bar bg-primary" role="progressbar" id="referralTierProgressBar" style="width: 0%"></div>
                        </div>
                        <small class="text-muted" id="referralNextTier">5 referrals to Bronze</small>
                    </div>

                    <!-- Share Link -->
                    <div class="mb-3">
                        <label class="form-label">Your Referral Link</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="referralLink" readonly placeholder="Loading...">
                            <button class="btn btn-outline-secondary" onclick="copyToClipboard('referralLink')" title="Copy">
                                <i class="material-icons align-middle" style="font-size: 16px;">content_copy</i>
                            </button>
                        </div>
                    </div>

                    <!-- Set Referrer -->
                    <div class="mb-3">
                        <label class="form-label">Who referred you?</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" id="referrerAddress" placeholder="Enter referrer address">
                            <button class="btn btn-primary btn-sm" onclick="setReferrer()">Set</button>
                        </div>
                    </div>

                    <!-- Top Referrers Button -->
                    <button class="btn btn-outline-secondary btn-sm w-100" onclick="toggleTopReferrers()">
                        <i class="material-icons align-middle" style="font-size: 16px;">leaderboard</i>
                        View Top Referrers
                    </button>
                    <div id="topReferrersList" class="mt-2" style="display: none;">
                        <div class="text-muted small">Loading...</div>
                    </div>

                    <!-- Tier Info -->
                    <div class="mt-3">
                        <small class="text-muted">
                            Tier bonuses: Bronze (5) +2% | Silver (25) +5% | Gold (100) +8% | Platinum (500) +12% | Diamond (2000) +15%
                        </small>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Engine Training Control Section -->
    <div class="row g-4 mt-2">
        <div class="col-12">
            <div class="card">
                <div class="card-header"
                     style="cursor: pointer;"
                     data-bs-toggle="collapse"
                     data-bs-target="#aiEngineCollapse"
                     aria-expanded="false"
                     aria-controls="aiEngineCollapse">
                    <h5 class="mb-0">
                        <i class="material-icons align-middle me-2">psychology</i>
                        AI Engine Training Frequency
                    </h5>
                </div>
                <div class="collapse" id="aiEngineCollapse">
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Training Frequency</label>
                        <div class="d-flex align-items-center gap-3">
                            <span class="text-muted small">Slow</span>
                            <input type="range" class="form-range flex-grow-1"
                                   id="trainingDelaySlider"
                                   min="0" max="100" step="1" value="50"
                                   oninput="updateTrainingDelayLabel(this.value)"
                                   onchange="setTrainingDelay(this.value)">
                            <span class="text-muted small">Fast</span>
                        </div>
                        <div class="text-center mt-2">
                            <span class="badge bg-secondary" id="trainingDelayLabel">10 minutes</span>
                        </div>
                        <small class="form-text text-muted">
                            Controls how frequently the AI engine trains new models.
                            Lower frequency = less CPU usage. Higher frequency = faster model improvements.
                        </small>
                    </div>
                </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Disclaimer Footer -->
<div class="container-fluid py-3">
    <div class="card">
        <div class="card-header text-center"
             style="cursor: pointer;"
             data-bs-toggle="collapse"
             data-bs-target="#disclaimerCollapse"
             aria-expanded="false"
             aria-controls="disclaimerCollapse">
            <h6 class="mb-0 text-muted">
                <i class="material-icons align-middle me-2" style="font-size: 18px;">info</i>
                Disclaimer of Warranties and Limitation of Liability
            </h6>
        </div>
        <div class="collapse" id="disclaimerCollapse">
            <div class="card-body">
                <div class="disclaimer-content" style="font-size: 0.85rem; line-height: 1.6;">
                    <h6>1. DISCLAIMER OF WARRANTIES</h6>
                    <p><strong>AS IS:</strong> The Satori Neuron software ("Software") is provided "AS IS" and "AS AVAILABLE" without warranties of any kind, whether express or implied, including but not limited to implied warranties of merchantability, fitness for a particular purpose, title, and non-infringement.</p>
                    <p><strong>NO GUARANTEE:</strong> We do not guarantee that the Software will be uninterrupted, error-free, secure, or free of viruses or other harmful components.</p>
                    <p><strong>USER RESPONSIBILITY:</strong> The user is solely responsible for any damage to their device or loss of data that results from the use of the Software.</p>

                    <h6 class="mt-3">2. LIMITATION OF LIABILITY</h6>
                    <p><strong>NO LIABILITY FOR DAMAGES:</strong> In no event shall The Satori Association or its affiliates, officers, directors, employees, agents, or licensors be liable for any indirect, incidental, special, consequential, or punitive damages, or any loss of profits or revenues, whether incurred directly or indirectly, or any loss of data, use, goodwill, or other intangible losses, resulting from:</p>
                    <ul>
                        <li>Your use or inability to use the Software;</li>
                        <li>Any unauthorized access to or use of the Software;</li>
                        <li>Any interruption or cessation of transmission to or from the Software;</li>
                        <li>Any bugs, viruses, trojan horses, or the like that may be transmitted to or through the Software by any third party;</li>
                        <li>Any errors or omissions in any content or for any loss or damage incurred as a result of the use of any content posted, emailed, transmitted, or otherwise made available through the Software, whether based on warranty, contract, tort (including negligence), or any other legal theory, whether or not we have been informed of the possibility of such damage.</li>
                    </ul>

                    <h6 class="mt-3">3. MAXIMUM LIABILITY</h6>
                    <p><strong>LIMITATION CAP:</strong> Our maximum aggregate liability under or in connection with the Software, whether in contract, tort (including negligence), or otherwise, shall in no circumstances exceed the amount paid by you, if any, for accessing or using the Software.</p>

                    <h6 class="mt-3">4. EXCLUSIONS</h6>
                    <p><strong>APPLICABLE LAW:</strong> Some jurisdictions do not allow the exclusion of certain warranties or the limitation or exclusion of liability for incidental or consequential damages. Accordingly, some of the above limitations may not apply to you. In such jurisdictions, our liability will be limited to the fullest extent permitted by applicable law.</p>

                    <h6 class="mt-3">5. INDEMNIFICATION</h6>
                    <p><strong>USER INDEMNITY:</strong> You agree to indemnify, defend, and hold harmless The Satori Association and its affiliates, officers, directors, employees, agents, and licensors from and against any claims, liabilities, damages, losses, and expenses, including, without limitation, reasonable legal and accounting fees, arising out of or in any way connected with your access to or use of the Software, or your violation of these terms.</p>

                    <h6 class="mt-3">6. GOVERNING LAW</h6>
                    <p><strong>SWISS LAW:</strong> This Disclaimer of Warranties and Limitation of Liability shall be governed by and construed in accordance with the laws of Switzerland, without regard to its conflict of laws principles.</p>

                    <h6 class="mt-3">7. DISPUTE RESOLUTION</h6>
                    <p><strong>MEDIATION FIRST:</strong> Any disputes arising under or in connection with this Disclaimer of Warranties and Limitation of Liability shall first be attempted to be resolved through mediation. The parties agree to submit the dispute to a mutually agreed-upon mediator in Switzerland. If mediation fails to resolve the dispute, it shall then be resolved in the courts of Switzerland.</p>

                    <h6 class="mt-3">8. CONTACT INFORMATION</h6>
                    <p>For any inquiries regarding this Disclaimer of Warranties and Limitation of Liability, please contact:</p>
                    <p class="mb-0">
                        <strong>The Satori Association</strong><br>
                        <a href="mailto:disclaimer@satorinet.io">disclaimer@satorinet.io</a>
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Messages -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="statusToast" class="toast" role="alert">
        <div class="toast-header bg-dark text-white">
            <strong class="me-auto">Satori</strong>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const API_URL = '/api';

    // Helper function to format balance values (removes trailing zeros)
    function formatBalance(value) {
        if (value === undefined || value === null) return '--';
        // Format to 8 decimals then parse to remove trailing zeros
        return parseFloat(parseFloat(value).toFixed(8)).toString();
    }

    // State tracking for mutual exclusion
    let isStakingToPool = false;
    let isOpenPool = false;  // True if pool has commission > 0 (accepting pool stakers)
    let hasWorkers = false;  // True if user has workers (active pool)

    function showToast(message, isError = false) {
        const toast = document.getElementById('statusToast');
        const toastBody = document.getElementById('toastMessage');
        toastBody.textContent = message;
        toastBody.className = 'toast-body ' + (isError ? 'text-danger' : 'text-success');
        const bsToast = new bootstrap.Toast(toast);
        bsToast.show();
    }

    async function apiCall(endpoint, method = 'GET', data = null) {
        let isNetworkError = false;
        try {
            const options = {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                }
            };
            if (data) {
                options.body = JSON.stringify(data);
            }
            const response = await fetch(API_URL + endpoint, options);

            // If we got a response, server is reachable - update status to connected
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            if (indicator && text) {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Connected';
            }

            // Check if response is JSON
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) {
                const text = await response.text();
                throw new Error(`Server returned non-JSON response: ${text.substring(0, 100)}`);
            }

            const result = await response.json();

            // Check for HTTP errors (but server is still connected)
            if (!response.ok) {
                // Handle error properly - could be string or object
                let errorMsg = `HTTP ${response.status}`;
                if (result.detail) {
                    errorMsg = typeof result.detail === 'object' ? JSON.stringify(result.detail) : result.detail;
                } else if (result.error) {
                    errorMsg = typeof result.error === 'object' ? JSON.stringify(result.error) : result.error;
                }
                throw new Error(errorMsg);
            }

            return result;
        } catch (error) {
            console.error('API Error:', error);

            // Only show "Disconnected" for network errors (not HTTP errors like 404, 401)
            // Network errors: TypeError (failed to fetch), timeout, connection refused
            if (error instanceof TypeError || error.message.includes('fetch') || error.message.includes('network')) {
                isNetworkError = true;
                const indicator = document.getElementById('statusIndicator');
                const text = document.getElementById('statusText');
                if (indicator && text) {
                    indicator.className = 'status-indicator status-offline';
                    text.textContent = 'Disconnected';
                }
            }

            // Ensure error message is always a string
            const errorMsg = error.message || String(error);
            showToast('API Error: ' + errorMsg, true);
            return null;
        }
    }

    // =========================================================================
    // P2P NETWORK HEALTH FUNCTIONS
    // =========================================================================

    async function loadP2PHealth() {
        try {
            const health = await apiCall('/p2p/health');
            if (health) {
                document.getElementById('p2pPeerCount').textContent = health.peer_count || 0;
                document.getElementById('p2pUptimePct').textContent =
                    (health.uptime_pct ? health.uptime_pct.toFixed(1) : '0') + '%';

                const modeText = document.getElementById('p2pModeText');
                const modeAlert = document.getElementById('p2pMode');
                const relayBadge = document.getElementById('p2pRelayBadge');

                modeText.textContent = health.mode.toUpperCase();

                if (health.connected) {
                    modeAlert.className = 'alert alert-success py-2 mb-0';
                } else if (health.mode === 'central') {
                    modeAlert.className = 'alert alert-secondary py-2 mb-0';
                } else {
                    modeAlert.className = 'alert alert-warning py-2 mb-0';
                }

                relayBadge.style.display = health.relay_eligible ? 'inline' : 'none';
            }
        } catch (e) {
            console.error('Failed to load P2P health:', e);
        }
    }

    async function loadHeartbeats() {
        try {
            const data = await apiCall('/p2p/heartbeats?limit=10');
            const feed = document.getElementById('heartbeatFeed');

            if (data && data.heartbeats && data.heartbeats.length > 0) {
                feed.innerHTML = data.heartbeats.map(hb => {
                    const ago = Math.floor((Date.now()/1000) - hb.timestamp);
                    const roles = hb.roles ? hb.roles.join(', ') : '';
                    return `<div class="list-group-item py-1 px-2">
                        <span class="text-success">❤️</span>
                        <span class="text-muted">${hb.address}</span>
                        <span class="badge bg-secondary ms-1">${roles || 'predictor'}</span>
                        <small class="text-muted float-end">${ago}s ago</small>
                    </div>`;
                }).join('');
            } else {
                feed.innerHTML = '<div class="text-muted small p-2">No heartbeats yet</div>';
            }
        } catch (e) {
            console.error('Failed to load heartbeats:', e);
        }
    }

    async function loadDelegations() {
        try {
            const data = await apiCall('/p2p/delegations');

            // My delegation
            const delegationInfo = document.getElementById('delegationInfo');
            if (data && data.my_delegate) {
                const d = data.my_delegate;
                delegationInfo.innerHTML = `
                    <p class="mb-1">Delegating to: <code>${d.parent_address}</code></p>
                    <p class="mb-0">Amount: ${d.amount} ${d.charity ? '<span class="badge bg-info">Charity</span>' : ''}</p>
                `;
            } else {
                delegationInfo.innerHTML = '<p class="text-muted mb-0">Not delegating to anyone</p>';
            }

            // Proxy children
            const proxyChildren = document.getElementById('proxyChildren');
            if (data && data.my_children && data.my_children.length > 0) {
                proxyChildren.innerHTML = data.my_children.map(c => `
                    <div class="mb-1">
                        <code>${c.child_address}</code>: ${c.amount}
                        ${c.charity ? '<span class="badge bg-info">Charity</span>' : ''}
                    </div>
                `).join('');
            } else {
                proxyChildren.innerHTML = '<p class="text-muted mb-0">No children delegating to me</p>';
            }
        } catch (e) {
            console.error('Failed to load delegations:', e);
        }
    }

    // Load all P2P data
    async function loadAllP2PData() {
        await Promise.all([
            loadP2PHealth(),
            loadHeartbeats(),
            loadDelegations()
        ]);
    }

    // =========================================================================
    // MUTUAL EXCLUSION FUNCTIONS
    // =========================================================================

    // Update UI based on mutual exclusion rules
    function updateMutualExclusionUI() {
        const poolStakingReasonCommission = 'You cannot stake to a pool while you have commission set (open pool)';
        const poolStakingReasonWorkers = 'You cannot stake to a pool while you have workers (active pool)';

        // Pool Staking elements
        const poolAddressInput = document.getElementById('poolAddress');
        const poolAddressWrapper = document.getElementById('poolAddressWrapper');
        const addStakeBtn = document.getElementById('addStakeBtn');
        const addStakeBtnWrapper = document.getElementById('addStakeBtnWrapper');
        const removeStakeBtn = document.getElementById('removeStakeBtn');
        const removeStakeBtnWrapper = document.getElementById('removeStakeBtnWrapper');

        // Pool Management elements
        const poolCommission = document.getElementById('poolCommission');
        const poolCommissionWrapper = document.getElementById('poolCommissionWrapper');
        const newWorkerInput = document.getElementById('newWorkerAddress');
        const addWorkerBtn = document.getElementById('addWorkerBtn');
        const addWorkerWrapper = document.getElementById('addWorkerWrapper');

        // Pool Staking inputs are always enabled
        // (Commented out: previously disabled when user was a pool operator)
        /*
        if (isOpenPool || hasWorkers) {
            const reason = isOpenPool ? poolStakingReasonCommission : poolStakingReasonWorkers;
            poolAddressInput.disabled = true;
            poolAddressWrapper.setAttribute('title', reason);
            addStakeBtn.disabled = true;
            addStakeBtnWrapper.setAttribute('title', reason);
            removeStakeBtn.disabled = true;
            removeStakeBtnWrapper.setAttribute('title', reason);
        } else {
        */
            poolAddressInput.disabled = false;
            poolAddressWrapper.setAttribute('title', '');
            addStakeBtn.disabled = false;
            addStakeBtnWrapper.setAttribute('title', '');
            // Remove button only enabled if actually staking to a pool
            if (isStakingToPool) {
                removeStakeBtn.disabled = false;
                removeStakeBtnWrapper.setAttribute('title', '');
            } else {
                removeStakeBtn.disabled = true;
                removeStakeBtnWrapper.setAttribute('title', 'You are not currently staking to a pool');
            }
        // }

        // If staking to pool, dim Pool Management card and show notice
        const poolManagementBody = document.getElementById('poolManagementBody');
        const poolStakingNotice = document.getElementById('poolStakingNotice');

        if (isStakingToPool) {
            poolManagementBody.classList.add('dimmed');
            poolStakingNotice.style.display = 'block';
        } else {
            poolManagementBody.classList.remove('dimmed');
            poolStakingNotice.style.display = 'none';
        }

        // Update card collapse states based on usage
        updateCardCollapseStates();
    }

    function updateCardCollapseStates() {
        const poolStakingCollapse = document.getElementById('poolStakingCollapse');
        const poolManagementCollapse = document.getElementById('poolManagementCollapse');

        if (poolStakingCollapse) {
            // Show Pool Staking card if user is staking to a pool
            if (isStakingToPool) {
                poolStakingCollapse.classList.add('show');
            } else {
                poolStakingCollapse.classList.remove('show');
            }
        }

        if (poolManagementCollapse) {
            // Show Pool Management card if user is an open pool or has workers
            if (isOpenPool || hasWorkers) {
                poolManagementCollapse.classList.add('show');
            } else {
                poolManagementCollapse.classList.remove('show');
            }
        }
    }

    function setBalanceLoading(elementId, isLoading) {
        const element = document.getElementById(elementId);
        if (isLoading) {
            element.innerHTML = '<span class="spinner-border spinner-border-sm" role="status"></span>';
        }
    }

    async function loadBalance() {
        // Load stake from Satori API server (only source for stake info)
        try {
            const result = await apiCall('/balance/get');
            if (result && result.stake !== undefined) {
                document.getElementById('stakeBalance').textContent = result.stake;
            } else {
                document.getElementById('stakeBalance').textContent = '--';
            }
        } catch (error) {
            console.error('Failed to load stake balance:', error);
            document.getElementById('stakeBalance').textContent = '--';
        }
    }

    async function refreshBalance() {
        // Get real-time balance from electrumx blockchain (wallet + vault)
        // Fetches SATORI token and EVR balance
        setBalanceLoading('tokenBalance', true);
        setBalanceLoading('evrBalance', true);

        try {
            const result = await apiCall('/wallet/balance/direct');
            if (result && !result.error) {
                document.getElementById('tokenBalance').textContent = result.total !== undefined ? formatBalance(result.total) : '--';
                document.getElementById('evrBalance').textContent = result.total_evr !== undefined ? formatBalance(result.total_evr) : '--';

                // Update balance labels in send section
                if (result.vault_balance !== undefined) {
                    document.getElementById('vaultBalanceLabel').textContent = '(' + formatBalance(result.vault_balance) + ')';
                }
                if (result.wallet_balance !== undefined) {
                    document.getElementById('walletBalanceLabel').textContent = '(' + formatBalance(result.wallet_balance) + ')';
                }

                // Load USD values for balances
                loadUsdValues(tokenBal, evrBal);
            } else {
                // If there's an error, show dashes
                document.getElementById('tokenBalance').textContent = '--';
                document.getElementById('evrBalance').textContent = '--';
                document.getElementById('vaultBalanceLabel').textContent = '(--)';
                document.getElementById('walletBalanceLabel').textContent = '(--)';
                if (result && result.error) {
                    console.error('ElectrumX balance fetch error:', result.error);
                }
            }
        } catch (error) {
            console.error('Failed to fetch balance from ElectrumX:', error);
            document.getElementById('tokenBalance').textContent = '--';
            document.getElementById('evrBalance').textContent = '--';
            document.getElementById('vaultBalanceLabel').textContent = '(--)';
            document.getElementById('walletBalanceLabel').textContent = '(--)';
        }
    }

    async function loadUsdValues(satoriBalance, evrBalance) {
        try {
            // Fetch SATORI price
            const satoriResponse = await fetch('/api/p2p/pricing/satori');
            if (satoriResponse.ok) {
                const satoriData = await satoriResponse.json();
                if (satoriData.success && satoriData.price && satoriData.price.last) {
                    const satoriPrice = parseFloat(satoriData.price.last) || 0;
                    const satoriUsd = (satoriBalance * satoriPrice).toFixed(2);
                    const tokenEl = document.getElementById('tokenUsdValue');
                    if (tokenEl) tokenEl.textContent = '~$' + satoriUsd + ' USDT';

                    // Also calculate stake USD (assume same price)
                    const stakeEl = document.getElementById('stakeBalance');
                    if (stakeEl && stakeEl.textContent !== '--') {
                        const stakeAmount = parseFloat(stakeEl.textContent) || 0;
                        const stakeUsd = (stakeAmount * satoriPrice).toFixed(2);
                        const stakeUsdEl = document.getElementById('stakeUsdValue');
                        if (stakeUsdEl) stakeUsdEl.textContent = '~$' + stakeUsd + ' USDT';
                    }
                }
            }

            // Fetch EVR price
            const evrResponse = await fetch('/api/p2p/pricing/evr');
            if (evrResponse.ok) {
                const evrData = await evrResponse.json();
                if (evrData.success && evrData.price && evrData.price.last) {
                    const evrPrice = parseFloat(evrData.price.last) || 0;
                    const evrUsd = (evrBalance * evrPrice).toFixed(2);
                    const evrEl = document.getElementById('evrUsdValue');
                    if (evrEl) evrEl.textContent = '~$' + evrUsd + ' USDT';
                }
            }
        } catch (error) {
            console.error('Error loading USD values:', error);
        }
    }

    async function loadAllBalances() {
        // Load both stake (from API) and live balances (from ElectrumX)
        await Promise.all([
            loadBalance(),      // Stake from Satori API
            refreshBalance()    // SATORI and EVR from ElectrumX
        ]);
    }

    async function loadRewardAddress() {
        const result = await apiCall('/peer/reward-address');
        if (result && result.reward_address) {
            document.getElementById('currentRewardAddress').value = result.reward_address;
        }
    }

    async function setRewardAddress() {
        const address = document.getElementById('newRewardAddress').value.trim();
        if (!address) {
            showToast('Please enter an address', true);
            return;
        }
        if (!isValidAddress(address)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        const result = await apiCall('/peer/reward-address', 'POST', { reward_address: address });
        if (result) {
            showToast('Reward address updated');
            loadRewardAddress();
            document.getElementById('newRewardAddress').value = '';
        }
    }

    async function loadStakingStatus() {
        const result = await apiCall('/lender/status');
        const statusEl = document.getElementById('stakingStatus');
        if (result && result.pool_address) {
            isStakingToPool = true;
            statusEl.className = 'alert alert-success';
            statusEl.textContent = 'Staking with pool: ' + result.pool_address;
            // Update the pool address input field
            document.getElementById('poolAddress').value = result.pool_address;
        } else {
            isStakingToPool = false;
            statusEl.className = 'alert alert-secondary';
            statusEl.textContent = 'Not staking with a pool';
            // Clear the pool address input field
            document.getElementById('poolAddress').value = '';
        }
        updateMutualExclusionUI();
    }

    async function addStakeToPool() {
        const pool = document.getElementById('poolAddress').value.trim();
        if (!pool) {
            showToast('Please enter a pool address', true);
            return;
        }
        if (!isValidAddress(pool)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        const result = await apiCall('/lender/lend', 'POST', { pool_address: pool });
        if (result) {
            showToast('Stake added to pool');
            loadStakingStatus();
        }
    }

    async function removeStakeFromPool() {
        const result = await apiCall('/lender/lend', 'DELETE');
        if (result) {
            showToast('Stake removed from pool');
            loadStakingStatus();
        }
    }

    async function loadAvailablePools() {
        const listEl = document.getElementById('availablePoolsList');
        listEl.innerHTML = '<div class="text-muted small p-2">Loading pools...</div>';

        const result = await apiCall('/pool/open', 'GET');
        if (result && result.pools && result.pools.length > 0) {
            listEl.innerHTML = '';
            result.pools.forEach(pool => {
                const item = document.createElement('a');
                item.href = '#';
                item.className = 'list-group-item list-group-item-action';
                item.onclick = (e) => {
                    e.preventDefault();
                    document.getElementById('poolAddress').value = pool.address;
                };
                item.innerHTML = `
                    <div class="d-flex w-100 justify-content-between align-items-center">
                        <div>
                            <small class="text-muted">Address:</small><br>
                            <code class="small">${pool.address}</code>
                        </div>
                        <div class="text-end">
                            ${pool.alias ? `<span class="badge bg-primary">${pool.alias}</span><br>` : ''}
                            <small class="text-success fw-bold">${pool.commission}% commission</small>
                        </div>
                    </div>
                `;
                listEl.appendChild(item);
            });
        } else {
            listEl.innerHTML = '<div class="text-muted small p-2">No open pools available</div>';
        }
    }

    async function setPoolCommission() {
        const commissionInput = document.getElementById('poolCommission');
        let commission = commissionInput.value ? parseInt(commissionInput.value) : null;

        // Validate
        if (commission !== null && (commission < 0 || commission > 100)) {
            showToast('Commission must be between 0 and 100', true);
            return;
        }

        // Convert 0 to null (closed)
        if (commission === 0) {
            commission = null;
        }

        const result = await apiCall('/pool/toggle-open', 'POST', { commission: commission });
        if (result) {
            const msg = commission === null ? 'Pool closed' : `Pool open with ${commission}% commission`;
            showToast(msg);
            await loadPoolCommission();
            await loadAvailablePools();  // Refresh pool list to show updated commission
            updateMutualExclusionUI();
        }
    }

    async function loadPoolCommission() {
        const result = await apiCall('/pool/commission', 'GET');
        if (result) {
            const commissionInput = document.getElementById('poolCommission');
            commissionInput.value = result.commission || '';
            isOpenPool = result.commission !== null && result.commission > 0;
            updateMutualExclusionUI();  // Update UI after setting isOpenPool
        }
    }

    async function loadWorkers() {
        const workerListEl = document.getElementById('workerList');
        const result = await apiCall('/pool/workers');

        if (result && result.workers && result.workers.length > 0) {
            hasWorkers = true;
            workerListEl.innerHTML = '';
            result.workers.forEach(worker => {
                const workerItem = document.createElement('div');
                workerItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                workerItem.innerHTML = `
                    <div>
                        <small class="text-muted">Address:</small><br>
                        <code class="small">${worker.address}</code>
                        ${worker.alias ? `<br><span class="badge bg-secondary">${worker.alias}</span>` : ''}
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeWorker('${worker.address}')">
                        <i class="material-icons align-middle" style="font-size: 16px;">delete</i>
                    </button>
                `;
                workerListEl.appendChild(workerItem);
            });
        } else {
            hasWorkers = false;
            workerListEl.innerHTML = '<p class="text-muted">No workers</p>';
        }

        updateMutualExclusionUI();
    }

    async function loadLenders() {
        const lenderListEl = document.getElementById('lenderList');
        const result = await apiCall('/pool/lenders');

        if (result && result.lenders && result.lenders.length > 0) {
            lenderListEl.innerHTML = '';
            result.lenders.forEach(lender => {
                const lenderItem = document.createElement('div');
                lenderItem.className = 'd-flex justify-content-between align-items-center mb-2 p-2 border rounded';
                lenderItem.innerHTML = `
                    <div>
                        <small class="text-muted">Address:</small><br>
                        <code class="small">${lender.address}</code>
                        ${lender.alias ? `<br><span class="badge bg-secondary">${lender.alias}</span>` : ''}
                    </div>
                `;
                lenderListEl.appendChild(lenderItem);
            });
        } else {
            lenderListEl.innerHTML = '<p class="text-muted">No pool stakers</p>';
        }
    }

    // Get central-lite API URL
    function getCentralApiUrl() {
        // For development: assume central-lite runs on port 8000
        // For production: this should be configured properly
        const protocol = window.location.protocol;
        const hostname = window.location.hostname;

        // If we're on localhost, use localhost:8000
        // Otherwise, use the same hostname (assumes central-lite on same domain)
        if (hostname === 'localhost' || hostname === '127.0.0.1') {
            return `${protocol}//${hostname}:8000`;
        }
        return `${protocol}//${hostname}`;
    }

    // Helper function to download JSON data as a file
    function downloadJSON(data, filename) {
        const blob = new Blob([JSON.stringify(data, null, 2)], {
            type: 'application/json'
        });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = filename;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    // Download workers audit
    async function downloadWorkersAudit() {
        try {
            const centralApiUrl = getCentralApiUrl();
            const response = await fetch(`${centralApiUrl}/api/v1/audit/workers/latest`);

            if (!response.ok) {
                if (response.status === 404) {
                    showToast('No workers audit available yet', 'warning');
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `workers_audit_${timestamp}.json`;

            downloadJSON(data, filename);
            showToast('Workers audit downloaded');
        } catch (error) {
            console.error('Error downloading workers audit:', error);
            showToast('Failed to download workers audit', 'error');
        }
    }

    // Download pool stakers audit
    async function downloadLendersAudit() {
        try {
            const centralApiUrl = getCentralApiUrl();
            const response = await fetch(`${centralApiUrl}/api/v1/audit/stakers/latest`);

            if (!response.ok) {
                if (response.status === 404) {
                    showToast('No pool stakers audit available yet', 'warning');
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const data = await response.json();

            // Generate filename with timestamp
            const now = new Date();
            const timestamp = now.toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `stakers_audit_${timestamp}.json`;

            downloadJSON(data, filename);
            showToast('Pool stakers audit downloaded');
        } catch (error) {
            console.error('Error downloading pool stakers audit:', error);
            showToast('Failed to download pool stakers audit', 'error');
        }
    }

    // Pay lenders from audit
    async function payLenders() {
        try {
            // 1. Fetch audit
            showToast('Fetching audit...', 'info');
            const centralApiUrl = getCentralApiUrl();
            const response = await fetch(`${centralApiUrl}/api/v1/audit/stakers/latest`);

            if (!response.ok) {
                if (response.status === 404) {
                    showToast('No audit available yet', 'warning');
                    return;
                }
                throw new Error(`HTTP ${response.status}`);
            }

            const audit = await response.json();

            // 2. Find my pool and lenders
            const myAddress = await apiCall('/wallet/address');
            if (!myAddress || !myAddress.wallet_address) {
                showToast('Unable to determine your wallet address', 'error');
                return;
            }

            const myPool = audit.pools.find(p => p.pool_address === myAddress.wallet_address);

            if (!myPool || !myPool.lenders || myPool.lenders.length === 0) {
                showToast('No pool stakers to pay', 'info');
                return;
            }

            // 3. Build payment dictionary
            const payments = {};
            myPool.lenders.forEach(lender => {
                if (lender.commission_owed > 0) {
                    payments[lender.lender_address] = lender.commission_owed;
                }
            });

            const count = Object.keys(payments).length;
            if (count === 0) {
                showToast('No pool stakers with amounts owed', 'info');
                return;
            }

            const total = Object.values(payments).reduce((sum, amt) => sum + amt, 0);

            // 4. Check balance
            const balance = await apiCall('/wallet/balance/direct');
            if (!balance) {
                showToast('Unable to check balance', 'error');
                return;
            }

            if (balance.vault_balance < total) {
                showToast(`Insufficient balance: need ${formatBalance(total)}, have ${formatBalance(balance.vault_balance)}`, 'error');
                return;
            }

            // 5. Confirm with user
            const confirmMsg =
                `Pay ${count} pool stakers a total of ${formatBalance(total)} SATORI?\n\n` +
                `Your balance: ${formatBalance(balance.vault_balance)} SATORI\n` +
                `EVR for fees: ${formatBalance(balance.vault_evr)} EVR\n\n` +
                `⚠️ This action cannot be undone!`;

            if (!confirm(confirmMsg)) {
                return;
            }

            // 6. Send payment
            showToast('Sending payment to pool stakers...', 'info');

            const paymentResponse = await fetch('/api/lender/pay', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({payments})
            });

            const data = await paymentResponse.json();

            if (data.success) {
                // 7. Show success
                const explorerUrl = `https://evr.cryptoscope.io/tx/?hash=${data.txhash}`;
                showToast(`✓ Paid ${data.lenders_paid} pool stakers!`, 'success');

                const resultMsg =
                    `Successfully paid ${data.lenders_paid} pool stakers!\n\n` +
                    `Total: ${formatBalance(data.total_sent)} SATORI\n\n` +
                    `Transaction: ${data.txhash}\n\n` +
                    `View on blockchain explorer:\n${explorerUrl}`;

                alert(resultMsg);

                // Refresh balance
                loadAllBalances();
            } else {
                showToast(`Payment failed: ${data.error}`, 'error');
            }

        } catch (error) {
            console.error('Error paying pool stakers:', error);
            showToast(`Failed to pay pool stakers: ${error.message}`, 'error');
        }
    }

    function isValidAddress(address) {
        return address && address.length === 34 && address.startsWith('E');
    }

    async function addWorker() {
        const address = document.getElementById('newWorkerAddress').value.trim();
        if (!address) {
            showToast('Please enter a worker address', true);
            return;
        }
        if (!isValidAddress(address)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        const result = await apiCall('/pool/worker', 'POST', { worker_address: address });
        if (result) {
            showToast('Worker added');
            document.getElementById('newWorkerAddress').value = '';
            loadWorkers();
        }
    }

    async function removeWorker(address) {
        const result = await apiCall(`/pool/worker/${address}`, 'DELETE');
        if (result) {
            showToast('Worker removed');
            loadWorkers();
        }
    }

    async function checkHealth() {
        try {
            const response = await fetch('/health');
            const data = await response.json();
            const indicator = document.getElementById('statusIndicator');
            const text = document.getElementById('statusText');
            if (data.api === 'connected') {
                indicator.className = 'status-indicator status-online';
                text.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-offline';
                text.textContent = 'Disconnected';
            }
        } catch (error) {
            document.getElementById('statusIndicator').className = 'status-indicator status-offline';
            document.getElementById('statusText').textContent = 'Disconnected';
        }
    }

    async function loadWalletAddresses() {
        const result = await apiCall('/wallet/address');
        if (result) {
            // Main wallet uses vault address
            if (result.vault_address) {
                document.getElementById('walletAddress').value = result.vault_address;
                loadQrCode(result.vault_address);
            } else {
                document.getElementById('walletAddress').value = 'Not available';
                document.getElementById('walletQrCode').innerHTML = '<p class="text-muted mb-0">No address</p>';
            }
            // Identity wallet (for backup)
            if (result.wallet_address) {
                document.getElementById('identityAddress').value = result.wallet_address;
            } else {
                document.getElementById('identityAddress').value = 'Not available';
            }
        }
    }

    // Identity Wallet functions
    let identityWalletVisible = false;
    let identityPrivateKeyLoaded = false;
    let identityPrivateKeyVisible = false;

    function toggleIdentityWallet() {
        const section = document.getElementById('identityWalletSection');
        identityWalletVisible = !identityWalletVisible;
        section.style.display = identityWalletVisible ? 'block' : 'none';
    }

    async function toggleIdentityPrivateKey() {
        const input = document.getElementById('identityPrivateKey');
        const icon = document.getElementById('identityKeyIcon');

        if (!identityPrivateKeyLoaded) {
            // Load the identity private key from API
            const result = await apiCall('/wallet/identity-private-key');
            if (result && result.private_key) {
                input.value = result.private_key;
                identityPrivateKeyLoaded = true;
            } else {
                input.value = 'Unable to load';
            }
        }

        identityPrivateKeyVisible = !identityPrivateKeyVisible;
        input.type = identityPrivateKeyVisible ? 'text' : 'password';
        icon.textContent = identityPrivateKeyVisible ? 'visibility_off' : 'visibility';
    }

    function copyIdentityPrivateKey() {
        const input = document.getElementById('identityPrivateKey');
        if (input.value && input.value !== 'Click to reveal...' && input.value !== 'Unable to load') {
            navigator.clipboard.writeText(input.value).then(() => {
                showToast('Identity private key copied to clipboard');
            }).catch(() => {
                showToast('Failed to copy', true);
            });
        } else {
            showToast('Please reveal the private key first', true);
        }
    }

    function copyToClipboard(elementId) {
        const input = document.getElementById(elementId);
        const value = input.value;
        if (value && value !== 'Loading...' && value !== 'Not available') {
            navigator.clipboard.writeText(value).then(() => {
                showToast('Address copied to clipboard');
            }).catch(() => {
                // Fallback for older browsers
                input.select();
                document.execCommand('copy');
                showToast('Address copied to clipboard');
            });
        }
    }

    // Wallet Card Functions
    let privateKeyLoaded = false;

    async function loadQrCode(address) {
        const qrContainer = document.getElementById('walletQrCode');
        const result = await apiCall('/wallet/qr/' + encodeURIComponent(address));
        if (result && result.qr_code) {
            qrContainer.innerHTML = '<img src="' + result.qr_code + '" alt="QR Code" style="max-width: 150px;">';
        } else {
            qrContainer.innerHTML = '<p class="text-muted mb-0">QR code unavailable</p>';
        }
    }

    async function togglePrivateKey() {
        const showBtn = document.getElementById('showPrivateKeyBtn');
        const section = document.getElementById('privateKeySection');

        if (section.style.display === 'none') {
            // Show private key (vault private key)
            if (!privateKeyLoaded) {
                const result = await apiCall('/wallet/private-key');
                if (result && result.private_key) {
                    document.getElementById('walletPrivateKey').textContent = result.private_key;
                    privateKeyLoaded = true;
                } else {
                    document.getElementById('walletPrivateKey').textContent = 'Unable to load private key';
                }
            }
            showBtn.style.display = 'none';
            section.style.display = 'block';
        } else {
            // Hide private key
            showBtn.style.display = 'block';
            section.style.display = 'none';
        }
    }

    function copyPrivateKey() {
        const privateKey = document.getElementById('walletPrivateKey').textContent;
        if (privateKey && privateKey !== 'Loading...' && privateKey !== 'Unable to load private key') {
            navigator.clipboard.writeText(privateKey).then(() => {
                showToast('Private key copied to clipboard');
            }).catch(() => {
                showToast('Failed to copy private key', true);
            });
        }
    }

    function toggleSweepAmount() {
        const sweepCheckbox = document.getElementById('sendSweep');
        const amountInput = document.getElementById('sendAmount');
        if (sweepCheckbox.checked) {
            amountInput.disabled = true;
            amountInput.value = '';
            amountInput.placeholder = 'All tokens';
        } else {
            amountInput.disabled = false;
            amountInput.placeholder = '0.00';
        }
    }

    async function sendTransaction() {
        const address = document.getElementById('sendDestAddress').value.trim();
        const amount = document.getElementById('sendAmount').value;
        const sweep = document.getElementById('sendSweep').checked;
        const sendBtn = document.getElementById('sendBtn');
        const resultDiv = document.getElementById('sendResult');

        // Get selected source (wallet or vault)
        const sendSource = document.querySelector('input[name="sendSource"]:checked').value;
        const sourceName = sendSource === 'wallet' ? 'Identity Wallet' : 'Vault';

        // Validate
        if (!address) {
            showToast('Please enter a destination address', true);
            return;
        }
        if (!isValidAddress(address)) {
            showToast('Invalid address: must start with E and be 34 characters', true);
            return;
        }
        if (!sweep && (!amount || parseFloat(amount) <= 0)) {
            showToast('Please enter an amount or select "Send All"', true);
            return;
        }

        // Confirm with source information
        const confirmMsg = sweep
            ? 'Send ALL tokens from ' + sourceName + ' to ' + address + '?'
            : 'Send ' + amount + ' SATORI from ' + sourceName + ' to ' + address + '?';
        if (!confirm(confirmMsg)) {
            return;
        }

        // Send
        sendBtn.disabled = true;
        sendBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';
        resultDiv.style.display = 'none';

        try {
            const data = { address: address, sweep: sweep };
            if (!sweep) {
                data.amount = parseFloat(amount);
            }

            // Use the appropriate endpoint based on source selection
            const endpoint = sendSource === 'wallet' ? '/wallet/send-from-wallet' : '/wallet/send';
            const result = await apiCall(endpoint, 'POST', data);

            if (result && result.success) {
                resultDiv.className = 'mt-3 alert alert-success';
                resultDiv.innerHTML = '<strong>Success!</strong><br>Sent from ' + sourceName + '<br>Transaction ID: <code style="word-break: break-all;">' + result.txid + '</code>';
                resultDiv.style.display = 'block';
                showToast('Transaction sent successfully from ' + sourceName + '!');
                // Clear form
                document.getElementById('sendDestAddress').value = '';
                document.getElementById('sendAmount').value = '';
                document.getElementById('sendSweep').checked = false;
                toggleSweepAmount();
                // Refresh balances to show updated amounts
                refreshBalance();
            } else {
                const errorMsg = result ? (result.error || 'Transaction failed') : 'Transaction failed';
                resultDiv.className = 'mt-3 alert alert-danger';
                resultDiv.innerHTML = '<strong>Error:</strong> ' + errorMsg;
                resultDiv.style.display = 'block';
                showToast('Transaction failed: ' + errorMsg, true);
            }
        } catch (error) {
            resultDiv.className = 'mt-3 alert alert-danger';
            resultDiv.innerHTML = '<strong>Error:</strong> ' + error.message;
            resultDiv.style.display = 'block';
            showToast('Transaction error: ' + error.message, true);
        } finally {
            sendBtn.disabled = false;
            sendBtn.innerHTML = '<i class="material-icons align-middle me-1">send</i> Send Transaction';
        }
    }

    // AI Engine Training Frequency Control
    function sliderToSeconds(sliderValue) {
        // Convert slider percentage to seconds (non-linear logarithmic scale)
        // 0% = 24 hours, 25% = 1 hour, 50% = 10 min, 75% = 1 min, 100% = 0 sec
        const percentage = sliderValue / 100.0;

        if (percentage <= 0.0) return 86400;  // 24 hours
        if (percentage >= 1.0) return 0;      // continuous

        // Improved logarithmic scale using exponential decay
        // Maps 0%->86400s (24h), 50%->675s (~11min), 100%->0s (continuous)
        const delay = Math.round(86400 * Math.pow(1 - percentage, 7));
        return delay;
    }

    function secondsToSlider(seconds) {
        // Convert seconds to slider percentage (inverse of sliderToSeconds)
        if (seconds >= 86400) return 0;
        if (seconds <= 0) return 100;

        // Inverse of logarithmic scale
        const percentage = 1 - Math.pow(seconds / 86400, 1/7);
        return Math.round(percentage * 100);
    }

    function formatDelay(seconds) {
        // Format seconds into human-readable string
        if (seconds === 0) return "Continuous";
        if (seconds < 60) return seconds + " seconds";
        if (seconds < 3600) return Math.round(seconds / 60) + " minutes";
        if (seconds < 86400) return Math.round(seconds / 3600) + " hours";
        return Math.round(seconds / 86400) + " days";
    }

    function updateTrainingDelayLabel(sliderValue) {
        // Update label as slider moves
        const seconds = sliderToSeconds(sliderValue);
        document.getElementById('trainingDelayLabel').textContent = formatDelay(seconds);
    }

    async function setTrainingDelay(sliderValue) {
        // Save to backend when slider changes
        const seconds = sliderToSeconds(sliderValue);

        try {
            const result = await apiCall('/engine/training-delay', 'POST', {
                delay_seconds: seconds
            });

            if (result && !result.error) {
                showToast(`Training frequency updated: ${formatDelay(seconds)}`);
            } else {
                showToast('Failed to update training frequency', true);
            }
        } catch (error) {
            console.error('Error setting training delay:', error);
            showToast('Failed to update training frequency', true);
        }
    }

    async function loadTrainingDelay() {
        // Load current setting on page load
        try {
            const result = await apiCall('/engine/training-delay');

            if (result && result.delay_seconds !== undefined) {
                const sliderValue = secondsToSlider(result.delay_seconds);
                document.getElementById('trainingDelaySlider').value = sliderValue;
                updateTrainingDelayLabel(sliderValue);
            }
        } catch (error) {
            console.error('Error loading training delay:', error);
        }
    }

    // =========================================================================
    // DONATION FUNCTIONS
    // =========================================================================

    async function loadTreasuryAddress() {
        const result = await apiCall('/donate/treasury-address');
        if (result && result.treasury_address) {
            document.getElementById('treasuryAddress').value = result.treasury_address;
        } else {
            document.getElementById('treasuryAddress').value = 'Not available';
        }
    }

    async function loadDonationStats() {
        await loadTreasuryAddress();

        const result = await apiCall('/donate/stats');
        if (result) {
            // Update stats
            document.getElementById('donorTotalDonated').textContent =
                result.total_donated ? result.total_donated.toFixed(2) + ' EVR' : '0 EVR';
            document.getElementById('donorTier').textContent = result.tier || 'None';
            document.getElementById('donorRewardsReceived').textContent =
                result.rewards_received ? result.rewards_received.toFixed(4) + ' SAT' : '0 SAT';

            // Update tier progress
            if (result.progress_to_next !== undefined && result.next_tier) {
                const progressPct = Math.min(100, result.progress_to_next * 100);
                document.getElementById('tierProgressBar').style.width = progressPct + '%';
                const remaining = result.next_tier_threshold - result.total_donated;
                document.getElementById('tierProgressText').textContent =
                    remaining > 0 ? remaining.toFixed(0) + ' EVR to ' + result.next_tier : 'Max tier reached!';
            } else {
                document.getElementById('tierProgressBar').style.width = '100%';
                document.getElementById('tierProgressText').textContent = 'Diamond tier achieved!';
            }
        }
    }

    function updateDonationEstimate() {
        const amount = parseFloat(document.getElementById('donationAmount').value) || 0;
        // Estimate: 1 EVR = 0.01 SATORI (example rate, will be fetched from server)
        const estimatedReward = amount * 0.01;
        document.getElementById('donationEstimate').textContent =
            '≈ ' + estimatedReward.toFixed(4) + ' SATORI reward';
    }

    async function sendDonation() {
        const amount = parseFloat(document.getElementById('donationAmount').value);
        if (!amount || amount <= 0) {
            showToast('Please enter a valid donation amount', true);
            return;
        }

        const donateBtn = document.getElementById('donateBtn');
        const resultDiv = document.getElementById('donationResult');

        // Confirm
        if (!confirm('Donate ' + amount + ' EVR to the Satori Treasury?')) {
            return;
        }

        donateBtn.disabled = true;
        donateBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Sending...';
        resultDiv.style.display = 'none';

        try {
            const result = await apiCall('/donate/send', 'POST', { amount: amount });

            if (result && result.success) {
                resultDiv.className = 'mt-2 alert alert-success py-2';
                resultDiv.innerHTML = '<small><strong>Success!</strong> TX: <code>' +
                    (result.tx_hash ? result.tx_hash.substring(0, 16) + '...' : 'pending') + '</code></small>';
                resultDiv.style.display = 'block';
                showToast('Donation sent successfully!');
                document.getElementById('donationAmount').value = '';
                loadDonationStats();
                refreshBalance();
            } else {
                const errorMsg = result ? (result.error || 'Donation failed') : 'Donation failed';
                resultDiv.className = 'mt-2 alert alert-danger py-2';
                resultDiv.innerHTML = '<small><strong>Error:</strong> ' + errorMsg + '</small>';
                resultDiv.style.display = 'block';
                showToast('Donation failed: ' + errorMsg, true);
            }
        } catch (error) {
            resultDiv.className = 'mt-2 alert alert-danger py-2';
            resultDiv.innerHTML = '<small><strong>Error:</strong> ' + error.message + '</small>';
            resultDiv.style.display = 'block';
            showToast('Donation error: ' + error.message, true);
        } finally {
            donateBtn.disabled = false;
            donateBtn.innerHTML = '<i class="material-icons align-middle me-1">send</i> Send Donation';
        }
    }

    let topDonorsVisible = false;
    async function toggleTopDonors() {
        const listEl = document.getElementById('topDonorsList');
        topDonorsVisible = !topDonorsVisible;

        if (topDonorsVisible) {
            listEl.style.display = 'block';
            listEl.innerHTML = '<div class="text-muted small">Loading...</div>';

            const result = await apiCall('/donate/top-donors?limit=10');
            if (result && result.donors && result.donors.length > 0) {
                listEl.innerHTML = '<table class="table table-sm mb-0"><thead><tr><th>#</th><th>Address</th><th>Total</th><th>Tier</th></tr></thead><tbody>' +
                    result.donors.map((d, i) => `<tr>
                        <td>${i + 1}</td>
                        <td><code class="small">${d.address ? d.address.substring(0, 10) + '...' : 'Unknown'}</code></td>
                        <td>${d.total_donated ? d.total_donated.toFixed(0) : 0} EVR</td>
                        <td><span class="badge bg-${getTierColor(d.tier)}">${d.tier || 'None'}</span></td>
                    </tr>`).join('') +
                    '</tbody></table>';
            } else {
                listEl.innerHTML = '<div class="text-muted small">No donors yet</div>';
            }
        } else {
            listEl.style.display = 'none';
        }
    }

    function getTierColor(tier) {
        const colors = {
            'bronze': 'warning',
            'silver': 'secondary',
            'gold': 'warning',
            'platinum': 'info',
            'diamond': 'primary'
        };
        return colors[tier?.toLowerCase()] || 'secondary';
    }

    // =========================================================================
    // REFERRAL SYSTEM FUNCTIONS
    // =========================================================================

    const REFERRAL_TIERS = [
        { name: 'None', count: 0, bonus: 0, color: '#9e9e9e' },
        { name: 'Bronze', count: 5, bonus: 2, color: '#cd7f32' },
        { name: 'Silver', count: 25, bonus: 5, color: '#c0c0c0' },
        { name: 'Gold', count: 100, bonus: 8, color: '#ffd700' },
        { name: 'Platinum', count: 500, bonus: 12, color: '#e5e4e2' },
        { name: 'Diamond', count: 2000, bonus: 15, color: '#b9f2ff' }
    ];

    async function loadReferralStats() {
        try {
            const result = await apiCall('/referral/stats');
            if (result) {
                const count = result.referral_count || 0;
                const tier = result.tier || 'None';
                const bonus = result.bonus_percent || 0;

                document.getElementById('referralCount').textContent = count;
                document.getElementById('referralTier').textContent = tier;
                document.getElementById('referralBonus').textContent = '+' + bonus + '%';

                // Set tier color
                const tierInfo = REFERRAL_TIERS.find(t => t.name === tier) || REFERRAL_TIERS[0];
                document.getElementById('referralTier').style.color = tierInfo.color;

                // Calculate progress to next tier
                const currentTierIndex = REFERRAL_TIERS.findIndex(t => t.name === tier);
                const nextTier = REFERRAL_TIERS[currentTierIndex + 1];

                if (nextTier) {
                    document.getElementById('referralNextTier').textContent =
                        (nextTier.count - count) + ' more to ' + nextTier.name;
                    const prevThreshold = tierInfo.count;
                    const nextThreshold = nextTier.count;
                    const progress = ((count - prevThreshold) / (nextThreshold - prevThreshold)) * 100;
                    document.getElementById('referralTierProgressBar').style.width = Math.min(progress, 100) + '%';
                } else {
                    document.getElementById('referralNextTier').textContent = 'Max tier reached!';
                    document.getElementById('referralTierProgressBar').style.width = '100%';
                }
            }
        } catch (error) {
            console.error('Error loading referral stats:', error);
        }

        // Set referral link
        const addressResult = await apiCall('/wallet/address');
        if (addressResult && addressResult.wallet_address) {
            document.getElementById('referralLink').value =
                'https://satorinet.io/download/' + addressResult.wallet_address;
        }
    }

    async function setReferrer() {
        const address = document.getElementById('referrerAddress').value.trim();
        if (!address || address.length !== 34) {
            showToast('Please enter a valid 34-character address', true);
            return;
        }

        try {
            const result = await apiCall('/referral/set', 'POST', { referrer_address: address });
            if (result && result.success) {
                showToast('Referrer set successfully!');
                document.getElementById('referrerAddress').value = '';
            } else {
                showToast(result?.error || 'Failed to set referrer', true);
            }
        } catch (error) {
            showToast('Error setting referrer: ' + error.message, true);
        }
    }

    let topReferrersVisible = false;
    async function toggleTopReferrers() {
        const listEl = document.getElementById('topReferrersList');
        topReferrersVisible = !topReferrersVisible;

        if (topReferrersVisible) {
            listEl.style.display = 'block';
            listEl.innerHTML = '<div class="text-muted small">Loading...</div>';

            const result = await apiCall('/referral/top?limit=10');
            if (result && result.referrers && result.referrers.length > 0) {
                listEl.innerHTML = '<table class="table table-sm mb-0"><thead><tr><th>#</th><th>Address</th><th>Count</th><th>Tier</th><th>Bonus</th></tr></thead><tbody>' +
                    result.referrers.map((r, i) => {
                        const tierInfo = REFERRAL_TIERS.find(t => t.name === r.tier) || REFERRAL_TIERS[0];
                        return `<tr>
                            <td>${i + 1}</td>
                            <td><code class="small">${r.address ? r.address.substring(0, 10) + '...' : 'Unknown'}</code></td>
                            <td>${r.referral_count || 0}</td>
                            <td style="color: ${tierInfo.color};">${r.tier || 'None'}</td>
                            <td style="color: #4CAF50;">+${r.bonus_percent || 0}%</td>
                        </tr>`;
                    }).join('') +
                    '</tbody></table>';
            } else {
                listEl.innerHTML = '<div class="text-muted small">No referrers yet</div>';
            }
        } else {
            listEl.style.display = 'none';
        }
    }

    // =========================================================================
    // TREASURY ALERTS FUNCTIONS
    // =========================================================================

    async function loadTreasuryAlerts() {
        try {
            // Load treasury status
            const status = await apiCall('/p2p/treasury/status');
            const card = document.getElementById('treasuryAlertsCard');

            if (!status) {
                card.style.display = 'none';
                return;
            }

            // Show the card if we have status
            card.style.display = 'block';

            // Update treasury levels
            const satoriLevel = document.getElementById('treasurySatoriLevel');
            const evrLevel = document.getElementById('treasuryEvrLevel');
            const alertIcon = document.getElementById('treasuryAlertIcon');
            const alertTitle = document.getElementById('treasuryAlertTitle');

            // Color-code based on severity
            if (status.severity === 'critical') {
                satoriLevel.className = 'h5 mb-0 text-danger';
                evrLevel.className = 'h5 mb-0 text-danger';
                alertIcon.textContent = 'error';
                alertIcon.className = 'material-icons align-middle me-2 text-danger';
                alertTitle.className = 'text-danger';
                alertTitle.textContent = 'Treasury Critical';
            } else if (status.severity === 'warning') {
                satoriLevel.className = 'h5 mb-0 text-warning';
                evrLevel.className = 'h5 mb-0 text-warning';
                alertIcon.textContent = 'warning';
                alertIcon.className = 'material-icons align-middle me-2 text-warning';
                alertTitle.textContent = 'Treasury Warning';
            } else {
                satoriLevel.className = 'h5 mb-0 text-success';
                evrLevel.className = 'h5 mb-0 text-success';
                alertIcon.textContent = 'check_circle';
                alertIcon.className = 'material-icons align-middle me-2 text-success';
                alertTitle.textContent = 'Treasury Healthy';
            }

            satoriLevel.textContent = status.satori_level || 'Normal';
            evrLevel.textContent = status.evr_level || 'Normal';

            // Show active alert banner if there's a current alert
            const banner = document.getElementById('activeAlertBanner');
            const actionButtonsDiv = document.getElementById('alertActionButtons');
            if (status.active_alert) {
                banner.style.display = 'block';
                banner.className = 'alert alert-' + getSeverityClass(status.active_alert.severity) + ' mb-3';
                document.getElementById('alertBannerIcon').textContent = getSeverityIcon(status.active_alert.severity);
                document.getElementById('alertBannerTitle').textContent = status.active_alert.type.replace(/_/g, ' ').toUpperCase();
                document.getElementById('alertBannerMessage').textContent = status.active_alert.message || 'Treasury issue detected';

                // Render action buttons
                actionButtonsDiv.innerHTML = '';
                const actions = status.active_alert.actions || [];
                actions.forEach(action => {
                    const btn = document.createElement('button');
                    btn.className = 'btn btn-sm ' + getActionButtonClass(action.action_type);
                    btn.innerHTML = `<i class="material-icons align-middle me-1" style="font-size: 14px;">${getActionIcon(action.action_type)}</i>${action.label}`;
                    btn.title = action.description || '';
                    btn.onclick = () => handleAlertAction(action);
                    actionButtonsDiv.appendChild(btn);
                });
            } else {
                banner.style.display = 'none';
                actionButtonsDiv.innerHTML = '';
            }

            // Load deferred rewards
            await loadDeferredRewards();

        } catch (e) {
            console.error('Failed to load treasury alerts:', e);
        }
    }

    async function loadDeferredRewards() {
        try {
            const result = await apiCall('/p2p/treasury/deferred');
            const section = document.getElementById('deferredRewardsSection');

            if (result && result.total_pending > 0) {
                section.style.display = 'block';
                document.getElementById('deferredTotal').textContent =
                    result.total_pending.toFixed(4) + ' SATORI';
                document.getElementById('deferredCount').textContent =
                    result.deferred_count || 0;
            } else {
                section.style.display = 'none';
            }
        } catch (e) {
            console.error('Failed to load deferred rewards:', e);
            document.getElementById('deferredRewardsSection').style.display = 'none';
        }
    }

    let alertHistoryVisible = false;
    async function toggleAlertHistory() {
        const listEl = document.getElementById('alertHistoryList');
        alertHistoryVisible = !alertHistoryVisible;

        if (alertHistoryVisible) {
            listEl.style.display = 'block';
            listEl.innerHTML = '<div class="text-muted small">Loading...</div>';

            const result = await apiCall('/p2p/treasury/alerts/history?limit=10');
            if (result && result.history && result.history.length > 0) {
                listEl.innerHTML = result.history.map(alert => {
                    const date = new Date(alert.timestamp * 1000).toLocaleDateString();
                    const time = new Date(alert.timestamp * 1000).toLocaleTimeString();
                    return `<div class="mb-2 p-2 border-start border-${getSeverityClass(alert.severity)} border-3">
                        <small class="text-muted">${date} ${time}</small><br>
                        <span class="badge bg-${getSeverityClass(alert.severity)} me-1">${alert.severity}</span>
                        <span class="small">${alert.type.replace(/_/g, ' ')}</span>
                    </div>`;
                }).join('');
            } else {
                listEl.innerHTML = '<div class="text-muted small">No alert history</div>';
            }
        } else {
            listEl.style.display = 'none';
        }
    }

    function getSeverityClass(severity) {
        const classes = {
            'critical': 'danger',
            'warning': 'warning',
            'info': 'info'
        };
        return classes[severity?.toLowerCase()] || 'secondary';
    }

    function getSeverityIcon(severity) {
        const icons = {
            'critical': 'error',
            'warning': 'warning',
            'info': 'info'
        };
        return icons[severity?.toLowerCase()] || 'notifications';
    }

    function getActionButtonClass(actionType) {
        const classes = {
            'donate_evr': 'btn-success',
            'view_status': 'btn-outline-secondary',
            'none': 'btn-outline-secondary'
        };
        return classes[actionType] || 'btn-outline-secondary';
    }

    function getActionIcon(actionType) {
        const icons = {
            'donate_evr': 'volunteer_activism',
            'view_status': 'info',
            'none': 'arrow_forward'
        };
        return icons[actionType] || 'arrow_forward';
    }

    function handleAlertAction(action) {
        if (action.action_type === 'donate_evr') {
            // Scroll to and expand the donate section
            const donateCollapse = document.getElementById('donateCollapse');
            if (donateCollapse && !donateCollapse.classList.contains('show')) {
                new bootstrap.Collapse(donateCollapse, {show: true});
            }
            // Scroll to the donate section
            document.querySelector('[data-bs-target="#donateCollapse"]')?.scrollIntoView({behavior: 'smooth'});
            showToast('Scroll down to the Donate section to send EVR to treasury');
        } else if (action.action_type === 'view_status') {
            loadTreasuryAlerts();
            showToast('Treasury status refreshed');
        }
    }

    // Initialize dashboard
    document.addEventListener('DOMContentLoaded', function() {
        // Update theme icon based on stored theme
        const storedTheme = localStorage.getItem('satori-theme') || 'dark';
        const themeIcon = document.getElementById('themeIcon');
        if (themeIcon) {
            themeIcon.textContent = storedTheme === 'dark' ? 'light_mode' : 'dark_mode';
        }

        // Initialize Bootstrap tooltips
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Ensure both pool cards start collapsed (will be expanded by API calls if needed)
        const poolStakingCollapse = document.getElementById('poolStakingCollapse');
        const poolManagementCollapse = document.getElementById('poolManagementCollapse');
        if (poolStakingCollapse) {
            poolStakingCollapse.classList.remove('show');
        }
        if (poolManagementCollapse) {
            poolManagementCollapse.classList.remove('show');
        }

        // Health check disabled to reduce API load
        // checkHealth();
        loadWalletAddresses();
        loadAllBalances();  // Load both stake and live balances from ElectrumX
        loadRewardAddress();
        loadStakingStatus();
        loadWorkers();
        loadLenders();
        loadAvailablePools();
        loadPoolCommission();
        loadAllP2PData();  // Load P2P network health, heartbeats, delegations
        loadTrainingDelay();  // Load AI engine training frequency setting
        loadDonationStats();  // Load donation stats and treasury address
        loadReferralStats();  // Load referral stats
        loadTreasuryAlerts();  // Load treasury alerts and deferred rewards

        // Periodic refresh of P2P data (every 30s)
        setInterval(loadP2PHealth, 30000);
        setInterval(loadHeartbeats, 15000);
        setInterval(loadTreasuryAlerts, 60000);  // Refresh alerts every minute
    });
</script>
{% endblock %}
