{% extends "base.html" %}

{% block title %}Satori - Oracles & Streams{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg px-4">
    <span class="navbar-brand">
        Satori
        <small class="text-muted ms-2" style="font-size: 0.65rem; font-weight: 400; opacity: 0.6;">{{ version }}</small>
    </span>
    <div class="ms-auto d-flex align-items-center">
        <!-- Connected Status -->
        <span class="me-3">
            <span class="status-indicator status-online" id="statusIndicator"></span>
            <span id="statusText">Connected</span>
        </span>
        <!-- Navigation Links -->
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-sm me-2" title="Dashboard">
            <i class="material-icons align-middle" style="font-size: 16px;">dashboard</i>
            Dashboard
        </a>
        <a href="{{ url_for('network') }}" class="btn btn-outline-light btn-sm me-2" title="P2P Network">
            <i class="material-icons align-middle" style="font-size: 16px;">hub</i>
            Network
        </a>
        <a href="{{ url_for('oracle_page') }}" class="btn btn-outline-light btn-sm me-2 active" title="Oracle">
            <i class="material-icons align-middle" style="font-size: 16px;">cloud_upload</i>
            Oracle
        </a>
        <a href="{{ url_for('predictions_page') }}" class="btn btn-outline-light btn-sm me-2" title="Predictions">
            <i class="material-icons align-middle" style="font-size: 16px;">trending_up</i>
            Predictions
        </a>
        <a href="{{ url_for('governance') }}" class="btn btn-outline-light btn-sm me-2" title="Governance">
            <i class="material-icons align-middle" style="font-size: 16px;">how_to_vote</i>
            Governance
        </a>
        {% if is_signer %}
        <a href="{{ url_for('signer_dashboard') }}" class="btn btn-outline-light btn-sm me-2" title="Signer">
            <i class="material-icons align-middle" style="font-size: 16px;">key</i>
            Signer
        </a>
        {% endif %}
        <a href="{{ url_for('stake_management') }}" class="btn btn-outline-light btn-sm me-2" title="Stake Management">
            <i class="material-icons align-middle" style="font-size: 16px;">handshake</i>
            Stake
        </a>
        <a href="{{ url_for('badges_page') }}" class="btn btn-outline-light btn-sm me-2" title="Badges & Achievements">
            <i class="material-icons align-middle" style="font-size: 16px;">military_tech</i>
            Badges
        </a>
        <a href="{{ url_for('donate') }}" class="btn btn-outline-light btn-sm me-2" title="Donate to Treasury">
            <i class="material-icons align-middle" style="font-size: 16px;">volunteer_activism</i>
            Donate
        </a>
        <a href="{{ url_for('guide') }}" class="btn btn-outline-light btn-sm me-2" title="Rewards Guide">
            <i class="material-icons align-middle" style="font-size: 16px;">menu_book</i>
            Guide
        </a>
        <a href="{{ url_for('restart_neuron') }}" class="btn btn-outline-light btn-sm me-2" title="Restart Node" onclick="return confirm('Restart your Satori node?');">
            <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm me-2">Logout</a>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <i class="material-icons" id="themeIcon">light_mode</i>
        </button>
    </div>
</nav>

<div class="container-fluid py-4">
    <!-- Mode Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#streamsTab" type="button">
                <i class="material-icons align-middle me-1" style="font-size: 18px;">hub</i>
                Stream Registry
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#oraclesTab" type="button">
                <i class="material-icons align-middle me-1" style="font-size: 18px;">visibility</i>
                Oracles
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#observationsTab" type="button">
                <i class="material-icons align-middle me-1" style="font-size: 18px;">update</i>
                Observations
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ============================================================== -->
        <!-- STREAMS TAB -->
        <!-- ============================================================== -->
        <div class="tab-pane fade show active" id="streamsTab">
            <!-- Stream Stats Row -->
            <div class="row g-4 mb-4">
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="knownStreams" class="mb-1" style="color: #00aaff;">--</h3>
                            <small class="text-muted">Known Streams</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="myClaims" class="mb-1 text-success">--</h3>
                            <small class="text-muted">My Claims</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="myPrimaryOracles" class="mb-1" style="color: #ff6b6b;">--</h3>
                            <small class="text-muted">Primary (Publishing)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="mySecondaryOracles" class="mb-1" style="color: #4ecdc4;">--</h3>
                            <small class="text-muted">Secondary (Relay)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="totalClaims" class="mb-1" style="color: #ffd700;">--</h3>
                            <small class="text-muted">Total Claims</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h4 id="streamRegistryStatus" class="mb-1 text-success">--</h4>
                            <small class="text-muted">Registry Status</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Discovered Streams -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">explore</i>
                                Discovered Streams
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadDiscoveredStreams()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="discoveredStreamsList" style="max-height: 350px; overflow-y: auto;">
                                <div class="text-center text-muted py-5">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Claimed Streams -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">check_circle</i>
                                My Claimed Streams
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyClaimedStreams()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="myClaimedStreamsList" style="max-height: 350px; overflow-y: auto;">
                                <div class="text-center text-muted py-5">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Claim Predictor Slot -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="material-icons align-middle me-2">assignment_turned_in</i>
                                Claim Predictor Slot
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" class="form-control" id="claimStreamId" placeholder="Stream ID">
                                <button class="btn btn-primary" id="claimBtn" onclick="claimStream()">Claim</button>
                                <button class="btn btn-outline-danger" id="releaseBtn" onclick="releaseStreamClaim()">Release</button>
                            </div>
                            <small class="text-muted">Claim a slot to make predictions on this stream</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Oracle Registration - Join Existing Stream as Primary -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card border-warning">
                        <div class="card-header d-flex justify-content-between align-items-center bg-warning bg-opacity-10" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#joinPrimaryCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">group_add</i>
                                Join Existing Stream as Primary Oracle
                                <i class="material-icons align-middle float-end" id="joinPrimaryCollapseIcon">expand_less</i>
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadPrimaryStreamPicker()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="collapse show" id="joinPrimaryCollapse">
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <strong>Join as an additional primary oracle</strong> for an existing stream. Multiple primary oracles provide redundancy and decentralization.
                                    You'll need to configure a data source to fetch observations independently.
                                </p>

                                <!-- Search -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="material-icons" style="font-size: 18px;">search</i></span>
                                        <input type="text" class="form-control" id="primaryStreamSearch" placeholder="Search streams..." onkeyup="filterPrimaryStreams()">
                                    </div>
                                </div>

                                <!-- Stream List -->
                                <div id="primaryStreamsList" class="list-group mb-3" style="max-height: 250px; overflow-y: auto;">
                                    <div class="text-center py-3 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading available streams...
                                    </div>
                                </div>

                                <!-- Selected Stream Config -->
                                <div id="joinPrimaryConfig" style="display: none;">
                                    <div class="alert alert-warning mb-3">
                                        <strong>Selected Stream:</strong> <span id="joinPrimaryStreamId"></span>
                                    </div>

                                    <!-- Data Source Template Selection -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">Configure Data Source</label>
                                        <div id="joinPrimaryTemplateSelector" class="row g-2">
                                            <!-- Templates will be loaded here -->
                                        </div>
                                    </div>

                                    <!-- Template Fields -->
                                    <div class="mb-3" id="joinPrimaryTemplateConfig" style="display: none;">
                                        <div class="card bg-dark">
                                            <div class="card-body">
                                                <div id="joinPrimaryTemplateFields"></div>
                                            </div>
                                        </div>
                                    </div>

                                    <!-- Register Button -->
                                    <button class="btn btn-warning btn-lg w-100" onclick="registerAsJoinPrimaryOracle()" id="joinPrimaryBtn">
                                        <i class="material-icons align-middle me-1" style="font-size: 20px;">group_add</i>
                                        Become Primary Oracle for This Stream
                                    </button>
                                    <div id="joinPrimaryResult" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Oracle Registration - Register a New Stream & Become its Oracle -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header d-flex justify-content-between align-items-center bg-danger bg-opacity-10" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#primaryOracleCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">cloud_upload</i>
                                Register New Stream & Become Primary Oracle
                                <i class="material-icons align-middle float-end" id="primaryCollapseIcon">expand_less</i>
                            </h5>
                        </div>
                        <div class="collapse show" id="primaryOracleCollapse">
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <strong>Primary oracles</strong> fetch real data from external sources (APIs, exchanges) and publish observations to the network.
                                    When you register a new stream, you become its primary oracle and start publishing data.
                                </p>

                                <!-- Step 1: Select Data Source Template -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Step 1: Select Data Source</label>
                                    <div id="templateSelector" class="row g-2">
                                        <div class="text-center py-3 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading templates...
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2: Configure Data Source (dynamic based on template) -->
                                <div class="mb-4" id="dataSourceConfig" style="display: none;">
                                    <label class="form-label fw-bold">Step 2: Configure <span id="selectedTemplateName">Data Source</span></label>
                                    <div class="card bg-dark">
                                        <div class="card-body">
                                            <!-- Template-specific fields will be inserted here -->
                                            <div id="templateFields"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: Stream ID -->
                                <div class="mb-4" id="streamIdSection" style="display: none;">
                                    <label class="form-label fw-bold">Step 3: Stream Identifier</label>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="primarySource" placeholder="Source (e.g., binance)">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="primaryStream" placeholder="Stream (e.g., BTCUSDT)">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="primaryTarget" placeholder="Target (e.g., price, close, mid)">
                                        </div>
                                    </div>
                                    <small class="text-muted">This creates a unique stream ID for your data feed</small>
                                </div>

                                <!-- Register Button -->
                                <div id="primaryRegisterSection" style="display: none;">
                                    <button class="btn btn-danger btn-lg w-100" onclick="registerAsPrimaryOracle()" id="registerPrimaryBtn">
                                        <i class="material-icons align-middle me-1" style="font-size: 20px;">cloud_upload</i>
                                        Register Stream & Become Primary Oracle
                                    </button>
                                    <div id="primaryRegisterResult" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secondary Oracle Registration (Stream Picker) -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header d-flex justify-content-between align-items-center bg-info bg-opacity-10" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#secondaryOracleCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">sync</i>
                                Become a Secondary (Relay) Oracle
                                <i class="material-icons align-middle float-end" id="secondaryCollapseIcon">expand_less</i>
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadSecondaryStreamPicker()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="collapse show" id="secondaryOracleCollapse">
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <strong>Secondary oracles</strong> help distribute data across the network by relaying observations from primary oracles.
                                    Select streams with active primaries to become a relay node. No API keys or data sources needed.
                                    <strong>You will automatically subscribe to observations when you register.</strong>
                                </p>

                                <!-- Search -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="material-icons" style="font-size: 18px;">search</i></span>
                                        <input type="text" class="form-control" id="secondaryStreamSearch" placeholder="Search streams..." onkeyup="filterSecondaryStreams()">
                                    </div>
                                </div>

                                <!-- Stream List -->
                                <div id="secondaryStreamsList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center py-3 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading available streams...
                                    </div>
                                </div>

                                <!-- Selection Summary -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">
                                        <span id="secondarySelectedCount">0</span> streams selected
                                    </span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearSecondarySelection()">Clear</button>
                                        <button class="btn btn-info btn-lg" onclick="registerSelectedAsSecondary()" id="registerSecondaryBtn" disabled>
                                            <i class="material-icons align-middle me-1" style="font-size: 20px;">sync</i>
                                            Register as Secondary Oracle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================== -->
        <!-- ORACLES TAB -->
        <!-- ============================================================== -->
        <div class="tab-pane fade" id="oraclesTab">
            <!-- Oracle Stats Row -->
            <div class="row g-4 mb-4">
                <!-- My Stats -->
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="myOracleRegistrations" class="mb-1 text-success">--</h3>
                            <small class="text-muted">My Registrations</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="oracleSubscribedStreams" class="mb-1" style="color: #00aaff;">--</h3>
                            <small class="text-muted">My Subscriptions</small>
                        </div>
                    </div>
                </div>
                <!-- Network Stats -->
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="knownOracles" class="mb-1" style="color: #ffd700;">--</h3>
                            <small class="text-muted">Network Oracles</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="networkPrimaryCount" class="mb-1" style="color: #ff6b6b;">--</h3>
                            <small class="text-muted">Network Primary</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="networkSecondaryCount" class="mb-1" style="color: #4ecdc4;">--</h3>
                            <small class="text-muted">Network Secondary</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="cachedObservations" class="mb-1" style="color: #00ff88;">--</h3>
                            <small class="text-muted">Cached Observations</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Registered Oracles -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">visibility</i>
                                Registered Oracle Streams
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-switch mb-0 me-2">
                                    <input class="form-check-input" type="checkbox" id="includeOwnOracleStreams" checked onchange="loadRegisteredOracles()">
                                    <label class="form-check-label small ms-1" for="includeOwnOracleStreams">Include mine</label>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadRegisteredOracles()">
                                    <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Oracle Address</th>
                                            <th>Oracle Peer ID</th>
                                            <th>Role</th>
                                            <th>Relays</th>
                                            <th>Predictors</th>
                                            <th>My Status</th>
                                        </tr>
                                    </thead>
                                    <tbody id="oraclesTable">
                                        <tr><td colspan="7" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Oracle Registrations -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">person</i>
                                My Oracle Registrations
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyOracleRegistrations()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Type</th>
                                            <th>Data Source</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myOracleRegistrationsTable">
                                        <tr><td colspan="4" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================== -->
        <!-- OBSERVATIONS TAB -->
        <!-- ============================================================== -->
        <div class="tab-pane fade" id="observationsTab">
            <!-- Recent Observations -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">update</i>
                                Recent Observations
                            </h5>
                            <div class="d-flex align-items-center gap-2">
                                <div class="form-check form-switch mb-0 me-2">
                                    <input class="form-check-input" type="checkbox" id="includeOwnObservations" checked onchange="loadLatestObservations()">
                                    <label class="form-check-label small ms-1" for="includeOwnObservations">Include mine</label>
                                </div>
                                <button class="btn btn-sm btn-outline-secondary" onclick="loadLatestObservations()">
                                    <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                                </button>
                            </div>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Value</th>
                                            <th>Oracle Address</th>
                                            <th>Peer ID</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="observationsTable">
                                        <tr><td colspan="5" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Published Observations -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">cloud_upload</i>
                                My Published Observations
                                <small class="text-muted ms-2" id="myObsCount"></small>
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyPublishedObservations()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Value</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myObservationsTable">
                                        <tr><td colspan="3" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination controls -->
                            <div class="card-footer d-flex justify-content-between align-items-center" id="myObsPagination" style="display: none !important;">
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="myObsPrevBtn" onclick="changeMyObsPage(-1)" disabled>
                                        <i class="material-icons align-middle" style="font-size: 16px;">chevron_left</i> Previous
                                    </button>
                                </div>
                                <span class="text-muted" id="myObsPageInfo">Page 1 of 1</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="myObsNextBtn" onclick="changeMyObsPage(1)" disabled>
                                        Next <i class="material-icons align-middle" style="font-size: 16px;">chevron_right</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Publish Observation -->
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#publishObservationCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">publish</i>
                                Publish Observation (Manual)
                                <i class="material-icons align-middle float-end">expand_more</i>
                            </h5>
                        </div>
                        <div class="collapse" id="publishObservationCollapse">
                            <div class="card-body">
                                <p class="text-muted small">You must be registered as an oracle for a stream to publish observations. Primary oracles publish automatically based on their data source configuration.</p>
                                <form id="observationForm" onsubmit="publishObservation(event)">
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <label class="form-label">Stream ID</label>
                                            <input type="text" class="form-control" id="pubObsStreamId" placeholder="Stream ID" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Observed Value</label>
                                            <input type="number" class="form-control" id="pubObsValue" placeholder="Value" step="any" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Timestamp (optional)</label>
                                            <input type="number" class="form-control" id="pubObsTimestamp" placeholder="Unix (now if empty)">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="submit" class="btn btn-success">
                                            <i class="material-icons align-middle" style="font-size: 16px;">send</i>
                                            Publish
                                        </button>
                                        <span id="publishResult" class="ms-3"></span>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast notification -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="statusToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">
            <strong class="me-auto">Satori</strong>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
        <div class="toast-body" id="toastMessage"></div>
    </div>
</div>

<script>
// =========================================================================
// UTILITY FUNCTIONS
// =========================================================================

function showToast(message, type = 'info') {
    const toast = document.getElementById('statusToast');
    const toastBody = document.getElementById('toastMessage');
    toastBody.textContent = message;
    // Map type to color class
    const colorClass = type === 'error' ? 'text-danger' : type === 'success' ? 'text-success' : 'text-info';
    toastBody.className = 'toast-body ' + colorClass;
    const bsToast = new bootstrap.Toast(toast);
    bsToast.show();
}

// =========================================================================
// PAGE INITIALIZATION
// =========================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme
    const storedTheme = localStorage.getItem('satori-theme') || 'dark';
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.textContent = storedTheme === 'dark' ? 'light_mode' : 'dark_mode';
    }

    // Load initial data
    loadStreamStats();
    loadOracleStats();
    loadDiscoveredStreams();
    loadMyClaimedStreams();
    loadRegisteredOracles();
    loadMyOracleRegistrations();  // Load my registrations
    loadLatestObservations();
    loadMyPublishedObservations();
    loadOracleTemplates();  // Load templates immediately since section is expanded
    loadPrimaryStreamPicker();  // Load primary stream picker for "join" section
    loadSecondaryStreamPicker();  // Load secondary picker immediately

    // Set up periodic refresh
    setInterval(loadStreamStats, 30000);
    setInterval(loadOracleStats, 30000);
    setInterval(loadLatestObservations, 15000);
    setInterval(loadMyPublishedObservations, 30000);
    setInterval(loadMyOracleRegistrations, 30000);  // Refresh my registrations

    // Handle tab switching - refresh data when switching tabs
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#oraclesTab') {
                loadOracleStats();
                loadRegisteredOracles();
                loadMyOracleRegistrations();
            } else if (target === '#observationsTab') {
                loadLatestObservations();
                loadMyPublishedObservations();
            } else if (target === '#streamsTab') {
                loadStreamStats();
                loadDiscoveredStreams();
                loadPrimaryStreamPicker();
                loadSecondaryStreamPicker();
            }
        });
    });

    // Handle collapse icon toggling
    const primaryCollapse = document.getElementById('primaryOracleCollapse');
    const secondaryCollapse = document.getElementById('secondaryOracleCollapse');

    if (primaryCollapse) {
        primaryCollapse.addEventListener('shown.bs.collapse', () => {
            document.getElementById('primaryCollapseIcon').textContent = 'expand_less';
        });
        primaryCollapse.addEventListener('hidden.bs.collapse', () => {
            document.getElementById('primaryCollapseIcon').textContent = 'expand_more';
        });
    }

    if (secondaryCollapse) {
        secondaryCollapse.addEventListener('shown.bs.collapse', () => {
            document.getElementById('secondaryCollapseIcon').textContent = 'expand_less';
        });
        secondaryCollapse.addEventListener('hidden.bs.collapse', () => {
            document.getElementById('secondaryCollapseIcon').textContent = 'expand_more';
        });
    }
});

// =========================================================================
// API HELPER
// =========================================================================

async function apiCall(endpoint, method = 'GET', data = null, timeoutMs = 30000) {
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

    const options = {
        method: method,
        headers: { 'Content-Type': 'application/json' },
        signal: controller.signal
    };
    if (data) {
        options.body = JSON.stringify(data);
    }
    try {
        const response = await fetch('/api' + endpoint, options);
        clearTimeout(timeoutId);
        return response.json();
    } catch (e) {
        clearTimeout(timeoutId);
        if (e.name === 'AbortError') {
            throw new Error('Request timed out');
        }
        throw e;
    }
}

// =========================================================================
// STREAM REGISTRY FUNCTIONS
// =========================================================================

async function loadStreamStats() {
    try {
        const [stats, summary] = await Promise.all([
            apiCall('/p2p/streams/stats'),
            apiCall('/p2p/oracle/summary')
        ]);
        document.getElementById('knownStreams').textContent = stats.known_streams || 0;
        document.getElementById('myClaims').textContent = stats.my_claims || 0;
        document.getElementById('totalClaims').textContent = stats.total_claims || 0;
        document.getElementById('streamRegistryStatus').textContent = stats.started ? 'Active' : 'Offline';
        document.getElementById('streamRegistryStatus').className = stats.started ? 'mb-1 text-success' : 'mb-1 text-danger';

        // Oracle counts
        document.getElementById('myPrimaryOracles').textContent = summary.primary_count || 0;
        document.getElementById('mySecondaryOracles').textContent = summary.secondary_count || 0;
    } catch (e) {
        console.error('Failed to load stream stats:', e);
    }
}

async function loadDiscoveredStreams() {
    const container = document.getElementById('discoveredStreamsList');
    try {
        const result = await apiCall('/p2p/streams/discover?limit=20');
        // Also load my claims to check if already claimed
        const myClaims = await apiCall('/p2p/streams/my');
        const myClaimedStreamIds = new Set((myClaims.claims || []).map(c => c.stream_id));

        if (result.streams && result.streams.length > 0) {
            container.innerHTML = result.streams.map(stream => {
                const alreadyClaimed = myClaimedStreamIds.has(stream.stream_id);
                const slotsAvailable = stream.predictor_slots || 0;
                const claimedCount = stream.claimed_count || 0;
                const slotsRemaining = Math.max(0, slotsAvailable - claimedCount);

                // Color code slots: green (plenty) -> yellow (medium) -> red (low/full)
                let slotsClass = 'bg-success';  // green: > 500 remaining
                if (slotsRemaining <= 10) {
                    slotsClass = 'bg-danger';   // red: <= 10 remaining
                } else if (slotsRemaining <= 100) {
                    slotsClass = 'bg-warning text-dark';  // yellow: 11-100 remaining
                } else if (slotsRemaining <= 500) {
                    slotsClass = 'bg-info';     // blue: 101-500 remaining
                }

                // Format oracle peer IDs
                let oracleInfo = '';
                if (stream.oracles && stream.oracles.length > 0) {
                    const oracleList = stream.oracles.map(o => {
                        const label = o.is_primary ? '<span class="badge bg-danger">P</span>' : '<span class="badge bg-info">S</span>';
                        const youLabel = o.is_me ? ' <span class="badge bg-warning text-dark">you</span>' : '';
                        return `${label} <small style="word-break: break-all;">${o.peer_id}</small>${youLabel}`;
                    }).join('<br>');
                    oracleInfo = `<br><small class="text-muted">Oracles:</small><br>${oracleList}`;
                }

                return `<div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${stream.source}/${stream.stream}/${stream.target}</strong>
                            <br><small class="text-muted">Type: ${stream.datatype || 'float'}</small>
                            <br><small class="text-muted">ID: <code>${stream.stream_id}</code></small>
                            ${oracleInfo}
                        </div>
                        <div class="text-end">
                            <span class="badge ${slotsClass}">${slotsRemaining}/${slotsAvailable} slots</span>
                            ${alreadyClaimed
                                ? '<br><span class="badge bg-success mt-1">Claimed</span>'
                                : `<br><button class="btn btn-outline-primary btn-sm mt-1" onclick="document.getElementById('claimStreamId').value='${stream.stream_id}'">Select</button>`
                            }
                        </div>
                    </div>
                    ${stream.description ? `<small class="text-muted">${stream.description}</small>` : ''}
                </div>`;
            }).join('');
        } else {
            container.innerHTML = `<div class="text-center py-5">
                <i class="material-icons text-muted" style="font-size: 48px;">cloud_off</i>
                <p class="text-muted mt-2 mb-3">No streams discovered yet.</p>
                <p class="small text-muted">Be the first to create a data stream!</p>
                <a href="#primaryOracleCollapse" class="btn btn-danger btn-sm" onclick="document.getElementById('primaryOracleCollapse').classList.add('show')">
                    <i class="material-icons align-middle me-1" style="font-size: 16px;">add</i>
                    Become a Primary Oracle
                </a>
            </div>`;
        }
    } catch (e) {
        console.error('Failed to load streams:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load streams</div>';
    }
}

async function loadMyClaimedStreams() {
    const container = document.getElementById('myClaimedStreamsList');
    try {
        // Fetch claims and stream details (which includes oracle info)
        const [result, streamsResult] = await Promise.all([
            apiCall('/p2p/streams/my'),
            apiCall('/p2p/streams/discover?limit=200')
        ]);
        const claims = result.claims || result.streams || [];

        // Build a map of stream_id -> oracle info
        const streamOracleMap = {};
        (streamsResult.streams || []).forEach(s => {
            streamOracleMap[s.stream_id] = s.oracles || [];
        });

        if (claims.length > 0) {
            container.innerHTML = claims.map(claim => {
                // Parse stream ID: source|stream|target -> source/stream/target
                const streamParts = (claim.stream_id || '').split('|');
                const streamLabel = streamParts.length >= 3
                    ? `${streamParts[0]}/${streamParts[1]}/${streamParts[2]}`
                    : claim.stream_id;
                const expires = claim.expires ? new Date(claim.expires * 1000).toLocaleDateString() : 'Never';
                const statusBadge = claim.is_expired ? '<span class="badge bg-danger">Expired</span>' : '<span class="badge bg-success">Active</span>';

                // Get oracle info for this stream
                const oracles = streamOracleMap[claim.stream_id] || [];
                let oracleInfo = '';
                if (oracles.length > 0) {
                    const oracleList = oracles.map(o => {
                        const label = o.is_primary ? '<span class="badge bg-danger">P</span>' : '<span class="badge bg-info">S</span>';
                        const youLabel = o.is_me ? ' <span class="badge bg-warning text-dark">you</span>' : '';
                        return `${label} <small style="word-break: break-all;">${o.peer_id}</small>${youLabel}`;
                    }).join('<br>');
                    oracleInfo = `<br><small class="text-muted">Oracles:</small><br>${oracleList}`;
                }

                return `<div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between">
                        <div>
                            <strong>${streamLabel}</strong>
                            <br><small class="text-muted">Slot #${claim.slot_index || 0} | Expires: ${expires}</small>
                            <br><small class="text-muted">ID: <code>${claim.stream_id}</code></small>
                            ${oracleInfo}
                        </div>
                        <div>
                            ${statusBadge}
                            <br><button class="btn btn-outline-danger btn-sm mt-1" onclick="document.getElementById('claimStreamId').value='${claim.stream_id}'; releaseStreamClaim()">
                                Release
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } else {
            container.innerHTML = `<div class="text-center py-5">
                <i class="material-icons text-muted" style="font-size: 48px;">playlist_add</i>
                <p class="text-muted mt-2 mb-3">No claimed streams yet.</p>
                <p class="small text-muted">Claim a stream from the Discovered Streams list to start making predictions!</p>
            </div>`;
        }
    } catch (e) {
        console.error('Failed to load my claims:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load claims</div>';
    }
}

async function claimStream() {
    const streamId = document.getElementById('claimStreamId').value.trim();
    if (!streamId) { alert('Please enter a stream ID'); return; }

    const btn = document.getElementById('claimBtn');
    const originalText = btn.textContent;
    btn.disabled = true;
    btn.textContent = 'Claiming...';

    try {
        // Use 70s timeout (backend has 60s timeout for claim operations)
        const result = await apiCall('/p2p/streams/claim', 'POST', { stream_id: streamId }, 70000);
        if (result.success) {
            showToast('Claimed slot #' + (result.claim?.slot_index || 0), 'success');
            document.getElementById('claimStreamId').value = '';
            loadStreamStats();
            loadMyClaimedStreams();
            loadDiscoveredStreams();  // Refresh to show "Claimed" badge
        } else {
            showToast('Failed: ' + (result.error || 'Unknown error'), 'error');
        }
    } catch (e) {
        showToast('Error: ' + e.message, 'error');
        // Still refresh in case claim succeeded but response timed out
        loadStreamStats();
        loadMyClaimedStreams();
        loadDiscoveredStreams();
    } finally {
        btn.disabled = false;
        btn.textContent = originalText;
    }
}

async function releaseStreamClaim() {
    const streamId = document.getElementById('claimStreamId').value.trim();
    if (!streamId) { alert('Please enter a stream ID'); return; }

    try {
        const result = await apiCall('/p2p/streams/release', 'POST', { stream_id: streamId });
        if (result.success) {
            alert('Released claim on stream');
            document.getElementById('claimStreamId').value = '';
            loadStreamStats();
            loadMyClaimedStreams();
            loadDiscoveredStreams();  // Refresh to remove "Claimed" badge
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) { alert('Error: ' + e.message); }
}

// =========================================================================
// ORACLE FUNCTIONS
// =========================================================================

async function loadOracleStats() {
    try {
        // Load basic oracle stats, summary, and oracles list
        const [stats, summary, oraclesResult] = await Promise.all([
            apiCall('/p2p/oracle/stats'),
            apiCall('/p2p/oracle/summary'),
            apiCall('/p2p/oracle/oracles')
        ]);

        // My stats
        document.getElementById('oracleSubscribedStreams').textContent = stats.subscribed_streams || 0;
        document.getElementById('myOracleRegistrations').textContent = stats.my_oracle_registrations || 0;
        // Show total observations (cached from network + our own published)
        const totalObservations = (stats.cached_observations || 0) + (stats.my_published_observations || 0);
        document.getElementById('cachedObservations').textContent = totalObservations;

        // Network-wide stats from oracles list
        const oracles = oraclesResult.oracles || [];
        const networkPrimaryCount = oracles.filter(o => o.is_primary).length;
        const networkSecondaryCount = oracles.filter(o => !o.is_primary).length;

        document.getElementById('knownOracles').textContent = oracles.length;
        document.getElementById('networkPrimaryCount').textContent = networkPrimaryCount;
        document.getElementById('networkSecondaryCount').textContent = networkSecondaryCount;
    } catch (e) {
        console.error('Failed to load oracle stats:', e);
    }
}

async function loadRegisteredOracles() {
    const tbody = document.getElementById('oraclesTable');
    const includeOwn = document.getElementById('includeOwnOracleStreams')?.checked ?? true;
    try {
        // Get oracles list, our oracle summary, claimed streams, stream stats
        // peer-id is optional (may fail if P2P not fully initialized)
        const [result, summary, myClaims, streamsResult] = await Promise.all([
            apiCall('/p2p/oracle/oracles'),
            apiCall('/p2p/oracle/summary'),
            apiCall('/p2p/streams/my'),
            apiCall('/p2p/streams/discover?limit=200')
        ]);

        // Try to get peer ID from p2p-status (optional, for "you" badge)
        let myPeerId = '';
        try {
            const p2pStatus = await apiCall('/p2p-status');
            myPeerId = p2pStatus.peer_id || '';
        } catch (e) {
            // P2P not ready yet, continue without peer ID
            console.debug('Peer ID not available yet:', e.message);
        }

        // Build sets of streams we're involved with
        const myPrimaryStreams = new Set(summary.primary_streams || []);
        const mySecondaryStreams = new Set(summary.secondary_streams || []);
        const myClaimedStreams = new Set((myClaims.claims || myClaims.streams || []).map(c => c.stream_id));

        let oracles = result.oracles || [];

        // Filter out our own oracle registrations if "Include mine" is unchecked
        if (!includeOwn) {
            const myAddress = summary.evrmore_address || '';
            oracles = oracles.filter(o => o.oracle_address !== myAddress);
        }

        // Count secondary oracles per stream
        const secondariesByStream = {};
        oracles.forEach(o => {
            if (!o.is_primary) {
                secondariesByStream[o.stream_id] = (secondariesByStream[o.stream_id] || 0) + 1;
            }
        });

        // Build predictor counts from streams (actual claimed count, not total slots)
        const predictorsByStream = {};
        (streamsResult.streams || []).forEach(s => {
            predictorsByStream[s.stream_id] = s.claimed_count || 0;
        });

        if (oracles.length > 0) {
            // One row per oracle registration
            tbody.innerHTML = oracles.map(o => {
                const addr = o.oracle_address || '';
                const streamId = o.stream_id || '';

                // This oracle's role
                const typeBadge = o.is_primary
                    ? '<span class="badge bg-danger">Primary</span>'
                    : '<span class="badge bg-info">Secondary</span>';

                // Counts for this stream (same for all oracles on same stream)
                const relayCount = secondariesByStream[streamId] || 0;
                const predictorCount = predictorsByStream[streamId] || 0;

                // Color code predictor count: more predictors = healthier stream
                let predictorClass = 'bg-secondary';  // gray: 0 predictors
                if (predictorCount >= 10) {
                    predictorClass = 'bg-success';    // green: 10+ predictors
                } else if (predictorCount >= 5) {
                    predictorClass = 'bg-info';       // blue: 5-9 predictors
                } else if (predictorCount >= 1) {
                    predictorClass = 'bg-warning text-dark';  // yellow: 1-4 predictors
                }

                // Our relationship to this stream
                let relationshipBadge = '<span class="badge bg-secondary">Peer</span>';
                if (myPrimaryStreams.has(streamId)) {
                    relationshipBadge = '<span class="badge bg-warning text-dark">Publishing</span>';
                } else if (mySecondaryStreams.has(streamId)) {
                    relationshipBadge = '<span class="badge bg-success">Relaying</span>';
                } else if (myClaimedStreams.has(streamId)) {
                    relationshipBadge = '<span class="badge bg-primary">Predicting</span>';
                }

                // Highlight row if we're involved with this stream
                const isInvolved = myPrimaryStreams.has(streamId) || mySecondaryStreams.has(streamId) || myClaimedStreams.has(streamId);

                // Get oracle peer ID and check if it's ours
                const peerId = o.peer_id || '--';
                const isMyPeer = peerId && myPeerId && peerId === myPeerId;
                const youBadge = isMyPeer ? ' <span class="badge bg-success" style="font-size: 0.65em; vertical-align: middle;">you</span>' : '';

                return `<tr${isInvolved ? ' class="table-active"' : ''}>
                    <td><code>${streamId}</code></td>
                    <td><code class="small">${addr}</code></td>
                    <td><small class="text-muted" style="word-break: break-all;">${peerId}</small>${youBadge}</td>
                    <td>${typeBadge}</td>
                    <td><span class="badge bg-info">${relayCount}</span></td>
                    <td><span class="badge ${predictorClass}">${predictorCount}</span></td>
                    <td>${relationshipBadge}</td>
                </tr>`;
            }).join('');
        } else {
            const msg = includeOwn
                ? 'No oracle streams registered yet.'
                : 'No oracle streams from other nodes yet.';
            tbody.innerHTML = `<tr><td colspan="7" class="text-center text-muted py-3">${msg}</td></tr>`;
        }
    } catch (e) {
        console.error('Failed to load oracles:', e);
        tbody.innerHTML = '<tr><td colspan="7" class="text-center text-danger py-3">Failed to load</td></tr>';
    }
}

async function loadMyOracleRegistrations() {
    const tbody = document.getElementById('myOracleRegistrationsTable');
    try {
        const summary = await apiCall('/p2p/oracle/summary');

        const rows = [];

        // Helper to format stream ID
        const formatStreamId = (streamId) => {
            const parts = streamId.split('|');
            return parts.length >= 3 ? `${parts[0]}/${parts[1]}/${parts[2]}` : streamId;
        };

        // Add primary registrations
        for (const streamId of (summary.primary_streams || [])) {
            const streamLabel = formatStreamId(streamId);
            rows.push(`<tr>
                <td><code title="${streamId}">${streamLabel}</code></td>
                <td><span class="badge bg-danger">Primary</span></td>
                <td><span class="text-muted">Configured</span></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="unregisterOracle('${streamId}')">
                        Unregister
                    </button>
                </td>
            </tr>`);
        }

        // Add secondary registrations
        for (const streamId of (summary.secondary_streams || [])) {
            const streamLabel = formatStreamId(streamId);
            rows.push(`<tr>
                <td><code title="${streamId}">${streamLabel}</code></td>
                <td><span class="badge bg-info">Secondary</span></td>
                <td><span class="text-muted">Relay</span></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="unregisterOracle('${streamId}')">
                        Unregister
                    </button>
                </td>
            </tr>`);
        }

        if (rows.length > 0) {
            tbody.innerHTML = rows.join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No oracle registrations. Register as a Primary or Secondary oracle on the Stream Registry tab.</td></tr>';
        }
    } catch (e) {
        console.error('Failed to load my oracle registrations:', e);
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Failed to load</td></tr>';
    }
}

async function unregisterOracle(streamId) {
    if (!confirm(`Unregister as oracle for this stream?`)) return;

    try {
        const result = await apiCall('/p2p/oracle/unregister', 'POST', { stream_id: streamId });
        if (result.success) {
            alert('Unregistered successfully');
            loadOracleStats();
            loadRegisteredOracles();
            loadMyOracleRegistrations();
            loadStreamStats();
            loadDiscoveredStreams();
            loadMyClaimedStreams();  // Refresh My Claimed Streams
            loadPrimaryStreamPicker();
            loadSecondaryStreamPicker();
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// =========================================================================
// PRIMARY ORACLE TEMPLATE PICKER
// =========================================================================

let oracleTemplates = [];
let selectedTemplate = null;

async function loadOracleTemplates() {
    const container = document.getElementById('templateSelector');

    try {
        const result = await apiCall('/p2p/oracle/templates');
        if (result.success && result.templates) {
            oracleTemplates = result.templates;
            renderTemplateSelector();
        } else {
            container.innerHTML = '<div class="text-center text-warning py-3">Oracle templates not available. Ensure satorip2p is up to date.</div>';
        }
    } catch (e) {
        console.error('Failed to load oracle templates:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load templates</div>';
    }
}

function renderTemplateSelector() {
    const container = document.getElementById('templateSelector');

    if (oracleTemplates.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">No templates available</div>';
        return;
    }

    container.innerHTML = oracleTemplates.map(t => {
        const isSelected = selectedTemplate && selectedTemplate.id === t.id;
        const iconMap = {
            'binance': 'currency_bitcoin',
            'binance_kline': 'candlestick_chart',
            'coingecko': 'pets',
            'coinmarketcap': 'bar_chart',
            'kraken': 'waves',
            'coinbase': 'account_balance',
            'custom': 'settings',
        };
        const icon = iconMap[t.id] || 'api';

        return `<div class="col-md-3 col-6 mb-2">
            <div class="card h-100 template-card ${isSelected ? 'border-danger' : ''}"
                 style="cursor: pointer; ${isSelected ? 'background: rgba(220, 53, 69, 0.1);' : ''}"
                 onclick="selectTemplate('${t.id}')">
                <div class="card-body text-center py-3">
                    <i class="material-icons mb-2" style="font-size: 32px; color: ${isSelected ? '#dc3545' : '#00aaff'};">${icon}</i>
                    <h6 class="mb-1">${t.name}</h6>
                    <small class="text-muted">${t.description}</small>
                </div>
            </div>
        </div>`;
    }).join('');
}

function selectTemplate(templateId) {
    selectedTemplate = oracleTemplates.find(t => t.id === templateId);
    if (!selectedTemplate) return;

    // Re-render selector to show selection
    renderTemplateSelector();

    // Show config section
    document.getElementById('dataSourceConfig').style.display = 'block';
    document.getElementById('selectedTemplateName').textContent = selectedTemplate.name;

    // Generate template-specific fields
    renderTemplateFields();

    // Show stream ID and register sections
    document.getElementById('streamIdSection').style.display = 'block';
    document.getElementById('primaryRegisterSection').style.display = 'block';

    // Pre-fill source if template has a name
    if (selectedTemplate.id !== 'custom') {
        document.getElementById('primarySource').value = selectedTemplate.id.replace('_kline', '');
    }
}

function renderTemplateFields() {
    const container = document.getElementById('templateFields');
    const requires = selectedTemplate.requires || [];

    let html = '';

    // Symbol field (for Binance, Kraken, Coinbase, CMC)
    if (requires.includes('symbol')) {
        const example = selectedTemplate.example_symbol || 'BTCUSDT';
        html += `<div class="mb-3">
            <label class="form-label">Trading Pair / Symbol</label>
            <input type="text" class="form-control" id="templateSymbol" placeholder="e.g., ${example}" value="">
            <small class="text-muted">Example: ${example}</small>
        </div>`;
    }

    // Base/Quote assets (for CoinGecko)
    if (requires.includes('base_asset')) {
        const exampleBase = selectedTemplate.example_base || 'bitcoin';
        html += `<div class="mb-3">
            <label class="form-label">Base Asset (CoinGecko ID)</label>
            <input type="text" class="form-control" id="templateBaseAsset" placeholder="e.g., ${exampleBase}" value="">
            <small class="text-muted">Use CoinGecko coin ID (e.g., bitcoin, ethereum, ripple)</small>
        </div>`;
    }

    if (requires.includes('quote_asset')) {
        const exampleQuote = selectedTemplate.example_quote || 'usd';
        html += `<div class="mb-3">
            <label class="form-label">Quote Currency</label>
            <input type="text" class="form-control" id="templateQuoteAsset" placeholder="e.g., ${exampleQuote}" value="">
            <small class="text-muted">e.g., usd, eur, btc</small>
        </div>`;
    }

    // API Key (for CMC)
    if (requires.includes('api_key')) {
        html += `<div class="mb-3">
            <label class="form-label">API Key <span class="badge bg-warning text-dark">Required</span></label>
            <input type="password" class="form-control" id="templateApiKey" placeholder="Your API key">
            <small class="text-muted">Required for ${selectedTemplate.name}. Get your API key from their website.</small>
        </div>`;
    }

    // Custom API fields
    if (requires.includes('api_url')) {
        html += `<div class="mb-3">
            <label class="form-label">API URL</label>
            <input type="text" class="form-control" id="templateApiUrl" placeholder="https://api.example.com/data">
            <small class="text-muted">Full URL to fetch data from</small>
        </div>`;
    }

    if (requires.includes('json_path')) {
        html += `<div class="mb-3">
            <label class="form-label">JSON Path to Value</label>
            <input type="text" class="form-control" id="templateJsonPath" placeholder="e.g., data.price or 0.close">
            <small class="text-muted">Path to extract the value from JSON response</small>
        </div>`;
    }

    // Additional headers for custom
    if (selectedTemplate.id === 'custom') {
        html += `<div class="mb-3">
            <label class="form-label">HTTP Headers (JSON, optional)</label>
            <input type="text" class="form-control" id="templateHeaders" placeholder='{"Authorization": "Bearer token"}'>
            <small class="text-muted">Optional headers in JSON format</small>
        </div>`;
    }

    // Fetch interval and value type - show for all templates
    html += `<div class="row g-2 mt-3">
        <div class="col-md-6">
            <label class="form-label">Fetch Interval (seconds)</label>
            <input type="number" class="form-control" id="templateFetchInterval" placeholder="60" value="60" min="1">
            <small class="text-muted">How often to fetch data (default: 60s)</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Value Type</label>
            <select class="form-select" id="templateValueType">
                <option value="float" selected>Float (decimal number)</option>
                <option value="int">Integer (whole number)</option>
                <option value="string">String (text)</option>
            </select>
            <small class="text-muted">Expected data type of the value</small>
        </div>
    </div>`;

    container.innerHTML = html || '<p class="text-muted">No additional configuration needed.</p>';
}

function buildDataSourceConfig() {
    if (!selectedTemplate) return null;

    const config = {
        template: selectedTemplate.id,
        api_url: selectedTemplate.api_url || '',
        json_path: selectedTemplate.json_path || '',
        value_type: selectedTemplate.value_type || 'float',
        api_headers: {},
        fetch_interval: 60,
    };

    // Get values from fields
    const symbol = document.getElementById('templateSymbol')?.value.trim();
    const baseAsset = document.getElementById('templateBaseAsset')?.value.trim();
    const quoteAsset = document.getElementById('templateQuoteAsset')?.value.trim();
    const apiKey = document.getElementById('templateApiKey')?.value.trim();
    const apiUrl = document.getElementById('templateApiUrl')?.value.trim();
    const jsonPath = document.getElementById('templateJsonPath')?.value.trim();
    const headersStr = document.getElementById('templateHeaders')?.value.trim();
    const fetchInterval = parseInt(document.getElementById('templateFetchInterval')?.value) || 60;
    const valueType = document.getElementById('templateValueType')?.value || 'float';

    // Set template params
    if (symbol) config.symbol = symbol;
    if (baseAsset) config.base_asset = baseAsset;
    if (quoteAsset) config.quote_asset = quoteAsset;

    // Replace placeholders in API URL
    if (config.api_url) {
        config.api_url = config.api_url
            .replace('{symbol}', symbol || '')
            .replace('{base_asset}', baseAsset || '')
            .replace('{quote_asset}', quoteAsset || '');
    }

    // Replace placeholders in JSON path
    if (config.json_path) {
        config.json_path = config.json_path
            .replace('{symbol}', symbol || '')
            .replace('{base_asset}', baseAsset || '')
            .replace('{quote_asset}', quoteAsset || '');
    }

    // Handle API key in headers
    if (apiKey && selectedTemplate.api_headers) {
        for (const [key, val] of Object.entries(selectedTemplate.api_headers)) {
            config.api_headers[key] = val.replace('{api_key}', apiKey);
        }
    }

    // Custom overrides
    if (apiUrl) config.api_url = apiUrl;
    if (jsonPath) config.json_path = jsonPath;

    // Set fetch interval and value type from UI
    config.fetch_interval = fetchInterval;
    config.value_type = valueType;

    // Parse custom headers
    if (headersStr) {
        try {
            const parsedHeaders = JSON.parse(headersStr);
            config.api_headers = { ...config.api_headers, ...parsedHeaders };
        } catch (e) {
            console.warn('Invalid headers JSON:', e);
        }
    }

    return config;
}

async function registerAsPrimaryOracle() {
    const source = document.getElementById('primarySource').value.trim();
    const stream = document.getElementById('primaryStream').value.trim();
    const target = document.getElementById('primaryTarget').value.trim();
    const resultDiv = document.getElementById('primaryRegisterResult');

    if (!source || !stream || !target) {
        resultDiv.innerHTML = '<span class="text-danger">Please fill in Source, Stream, and Target</span>';
        return;
    }

    if (!selectedTemplate) {
        resultDiv.innerHTML = '<span class="text-danger">Please select a data source template</span>';
        return;
    }

    // Check required fields
    const requires = selectedTemplate.requires || [];
    if (requires.includes('api_key') && !document.getElementById('templateApiKey')?.value.trim()) {
        resultDiv.innerHTML = '<span class="text-danger">API key is required for ' + selectedTemplate.name + '</span>';
        return;
    }

    // Build stream ID (using same format as stream registry)
    const streamId = `${source}|${stream}|${target}`;
    const dataSource = buildDataSourceConfig();

    const btn = document.getElementById('registerPrimaryBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';
    resultDiv.innerHTML = '';

    try {
        const result = await apiCall('/p2p/oracle/register-primary', 'POST', {
            stream_id: streamId,
            data_source: dataSource,
        });

        if (result.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">
                <i class="material-icons align-middle" style="font-size: 16px;">check_circle</i>
                <strong>Success!</strong> Registered stream and became primary oracle for <code>${source}/${stream}/${target}</code>
            </div>`;

            // Refresh all relevant data
            loadStreamStats();
            loadDiscoveredStreams();
            loadMyClaimedStreams();  // Refresh My Claimed Streams
            loadRegisteredOracles();
            loadMyOracleRegistrations();
            loadPrimaryStreamPicker();
            loadSecondaryStreamPicker();

            // Clear form after delay
            setTimeout(() => {
                document.getElementById('primarySource').value = '';
                document.getElementById('primaryStream').value = '';
                document.getElementById('primaryTarget').value = '';
                selectedTemplate = null;
                renderTemplateSelector();
                document.getElementById('dataSourceConfig').style.display = 'none';
                document.getElementById('streamIdSection').style.display = 'none';
                document.getElementById('primaryRegisterSection').style.display = 'none';
                resultDiv.innerHTML = '';
            }, 5000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${result.error || 'Registration failed'}</div>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// =========================================================================
// JOIN PRIMARY ORACLE STREAM PICKER
// =========================================================================

let primaryAvailableStreams = [];
let selectedJoinPrimaryStream = null;
let joinPrimarySelectedTemplate = null;

async function loadPrimaryStreamPicker() {
    const container = document.getElementById('primaryStreamsList');
    container.innerHTML = `<div class="text-center py-3 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Loading available streams...
    </div>`;

    // Hide config section when reloading
    document.getElementById('joinPrimaryConfig').style.display = 'none';
    selectedJoinPrimaryStream = null;

    try {
        // Fetch all discovered streams and our oracle summary
        const [streamsResult, oracleSummary] = await Promise.all([
            apiCall('/p2p/streams/discover?limit=100'),
            apiCall('/p2p/oracle/summary')
        ]);

        const streams = streamsResult.streams || [];
        const myPrimaryStreams = new Set(oracleSummary.primary_streams || []);

        // Filter out streams we're already primary for
        primaryAvailableStreams = streams.filter(s => {
            return !myPrimaryStreams.has(s.stream_id);
        });

        renderPrimaryStreamList();

    } catch (e) {
        console.error('Failed to load streams for primary picker:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load streams</div>';
    }
}

function renderPrimaryStreamList(filter = '') {
    const container = document.getElementById('primaryStreamsList');
    const filterLower = filter.toLowerCase();

    // Filter streams by search term
    const filtered = primaryAvailableStreams.filter(s => {
        if (!filter) return true;
        const searchable = `${s.source} ${s.stream} ${s.target} ${s.stream_id}`.toLowerCase();
        return searchable.includes(filterLower);
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="text-center text-muted py-3">
            ${filter ? 'No streams match your search.' : 'No streams available. Register a new stream as primary oracle below.'}
        </div>`;
        return;
    }

    container.innerHTML = filtered.map(s => {
        const streamLabel = `${s.source}/${s.stream}/${s.target}`;
        const isSelected = selectedJoinPrimaryStream === s.stream_id;

        return `<div class="list-group-item list-group-item-action d-flex align-items-center ${isSelected ? 'active' : ''}"
                     style="cursor: pointer;"
                     onclick="selectJoinPrimaryStream('${s.stream_id}')">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    <strong>${streamLabel}</strong>
                </div>
                <small class="${isSelected ? '' : 'text-muted'}">${s.datatype} | Cadence: ${s.cadence}s | ${s.predictor_slots} slots</small>
            </div>
            <i class="material-icons ms-2" style="font-size: 20px;">${isSelected ? 'check_circle' : 'radio_button_unchecked'}</i>
        </div>`;
    }).join('');
}

function filterPrimaryStreams() {
    const search = document.getElementById('primaryStreamSearch').value;
    renderPrimaryStreamList(search);
}

// Store existing data source config from primary oracle (for auto-fill)
let joinPrimaryExistingDataSource = null;

async function selectJoinPrimaryStream(streamId) {
    selectedJoinPrimaryStream = streamId;
    joinPrimaryExistingDataSource = null;  // Reset
    joinPrimarySelectedTemplate = null;     // Reset template selection
    renderPrimaryStreamList(document.getElementById('primaryStreamSearch').value);

    // Show config section
    document.getElementById('joinPrimaryConfig').style.display = 'block';
    document.getElementById('joinPrimaryStreamId').textContent = streamId;

    // Fetch oracles for this stream to get existing primary's data source config
    try {
        const oraclesResult = await apiCall('/p2p/oracle/oracles');
        const oracles = oraclesResult.oracles || [];

        // Find a primary oracle for this stream that has data_source config
        const primaryOracle = oracles.find(o =>
            o.stream_id === streamId && o.is_primary && o.data_source
        );

        if (primaryOracle && primaryOracle.data_source) {
            joinPrimaryExistingDataSource = primaryOracle.data_source;
            joinPrimarySelectedTemplate = primaryOracle.data_source.template;
            console.log('Found existing data source config:', joinPrimaryExistingDataSource);

            // Hide template selector and fields - show auto-config confirmation instead
            document.getElementById('joinPrimaryTemplateSelector').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-success mb-0">
                        <i class="material-icons align-middle me-2" style="font-size: 20px;">check_circle</i>
                        <strong>Configuration auto-detected from existing primary oracle</strong>
                        <div class="mt-2 small">
                            <strong>Template:</strong> ${primaryOracle.data_source.template || 'N/A'}<br>
                            ${primaryOracle.data_source.base_asset ? `<strong>Base Asset:</strong> ${primaryOracle.data_source.base_asset}<br>` : ''}
                            ${primaryOracle.data_source.quote_asset ? `<strong>Quote Asset:</strong> ${primaryOracle.data_source.quote_asset}<br>` : ''}
                            ${primaryOracle.data_source.symbol ? `<strong>Symbol:</strong> ${primaryOracle.data_source.symbol}<br>` : ''}
                        </div>
                    </div>
                </div>`;
            document.getElementById('joinPrimaryTemplateConfig').style.display = 'none';
            return;  // Skip loading templates - we have everything we need
        }
    } catch (e) {
        console.error('Failed to fetch oracle data for auto-fill:', e);
    }

    // No existing config found - load templates for manual selection
    await loadJoinPrimaryTemplates();
}

async function loadJoinPrimaryTemplates() {
    const container = document.getElementById('joinPrimaryTemplateSelector');
    container.innerHTML = `<div class="col-12 text-center py-2">
        <div class="spinner-border spinner-border-sm" role="status"></div>
    </div>`;

    try {
        const result = await apiCall('/p2p/oracle/templates');
        if (!result.success || !result.templates) {
            container.innerHTML = '<div class="col-12 text-danger">Failed to load templates</div>';
            return;
        }

        const templates = result.templates;

        // Check if we have existing data source config to auto-select template
        const autoSelectTemplate = joinPrimaryExistingDataSource?.template || null;
        if (autoSelectTemplate && templates[autoSelectTemplate]) {
            joinPrimarySelectedTemplate = autoSelectTemplate;
        }

        container.innerHTML = Object.entries(templates).map(([key, tmpl]) => `
            <div class="col-md-3 col-6">
                <div class="card h-100 template-card ${joinPrimarySelectedTemplate === key ? 'border-warning' : ''}"
                     onclick="selectJoinPrimaryTemplate('${key}')"
                     style="cursor: pointer;">
                    <div class="card-body text-center py-2">
                        <h6 class="mb-1">${tmpl.name}</h6>
                        <small class="text-muted">${tmpl.description || ''}</small>
                    </div>
                </div>
            </div>
        `).join('');

        // If we auto-selected a template, load its fields with pre-filled values
        if (joinPrimarySelectedTemplate) {
            await loadJoinPrimaryTemplateFields(joinPrimarySelectedTemplate, templates[joinPrimarySelectedTemplate]);
        }

    } catch (e) {
        console.error('Failed to load templates:', e);
        container.innerHTML = '<div class="col-12 text-danger">Failed to load templates</div>';
    }
}

async function selectJoinPrimaryTemplate(templateKey) {
    joinPrimarySelectedTemplate = templateKey;

    // Update visual selection
    document.querySelectorAll('#joinPrimaryTemplateSelector .template-card').forEach(el => {
        el.classList.remove('border-warning');
    });
    event.currentTarget?.closest('.template-card')?.classList.add('border-warning');

    // Load template fields
    try {
        const result = await apiCall('/p2p/oracle/templates');
        const template = result.templates?.[templateKey];
        if (!template) return;

        await loadJoinPrimaryTemplateFields(templateKey, template);

    } catch (e) {
        console.error('Failed to load template fields:', e);
    }
}

// Helper function to load template fields with optional pre-fill from existing data source
async function loadJoinPrimaryTemplateFields(templateKey, template) {
    // Show template config section
    document.getElementById('joinPrimaryTemplateConfig').style.display = 'block';

    const fieldsContainer = document.getElementById('joinPrimaryTemplateFields');
    const requires = template.requires || [];

    // Build fields HTML with pre-filled values if available
    fieldsContainer.innerHTML = requires.map(field => {
        const placeholder = template[`example_${field}`] || template[`example`] || field;

        // Check if we have an existing value from the primary oracle's data source
        let existingValue = '';
        if (joinPrimaryExistingDataSource && joinPrimaryExistingDataSource[field]) {
            existingValue = joinPrimaryExistingDataSource[field];
        }

        return `<div class="mb-2">
            <label class="form-label small">${field}${existingValue ? ' <span class="badge bg-success">auto-filled</span>' : ''}</label>
            <input type="text" class="form-control form-control-sm" id="joinPrimary_${field}"
                   placeholder="e.g., ${placeholder}" value="${existingValue}">
        </div>`;
    }).join('') || '<p class="text-muted mb-0">No additional configuration needed.</p>';

    // Show info message if fields were auto-filled
    if (joinPrimaryExistingDataSource && requires.some(f => joinPrimaryExistingDataSource[f])) {
        const infoDiv = document.createElement('div');
        infoDiv.className = 'alert alert-info py-2 mt-2';
        infoDiv.innerHTML = '<small><i class="material-icons align-middle me-1" style="font-size: 16px;">info</i>Fields auto-filled from existing primary oracle. You can modify if needed.</small>';
        fieldsContainer.appendChild(infoDiv);
    }
}

async function registerAsJoinPrimaryOracle() {
    if (!selectedJoinPrimaryStream) {
        showToast('Please select a stream first', 'error');
        return;
    }

    // Check if we have existing data source config (auto-detected from network)
    // OR if user manually selected a template
    if (!joinPrimaryExistingDataSource && !joinPrimarySelectedTemplate) {
        showToast('Please select a data source template', 'error');
        return;
    }

    const btn = document.getElementById('joinPrimaryBtn');
    const resultDiv = document.getElementById('joinPrimaryResult');
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';

    try {
        let dataSource;

        // Use existing data source if we have it (auto-detected from network oracle)
        if (joinPrimaryExistingDataSource) {
            dataSource = joinPrimaryExistingDataSource;
            console.log('Using auto-detected data source config:', dataSource);
        } else {
            // Build data source config from form fields
            dataSource = {
                template: joinPrimarySelectedTemplate
            };

            // Get template to find required fields
            const templatesResult = await apiCall('/p2p/oracle/templates');
            const template = templatesResult.templates?.[joinPrimarySelectedTemplate];
            if (template?.requires) {
                template.requires.forEach(field => {
                    const input = document.getElementById(`joinPrimary_${field}`);
                    if (input && input.value) {
                        dataSource[field] = input.value;
                    }
                });
            }
        }

        const result = await apiCall('/p2p/oracle/register', 'POST', {
            stream_id: selectedJoinPrimaryStream,
            is_primary: true,
            data_source: dataSource
        });

        if (result.success) {
            resultDiv.innerHTML = '<div class="alert alert-success">Successfully registered as primary oracle!</div>';
            showToast('Registered as primary oracle!', 'success');
            // Reload all relevant data
            loadStreamStats();
            loadDiscoveredStreams();
            loadMyClaimedStreams();  // Refresh My Claimed Streams
            loadRegisteredOracles();
            loadMyOracleRegistrations();
            loadPrimaryStreamPicker();
            loadSecondaryStreamPicker();
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">Failed: ${result.error || 'Unknown error'}</div>`;
        }

    } catch (e) {
        console.error('Failed to register:', e);
        resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    } finally {
        btn.disabled = false;
        btn.innerHTML = '<i class="material-icons align-middle me-1" style="font-size: 20px;">group_add</i> Become Primary Oracle for This Stream';
    }
}

// =========================================================================
// SECONDARY ORACLE STREAM PICKER
// =========================================================================

// Store for available streams and selected streams
let secondaryAvailableStreams = [];
let secondarySelectedStreams = new Set();

async function loadSecondaryStreamPicker() {
    const container = document.getElementById('secondaryStreamsList');
    container.innerHTML = `<div class="text-center py-3 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Loading available streams...
    </div>`;

    try {
        // Fetch all discovered streams and our oracle summary
        const [streamsResult, oracleSummary, oraclesResult] = await Promise.all([
            apiCall('/p2p/streams/discover?limit=100'),
            apiCall('/p2p/oracle/summary'),
            apiCall('/p2p/oracle/oracles')
        ]);

        const streams = streamsResult.streams || [];
        const myPrimaryStreams = new Set(oracleSummary.primary_streams || []);
        const mySecondaryStreams = new Set(oracleSummary.secondary_streams || []);
        const oracles = oraclesResult.oracles || [];

        // Build map of stream_id -> has primary oracle
        const streamsWithPrimary = new Set();
        oracles.forEach(o => {
            if (o.is_primary) {
                streamsWithPrimary.add(o.stream_id);
            }
        });

        // Filter out streams we already have registrations for
        secondaryAvailableStreams = streams.filter(s => {
            // Exclude if we're already primary or secondary for this stream
            if (myPrimaryStreams.has(s.stream_id) || mySecondaryStreams.has(s.stream_id)) {
                return false;
            }
            return true;
        });

        // Sort: streams with active primaries first (they're ready for secondaries)
        secondaryAvailableStreams.sort((a, b) => {
            const aHasPrimary = streamsWithPrimary.has(a.stream_id);
            const bHasPrimary = streamsWithPrimary.has(b.stream_id);
            if (aHasPrimary && !bHasPrimary) return -1;
            if (!aHasPrimary && bHasPrimary) return 1;
            return 0;
        });

        // Add hasPrimary flag to each stream
        secondaryAvailableStreams.forEach(s => {
            s.hasPrimary = streamsWithPrimary.has(s.stream_id);
        });

        renderSecondaryStreamList();

    } catch (e) {
        console.error('Failed to load streams for secondary picker:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load streams</div>';
    }
}

function renderSecondaryStreamList(filter = '') {
    const container = document.getElementById('secondaryStreamsList');
    const filterLower = filter.toLowerCase();

    // Filter streams by search term
    const filtered = secondaryAvailableStreams.filter(s => {
        if (!filter) return true;
        const searchable = `${s.source} ${s.stream} ${s.target} ${s.stream_id}`.toLowerCase();
        return searchable.includes(filterLower);
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="text-center text-muted py-3">
            ${filter ? 'No streams match your search.' : 'No streams available for secondary registration. Register a primary oracle first, or wait for other nodes to register streams.'}
        </div>`;
        return;
    }

    container.innerHTML = filtered.map(s => {
        const isSelected = secondarySelectedStreams.has(s.stream_id);
        const streamLabel = `${s.source}/${s.stream}/${s.target}`;
        const primaryBadge = s.hasPrimary
            ? '<span class="badge bg-success ms-2" title="Has active primary oracle - ready for relay">Primary Active</span>'
            : '<span class="badge bg-warning text-dark ms-2" title="No primary oracle yet - cannot relay">No Primary</span>';

        return `<label class="list-group-item list-group-item-action d-flex align-items-center ${s.hasPrimary ? '' : 'opacity-50'}" style="cursor: pointer;">
            <input type="checkbox" class="form-check-input me-3" value="${s.stream_id}"
                   ${isSelected ? 'checked' : ''}
                   ${s.hasPrimary ? '' : 'disabled'}
                   onchange="toggleSecondaryStream('${s.stream_id}')">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    <strong>${streamLabel}</strong>
                    ${primaryBadge}
                </div>
                <small class="text-muted">${s.datatype} | Cadence: ${s.cadence}s | ${s.predictor_slots} slots</small>
            </div>
        </label>`;
    }).join('');
}

function filterSecondaryStreams() {
    const searchValue = document.getElementById('secondaryStreamSearch').value.trim();
    renderSecondaryStreamList(searchValue);
}

function toggleSecondaryStream(streamId) {
    if (secondarySelectedStreams.has(streamId)) {
        secondarySelectedStreams.delete(streamId);
    } else {
        secondarySelectedStreams.add(streamId);
    }
    updateSecondarySelectedCount();
}

function clearSecondarySelection() {
    secondarySelectedStreams.clear();
    updateSecondarySelectedCount();
    // Re-render to uncheck all checkboxes
    const searchValue = document.getElementById('secondaryStreamSearch').value.trim();
    renderSecondaryStreamList(searchValue);
}

function updateSecondarySelectedCount() {
    const count = secondarySelectedStreams.size;
    document.getElementById('secondarySelectedCount').textContent = count;
    document.getElementById('registerSecondaryBtn').disabled = count === 0;
}

async function registerSelectedAsSecondary() {
    if (secondarySelectedStreams.size === 0) {
        alert('Please select at least one stream');
        return;
    }

    const btn = document.getElementById('registerSecondaryBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Registering...';

    const streamIds = Array.from(secondarySelectedStreams);
    const results = { success: 0, failed: 0, errors: [] };

    // Register for each selected stream (includes auto-subscribe)
    for (const streamId of streamIds) {
        try {
            // Register as secondary AND subscribe to observations
            const [regResult, subResult] = await Promise.all([
                apiCall('/p2p/oracle/register-secondary', 'POST', { stream_id: streamId }),
                apiCall('/p2p/oracle/subscribe', 'POST', { stream_id: streamId })
            ]);

            if (regResult.success) {
                results.success++;
            } else {
                results.failed++;
                results.errors.push(`${streamId.split('|').slice(2).join('/')}: ${regResult.error || 'Unknown error'}`);
            }
        } catch (e) {
            results.failed++;
            results.errors.push(`${streamId.split('|').slice(2).join('/')}: ${e.message}`);
        }
    }

    btn.innerHTML = originalText;
    btn.disabled = false;

    // Show results
    let message = `Registered as secondary oracle for ${results.success} stream(s) and subscribed to observations.`;
    if (results.failed > 0) {
        message += `\n\nFailed for ${results.failed} stream(s):\n${results.errors.join('\n')}`;
    }
    alert(message);

    // Clear selection and refresh
    clearSecondarySelection();
    loadOracleStats();
    loadRegisteredOracles();
    loadMyOracleRegistrations();
    loadPrimaryStreamPicker();
    loadSecondaryStreamPicker();
    loadStreamStats();
    loadDiscoveredStreams();
    loadMyClaimedStreams();  // Refresh My Claimed Streams
}

// =========================================================================
// OBSERVATIONS FUNCTIONS
// =========================================================================

// Pagination state for My Published Observations
let myObsCurrentPage = 1;
let myObsTotalPages = 1;
const myObsPerPage = 50;

async function loadMyPublishedObservations(page = 1) {
    const tbody = document.getElementById('myObservationsTable');
    const countEl = document.getElementById('myObsCount');
    const paginationEl = document.getElementById('myObsPagination');
    const pageInfoEl = document.getElementById('myObsPageInfo');
    const prevBtn = document.getElementById('myObsPrevBtn');
    const nextBtn = document.getElementById('myObsNextBtn');

    try {
        const result = await apiCall(`/p2p/oracle/observations/my?page=${page}&per_page=${myObsPerPage}`);

        // Update pagination state
        myObsCurrentPage = result.page || 1;
        myObsTotalPages = result.total_pages || 1;
        const total = result.total || 0;

        // Update count display
        if (countEl) {
            countEl.textContent = total > 0 ? `(${total} total)` : '';
        }

        if (result.observations && result.observations.length > 0) {
            tbody.innerHTML = result.observations.map(obs => {
                const date = new Date(obs.timestamp * 1000);
                const streamId = obs.stream_id || '';
                return `<tr>
                    <td>${streamId}</td>
                    <td><strong>${obs.value}</strong></td>
                    <td>${date.toLocaleString()}</td>
                </tr>`;
            }).join('');

            // Show pagination if more than one page
            if (myObsTotalPages > 1) {
                paginationEl.style.display = 'flex';
                paginationEl.style.setProperty('display', 'flex', 'important');
                pageInfoEl.textContent = `Page ${myObsCurrentPage} of ${myObsTotalPages}`;
                prevBtn.disabled = myObsCurrentPage <= 1;
                nextBtn.disabled = myObsCurrentPage >= myObsTotalPages;
            } else {
                paginationEl.style.display = 'none';
                paginationEl.style.setProperty('display', 'none', 'important');
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No published observations yet. Register as an oracle to start publishing.</td></tr>';
            paginationEl.style.display = 'none';
            paginationEl.style.setProperty('display', 'none', 'important');
        }
    } catch (e) {
        console.error('Failed to load my observations:', e);
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger py-3">Failed to load</td></tr>';
        paginationEl.style.display = 'none';
        paginationEl.style.setProperty('display', 'none', 'important');
    }
}

function changeMyObsPage(delta) {
    const newPage = myObsCurrentPage + delta;
    if (newPage >= 1 && newPage <= myObsTotalPages) {
        loadMyPublishedObservations(newPage);
    }
}

async function loadLatestObservations() {
    const tbody = document.getElementById('observationsTable');
    const includeOwn = document.getElementById('includeOwnObservations')?.checked ?? true;
    try {
        const result = await apiCall(`/p2p/oracle/observations/latest?include_own=${includeOwn}`);
        if (result.observations && result.observations.length > 0) {
            tbody.innerHTML = result.observations.map(obs => {
                const date = new Date(obs.timestamp * 1000);
                const streamId = obs.stream_id || '';
                const oracleAddr = obs.oracle_address || '';
                const peerId = obs.peer_id || '--';
                return `<tr>
                    <td>${streamId}</td>
                    <td><strong>${obs.value}</strong></td>
                    <td><code>${oracleAddr}</code></td>
                    <td>${peerId}</td>
                    <td>${date.toLocaleString()}</td>
                </tr>`;
            }).join('');
        } else {
            const msg = includeOwn
                ? 'No observations yet. Register as an oracle to start publishing.'
                : 'No observations received from other oracles yet.';
            tbody.innerHTML = `<tr><td colspan="5" class="text-center text-muted py-3">${msg}</td></tr>`;
        }
    } catch (e) {
        console.error('Failed to load observations:', e);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">Failed to load</td></tr>';
    }
}

async function publishObservation(event) {
    event.preventDefault();

    const streamId = document.getElementById('pubObsStreamId').value.trim();
    const value = parseFloat(document.getElementById('pubObsValue').value);
    const timestamp = document.getElementById('pubObsTimestamp').value;
    const resultSpan = document.getElementById('publishResult');

    resultSpan.innerHTML = '<span class="text-info">Publishing...</span>';

    try {
        const payload = { stream_id: streamId, value: value };
        if (timestamp) payload.timestamp = parseInt(timestamp);

        const result = await apiCall('/p2p/oracle/publish', 'POST', payload);
        if (result.success) {
            resultSpan.innerHTML = '<span class="text-success">Published!</span>';
            document.getElementById('observationForm').reset();
            loadLatestObservations();
            loadMyPublishedObservations();
            setTimeout(() => { resultSpan.innerHTML = ''; }, 3000);
        } else {
            resultSpan.innerHTML = '<span class="text-danger">' + (result.error || 'Failed') + '</span>';
        }
    } catch (e) {
        resultSpan.innerHTML = '<span class="text-danger">Error: ' + e.message + '</span>';
    }
}
</script>
{% endblock %}
