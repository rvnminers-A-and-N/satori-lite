{% extends "base.html" %}

{% block title %}Satori - Oracles & Streams{% endblock %}

{% block content %}
<!-- Navigation -->
<nav class="navbar navbar-expand-lg px-4">
    <span class="navbar-brand">
        Satori
        <small class="text-muted ms-2" style="font-size: 0.65rem; font-weight: 400; opacity: 0.6;">{{ version }}</small>
    </span>
    <div class="ms-auto d-flex align-items-center">
        <!-- Connected Status -->
        <span class="me-3">
            <span class="status-indicator status-online" id="statusIndicator"></span>
            <span id="statusText">Connected</span>
        </span>
        <!-- Navigation Links -->
        <a href="{{ url_for('dashboard') }}" class="btn btn-outline-light btn-sm me-2" title="Dashboard">
            <i class="material-icons align-middle" style="font-size: 16px;">dashboard</i>
            Dashboard
        </a>
        <a href="{{ url_for('network') }}" class="btn btn-outline-light btn-sm me-2" title="P2P Network">
            <i class="material-icons align-middle" style="font-size: 16px;">hub</i>
            Network
        </a>
        <a href="{{ url_for('oracle_page') }}" class="btn btn-outline-light btn-sm me-2 active" title="Oracle">
            <i class="material-icons align-middle" style="font-size: 16px;">cloud_upload</i>
            Oracle
        </a>
        <a href="{{ url_for('predictions_page') }}" class="btn btn-outline-light btn-sm me-2" title="Predictions">
            <i class="material-icons align-middle" style="font-size: 16px;">trending_up</i>
            Predictions
        </a>
        <a href="{{ url_for('governance') }}" class="btn btn-outline-light btn-sm me-2" title="Governance">
            <i class="material-icons align-middle" style="font-size: 16px;">how_to_vote</i>
            Governance
        </a>
        {% if is_signer %}
        <a href="{{ url_for('signer_dashboard') }}" class="btn btn-outline-light btn-sm me-2" title="Signer">
            <i class="material-icons align-middle" style="font-size: 16px;">key</i>
            Signer
        </a>
        {% endif %}
        <a href="{{ url_for('stake_management') }}" class="btn btn-outline-light btn-sm me-2" title="Stake Management">
            <i class="material-icons align-middle" style="font-size: 16px;">handshake</i>
            Stake
        </a>
        <a href="{{ url_for('badges_page') }}" class="btn btn-outline-light btn-sm me-2" title="Badges & Achievements">
            <i class="material-icons align-middle" style="font-size: 16px;">military_tech</i>
            Badges
        </a>
        <a href="{{ url_for('donate') }}" class="btn btn-outline-light btn-sm me-2" title="Donate to Treasury">
            <i class="material-icons align-middle" style="font-size: 16px;">volunteer_activism</i>
            Donate
        </a>
        <a href="{{ url_for('guide') }}" class="btn btn-outline-light btn-sm me-2" title="Rewards Guide">
            <i class="material-icons align-middle" style="font-size: 16px;">menu_book</i>
            Guide
        </a>
        <a href="{{ url_for('restart_neuron') }}" class="btn btn-outline-light btn-sm me-2" title="Restart Node" onclick="return confirm('Restart your Satori node?');">
            <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
        </a>
        <a href="{{ url_for('logout') }}" class="btn btn-outline-light btn-sm me-2">Logout</a>
        <button class="theme-toggle" onclick="toggleTheme()" title="Toggle dark/light mode">
            <i class="material-icons" id="themeIcon">light_mode</i>
        </button>
    </div>
</nav>

<div class="container-fluid py-4">
    <!-- Mode Tabs -->
    <ul class="nav nav-tabs mb-4" role="tablist">
        <li class="nav-item">
            <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#streamsTab" type="button">
                <i class="material-icons align-middle me-1" style="font-size: 18px;">hub</i>
                Stream Registry
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#oraclesTab" type="button">
                <i class="material-icons align-middle me-1" style="font-size: 18px;">visibility</i>
                Oracles
            </button>
        </li>
        <li class="nav-item">
            <button class="nav-link" data-bs-toggle="tab" data-bs-target="#observationsTab" type="button">
                <i class="material-icons align-middle me-1" style="font-size: 18px;">update</i>
                Observations
            </button>
        </li>
    </ul>

    <div class="tab-content">
        <!-- ============================================================== -->
        <!-- STREAMS TAB -->
        <!-- ============================================================== -->
        <div class="tab-pane fade show active" id="streamsTab">
            <!-- Stream Stats Row -->
            <div class="row g-4 mb-4">
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="knownStreams" class="mb-1" style="color: #00aaff;">--</h3>
                            <small class="text-muted">Known Streams</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="myClaims" class="mb-1 text-success">--</h3>
                            <small class="text-muted">My Claims</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="myPrimaryOracles" class="mb-1" style="color: #ff6b6b;">--</h3>
                            <small class="text-muted">Primary (Publishing)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="mySecondaryOracles" class="mb-1" style="color: #4ecdc4;">--</h3>
                            <small class="text-muted">Secondary (Relay)</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="totalClaims" class="mb-1" style="color: #ffd700;">--</h3>
                            <small class="text-muted">Total Claims</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h4 id="streamRegistryStatus" class="mb-1 text-success">--</h4>
                            <small class="text-muted">Registry Status</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Discovered Streams -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">explore</i>
                                Discovered Streams
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadDiscoveredStreams()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="discoveredStreamsList" style="max-height: 350px; overflow-y: auto;">
                                <div class="text-center text-muted py-5">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- My Claimed Streams -->
                <div class="col-lg-6">
                    <div class="card h-100">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">check_circle</i>
                                My Claimed Streams
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyClaimedStreams()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div id="myClaimedStreamsList" style="max-height: 350px; overflow-y: auto;">
                                <div class="text-center text-muted py-5">Loading...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Claim Predictor Slot -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="material-icons align-middle me-2">assignment_turned_in</i>
                                Claim Predictor Slot
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="input-group">
                                <input type="text" class="form-control" id="claimStreamId" placeholder="Stream ID">
                                <button class="btn btn-primary" onclick="claimStream()">Claim</button>
                                <button class="btn btn-outline-danger" onclick="releaseStreamClaim()">Release</button>
                            </div>
                            <small class="text-muted">Claim a slot to make predictions on this stream</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Primary Oracle Registration - Register a New Stream & Become its Oracle -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card border-danger">
                        <div class="card-header d-flex justify-content-between align-items-center bg-danger bg-opacity-10" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#primaryOracleCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">cloud_upload</i>
                                Register New Stream & Become Primary Oracle
                                <i class="material-icons align-middle float-end" id="primaryCollapseIcon">expand_less</i>
                            </h5>
                        </div>
                        <div class="collapse show" id="primaryOracleCollapse">
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <strong>Primary oracles</strong> fetch real data from external sources (APIs, exchanges) and publish observations to the network.
                                    When you register a new stream, you become its primary oracle and start publishing data.
                                </p>

                                <!-- Step 1: Select Data Source Template -->
                                <div class="mb-4">
                                    <label class="form-label fw-bold">Step 1: Select Data Source</label>
                                    <div id="templateSelector" class="row g-2">
                                        <div class="text-center py-3 text-muted">
                                            <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                            Loading templates...
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 2: Configure Data Source (dynamic based on template) -->
                                <div class="mb-4" id="dataSourceConfig" style="display: none;">
                                    <label class="form-label fw-bold">Step 2: Configure <span id="selectedTemplateName">Data Source</span></label>
                                    <div class="card bg-dark">
                                        <div class="card-body">
                                            <!-- Template-specific fields will be inserted here -->
                                            <div id="templateFields"></div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Step 3: Stream ID -->
                                <div class="mb-4" id="streamIdSection" style="display: none;">
                                    <label class="form-label fw-bold">Step 3: Stream Identifier</label>
                                    <div class="row g-2">
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="primarySource" placeholder="Source (e.g., binance)">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="primaryStream" placeholder="Stream (e.g., BTCUSDT)">
                                        </div>
                                        <div class="col-md-4">
                                            <input type="text" class="form-control" id="primaryTarget" placeholder="Target (e.g., close)">
                                        </div>
                                    </div>
                                    <small class="text-muted">This creates a unique stream ID for your data feed</small>
                                </div>

                                <!-- Register Button -->
                                <div id="primaryRegisterSection" style="display: none;">
                                    <button class="btn btn-danger btn-lg w-100" onclick="registerAsPrimaryOracle()" id="registerPrimaryBtn">
                                        <i class="material-icons align-middle me-1" style="font-size: 20px;">cloud_upload</i>
                                        Register Stream & Become Primary Oracle
                                    </button>
                                    <div id="primaryRegisterResult" class="mt-2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Secondary Oracle Registration (Stream Picker) -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card border-info">
                        <div class="card-header d-flex justify-content-between align-items-center bg-info bg-opacity-10" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#secondaryOracleCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">sync</i>
                                Become a Secondary (Relay) Oracle
                                <i class="material-icons align-middle float-end" id="secondaryCollapseIcon">expand_less</i>
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="event.stopPropagation(); loadSecondaryStreamPicker()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="collapse show" id="secondaryOracleCollapse">
                            <div class="card-body">
                                <p class="text-muted mb-3">
                                    <strong>Secondary oracles</strong> help distribute data across the network by relaying observations from primary oracles.
                                    Select streams with active primaries to become a relay node. No API keys or data sources needed.
                                    <strong>You will automatically subscribe to observations when you register.</strong>
                                </p>

                                <!-- Search -->
                                <div class="mb-3">
                                    <div class="input-group">
                                        <span class="input-group-text"><i class="material-icons" style="font-size: 18px;">search</i></span>
                                        <input type="text" class="form-control" id="secondaryStreamSearch" placeholder="Search streams..." onkeyup="filterSecondaryStreams()">
                                    </div>
                                </div>

                                <!-- Stream List -->
                                <div id="secondaryStreamsList" class="list-group mb-3" style="max-height: 300px; overflow-y: auto;">
                                    <div class="text-center py-3 text-muted">
                                        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
                                        Loading available streams...
                                    </div>
                                </div>

                                <!-- Selection Summary -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <span class="text-muted">
                                        <span id="secondarySelectedCount">0</span> streams selected
                                    </span>
                                    <div>
                                        <button class="btn btn-sm btn-outline-secondary me-2" onclick="clearSecondarySelection()">Clear</button>
                                        <button class="btn btn-info btn-lg" onclick="registerSelectedAsSecondary()" id="registerSecondaryBtn" disabled>
                                            <i class="material-icons align-middle me-1" style="font-size: 20px;">sync</i>
                                            Register as Secondary Oracle
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================== -->
        <!-- ORACLES TAB -->
        <!-- ============================================================== -->
        <div class="tab-pane fade" id="oraclesTab">
            <!-- Oracle Stats Row -->
            <div class="row g-4 mb-4">
                <!-- My Stats -->
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="myOracleRegistrations" class="mb-1 text-success">--</h3>
                            <small class="text-muted">My Registrations</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="oracleSubscribedStreams" class="mb-1" style="color: #00aaff;">--</h3>
                            <small class="text-muted">My Subscriptions</small>
                        </div>
                    </div>
                </div>
                <!-- Network Stats -->
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="knownOracles" class="mb-1" style="color: #ffd700;">--</h3>
                            <small class="text-muted">Network Oracles</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="networkPrimaryCount" class="mb-1" style="color: #ff6b6b;">--</h3>
                            <small class="text-muted">Network Primary</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="networkSecondaryCount" class="mb-1" style="color: #4ecdc4;">--</h3>
                            <small class="text-muted">Network Secondary</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-2 col-6">
                    <div class="card text-center h-100">
                        <div class="card-body py-3">
                            <h3 id="cachedObservations" class="mb-1" style="color: #00ff88;">--</h3>
                            <small class="text-muted">Cached Observations</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                <!-- Registered Oracles -->
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">group</i>
                                Registered Oracles
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadRegisteredOracles()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Oracle Address</th>
                                            <th>Peer ID</th>
                                            <th>Reputation</th>
                                            <th>Type</th>
                                        </tr>
                                    </thead>
                                    <tbody id="oraclesTable">
                                        <tr><td colspan="5" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Oracle Registrations -->
            <div class="row g-4 mt-2">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">person</i>
                                My Oracle Registrations
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyOracleRegistrations()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Type</th>
                                            <th>Data Source</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myOracleRegistrationsTable">
                                        <tr><td colspan="4" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ============================================================== -->
        <!-- OBSERVATIONS TAB -->
        <!-- ============================================================== -->
        <div class="tab-pane fade" id="observationsTab">
            <!-- Recent Observations -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">update</i>
                                Recent Observations
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadLatestObservations()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Value</th>
                                            <th>Oracle Address</th>
                                            <th>Peer ID</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="observationsTable">
                                        <tr><td colspan="5" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- My Published Observations -->
            <div class="row g-4 mb-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">cloud_upload</i>
                                My Published Observations
                                <small class="text-muted ms-2" id="myObsCount"></small>
                            </h5>
                            <button class="btn btn-sm btn-outline-secondary" onclick="loadMyPublishedObservations()">
                                <i class="material-icons align-middle" style="font-size: 16px;">refresh</i>
                            </button>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0">
                                    <thead>
                                        <tr>
                                            <th>Stream</th>
                                            <th>Value</th>
                                            <th>Timestamp</th>
                                        </tr>
                                    </thead>
                                    <tbody id="myObservationsTable">
                                        <tr><td colspan="3" class="text-center text-muted py-3">Loading...</td></tr>
                                    </tbody>
                                </table>
                            </div>
                            <!-- Pagination controls -->
                            <div class="card-footer d-flex justify-content-between align-items-center" id="myObsPagination" style="display: none !important;">
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="myObsPrevBtn" onclick="changeMyObsPage(-1)" disabled>
                                        <i class="material-icons align-middle" style="font-size: 16px;">chevron_left</i> Previous
                                    </button>
                                </div>
                                <span class="text-muted" id="myObsPageInfo">Page 1 of 1</span>
                                <div>
                                    <button class="btn btn-sm btn-outline-secondary" id="myObsNextBtn" onclick="changeMyObsPage(1)" disabled>
                                        Next <i class="material-icons align-middle" style="font-size: 16px;">chevron_right</i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Publish Observation -->
            <div class="row g-4">
                <div class="col-12">
                    <div class="card">
                        <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse" data-bs-target="#publishObservationCollapse">
                            <h5 class="mb-0">
                                <i class="material-icons align-middle me-2">publish</i>
                                Publish Observation (Manual)
                                <i class="material-icons align-middle float-end">expand_more</i>
                            </h5>
                        </div>
                        <div class="collapse" id="publishObservationCollapse">
                            <div class="card-body">
                                <p class="text-muted small">You must be registered as an oracle for a stream to publish observations. Primary oracles publish automatically based on their data source configuration.</p>
                                <form id="observationForm" onsubmit="publishObservation(event)">
                                    <div class="row g-3">
                                        <div class="col-md-5">
                                            <label class="form-label">Stream ID</label>
                                            <input type="text" class="form-control" id="pubObsStreamId" placeholder="Stream ID" required>
                                        </div>
                                        <div class="col-md-4">
                                            <label class="form-label">Observed Value</label>
                                            <input type="number" class="form-control" id="pubObsValue" placeholder="Value" step="any" required>
                                        </div>
                                        <div class="col-md-3">
                                            <label class="form-label">Timestamp (optional)</label>
                                            <input type="number" class="form-control" id="pubObsTimestamp" placeholder="Unix (now if empty)">
                                        </div>
                                    </div>
                                    <div class="mt-3">
                                        <button type="submit" class="btn btn-success">
                                            <i class="material-icons align-middle" style="font-size: 16px;">send</i>
                                            Publish
                                        </button>
                                        <span id="publishResult" class="ms-3"></span>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// =========================================================================
// PAGE INITIALIZATION
// =========================================================================

document.addEventListener('DOMContentLoaded', function() {
    // Initialize theme
    const storedTheme = localStorage.getItem('satori-theme') || 'dark';
    const themeIcon = document.getElementById('themeIcon');
    if (themeIcon) {
        themeIcon.textContent = storedTheme === 'dark' ? 'light_mode' : 'dark_mode';
    }

    // Load initial data
    loadStreamStats();
    loadOracleStats();
    loadDiscoveredStreams();
    loadMyClaimedStreams();
    loadRegisteredOracles();
    loadMyOracleRegistrations();  // Load my registrations
    loadLatestObservations();
    loadMyPublishedObservations();
    loadOracleTemplates();  // Load templates immediately since section is expanded
    loadSecondaryStreamPicker();  // Load secondary picker immediately

    // Set up periodic refresh
    setInterval(loadStreamStats, 30000);
    setInterval(loadOracleStats, 30000);
    setInterval(loadLatestObservations, 15000);
    setInterval(loadMyPublishedObservations, 30000);
    setInterval(loadMyOracleRegistrations, 30000);  // Refresh my registrations

    // Handle tab switching - refresh data when switching tabs
    document.querySelectorAll('[data-bs-toggle="tab"]').forEach(tab => {
        tab.addEventListener('shown.bs.tab', (e) => {
            const target = e.target.getAttribute('data-bs-target');
            if (target === '#oraclesTab') {
                loadOracleStats();
                loadRegisteredOracles();
                loadMyOracleRegistrations();
            } else if (target === '#observationsTab') {
                loadLatestObservations();
                loadMyPublishedObservations();
            } else if (target === '#streamsTab') {
                loadStreamStats();
                loadDiscoveredStreams();
                loadSecondaryStreamPicker();
            }
        });
    });

    // Handle collapse icon toggling
    const primaryCollapse = document.getElementById('primaryOracleCollapse');
    const secondaryCollapse = document.getElementById('secondaryOracleCollapse');

    if (primaryCollapse) {
        primaryCollapse.addEventListener('shown.bs.collapse', () => {
            document.getElementById('primaryCollapseIcon').textContent = 'expand_less';
        });
        primaryCollapse.addEventListener('hidden.bs.collapse', () => {
            document.getElementById('primaryCollapseIcon').textContent = 'expand_more';
        });
    }

    if (secondaryCollapse) {
        secondaryCollapse.addEventListener('shown.bs.collapse', () => {
            document.getElementById('secondaryCollapseIcon').textContent = 'expand_less';
        });
        secondaryCollapse.addEventListener('hidden.bs.collapse', () => {
            document.getElementById('secondaryCollapseIcon').textContent = 'expand_more';
        });
    }
});

// =========================================================================
// API HELPER
// =========================================================================

async function apiCall(endpoint, method = 'GET', data = null) {
    const options = {
        method: method,
        headers: { 'Content-Type': 'application/json' }
    };
    if (data) {
        options.body = JSON.stringify(data);
    }
    const response = await fetch('/api' + endpoint, options);
    return response.json();
}

// =========================================================================
// STREAM REGISTRY FUNCTIONS
// =========================================================================

async function loadStreamStats() {
    try {
        const [stats, summary] = await Promise.all([
            apiCall('/p2p/streams/stats'),
            apiCall('/p2p/oracle/summary')
        ]);
        document.getElementById('knownStreams').textContent = stats.known_streams || 0;
        document.getElementById('myClaims').textContent = stats.my_claims || 0;
        document.getElementById('totalClaims').textContent = stats.total_claims || 0;
        document.getElementById('streamRegistryStatus').textContent = stats.started ? 'Active' : 'Offline';
        document.getElementById('streamRegistryStatus').className = stats.started ? 'mb-1 text-success' : 'mb-1 text-danger';

        // Oracle counts
        document.getElementById('myPrimaryOracles').textContent = summary.primary_count || 0;
        document.getElementById('mySecondaryOracles').textContent = summary.secondary_count || 0;
    } catch (e) {
        console.error('Failed to load stream stats:', e);
    }
}

async function loadDiscoveredStreams() {
    const container = document.getElementById('discoveredStreamsList');
    try {
        const result = await apiCall('/p2p/streams/discover?limit=20');
        if (result.streams && result.streams.length > 0) {
            container.innerHTML = result.streams.map(stream => {
                const streamIdShort = stream.stream_id.substring(0, 12) + '...';
                return `<div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <strong>${stream.source}/${stream.stream}</strong>
                            <br><small class="text-muted">Target: ${stream.target} | ${stream.datatype}</small>
                            <br><small class="text-muted" title="${stream.stream_id}">ID: ${streamIdShort}</small>
                        </div>
                        <div class="text-end">
                            <span class="badge bg-secondary">${stream.predictor_slots} slots</span>
                            <br><button class="btn btn-outline-primary btn-sm mt-1" onclick="document.getElementById('claimStreamId').value='${stream.stream_id}'">
                                Select
                            </button>
                        </div>
                    </div>
                    ${stream.description ? `<small class="text-muted">${stream.description}</small>` : ''}
                </div>`;
            }).join('');
        } else {
            container.innerHTML = '<div class="text-center text-muted py-5">No streams discovered. Register a stream below to get started!</div>';
        }
    } catch (e) {
        console.error('Failed to load streams:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load streams</div>';
    }
}

async function loadMyClaimedStreams() {
    const container = document.getElementById('myClaimedStreamsList');
    try {
        const result = await apiCall('/p2p/streams/my');
        if (result.claims && result.claims.length > 0) {
            container.innerHTML = result.claims.map(claim => {
                const streamIdShort = claim.stream_id.substring(0, 16) + '...';
                const expires = claim.expires ? new Date(claim.expires * 1000).toLocaleDateString() : 'Never';
                const statusBadge = claim.is_expired ? '<span class="badge bg-danger">Expired</span>' : '<span class="badge bg-success">Active</span>';
                return `<div class="p-3 border-bottom">
                    <div class="d-flex justify-content-between">
                        <div>
                            <span title="${claim.stream_id}">${streamIdShort}</span>
                            <br><small class="text-muted">Slot #${claim.slot_index} | Expires: ${expires}</small>
                        </div>
                        <div>
                            ${statusBadge}
                            <br><button class="btn btn-outline-danger btn-sm mt-1" onclick="document.getElementById('claimStreamId').value='${claim.stream_id}'; releaseStreamClaim()">
                                Release
                            </button>
                        </div>
                    </div>
                </div>`;
            }).join('');
        } else {
            container.innerHTML = '<div class="text-center text-muted py-5">No claimed streams. Claim a stream to start making predictions.</div>';
        }
    } catch (e) {
        console.error('Failed to load my claims:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load claims</div>';
    }
}

async function claimStream() {
    const streamId = document.getElementById('claimStreamId').value.trim();
    if (!streamId) { alert('Please enter a stream ID'); return; }

    try {
        const result = await apiCall('/p2p/streams/claim', 'POST', { stream_id: streamId });
        if (result.success) {
            alert('Claimed slot #' + (result.claim?.slot_index || 0));
            document.getElementById('claimStreamId').value = '';
            loadStreamStats();
            loadMyClaimedStreams();
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) { alert('Error: ' + e.message); }
}

async function releaseStreamClaim() {
    const streamId = document.getElementById('claimStreamId').value.trim();
    if (!streamId) { alert('Please enter a stream ID'); return; }

    try {
        const result = await apiCall('/p2p/streams/release', 'POST', { stream_id: streamId });
        if (result.success) {
            alert('Released claim on stream');
            document.getElementById('claimStreamId').value = '';
            loadStreamStats();
            loadMyClaimedStreams();
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) { alert('Error: ' + e.message); }
}

// =========================================================================
// ORACLE FUNCTIONS
// =========================================================================

async function loadOracleStats() {
    try {
        // Load basic oracle stats, summary, and oracles list
        const [stats, summary, oraclesResult] = await Promise.all([
            apiCall('/p2p/oracle/stats'),
            apiCall('/p2p/oracle/summary'),
            apiCall('/p2p/oracle/oracles')
        ]);

        // My stats
        document.getElementById('oracleSubscribedStreams').textContent = stats.subscribed_streams || 0;
        document.getElementById('myOracleRegistrations').textContent = stats.my_oracle_registrations || 0;
        document.getElementById('cachedObservations').textContent = stats.cached_observations || 0;

        // Network-wide stats from oracles list
        const oracles = oraclesResult.oracles || [];
        const networkPrimaryCount = oracles.filter(o => o.is_primary).length;
        const networkSecondaryCount = oracles.filter(o => !o.is_primary).length;

        document.getElementById('knownOracles').textContent = oracles.length;
        document.getElementById('networkPrimaryCount').textContent = networkPrimaryCount;
        document.getElementById('networkSecondaryCount').textContent = networkSecondaryCount;
    } catch (e) {
        console.error('Failed to load oracle stats:', e);
    }
}

async function loadRegisteredOracles() {
    const tbody = document.getElementById('oraclesTable');
    try {
        // Get oracles list and our identity to check if oracle is ours
        const [result, identity] = await Promise.all([
            apiCall('/p2p/oracle/oracles'),
            apiCall('/p2p/identity')
        ]);

        // Our evrmore address for checking "ours" badge
        const myAddress = identity.evrmore_address || '';

        if (result.oracles && result.oracles.length > 0) {
            tbody.innerHTML = result.oracles.map(o => {
                const addr = o.oracle_address || '';
                const peerId = o.peer_id || '--';
                const streamId = o.stream_id || '';
                // Only mark as "ours" if the oracle address matches OUR address
                const isOurs = myAddress && addr === myAddress;
                const typeBadge = o.is_primary
                    ? '<span class="badge bg-danger">Primary</span>'
                    : '<span class="badge bg-info">Secondary</span>';
                const oursBadge = isOurs ? ' <span class="badge bg-success">Ours</span>' : '';

                // Parse stream ID: source|stream|target -> source/stream/target
                const streamParts = streamId.split('|');
                const streamLabel = streamParts.length >= 3
                    ? `${streamParts[0]}/${streamParts[1]}/${streamParts[2]}`
                    : streamId;

                return `<tr${isOurs ? ' class="table-active"' : ''}>
                    <td><code title="${streamId}">${streamLabel}</code></td>
                    <td><code class="small">${addr}</code></td>
                    <td class="small">${peerId}</td>
                    <td>${Math.round((o.reputation || 1.0) * 100)}%</td>
                    <td>${typeBadge}${oursBadge}</td>
                </tr>`;
            }).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No oracles registered</td></tr>';
        }
    } catch (e) {
        console.error('Failed to load oracles:', e);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">Failed to load</td></tr>';
    }
}

async function loadMyOracleRegistrations() {
    const tbody = document.getElementById('myOracleRegistrationsTable');
    try {
        const summary = await apiCall('/p2p/oracle/summary');

        const rows = [];

        // Helper to format stream ID
        const formatStreamId = (streamId) => {
            const parts = streamId.split('|');
            return parts.length >= 3 ? `${parts[0]}/${parts[1]}/${parts[2]}` : streamId;
        };

        // Add primary registrations
        for (const streamId of (summary.primary_streams || [])) {
            const streamLabel = formatStreamId(streamId);
            rows.push(`<tr>
                <td><code title="${streamId}">${streamLabel}</code></td>
                <td><span class="badge bg-danger">Primary</span></td>
                <td><span class="text-muted">Configured</span></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="unregisterOracle('${streamId}')">
                        Unregister
                    </button>
                </td>
            </tr>`);
        }

        // Add secondary registrations
        for (const streamId of (summary.secondary_streams || [])) {
            const streamLabel = formatStreamId(streamId);
            rows.push(`<tr>
                <td><code title="${streamId}">${streamLabel}</code></td>
                <td><span class="badge bg-info">Secondary</span></td>
                <td><span class="text-muted">Relay</span></td>
                <td>
                    <button class="btn btn-outline-danger btn-sm" onclick="unregisterOracle('${streamId}')">
                        Unregister
                    </button>
                </td>
            </tr>`);
        }

        if (rows.length > 0) {
            tbody.innerHTML = rows.join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted py-3">No oracle registrations. Register as a Primary or Secondary oracle on the Stream Registry tab.</td></tr>';
        }
    } catch (e) {
        console.error('Failed to load my oracle registrations:', e);
        tbody.innerHTML = '<tr><td colspan="4" class="text-center text-danger py-3">Failed to load</td></tr>';
    }
}

async function unregisterOracle(streamId) {
    if (!confirm(`Unregister as oracle for this stream?`)) return;

    try {
        const result = await apiCall('/p2p/oracle/unregister', 'POST', { stream_id: streamId });
        if (result.success) {
            alert('Unregistered successfully');
            loadOracleStats();
            loadRegisteredOracles();
            loadMyOracleRegistrations();
            loadStreamStats();
            loadSecondaryStreamPicker();
        } else {
            alert('Failed: ' + (result.error || 'Unknown error'));
        }
    } catch (e) {
        alert('Error: ' + e.message);
    }
}

// =========================================================================
// PRIMARY ORACLE TEMPLATE PICKER
// =========================================================================

let oracleTemplates = [];
let selectedTemplate = null;

async function loadOracleTemplates() {
    const container = document.getElementById('templateSelector');

    try {
        const result = await apiCall('/p2p/oracle/templates');
        if (result.success && result.templates) {
            oracleTemplates = result.templates;
            renderTemplateSelector();
        } else {
            container.innerHTML = '<div class="text-center text-warning py-3">Oracle templates not available. Ensure satorip2p is up to date.</div>';
        }
    } catch (e) {
        console.error('Failed to load oracle templates:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load templates</div>';
    }
}

function renderTemplateSelector() {
    const container = document.getElementById('templateSelector');

    if (oracleTemplates.length === 0) {
        container.innerHTML = '<div class="text-center text-muted py-3">No templates available</div>';
        return;
    }

    container.innerHTML = oracleTemplates.map(t => {
        const isSelected = selectedTemplate && selectedTemplate.id === t.id;
        const iconMap = {
            'binance': 'currency_bitcoin',
            'binance_kline': 'candlestick_chart',
            'coingecko': 'pets',
            'coinmarketcap': 'bar_chart',
            'kraken': 'waves',
            'coinbase': 'account_balance',
            'custom': 'settings',
        };
        const icon = iconMap[t.id] || 'api';

        return `<div class="col-md-3 col-6 mb-2">
            <div class="card h-100 template-card ${isSelected ? 'border-danger' : ''}"
                 style="cursor: pointer; ${isSelected ? 'background: rgba(220, 53, 69, 0.1);' : ''}"
                 onclick="selectTemplate('${t.id}')">
                <div class="card-body text-center py-3">
                    <i class="material-icons mb-2" style="font-size: 32px; color: ${isSelected ? '#dc3545' : '#00aaff'};">${icon}</i>
                    <h6 class="mb-1">${t.name}</h6>
                    <small class="text-muted">${t.description}</small>
                </div>
            </div>
        </div>`;
    }).join('');
}

function selectTemplate(templateId) {
    selectedTemplate = oracleTemplates.find(t => t.id === templateId);
    if (!selectedTemplate) return;

    // Re-render selector to show selection
    renderTemplateSelector();

    // Show config section
    document.getElementById('dataSourceConfig').style.display = 'block';
    document.getElementById('selectedTemplateName').textContent = selectedTemplate.name;

    // Generate template-specific fields
    renderTemplateFields();

    // Show stream ID and register sections
    document.getElementById('streamIdSection').style.display = 'block';
    document.getElementById('primaryRegisterSection').style.display = 'block';

    // Pre-fill source if template has a name
    if (selectedTemplate.id !== 'custom') {
        document.getElementById('primarySource').value = selectedTemplate.id.replace('_kline', '');
    }
}

function renderTemplateFields() {
    const container = document.getElementById('templateFields');
    const requires = selectedTemplate.requires || [];

    let html = '';

    // Symbol field (for Binance, Kraken, Coinbase, CMC)
    if (requires.includes('symbol')) {
        const example = selectedTemplate.example_symbol || 'BTCUSDT';
        html += `<div class="mb-3">
            <label class="form-label">Trading Pair / Symbol</label>
            <input type="text" class="form-control" id="templateSymbol" placeholder="e.g., ${example}" value="">
            <small class="text-muted">Example: ${example}</small>
        </div>`;
    }

    // Base/Quote assets (for CoinGecko)
    if (requires.includes('base_asset')) {
        const exampleBase = selectedTemplate.example_base || 'bitcoin';
        html += `<div class="mb-3">
            <label class="form-label">Base Asset (CoinGecko ID)</label>
            <input type="text" class="form-control" id="templateBaseAsset" placeholder="e.g., ${exampleBase}" value="">
            <small class="text-muted">Use CoinGecko coin ID (e.g., bitcoin, ethereum, ripple)</small>
        </div>`;
    }

    if (requires.includes('quote_asset')) {
        const exampleQuote = selectedTemplate.example_quote || 'usd';
        html += `<div class="mb-3">
            <label class="form-label">Quote Currency</label>
            <input type="text" class="form-control" id="templateQuoteAsset" placeholder="e.g., ${exampleQuote}" value="">
            <small class="text-muted">e.g., usd, eur, btc</small>
        </div>`;
    }

    // API Key (for CMC)
    if (requires.includes('api_key')) {
        html += `<div class="mb-3">
            <label class="form-label">API Key <span class="badge bg-warning text-dark">Required</span></label>
            <input type="password" class="form-control" id="templateApiKey" placeholder="Your API key">
            <small class="text-muted">Required for ${selectedTemplate.name}. Get your API key from their website.</small>
        </div>`;
    }

    // Custom API fields
    if (requires.includes('api_url')) {
        html += `<div class="mb-3">
            <label class="form-label">API URL</label>
            <input type="text" class="form-control" id="templateApiUrl" placeholder="https://api.example.com/data">
            <small class="text-muted">Full URL to fetch data from</small>
        </div>`;
    }

    if (requires.includes('json_path')) {
        html += `<div class="mb-3">
            <label class="form-label">JSON Path to Value</label>
            <input type="text" class="form-control" id="templateJsonPath" placeholder="e.g., data.price or 0.close">
            <small class="text-muted">Path to extract the value from JSON response</small>
        </div>`;
    }

    // Additional headers for custom
    if (selectedTemplate.id === 'custom') {
        html += `<div class="mb-3">
            <label class="form-label">HTTP Headers (JSON, optional)</label>
            <input type="text" class="form-control" id="templateHeaders" placeholder='{"Authorization": "Bearer token"}'>
            <small class="text-muted">Optional headers in JSON format</small>
        </div>`;
    }

    // Fetch interval and value type - show for all templates
    html += `<div class="row g-2 mt-3">
        <div class="col-md-6">
            <label class="form-label">Fetch Interval (seconds)</label>
            <input type="number" class="form-control" id="templateFetchInterval" placeholder="60" value="60" min="1">
            <small class="text-muted">How often to fetch data (default: 60s)</small>
        </div>
        <div class="col-md-6">
            <label class="form-label">Value Type</label>
            <select class="form-select" id="templateValueType">
                <option value="float" selected>Float (decimal number)</option>
                <option value="int">Integer (whole number)</option>
                <option value="string">String (text)</option>
            </select>
            <small class="text-muted">Expected data type of the value</small>
        </div>
    </div>`;

    container.innerHTML = html || '<p class="text-muted">No additional configuration needed.</p>';
}

function buildDataSourceConfig() {
    if (!selectedTemplate) return null;

    const config = {
        template: selectedTemplate.id,
        api_url: selectedTemplate.api_url || '',
        json_path: selectedTemplate.json_path || '',
        value_type: selectedTemplate.value_type || 'float',
        api_headers: {},
        fetch_interval: 60,
    };

    // Get values from fields
    const symbol = document.getElementById('templateSymbol')?.value.trim();
    const baseAsset = document.getElementById('templateBaseAsset')?.value.trim();
    const quoteAsset = document.getElementById('templateQuoteAsset')?.value.trim();
    const apiKey = document.getElementById('templateApiKey')?.value.trim();
    const apiUrl = document.getElementById('templateApiUrl')?.value.trim();
    const jsonPath = document.getElementById('templateJsonPath')?.value.trim();
    const headersStr = document.getElementById('templateHeaders')?.value.trim();
    const fetchInterval = parseInt(document.getElementById('templateFetchInterval')?.value) || 60;
    const valueType = document.getElementById('templateValueType')?.value || 'float';

    // Set template params
    if (symbol) config.symbol = symbol;
    if (baseAsset) config.base_asset = baseAsset;
    if (quoteAsset) config.quote_asset = quoteAsset;

    // Replace placeholders in API URL
    if (config.api_url) {
        config.api_url = config.api_url
            .replace('{symbol}', symbol || '')
            .replace('{base_asset}', baseAsset || '')
            .replace('{quote_asset}', quoteAsset || '');
    }

    // Replace placeholders in JSON path
    if (config.json_path) {
        config.json_path = config.json_path
            .replace('{symbol}', symbol || '')
            .replace('{base_asset}', baseAsset || '')
            .replace('{quote_asset}', quoteAsset || '');
    }

    // Handle API key in headers
    if (apiKey && selectedTemplate.api_headers) {
        for (const [key, val] of Object.entries(selectedTemplate.api_headers)) {
            config.api_headers[key] = val.replace('{api_key}', apiKey);
        }
    }

    // Custom overrides
    if (apiUrl) config.api_url = apiUrl;
    if (jsonPath) config.json_path = jsonPath;

    // Set fetch interval and value type from UI
    config.fetch_interval = fetchInterval;
    config.value_type = valueType;

    // Parse custom headers
    if (headersStr) {
        try {
            const parsedHeaders = JSON.parse(headersStr);
            config.api_headers = { ...config.api_headers, ...parsedHeaders };
        } catch (e) {
            console.warn('Invalid headers JSON:', e);
        }
    }

    return config;
}

async function registerAsPrimaryOracle() {
    const source = document.getElementById('primarySource').value.trim();
    const stream = document.getElementById('primaryStream').value.trim();
    const target = document.getElementById('primaryTarget').value.trim();
    const resultDiv = document.getElementById('primaryRegisterResult');

    if (!source || !stream || !target) {
        resultDiv.innerHTML = '<span class="text-danger">Please fill in Source, Stream, and Target</span>';
        return;
    }

    if (!selectedTemplate) {
        resultDiv.innerHTML = '<span class="text-danger">Please select a data source template</span>';
        return;
    }

    // Check required fields
    const requires = selectedTemplate.requires || [];
    if (requires.includes('api_key') && !document.getElementById('templateApiKey')?.value.trim()) {
        resultDiv.innerHTML = '<span class="text-danger">API key is required for ' + selectedTemplate.name + '</span>';
        return;
    }

    // Build stream ID (using same format as stream registry)
    const streamId = `${source}|${stream}|${target}`;
    const dataSource = buildDataSourceConfig();

    const btn = document.getElementById('registerPrimaryBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Registering...';
    resultDiv.innerHTML = '';

    try {
        const result = await apiCall('/p2p/oracle/register-primary', 'POST', {
            stream_id: streamId,
            data_source: dataSource,
        });

        if (result.success) {
            resultDiv.innerHTML = `<div class="alert alert-success">
                <i class="material-icons align-middle" style="font-size: 16px;">check_circle</i>
                <strong>Success!</strong> Registered stream and became primary oracle for <code>${source}/${stream}/${target}</code>
            </div>`;

            // Refresh all relevant data
            loadStreamStats();
            loadDiscoveredStreams();
            loadRegisteredOracles();
            loadSecondaryStreamPicker();

            // Clear form after delay
            setTimeout(() => {
                document.getElementById('primarySource').value = '';
                document.getElementById('primaryStream').value = '';
                document.getElementById('primaryTarget').value = '';
                selectedTemplate = null;
                renderTemplateSelector();
                document.getElementById('dataSourceConfig').style.display = 'none';
                document.getElementById('streamIdSection').style.display = 'none';
                document.getElementById('primaryRegisterSection').style.display = 'none';
                resultDiv.innerHTML = '';
            }, 5000);
        } else {
            resultDiv.innerHTML = `<div class="alert alert-danger">${result.error || 'Registration failed'}</div>`;
        }
    } catch (e) {
        resultDiv.innerHTML = `<div class="alert alert-danger">Error: ${e.message}</div>`;
    } finally {
        btn.innerHTML = originalText;
        btn.disabled = false;
    }
}

// =========================================================================
// SECONDARY ORACLE STREAM PICKER
// =========================================================================

// Store for available streams and selected streams
let secondaryAvailableStreams = [];
let secondarySelectedStreams = new Set();

async function loadSecondaryStreamPicker() {
    const container = document.getElementById('secondaryStreamsList');
    container.innerHTML = `<div class="text-center py-3 text-muted">
        <div class="spinner-border spinner-border-sm me-2" role="status"></div>
        Loading available streams...
    </div>`;

    try {
        // Fetch all discovered streams and our oracle summary
        const [streamsResult, oracleSummary, oraclesResult] = await Promise.all([
            apiCall('/p2p/streams/discover?limit=100'),
            apiCall('/p2p/oracle/summary'),
            apiCall('/p2p/oracle/oracles')
        ]);

        const streams = streamsResult.streams || [];
        const myPrimaryStreams = new Set(oracleSummary.primary_streams || []);
        const mySecondaryStreams = new Set(oracleSummary.secondary_streams || []);
        const oracles = oraclesResult.oracles || [];

        // Build map of stream_id -> has primary oracle
        const streamsWithPrimary = new Set();
        oracles.forEach(o => {
            if (o.is_primary) {
                streamsWithPrimary.add(o.stream_id);
            }
        });

        // Filter out streams we already have registrations for
        secondaryAvailableStreams = streams.filter(s => {
            // Exclude if we're already primary or secondary for this stream
            if (myPrimaryStreams.has(s.stream_id) || mySecondaryStreams.has(s.stream_id)) {
                return false;
            }
            return true;
        });

        // Sort: streams with active primaries first (they're ready for secondaries)
        secondaryAvailableStreams.sort((a, b) => {
            const aHasPrimary = streamsWithPrimary.has(a.stream_id);
            const bHasPrimary = streamsWithPrimary.has(b.stream_id);
            if (aHasPrimary && !bHasPrimary) return -1;
            if (!aHasPrimary && bHasPrimary) return 1;
            return 0;
        });

        // Add hasPrimary flag to each stream
        secondaryAvailableStreams.forEach(s => {
            s.hasPrimary = streamsWithPrimary.has(s.stream_id);
        });

        renderSecondaryStreamList();

    } catch (e) {
        console.error('Failed to load streams for secondary picker:', e);
        container.innerHTML = '<div class="text-center text-danger py-3">Failed to load streams</div>';
    }
}

function renderSecondaryStreamList(filter = '') {
    const container = document.getElementById('secondaryStreamsList');
    const filterLower = filter.toLowerCase();

    // Filter streams by search term
    const filtered = secondaryAvailableStreams.filter(s => {
        if (!filter) return true;
        const searchable = `${s.source} ${s.stream} ${s.target} ${s.stream_id}`.toLowerCase();
        return searchable.includes(filterLower);
    });

    if (filtered.length === 0) {
        container.innerHTML = `<div class="text-center text-muted py-3">
            ${filter ? 'No streams match your search.' : 'No streams available for secondary registration. Register a primary oracle first, or wait for other nodes to register streams.'}
        </div>`;
        return;
    }

    container.innerHTML = filtered.map(s => {
        const isSelected = secondarySelectedStreams.has(s.stream_id);
        const streamLabel = `${s.source}/${s.stream}/${s.target}`;
        const primaryBadge = s.hasPrimary
            ? '<span class="badge bg-success ms-2" title="Has active primary oracle - ready for relay">Primary Active</span>'
            : '<span class="badge bg-warning text-dark ms-2" title="No primary oracle yet - cannot relay">No Primary</span>';

        return `<label class="list-group-item list-group-item-action d-flex align-items-center ${s.hasPrimary ? '' : 'opacity-50'}" style="cursor: pointer;">
            <input type="checkbox" class="form-check-input me-3" value="${s.stream_id}"
                   ${isSelected ? 'checked' : ''}
                   ${s.hasPrimary ? '' : 'disabled'}
                   onchange="toggleSecondaryStream('${s.stream_id}')">
            <div class="flex-grow-1">
                <div class="d-flex align-items-center">
                    <strong>${streamLabel}</strong>
                    ${primaryBadge}
                </div>
                <small class="text-muted">${s.datatype} | Cadence: ${s.cadence}s | ${s.predictor_slots} slots</small>
            </div>
        </label>`;
    }).join('');
}

function filterSecondaryStreams() {
    const searchValue = document.getElementById('secondaryStreamSearch').value.trim();
    renderSecondaryStreamList(searchValue);
}

function toggleSecondaryStream(streamId) {
    if (secondarySelectedStreams.has(streamId)) {
        secondarySelectedStreams.delete(streamId);
    } else {
        secondarySelectedStreams.add(streamId);
    }
    updateSecondarySelectedCount();
}

function clearSecondarySelection() {
    secondarySelectedStreams.clear();
    updateSecondarySelectedCount();
    // Re-render to uncheck all checkboxes
    const searchValue = document.getElementById('secondaryStreamSearch').value.trim();
    renderSecondaryStreamList(searchValue);
}

function updateSecondarySelectedCount() {
    const count = secondarySelectedStreams.size;
    document.getElementById('secondarySelectedCount').textContent = count;
    document.getElementById('registerSecondaryBtn').disabled = count === 0;
}

async function registerSelectedAsSecondary() {
    if (secondarySelectedStreams.size === 0) {
        alert('Please select at least one stream');
        return;
    }

    const btn = document.getElementById('registerSecondaryBtn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Registering...';

    const streamIds = Array.from(secondarySelectedStreams);
    const results = { success: 0, failed: 0, errors: [] };

    // Register for each selected stream (includes auto-subscribe)
    for (const streamId of streamIds) {
        try {
            // Register as secondary AND subscribe to observations
            const [regResult, subResult] = await Promise.all([
                apiCall('/p2p/oracle/register-secondary', 'POST', { stream_id: streamId }),
                apiCall('/p2p/oracle/subscribe', 'POST', { stream_id: streamId })
            ]);

            if (regResult.success) {
                results.success++;
            } else {
                results.failed++;
                results.errors.push(`${streamId.split('|').slice(2).join('/')}: ${regResult.error || 'Unknown error'}`);
            }
        } catch (e) {
            results.failed++;
            results.errors.push(`${streamId.split('|').slice(2).join('/')}: ${e.message}`);
        }
    }

    btn.innerHTML = originalText;
    btn.disabled = false;

    // Show results
    let message = `Registered as secondary oracle for ${results.success} stream(s) and subscribed to observations.`;
    if (results.failed > 0) {
        message += `\n\nFailed for ${results.failed} stream(s):\n${results.errors.join('\n')}`;
    }
    alert(message);

    // Clear selection and refresh
    clearSecondarySelection();
    loadOracleStats();
    loadRegisteredOracles();
    loadSecondaryStreamPicker();
    loadStreamStats();
}

// =========================================================================
// OBSERVATIONS FUNCTIONS
// =========================================================================

// Pagination state for My Published Observations
let myObsCurrentPage = 1;
let myObsTotalPages = 1;
const myObsPerPage = 50;

async function loadMyPublishedObservations(page = 1) {
    const tbody = document.getElementById('myObservationsTable');
    const countEl = document.getElementById('myObsCount');
    const paginationEl = document.getElementById('myObsPagination');
    const pageInfoEl = document.getElementById('myObsPageInfo');
    const prevBtn = document.getElementById('myObsPrevBtn');
    const nextBtn = document.getElementById('myObsNextBtn');

    try {
        const result = await apiCall(`/p2p/oracle/observations/my?page=${page}&per_page=${myObsPerPage}`);

        // Update pagination state
        myObsCurrentPage = result.page || 1;
        myObsTotalPages = result.total_pages || 1;
        const total = result.total || 0;

        // Update count display
        if (countEl) {
            countEl.textContent = total > 0 ? `(${total} total)` : '';
        }

        if (result.observations && result.observations.length > 0) {
            tbody.innerHTML = result.observations.map(obs => {
                const date = new Date(obs.timestamp * 1000);
                const streamId = obs.stream_id || '';
                return `<tr>
                    <td>${streamId}</td>
                    <td><strong>${obs.value}</strong></td>
                    <td>${date.toLocaleString()}</td>
                </tr>`;
            }).join('');

            // Show pagination if more than one page
            if (myObsTotalPages > 1) {
                paginationEl.style.display = 'flex';
                paginationEl.style.setProperty('display', 'flex', 'important');
                pageInfoEl.textContent = `Page ${myObsCurrentPage} of ${myObsTotalPages}`;
                prevBtn.disabled = myObsCurrentPage <= 1;
                nextBtn.disabled = myObsCurrentPage >= myObsTotalPages;
            } else {
                paginationEl.style.display = 'none';
                paginationEl.style.setProperty('display', 'none', 'important');
            }
        } else {
            tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted py-3">No published observations yet. Register as an oracle to start publishing.</td></tr>';
            paginationEl.style.display = 'none';
            paginationEl.style.setProperty('display', 'none', 'important');
        }
    } catch (e) {
        console.error('Failed to load my observations:', e);
        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger py-3">Failed to load</td></tr>';
        paginationEl.style.display = 'none';
        paginationEl.style.setProperty('display', 'none', 'important');
    }
}

function changeMyObsPage(delta) {
    const newPage = myObsCurrentPage + delta;
    if (newPage >= 1 && newPage <= myObsTotalPages) {
        loadMyPublishedObservations(newPage);
    }
}

async function loadLatestObservations() {
    const tbody = document.getElementById('observationsTable');
    try {
        const result = await apiCall('/p2p/oracle/observations/latest');
        if (result.observations && result.observations.length > 0) {
            tbody.innerHTML = result.observations.map(obs => {
                const date = new Date(obs.timestamp * 1000);
                const streamId = obs.stream_id || '';
                const oracleAddr = obs.oracle_address || '';
                const peerId = obs.peer_id || '--';
                return `<tr>
                    <td>${streamId}</td>
                    <td><strong>${obs.value}</strong></td>
                    <td><code>${oracleAddr}</code></td>
                    <td>${peerId}</td>
                    <td>${date.toLocaleString()}</td>
                </tr>`;
            }).join('');
        } else {
            tbody.innerHTML = '<tr><td colspan="5" class="text-center text-muted py-3">No recent observations received from other oracles. If you are a Primary oracle, your published observations will appear in "My Published Observations" below.</td></tr>';
        }
    } catch (e) {
        console.error('Failed to load observations:', e);
        tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger py-3">Failed to load</td></tr>';
    }
}

async function publishObservation(event) {
    event.preventDefault();

    const streamId = document.getElementById('pubObsStreamId').value.trim();
    const value = parseFloat(document.getElementById('pubObsValue').value);
    const timestamp = document.getElementById('pubObsTimestamp').value;
    const resultSpan = document.getElementById('publishResult');

    resultSpan.innerHTML = '<span class="text-info">Publishing...</span>';

    try {
        const payload = { stream_id: streamId, value: value };
        if (timestamp) payload.timestamp = parseInt(timestamp);

        const result = await apiCall('/p2p/oracle/publish', 'POST', payload);
        if (result.success) {
            resultSpan.innerHTML = '<span class="text-success">Published!</span>';
            document.getElementById('observationForm').reset();
            loadLatestObservations();
            loadMyPublishedObservations();
            setTimeout(() => { resultSpan.innerHTML = ''; }, 3000);
        } else {
            resultSpan.innerHTML = '<span class="text-danger">' + (result.error || 'Failed') + '</span>';
        }
    } catch (e) {
        resultSpan.innerHTML = '<span class="text-danger">Error: ' + e.message + '</span>';
    }
}
</script>
{% endblock %}
