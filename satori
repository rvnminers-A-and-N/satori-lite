#!/bin/bash

# Check if Docker is installed and running
if ! command -v docker &> /dev/null; then
    echo "Error: Docker is not installed. Please install Docker first."
    echo "Visit: https://docs.docker.com/get-docker/"
    exit 1
fi

if ! docker info &> /dev/null; then
    echo "Error: Docker is not running. Please start Docker and try again."
    exit 1
fi

# Production mode - uses Docker image code
IMAGE_TAG="latest"
IMAGE="satorinet/satori-lite:${IMAGE_TAG}"
BASE_PORT=24601

# Parse instance number (default: 1)
if [[ "$1" =~ ^[0-9]+$ ]]; then
    INSTANCE=$1
    shift
else
    INSTANCE=1
fi

CONTAINER_NAME="satori-${INSTANCE}"
PORT=$((BASE_PORT + INSTANCE - 1))
DATA_DIR="$(pwd)/${INSTANCE}"

# Function to create data directories
create_data_dirs() {
    mkdir -p "${DATA_DIR}/config"
    mkdir -p "${DATA_DIR}/wallet"
    mkdir -p "${DATA_DIR}/models"
    mkdir -p "${DATA_DIR}/data"
}

# Function to create and start container
create_container() {
    # Create data directories
    create_data_dirs

    # Always pull latest image
    echo "Pulling latest image..."
    docker pull $IMAGE

    # Production mode: mount data only
    docker run -d --name $CONTAINER_NAME \
        --restart unless-stopped \
        -p ${PORT}:${PORT} \
        -e SATORI_ENV=prod \
        -e SATORI_UI_PORT=${PORT} \
        -v "${DATA_DIR}/config:/Satori/Neuron/config" \
        -v "${DATA_DIR}/wallet:/Satori/Neuron/wallet" \
        -v "${DATA_DIR}/models:/Satori/models" \
        -v "${DATA_DIR}/data:/Satori/Engine/db" \
        $IMAGE || {
        echo "Error: Failed to create container. Is Docker running?"
        exit 1
    }
}

# Help
if [ "$1" = "--help" ] || [ "$1" = "-h" ]; then
    echo "Satori Neuron"
    echo ""
    echo "Usage: satori [instance] [command]"
    echo ""
    echo "Instance:"
    echo "  (number)    Instance number (default: 1)"
    echo ""
    echo "Commands:"
    echo "  (none)      Enter interactive CLI"
    echo "  start       Start the neuron container"
    echo "  stop        Stop the neuron container"
    echo "  restart     Restart the neuron container"
    echo "  logs        Show container logs"
    echo "  status      Show container status"
    echo "  --help      Show this help"
    echo ""
    echo "Examples:"
    echo "  satori          # Run instance 1 on port 24601"
    echo "  satori 2        # Run instance 2 on port 24602"
    echo "  satori 2 stop   # Stop instance 2"
    echo "  satori 3 logs   # Show logs for instance 3"
    echo ""
    echo "Data persists in: ./<instance>/config, wallet, models, data"
    exit 0
fi

# Commands
case "$1" in
    start)
        docker start $CONTAINER_NAME
        echo "Satori neuron ${INSTANCE} started (port ${PORT})"
        ;;
    stop)
        docker stop $CONTAINER_NAME 2>/dev/null
        docker rm $CONTAINER_NAME 2>/dev/null
        echo "Satori neuron ${INSTANCE} stopped and removed"
        ;;
    restart)
        echo "Restarting Satori neuron ${INSTANCE}..."
        # Stop and remove container
        docker stop $CONTAINER_NAME 2>/dev/null
        docker rm $CONTAINER_NAME 2>/dev/null
        # Create fresh container with latest image
        create_container
        echo "Satori neuron ${INSTANCE} restarted with latest image (port ${PORT})"
        ;;
    logs)
        docker logs $CONTAINER_NAME --tail 100 -f
        ;;
    status)
        if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "Satori neuron ${INSTANCE} is running (port ${PORT})"
            docker ps --filter "name=$CONTAINER_NAME" --format "Container: {{.Names}}\nStatus: {{.Status}}\nCreated: {{.CreatedAt}}"
        else
            echo "Satori neuron ${INSTANCE} is not running"
        fi
        ;;
    "")
        # Default: enter CLI
        if ! docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
            echo "Satori neuron ${INSTANCE} is not running. Starting on port ${PORT}..."
            # Try to start existing container, or create new one
            if ! docker start $CONTAINER_NAME 2>/dev/null; then
                echo "Container not found. Creating..."
                create_container
            fi
            sleep 2
        fi
        docker exec -it $CONTAINER_NAME python /Satori/Neuron/cli.py
        ;;
    *)
        echo "Unknown command: $1"
        echo "Run 'satori --help' for usage"
        exit 1
        ;;
esac
